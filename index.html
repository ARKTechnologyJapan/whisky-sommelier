<!DOCTYPE html>
<!-- saved from url=(0121)https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse__wt7iPZ8SpK0k4hm3J-WvQ/index_updated.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昼の月。AIソムリエ</title>
    <link href="./index_files/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./index_files/all.min.css">
    <script src="./index_files/chart.js.ダウンロード"></script>
    <!-- Leaflet.js地図ライブラリ -->
    <link rel="stylesheet" href="./index_files/leaflet.css" crossorigin="">
    <script src="./index_files/leaflet.js.ダウンロード" crossorigin=""></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Noto Sans JP', sans-serif;
        }
        .header-container {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo {
            width: 50px;
            height: 50px;
            position: absolute;
            left: 20px;
            object-fit: contain;
            border-radius: 8px;
            background: rgba(78, 205, 197, 0);
            border: 2px solid #4ecdc500;
            padding: 5px;
        }
        
        .header-title {
            color: #fff;
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            margin: 0;
        }
        .container-custom {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        .taste-matrix {
            width: 300px;
            height: 300px;
            border: 2px solid #fff;
            position: relative;
            background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%), 
                        linear-gradient(to top, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%);
        }
        .taste-dot {
            width: 16px;
            height: 16px;
            background-color: #ff6b6b;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        .dual-matrix-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }
        .matrix-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .matrix-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
        }
        .whisky-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .whisky-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }
        .whisky-card.selected {
            background: rgba(78, 205, 196, 0.15);
            border-color: #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }
        .whisky-card.featured {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.10));
            border: 2px solid #FFA500;
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
            animation: pulse-orange 2s infinite;
        }
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
            50% { box-shadow: 0 0 30px rgba(255, 165, 0, 0.6); }
            100% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
        }
        .featured-label {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(45deg, #FFA500, #FFD700);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            color: #4ecdc4;
        }
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            color: #4ecdc4;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .progress-percentage {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        .success {
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        .price-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            margin: 10px 0;
        }
        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
        }
        .price-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: none;
        }
        .voice-input-btn {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .voice-input-btn:hover {
            background: rgba(78, 205, 196, 0.3);
        }
        .voice-input-btn.recording {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 均等に分割するように変更 */
            gap: 20px;
            align-items: start;
        }
        
        .recommendations-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(10px);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .chart-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            position: sticky;
            top: 120px;
            max-height: 80vh;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(78, 205, 196, 0.5) rgba(255, 255, 255, 0.1);
        }
        
        .chart-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .chart-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .chart-panel::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 4px;
        }
        
        .chart-container {
            height: 500px;
            width: 100%;
            position: relative;
        }
        .chart-container h3 {
            text-align: center;
            margin-bottom: 20px;
            color: #4ecdc4;
            font-size: 16px;
        }
        .chart-canvas {
            height: 400px !important;
            width: 100% !important;
        }
        #combinedProfileChart {
            height: 400px !important;
            width: 100% !important;
        }
        .recommendation-summary {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .custom-footer {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 40px;
        }
        
        .whisky-overview {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .whisky-overview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .whisky-overview h2 {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .whisky-overview .subtitle {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 15px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        .whisky-overview .description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
        }
        
        .whisky-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            position: relative;
            z-index: 1;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        .taste-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            fill: #4ecdc4;
        }

        .chat-section {
            margin-top: 30px;
        }

        .chat-examples {
            background: rgba(78, 205, 196, 0.05);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .question-example {
            display: block;
            padding: 8px 12px;
            margin-bottom: 8px;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 6px;
            color: #4ecdc4;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .question-example:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-1px);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
        }

        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
        }

        .ai-message {
            background: rgba(78, 205, 196, 0.15);
            border-left: 3px solid #4ecdc4;
            color: #fff;
        }

        .user-message {
            background: rgba(255, 107, 107, 0.15);
            border-left: 3px solid #ff6b6b;
            color: #fff;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 3px;
        }
        
        @media (max-width: 1024px) {
            .split-layout {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .chart-panel {
                position: static;
            }
            
            .whisky-overview h2 {
                font-size: 2rem;
            }
            
            .whisky-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .dual-matrix-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        @media (max-width: 768px) {
            .custom-footer {
                display: block;
            }
            
            .whisky-overview h2 {
                font-size: 1.8rem;
            }
            
            .whisky-overview .subtitle {
                font-size: 1rem;
            }
            
            .whisky-overview .description {
                font-size: 1rem;
            }
        }
        
        .recommendations-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .recommendations-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .recommendations-panel::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 4px;
        }
        
        .recommendations-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(78, 205, 196, 0.7);
        }

        /* 新規追加スタイル - 蒸留所マップと情報パネル */
        .distillery-section {
            margin-top: 20px;
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: opacity 0.8s ease, height 0.8s ease;
        }

        .distillery-section.active {
            opacity: 1;
            height: auto;
        }

        .distillery-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(78, 205, 196, 0.3);
            background-color: #1a1a1a;
        }

        #distilleryMap {
            height: 100%;
            width: 100%;
            background-color: #242424;
        }

        .distillery-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
        }

        .distillery-info h3 {
            color: #4ecdc4;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 8px;
        }

        .distillery-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 16px;
            margin-top: 15px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        .info-value {
            color: rgba(255, 255, 255, 0.9);
        }

        .distillery-description {
            margin-top: 15px;
            line-height: 1.6;
        }

        .status-active {
            color: #4ecdc4;
            font-weight: bold;
        }

        .status-closed {
            color: #ff6b6b;
            font-weight: bold;
        }

        .status-unknown {
            color: #ffb347;
            font-weight: bold;
        }

        /* Leafletマップスタイルのカスタマイズ */
        .leaflet-container {
            background-color: #f0f0f0 !important;
        }
        .leaflet-tile-pane {
            opacity: 0.9;
        }
        .leaflet-popup-content-wrapper {
            background-color: rgba(40, 44, 52, 0.95) !important;
            color: #fff !important;
            border: 1px solid rgba(78, 205, 196, 0.5);
        }
        .leaflet-popup-tip {
            background-color: rgba(40, 44, 52, 0.95) !important;
        }
        .leaflet-control-zoom a {
            background-color: rgba(40, 44, 52, 0.8) !important;
            color: #fff !important;
            border-color: rgba(78, 205, 196, 0.3) !important;
        }
        .leaflet-control-zoom a:hover {
            background-color: rgba(78, 205, 196, 0.3) !important;
        }
        
        /* 共通のJSONデータ処理用スタイル */
        .distillery-map-container {
            height: 300px;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid rgba(78, 205, 196, 0.3);
            position: relative;
            margin-bottom: 15px;
        }

        .distillery-map {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            z-index: 1;
        }

        .distillery-info-panel {
            margin-top: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            border: 1px solid rgba(78, 205, 196, 0.2);
        }

        .distillery-name {
            color: #4ecdc4;
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
        }
        
        /* 統一ナビゲーション用スタイル */
        .nav-links {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 10px;
        }

        .nav-link {
            color: #fff;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 6px;
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid rgba(78, 205, 196, 0.3);
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .nav-link:hover {
            background: rgba(78, 205, 196, 0.3);
            transform: translateY(-2px);
        }

        .nav-link.active {
            background: rgba(78, 205, 196, 0.4);
            border-color: rgba(78, 205, 196, 0.6);
            box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
        }
    </style>
<style>
    .genspark-notice-dialog {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }

    .genspark-notice-content {
      background-color: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      box-sizing: border-box;
      padding: 10px 30px 30px 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-size: 16px;
    }

    .genspark-notice-title {
      color: #000;
      font-family: Arial;
      font-size: 20px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 
    }

    .genspark-notice-list {
      margin: 24px 0;
      
      color: #606366;
      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      padding-left: 12px;
    }

    .genspark-notice-list li {
      margin-bottom: 12px;
      list-style-type: disc;
    }

    .genspark-notice-list li a {
      color: #606366;
      text-decoration: underline;
    }

    .genspark-notice-checkbox {
      display: flex;
      align-items: center;
      margin-top: 20px;
      gap: 10px;

      color: #232425;

      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }

    .genspark-notice-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
      
    .genspark-notice-ok {
      color: #232425;

      text-align: center;
      font-family: Arial;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 

      cursor: pointer;
      display: flex;
      height: 40px;
      padding: 6px 14px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      align-self: stretch;
      border-radius: 8px;
      border: 1px solid #000;
      box-sizing: border-box;
      width: 100%;
    }
  </style></head>
<body>
    <div class="header-container">
        <img class="logo" src="./index_files/NH_bar_logo_fin_white.png" alt="昼の月バーロゴ">
        <h1 class="header-title">昼の月。AIソムリエ</h1>
        <div class="nav-links">
            <a href="https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse__wt7iPZ8SpK0k4hm3J-WvQ/index.html" class="nav-link" id="homeLink">🏠 AIソムリエ</a>
            <a href="https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse__wt7iPZ8SpK0k4hm3J-WvQ/whisky_list.html" class="nav-link" id="listLink">🥃 ウィスキー一覧</a>
        </div>
    </div>
    
    <div class="container-custom">
        <div class="whisky-overview">
            <h2>🍷 プレミアムウィスキーコレクション</h2>
            <div class="subtitle">本日は厳選された<span id="whiskyCount">6</span>本のウィスキーから</div>
            <div class="description">
                <strong>あなたの味覚に完璧にマッチする</strong>最高の一本を<br>
                AI技術で分析・提案いたします
            </div>
            <div class="whisky-stats">
                <div class="stat-item">
                    <span class="stat-number" id="totalWhiskies">6</span>
                    <div class="stat-label">厳選銘柄</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number" id="uniqueRegions">4</span>
                    <div class="stat-label">産地</div>
                </div>
                <div class="stat-item">
                    <span class="stat-number">AI</span>
                    <div class="stat-label">分析技術</div>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">
                💎 価格帯設定
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2">下限価格: <span id="minPriceDisplay">¥5,000</span></label>
                    <input type="range" id="minPrice" class="price-slider" min="1" max="80" value="5" step="1">
                </div>
                <div>
                    <label class="block mb-2">上限価格: <span id="maxPriceDisplay">¥50,000</span></label>
                    <input type="range" id="maxPrice" class="price-slider" min="1" max="80" value="50" step="1">
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">
                👅 味覚プロファイル設定
            </h2>
            <p class="mb-6">2つの四角内をクリックして、それぞれの好みの位置を選択してください</p>
            
            <div class="dual-matrix-container">
                <div class="matrix-wrapper">
                    <div class="matrix-title">🥃 基本的な味の傾向</div>
                    <div class="relative">
                        <div class="taste-matrix" id="tasteMatrix1">
                            <div class="taste-dot" id="tasteDot1" style="left: 50%; top: 50%;"></div>
                        </div>
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">フルーティー</div>
                        <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">スモーキー</div>
                        <div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">ライト</div>
                        <div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ヘビー</div>
                    </div>
                    <div class="text-center mt-4">
                        <span id="coordinates1" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
                    </div>
                </div>
                
                <div class="matrix-wrapper">
                    <div class="matrix-title">🎯 複雑さの好み</div>
                    <div class="relative">
                        <div class="taste-matrix" id="tasteMatrix2">
                            <div class="taste-dot" id="tasteDot2" style="left: 50%; top: 50%;"></div>
                        </div>
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">まろやか</div>
                        <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">強烈</div>
                        <div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">若い</div>
                        <div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">熟成</div>
                    </div>
                    <div class="text-center mt-4">
                        <span id="coordinates2" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card chat-section">
            <h2 class="text-2xl font-bold mb-4">
                🤖 AIソムリエとチャット（何度でもお気軽に！）
            </h2>
            
            <div class="chat-examples">
                <div class="mb-3 text-sm text-gray-300">質問例（クリックで入力）：</div>
                <div class="question-example" data-question="タリスカー44年（最高額80,400円）について詳しく教えて">💎 タリスカー44年（最高額80,400円）について詳しく教えて</div>
                <div class="question-example" data-question="3000円以下でスモーキーなアイラ島のウィスキーはある？">🌊 3000円以下でスモーキーなアイラ島のウィスキーはある？</div>
                <div class="question-example" data-question="日本の軽井沢や長濱などフルーティーなウィスキーを比較して">🍯 日本の軽井沢や長濱などフルーティーなウィスキーを比較して</div>
                <div class="question-example" data-question="5000円前後でcomplexity5点の複雑なウィスキーのおすすめは？">⭐ 5000円前後でcomplexity5点の複雑なウィスキーのおすすめは？</div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力してください...">
                <button id="voiceInputBtn" class="voice-input-btn">
                    🎤
                </button>
                <button id="sendChatBtn" class="btn-primary">💬 質問する</button>
            </div>

            <div id="chatHistory" class="chat-history" style="display: none;"></div>
        </div>
        
        <div class="text-center mb-8">
            <button id="getRecommendation" class="btn-primary text-lg mr-4">🎯 AIウィスキー提案を受ける</button>
            <button id="refreshRecommendation" class="btn-secondary text-lg">
                🔄 リフレッシュして再提案
            </button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="animate-spin text-4xl mb-4">🥃</div>
            <p class="mt-2">AIが最適なウィスキーを分析中...</p>
        </div>
        
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div id="progressText" class="progress-text">最適化処理中...</div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 100%;"></div>
            </div>
            <div id="progressPercentage" class="progress-percentage">100%</div>
        </div>
        
        <div id="splitLayoutContainer" style="display: grid;" class="split-layout">
            <div class="recommendations-panel">
                <h2 class="text-2xl font-bold mb-4">
                    🎯 AI提案結果
                </h2>
                <div id="preferencesSummary" class="recommendation-summary">
                <h3 class="text-lg font-bold mb-3">🎯 あなたの好みの傾向</h3>
                <div class="space-y-2 text-sm">
                    <div><strong>基本的な味の傾向:</strong> バランスのとれたマイルドな味わいを好む</div>
                    <div><strong>複雑さの好み:</strong> 適度に熟成した適度な複雑さを好む</div>
                    <div><strong>価格帯:</strong> ¥5,000 - ¥50,000</div>
                    
                    <div class="mt-3 pt-2 border-t border-gray-600">
                        この総合プロファイルに基づいて、最適な3銘柄を厳選しました。
                    </div>
                </div>
            </div>
                <div id="recommendationContent">
                    <div class="whisky-card featured" onclick="selectWhisky(&#39;5&#39;)">
                        <div class="featured-label">⭐ 最もおすすめ</div>
                        <h3 class="text-xl font-bold mb-2">軽井沢25年</h3>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-green-400">¥25,000</span>
                            <span class="text-sm bg-blue-600 px-2 py-1 rounded">Japan</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">Japanese Whisky</p>
                        <p class="text-sm mb-3">閉鎖された軽井沢蒸溜所からの希少な逸品。25年熟成されたこの表現は、日本の繊細さと果実の豊かさのバランスが見事。深い複雑さと長く続く余韻が特徴。</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">適合度: 68%</span>
                            <div class="w-24 h-2 bg-gray-700 rounded-full">
                                <div class="h-full bg-gradient-to-r from-red-500 to-green-500 rounded-full" style="width: 68%"></div>
                            </div>
                        </div>
                    </div>
                
                    <div class="whisky-card selected" onclick="selectWhisky(&#39;3&#39;)">
                        
                        <h3 class="text-xl font-bold mb-2">マッカラン1990年SAMAROLI</h3>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-green-400">¥12,200</span>
                            <span class="text-sm bg-blue-600 px-2 py-1 rounded">Scotland</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">Single Malt Scotch Whisky - Speyside</p>
                        <p class="text-sm mb-3">有名な独立系ボトラー、サマローリによってボトリングされた希少なマッカラン1990年。豊かなシェリーの影響があり、ドライフルーツ、オレンジピール、クリスマスケーキの風味が特徴。複雑な樽のスパイスが蜂蜜、トフィー、ダークチョコレートと調和しています。</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">適合度: 60%</span>
                            <div class="w-24 h-2 bg-gray-700 rounded-full">
                                <div class="h-full bg-gradient-to-r from-red-500 to-green-500 rounded-full" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                
                    <div class="whisky-card" onclick="selectWhisky(&#39;4&#39;)">
                        
                        <h3 class="text-xl font-bold mb-2">ボウモア26年ダンカンテイラー</h3>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-green-400">¥15,000</span>
                            <span class="text-sm bg-blue-600 px-2 py-1 rounded">Scotland, Islay</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">Single Malt Scotch Whisky</p>
                        <p class="text-sm mb-3">ボウモア蒸溜所の美しく熟成された表現で、ダンカンテイラー社によってボトリング。アイラ島のスモーキーさと長期熟成による果実味の発達のバランスが絶妙。</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">適合度: 59%</span>
                            <div class="w-24 h-2 bg-gray-700 rounded-full">
                                <div class="h-full bg-gradient-to-r from-red-500 to-green-500 rounded-full" style="width: 59%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button id="getAnotherRecommendation" class="btn-secondary">
                        🔄 別の提案
                    </button>
                </div>
            </div>
            
            <div class="chart-panel">
                <h2 class="text-2xl font-bold mb-4">
                    📊 味覚プロファイル比較
                </h2>
                <div class="chart-container">
                    <h3 id="chartTitle">あなたの好み vs マッカラン1990年SAMAROLI</h3>
                    <canvas id="combinedProfileChart" class="chart-canvas" style="box-sizing: border-box; display: block; height: 500px; width: 500px;" width="625" height="625"></canvas>
                </div>
                <div class="text-center mt-4">
                    <p class="text-sm text-gray-400">ウィスキーの銘柄をクリックすると、あなたの好みと重ねて表示されます</p>
                </div>
                
                <!-- 蒸留所マップと情報セクション (最初は非表示) -->
                <div id="distillerySection" class="distillery-section active">
                    <h2 class="text-xl font-bold mb-3 text-center">
                        🌍 蒸留所情報
                    </h2>
                    <div class="distillery-container">
                        <div class="map-container">
                            <div id="distilleryMap" class="leaflet-container leaflet-touch leaflet-retina leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0" style="position: relative;"><div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(151px, -6px, 0px);"><div class="leaflet-pane leaflet-tile-pane"><div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 17; transform: translate3d(-248px, -92px, 0px) scale(4);"></div><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 19; transform: translate3d(0px, 0px, 0px) scale(1);"><img alt="" role="presentation" src="./index_files/77.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-76px, -48px, 0px); opacity: 1;"><img alt="" role="presentation" src="./index_files/78.png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-76px, 208px, 0px); opacity: 1;"><img alt="" role="presentation" src="./index_files/77(1).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-332px, -48px, 0px); opacity: 1;"><img alt="" role="presentation" src="./index_files/77(2).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(180px, -48px, 0px); opacity: 1;"><img alt="" role="presentation" src="./index_files/78(1).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(-332px, 208px, 0px); opacity: 1;"><img alt="" role="presentation" src="./index_files/78(2).png" class="leaflet-tile leaflet-tile-loaded" style="width: 256px; height: 256px; transform: translate3d(180px, 208px, 0px); opacity: 1;"></div></div></div><div class="leaflet-pane leaflet-shadow-pane"></div><div class="leaflet-pane leaflet-overlay-pane"><svg pointer-events="none" class="leaflet-zoom-animated" width="620" height="356" viewBox="-203 -24 620 356" style="transform: translate3d(-203px, -24px, 0px);"><g><path class="leaflet-interactive" stroke="#ff6b6b" stroke-opacity="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#ff6b6b" fill-opacity="0.7" fill-rule="evenodd" d="M100,155a8,8 0 1,0 16,0 a8,8 0 1,0 -16,0 "></path><path class="leaflet-interactive" stroke="#ff6b6b" stroke-opacity="0.3" stroke-width="1" stroke-linecap="round" stroke-linejoin="round" fill="rgba(255, 107, 107, 0.2)" fill-opacity="0.2" fill-rule="evenodd" d="M92,155a16,16 0 1,0 32,0 a16,16 0 1,0 -32,0 "></path><path class="leaflet-interactive" stroke="#4ecdc4" stroke-opacity="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#4ecdc4" fill-opacity="0.7" fill-rule="evenodd" d="M0 0"></path><path class="leaflet-interactive" stroke="#4ecdc4" stroke-opacity="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#4ecdc4" fill-opacity="0.7" fill-rule="evenodd" d="M0 0"></path><path class="leaflet-interactive" stroke="#4ecdc4" stroke-opacity="1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" fill="#4ecdc4" fill-opacity="0.7" fill-rule="evenodd" d="M0 0"></path></g></svg></div><div class="leaflet-pane leaflet-marker-pane"></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(32183.5px, 19914.5px, 0px) scale(128);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse__wt7iPZ8SpK0k4hm3J-WvQ/index_updated.html#" title="Zoom in" role="button" aria-label="Zoom in">+</a><a class="leaflet-control-zoom-out" href="https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse__wt7iPZ8SpK0k4hm3J-WvQ/index_updated.html#" title="Zoom out" role="button" aria-label="Zoom out">−</a></div><div class="leaflet-control-attribution leaflet-control"><a href="https://leafletjs.com/" title="A JS library for interactive maps">Leaflet</a> | © <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a></div></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="custom-footer">
            Powered by Nebula Hirozon Technology
        </div>
    </div>
    
    <script>
        // グローバル変数
        let distilleryMap = null;
        let distilleryMarkers = {};
        let whiskyData = [];
        let profileChartInstance = null;
        let selectedWhisky = null;
        let distilleryDatabase = {};
        let userPreferences = {
            taste: { x: 0.5, y: 0.5 },
            complexity: { x: 0.5, y: 0.5 },
            minPrice: 5,
            maxPrice: 50
        };
        
        // 初期化処理
        document.addEventListener('DOMContentLoaded', function() {
            // ナビゲーションリンクのアクティブ状態を設定
            setActiveNavLinks();
            
            // 初期化
            initTasteMatrix();
            initPriceSliders();
            setupChatInput();
            setupQuestionExamples();
            
            // ボタンイベントリスナー
            document.getElementById('getRecommendation').addEventListener('click', getRecommendation);
            document.getElementById('refreshRecommendation').addEventListener('click', refreshRecommendation);
            document.getElementById('getAnotherRecommendation').addEventListener('click', getAnotherRecommendation);
            
            // 共通データ読み込み
            loadCommonData();
        });
        
        // ナビゲーションリンクのアクティブ状態設定
        function setActiveNavLinks() {
            const currentPage = window.location.pathname.split('/').pop();
            const homeLink = document.getElementById('homeLink');
            const listLink = document.getElementById('listLink');
            
            if (homeLink && listLink) {
                if (currentPage === 'index.html' || currentPage === '') {
                    homeLink.classList.add('active');
                    listLink.classList.remove('active');
                } else if (currentPage === 'whisky_list.html') {
                    homeLink.classList.remove('active');
                    listLink.classList.add('active');
                }
            }
        }
        
        // 両ページで共通のJSON読み込み処理
        async function loadCommonData() {
            // まず蒸留所データを読み込み
            await loadDistilleryData().catch(err => console.warn('蒸留所データ読み込みエラー:', err));
            
            // 次にウィスキーデータを読み込み
            await loadWhiskyData().catch(err => console.warn('ウィスキーデータ読み込みエラー:', err));
            
            // マップ初期化（両方のページで同じ関数を使用）
            initializeCommonMap();
        }
        
        // マップ初期化共通関数
        function initializeCommonMap() {
            const mapElement = document.getElementById('distilleryMap');
            if (!mapElement) return;
            
            // Leafletマップの初期化（両ページで同じ設定）
            distilleryMap = L.map('distilleryMap', {
                center: [55.0, -3.0],  // スコットランド中心
                zoom: 5,
                zoomControl: false
            });
            
            // 同じタイルレイヤー
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
                maxZoom: 19
            }).addTo(distilleryMap);
            
            // ズームコントロールを右下に統一
            L.control.zoom({
                position: 'bottomright'
            }).addTo(distilleryMap);
            
            // サイズを更新
            setTimeout(() => {
                distilleryMap.invalidateSize();
            }, 100);
        }
        
        // 蒸留所マーカー更新の共通関数
        function updateDistilleryMarkers(activeName) {
            // 既存のマーカーをクリア
            clearAllMarkers();
            
            // アクティブな蒸留所のマーカーを作成（赤色）
            if (activeName && distilleryDatabase[activeName]) {
                const distillery = distilleryDatabase[activeName];
                createMarker(distillery, true);  // true = アクティブ（赤色）
            }
            
            // その他の蒸留所マーカーを作成（緑色）
            Object.keys(distilleryDatabase).forEach(name => {
                if (name !== activeName && name !== 'NaN' && distilleryDatabase[name]) {
                    createMarker(distilleryDatabase[name], false);  // false = 非アクティブ（緑色）
                }
            });
        }
        
        // マーカー作成共通関数
        function createMarker(distillery, isActive) {
            if (!distillery || !distillery.location) return;
            
            // 座標の検証
            if (!isValidCoordinate(distillery.location.lat, distillery.location.lng)) return;
            
            // マーカーのスタイル（アクティブ=赤、非アクティブ=緑）
            const markerColor = isActive ? '#ff6b6b' : '#4ecdc4';
            const markerOptions = {
                radius: isActive ? 8 : 6,
                fillColor: markerColor,
                color: markerColor,
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
            };
            
            // マーカー作成
            const marker = L.circleMarker([distillery.location.lat, distillery.location.lng], markerOptions)
                .addTo(distilleryMap);
            
            // クリックイベント
            marker.on('click', () => showDistilleryInfo(distillery));
            
            // アクティブなら追加エフェクト（パルス）
            if (isActive) {
                const pulseOptions = {
                    radius: 20,
                    fillColor: 'rgba(255, 107, 107, 0.2)',
                    color: markerColor,
                    weight: 1,
                    opacity: 0.3,
                    fillOpacity: 0.2
                };
                
                const pulseCircle = L.circleMarker(
                    [distillery.location.lat, distillery.location.lng], 
                    pulseOptions
                ).addTo(distilleryMap);
                
                // アニメーション効果
                let isGrowing = true;
                let currentRadius = 20;
                
                const pulseInterval = setInterval(() => {
                    if (isGrowing) {
                        currentRadius += 1;
                        if (currentRadius >= 30) isGrowing = false;
                    } else {
                        currentRadius -= 1;
                        if (currentRadius <= 15) isGrowing = true;
                    }
                    
                    pulseCircle.setRadius(currentRadius);
                }, 100);
                
                // マーカーにパルス情報を紐づけ
                marker.pulse = {
                    circle: pulseCircle,
                    interval: pulseInterval
                };
            }
            
            // マーカー保存
            distilleryMarkers[distillery.name] = marker;
            return marker;
        }
        
        // 座標検証ヘルパー関数
        function isValidCoordinate(lat, lng) {
            return lat && lng && !isNaN(lat) && !isNaN(lng) && 
                   lat >= -90 && lat <= 90 && lng >= -180 && lng <= 180;
        }
        
        // 全マーカークリア関数
        function clearAllMarkers() {
            Object.values(distilleryMarkers).forEach(marker => {
                // パルスエフェクトがあれば停止・削除
                if (marker.pulse) {
                    clearInterval(marker.pulse.interval);
                    if (marker.pulse.circle) {
                        distilleryMap.removeLayer(marker.pulse.circle);
                    }
                }
                if (distilleryMap) {
                    distilleryMap.removeLayer(marker);
                }
            });
            
            // マーカー配列クリア
            distilleryMarkers = {};
        }
        
        // 蒸留所情報表示関数
        function showDistilleryInfo(distillery) {
            if (!distillery) return;
            
            // ポップアップ表示
            if (distilleryMap && distillery.location) {
                const popupContent = `<b>${distillery.name}</b><br>${distillery.region || ''}`;
                L.popup()
                    .setLatLng([distillery.location.lat, distillery.location.lng])
                    .setContent(popupContent)
                    .openOn(distilleryMap);
            }
        }
        
        // 蒸留所データ読み込み
        async function loadDistilleryData() {
            try {
                // まずlocalStorageから試行
                const cachedData = localStorage.getItem('distilleryData');
                if (cachedData) {
                    const cache = JSON.parse(cachedData);
                    if (cache.timestamp && (Date.now() - cache.timestamp < 24 * 60 * 60 * 1000)) {
                        console.log('蒸留所データをキャッシュから読み込みました');
                        distilleryDatabase = cache.data;
                        return;
                    }
                }
                
                // 複数の可能性のあるファイル名を試す
                const possibleFiles = [
                    './distilleries.json',
                    './distillery_data.json',
                    './distillery.json',
                    './data/distilleries.json',
                    'https://raw.githubusercontent.com/user/repo/main/distilleries.json'
                ];
                
                let dataLoaded = false;
                
                for (const fileName of possibleFiles) {
                    try {
                        const response = await fetch(fileName);
                        if (response.ok) {
                            const data = await response.json();
                            if (data && typeof data === 'object') {
                                distilleryDatabase = data;
                                
                                // キャッシュに保存
                                localStorage.setItem('distilleryData', JSON.stringify({
                                    timestamp: Date.now(),
                                    data: distilleryDatabase
                                }));
                                
                                console.log(`蒸留所データを ${fileName} から読み込みました`);
                                dataLoaded = true;
                                break;
                            }
                        }
                    } catch (error) {
                        console.warn(`${fileName} からの読み込みに失敗しました:`, error);
                    }
                }
                
                // すべてのファイルのロードが失敗した場合はデフォルトデータを使用
                if (!dataLoaded) {
                    console.log('デフォルトの蒸留所データを使用します');
                    distilleryDatabase = getDefaultDistilleryData();
                }
                
            } catch (error) {
                console.error('蒸留所データの読み込みに失敗しました:', error);
                distilleryDatabase = getDefaultDistilleryData();
            }
        }
        
        // ウィスキーデータ読み込み
        async function loadWhiskyData() {
            try {
                // まずlocalStorageから試行
                const cachedData = localStorage.getItem('whiskyData');
                if (cachedData) {
                    const cache = JSON.parse(cachedData);
                    if (cache.timestamp && (Date.now() - cache.timestamp < 24 * 60 * 60 * 1000)) {
                        console.log('ウィスキーデータをキャッシュから読み込みました');
                        whiskyData = cache.data;
                        updateUIWithData();
                        return;
                    }
                }
                
                // 複数の可能性のあるファイル名を試す
                const possibleFiles = [
                    './whisky_data.json',
                    './whiskey_data.json',
                    './data.json',
                    './data/whiskies.json',
                    'https://raw.githubusercontent.com/user/repo/main/whisky_data.json'
                ];
                
                let dataLoaded = false;
                
                for (const fileName of possibleFiles) {
                    try {
                        const response = await fetch(fileName);
                        if (response.ok) {
                            const data = await response.json();
                            if (Array.isArray(data)) {
                                whiskyData = data;
                                
                                // キャッシュに保存
                                localStorage.setItem('whiskyData', JSON.stringify({
                                    timestamp: Date.now(),
                                    data: whiskyData
                                }));
                                
                                console.log(`ウィスキーデータを ${fileName} から読み込みました`);
                                dataLoaded = true;
                                updateUIWithData();
                                break;
                            }
                        }
                    } catch (error) {
                        console.warn(`${fileName} からの読み込みに失敗しました:`, error);
                    }
                }
                
                // すべてのファイルのロードが失敗した場合はデフォルトデータを使用
                if (!dataLoaded) {
                    console.log('デフォルトのウィスキーデータを使用します');
                    whiskyData = getDefaultWhiskyData();
                    updateUIWithData();
                }
                
            } catch (error) {
                console.error('ウィスキーデータの読み込みに失敗しました:', error);
                whiskyData = getDefaultWhiskyData();
                updateUIWithData();
            }
        }
        
        // UIにデータを反映
        function updateUIWithData() {
            if (!whiskyData || whiskyData.length === 0) return;
            
            document.getElementById('whiskyCount').textContent = whiskyData.length;
            document.getElementById('totalWhiskies').textContent = whiskyData.length;
            
            // ユニークな産地数を計算
            const uniqueRegions = new Set();
            whiskyData.forEach(whisky => {
                if (whisky.region) uniqueRegions.add(whisky.region);
            });
            document.getElementById('uniqueRegions').textContent = uniqueRegions.size;
        }
        
        // テイスト行列の初期化
        function initTasteMatrix() {
            const tasteMatrix1 = document.getElementById('tasteMatrix1');
            const tasteMatrix2 = document.getElementById('tasteMatrix2');
            const tasteDot1 = document.getElementById('tasteDot1');
            const tasteDot2 = document.getElementById('tasteDot2');
            const coordinates1 = document.getElementById('coordinates1');
            const coordinates2 = document.getElementById('coordinates2');
            
            // 中心点に配置（50%,50%）
            tasteDot1.style.left = '50%';
            tasteDot1.style.top = '50%';
            tasteDot2.style.left = '50%';
            tasteDot2.style.top = '50%';
            coordinates1.textContent = `座標: X: 0.50, Y: 0.50`;
            coordinates2.textContent = `座標: X: 0.50, Y: 0.50`;
            
            // ユーザープリファレンスを更新
            userPreferences.taste = { x: 0.5, y: 0.5 };
            userPreferences.complexity = { x: 0.5, y: 0.5 };
            
            // クリックハンドラ設定
            function setupMatrixClickHandlers(matrix, dot, coordsDisplay, preferenceProp) {
                matrix.addEventListener('click', function(event) {
                    const rect = matrix.getBoundingClientRect();
                    const x = (event.clientX - rect.left) / rect.width;
                    const y = (event.clientY - rect.top) / rect.height;
                    
                    dot.style.left = (x * 100) + '%';
                    dot.style.top = (y * 100) + '%';
                    
                    coordsDisplay.textContent = `座標: X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}`;
                    
                    // ユーザープリファレンスを更新
                    userPreferences[preferenceProp] = { x, y };
                });
            }
            
            setupMatrixClickHandlers(tasteMatrix1, tasteDot1, coordinates1, 'taste');
            setupMatrixClickHandlers(tasteMatrix2, tasteDot2, coordinates2, 'complexity');
        }
        
        // 価格スライダーの初期化
        function initPriceSliders() {
            const minPriceSlider = document.getElementById('minPrice');
            const maxPriceSlider = document.getElementById('maxPrice');
            const minPriceDisplay = document.getElementById('minPriceDisplay');
            const maxPriceDisplay = document.getElementById('maxPriceDisplay');
            
            function updatePriceDisplay() {
                const minPrice = parseInt(minPriceSlider.value);
                const maxPrice = parseInt(maxPriceSlider.value);
                
                // min が max を超えないように
                if (minPrice > maxPrice) {
                    minPriceSlider.value = maxPrice;
                    userPreferences.minPrice = maxPrice;
                } else {
                    userPreferences.minPrice = minPrice;
                }
                
                // max が min を下回らないように
                if (maxPrice < minPrice) {
                    maxPriceSlider.value = minPrice;
                    userPreferences.maxPrice = minPrice;
                } else {
                    userPreferences.maxPrice = maxPrice;
                }
                
                // 表示を更新
                minPriceDisplay.textContent = `¥${userPreferences.minPrice},000`;
                maxPriceDisplay.textContent = `¥${userPreferences.maxPrice},000`;
            }
            
            minPriceSlider.addEventListener('input', updatePriceDisplay);
            maxPriceSlider.addEventListener('input', updatePriceDisplay);
            
            // 初期値を設定
            minPriceSlider.value = userPreferences.minPrice;
            maxPriceSlider.value = userPreferences.maxPrice;
            updatePriceDisplay();
        }
        
        // チャット入力の設定
        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const sendChatBtn = document.getElementById('sendChatBtn');
            const chatHistory = document.getElementById('chatHistory');
            
            sendChatBtn.addEventListener('click', () => {
                const question = chatInput.value.trim();
                if (!question) return;
                
                // チャット履歴の表示
                if (chatHistory.style.display !== 'block') {
                    chatHistory.style.display = 'block';
                }
                
                // ユーザーメッセージを追加
                addChatMessage(question, 'user');
                
                // AIの応答を生成
                setTimeout(() => {
                    const response = generateAIResponse(question);
                    addChatMessage(response, 'ai');
                }, 500);
                
                // 入力をクリア
                chatInput.value = '';
            });
            
            chatInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatBtn.click();
                }
            });
        }
        
        // 質問例のセットアップ
        function setupQuestionExamples() {
            const examples = document.querySelectorAll('.question-example');
            examples.forEach(example => {
                example.addEventListener('click', () => {
                    const question = example.getAttribute('data-question');
                    document.getElementById('chatInput').value = question;
                });
            });
        }
        
        // チャットメッセージ追加
        function addChatMessage(message, type) {
            const chatHistory = document.getElementById('chatHistory');
            const messageElem = document.createElement('div');
            messageElem.className = `chat-message ${type}-message`;
            messageElem.textContent = message;
            chatHistory.appendChild(messageElem);
            chatHistory.scrollTop = chatHistory.scrollHeight;
        }
        
        // AIレスポンス生成（シンプルな例）
        function generateAIResponse(question) {
            // 実際の実装ではAPIを呼ぶなどより洗練された方法を使います
            const responses = {
                'タリスカー44年': 'タリスカー44年は、スコットランドのスカイ島で2018年に限定リリースされた非常に希少なボトルです。長期熟成による深い複雑さと、タリスカー特有の塩味、海藻、柑橘系の風味が特徴です。現在の市場価格は約¥80,400です。',
                '3000円以下': 'キルホーマン2013-2021信濃屋が¥2,000でスモーキーなアイラモルトとしておすすめです。強いピート感と潮気を感じられる、コストパフォーマンスの高い一本です。',
                '日本のフルーティー': '軽井沢25年は日本を代表するフルーティーなウイスキーで、洗練された果実味と複雑さが特徴です。価格は¥25,000程度で、長期熟成による深みのある味わいが楽しめます。',
                '複雑なウィスキー': 'マッカラン1990年SAMAROLIは複雑さ5点満点の素晴らしいウイスキーです。¥12,200とリーズナブルな価格で、豊かなシェリーの風味とスパイスの複雑な相互作用が楽しめます。'
            };
            
            // 簡易的なキーワードマッチング
            for (const [key, response] of Object.entries(responses)) {
                if (question.includes(key)) {
                    return response;
                }
            }
            
            return 'ご質問ありがとうございます。詳細な情報を検索中です。もう少し具体的なウィスキー名や好みをお教えいただけますと、より的確なご案内ができます。';
        }
        
        // レコメンデーションの取得
        function getRecommendation() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const progressContainer = document.getElementById('progressContainer');
            const splitLayoutContainer = document.getElementById('splitLayoutContainer');
            
            // UI更新
            loadingIndicator.style.display = 'block';
            progressContainer.style.display = 'block';
            splitLayoutContainer.style.display = 'none';
            
            // プログレスアニメーション
            let progress = 0;
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressInterval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 100) {
                    progress = 100;
                    clearInterval(progressInterval);
                    
                    // 処理完了
                    setTimeout(() => {
                        loadingIndicator.style.display = 'none';
                        progressContainer.style.display = 'none';
                        splitLayoutContainer.style.display = 'grid';
                        
                        // プリファレンスサマリーを更新
                        updatePreferencesSummary();
                        
                        // レコメンデーションを表示
                        displayRecommendations();
                        
                        // 最初のウィスキーを選択
                        const firstRecommendation = document.querySelector('.whisky-card');
                        if (firstRecommendation) {
                            const whiskyId = firstRecommendation.getAttribute('onclick').match(/\d+/)[0];
                            selectWhisky(whiskyId);
                        }
                    }, 500);
                }
                progressFill.style.width = `${progress}%`;
                progressPercentage.textContent = `${Math.round(progress)}%`;
            }, 200);
        }
        
        // リフレッシュして再提案
        function refreshRecommendation() {
            // UIをリセット
            initTasteMatrix();
            initPriceSliders();
            
            // チャット履歴をクリア
            const chatHistory = document.getElementById('chatHistory');
            chatHistory.innerHTML = '';
            chatHistory.style.display = 'none';
            
            // チャット入力をクリア
            document.getElementById('chatInput').value = '';
            
            // レコメンデーション結果を非表示
            document.getElementById('splitLayoutContainer').style.display = 'none';
            
            // 追加のリセット処理（必要に応じて）
            if (profileChartInstance) {
                profileChartInstance.destroy();
                profileChartInstance = null;
            }
            
            selectedWhisky = null;
            
            // レーダーチャートのキャンバスをリセット
            const chartCanvas = document.getElementById('combinedProfileChart');
            if (chartCanvas) {
                const ctx = chartCanvas.getContext('2d');
                ctx.clearRect(0, 0, chartCanvas.width, chartCanvas.height);
            }
        }
        
        // 別のウィスキー提案
        function getAnotherRecommendation() {
            // ランダムな3つのウィスキーを選ぶ
            displayRecommendations(true);
            
            // 最初のウィスキーを選択
            const firstRecommendation = document.querySelector('.whisky-card');
            if (firstRecommendation) {
                const whiskyId = firstRecommendation.getAttribute('onclick').match(/\d+/)[0];
                selectWhisky(whiskyId);
            }
        }
        
        // プリファレンスサマリーを更新
        function updatePreferencesSummary() {
            const summary = document.getElementById('preferencesSummary');
            
            // 味の傾向のテキスト生成
            let tasteDescription = '';
            if (userPreferences.taste.x > 0.66) {
                tasteDescription += 'ヘビーで';
            } else if (userPreferences.taste.x < 0.33) {
                tasteDescription += 'ライトで';
            } else {
                tasteDescription += 'バランスのとれた';
            }
            
            if (userPreferences.taste.y > 0.66) {
                tasteDescription += 'スモーキーな';
            } else if (userPreferences.taste.y < 0.33) {
                tasteDescription += 'フルーティーな';
            } else {
                tasteDescription += 'マイルドな';
            }
            
            // 複雑さのテキスト生成
            let complexityDescription = '';
            if (userPreferences.complexity.x > 0.66) {
                complexityDescription += '熟成で';
            } else if (userPreferences.complexity.x < 0.33) {
                complexityDescription += '若いで';
            } else {
                complexityDescription += '適度に熟成した';
            }
            
            if (userPreferences.complexity.y > 0.66) {
                complexityDescription += '強烈な';
            } else if (userPreferences.complexity.y < 0.33) {
                complexityDescription += 'まろやかな';
            } else {
                complexityDescription += '適度な';
            }
            
            // HTMLを更新
            summary.innerHTML = `
                <h3 class="text-lg font-bold mb-3">🎯 あなたの好みの傾向</h3>
                <div class="space-y-2 text-sm">
                    <div><strong>基本的な味の傾向:</strong> ${tasteDescription}味わいを好む</div>
                    <div><strong>複雑さの好み:</strong> ${complexityDescription}複雑さを好む</div>
                    <div><strong>価格帯:</strong> ¥${userPreferences.minPrice},000 - ¥${userPreferences.maxPrice},000</div>
                    
                    <div class="mt-3 pt-2 border-t border-gray-600">
                        この総合プロファイルに基づいて、最適な3銘柄を厳選しました。
                    </div>
                </div>
            `;
        }
        
        // レコメンデーションを表示
        function displayRecommendations(random = false) {
            const recommendationContent = document.getElementById('recommendationContent');
            
            // ウィスキーデータがない場合
            if (!whiskyData || whiskyData.length === 0) {
                recommendationContent.innerHTML = '<div class="error">ウィスキーデータが読み込まれていません</div>';
                return;
            }
            
            // ウィスキーをスコア計算して並べ替え
            let scoredWhiskies = whiskyData.map(whisky => {
                const score = calculateWhiskyScore(whisky);
                return { ...whisky, score };
            });
            
            scoredWhiskies.sort((a, b) => b.score - a.score);
            
            // ランダムモードの場合はシャッフル
            if (random) {
                scoredWhiskies = shuffleArray(scoredWhiskies);
            }
            
            // 上位3つのウィスキーを表示
            const topWhiskies = scoredWhiskies.slice(0, 3);
            let htmlContent = '';
            
            topWhiskies.forEach((whisky, index) => {
                const isFirst = index === 0;
                const matchPercentage = Math.round(whisky.score * 100);
                
                htmlContent += `
                    <div class="whisky-card ${isFirst ? 'featured' : ''}" onclick="selectWhisky('${whisky.id}')">
                        ${isFirst ? '<div class="featured-label">⭐ 最もおすすめ</div>' : ''}
                        <h3 class="text-xl font-bold mb-2">${whisky.name}</h3>
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-lg font-semibold text-green-400">¥${whisky.price.toLocaleString()}</span>
                            <span class="text-sm bg-blue-600 px-2 py-1 rounded">${whisky.region}</span>
                        </div>
                        <p class="text-sm text-gray-300 mb-2">${whisky.category || 'Whisky'}</p>
                        <p class="text-sm mb-3">${whisky.description_jp || whisky.description || '情報がありません'}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-sm text-gray-400">適合度: ${matchPercentage}%</span>
                            <div class="w-24 h-2 bg-gray-700 rounded-full">
                                <div class="h-full bg-gradient-to-r from-red-500 to-green-500 rounded-full" style="width: ${matchPercentage}%"></div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            recommendationContent.innerHTML = htmlContent;
        }
        
        // ウィスキースコアの計算
        function calculateWhiskyScore(whisky) {
            if (!whisky) return 0;
            
            let score = 0;
            
            // 価格フィルター（価格範囲外なら低スコア）
            const minPrice = userPreferences.minPrice * 1000;
            const maxPrice = userPreferences.maxPrice * 1000;
            if (whisky.price < minPrice || whisky.price > maxPrice) {
                return 0.01; // 価格範囲外
            }
            
            // 味のプロファイル（フルーティー/スモーキー、ライト/ヘビー）の一致度
            if (whisky.profile) {
                // X軸: ライト(0) → ヘビー(1)
                // フルーティー/スモーキーとボディ感を考慮
                const userX = userPreferences.taste.x;
                const whiskyX = (whisky.profile.body || 3) / 5; // 1-5スケールを0-1に変換
                
                // Y軸: フルーティー(0) → スモーキー(1)
                const userY = userPreferences.taste.y;
                const whiskyY = (whisky.profile.smoky || 3) / 5; // 1-5スケールを0-1に変換
                
                // 距離ベースのスコア（近いほど高スコア）
                const tasteDistance = Math.sqrt(
                    Math.pow(userX - whiskyX, 2) + 
                    Math.pow(userY - whiskyY, 2)
                );
                score += (1 - tasteDistance) * 0.4; // 40%のウェイト
                
                // 複雑さの一致度
                const userComplexityX = userPreferences.complexity.x;
                const userComplexityY = userPreferences.complexity.y;
                
                // X軸: 若い(0) → 熟成(1)
                // Y軸: まろやか(0) → 強烈(1)
                const whiskyComplexity = (whisky.profile.complexity || 3) / 5;
                const whiskySweetness = (whisky.profile.sweetness || 3) / 5;
                const whiskySpicy = (whisky.profile.spicy || 3) / 5;
                
                // 複雑さのスコア（大きい値ほど複雑）
                const whiskyComplexityX = (whiskySpicy + whiskyComplexity) / 2; // 若い/熟成軸
                const whiskyComplexityY = (whiskyComplexity + (1 - whiskySweetness)) / 2; // まろやか/強烈軸
                
                const complexityDistance = Math.sqrt(
                    Math.pow(userComplexityX - whiskyComplexityX, 2) + 
                    Math.pow(userComplexityY - whiskyComplexityY, 2)
                );
                score += (1 - complexityDistance) * 0.4; // 40%のウェイト
            }
            
            // 価格最適化（設定範囲内で理想的な価格に近いほど高スコア）
            const priceRange = maxPrice - minPrice;
            if (priceRange > 0) {
                const idealPrice = minPrice + priceRange * 0.7; // 70%の位置を理想とする
                const priceDiff = Math.abs(whisky.price - idealPrice) / priceRange;
                score += (1 - priceDiff) * 0.2; // 20%のウェイト
            }
            
            return Math.max(0.01, Math.min(1, score)); // 0.01-1.0の範囲に収める
        }
        
        // 配列をシャッフル
        function shuffleArray(array) {
            const result = [...array];
            for (let i = result.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [result[i], result[j]] = [result[j], result[i]];
            }
            return result;
        }
        
        // ウィスキーの選択
        function selectWhisky(whiskyId) {
            // 選択したウィスキーを取得
            const whisky = whiskyData.find(w => w.id == whiskyId);
            if (!whisky) return;
            
            selectedWhisky = whisky;
            
            // カードの選択状態を更新
            document.querySelectorAll('.whisky-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            const selectedCard = document.querySelector(`.whisky-card[onclick*="${whiskyId}"]`);
            if (selectedCard) {
                selectedCard.classList.add('selected');
            }
            
            // チャートを更新
            updateCombinedProfileChart(whisky);
            
            // チャートタイトルを更新
            document.getElementById('chartTitle').textContent = `あなたの好み vs ${whisky.name}`;
            
            // 蒸留所情報を更新
            updateDistilleryMap(whisky);
        }
        
        // 複合プロファイルチャートの更新
        function updateCombinedProfileChart(whisky) {
            const ctx = document.getElementById('combinedProfileChart').getContext('2d');
            
            // 既存のチャートがあれば破棄
            if (profileChartInstance) {
                profileChartInstance.destroy();
            }
            
            // ユーザープリファレンスを変換
            const userTasteX = userPreferences.taste.x * 5; // 0-1を0-5に変換
            const userTasteY = userPreferences.taste.y * 5;
            const userComplexityX = userPreferences.complexity.x * 5;
            const userComplexityY = userPreferences.complexity.y * 5;
            
            const userProfile = {
                fruity: 5 - userTasteY,  // フルーティーはYの逆（0=スモーキー、5=フルーティー）
                smoky: userTasteY,
                body: userTasteX,
                spicy: userComplexityX * 0.8,  // 若い/熟成を適度に変換
                sweetness: 5 - userComplexityY,  // まろやかさはYの逆
                complexity: userComplexityX * 0.5 + userComplexityY * 0.5  // 複雑さは両方の組み合わせ
            };
            
            // ウィスキープロファイルのデフォルト値
            const whiskyProfile = whisky.profile || {
                fruity: 3,
                smoky: 3,
                body: 3,
                spicy: 3,
                sweetness: 3,
                complexity: 3
            };
            
            // 日本語ラベル
            const labels = {
                fruity: 'フルーティー',
                smoky: 'スモーキー',
                body: 'ボディ',
                spicy: 'スパイシー',
                sweetness: '甘さ',
                complexity: '複雑さ'
            };
            
            // レーダーチャートを作成
            profileChartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: Object.values(labels),
                    datasets: [
                        {
                            label: 'あなたの好み',
                            data: [
                                userProfile.fruity,
                                userProfile.smoky,
                                userProfile.body,
                                userProfile.spicy,
                                userProfile.sweetness,
                                userProfile.complexity
                            ],
                            backgroundColor: 'rgba(255, 107, 107, 0.2)',
                            borderColor: 'rgba(255, 107, 107, 1)',
                            pointBackgroundColor: 'rgba(255, 107, 107, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(255, 107, 107, 1)'
                        },
                        {
                            label: whisky.name,
                            data: [
                                whiskyProfile.fruity,
                                whiskyProfile.smoky,
                                whiskyProfile.body,
                                whiskyProfile.spicy,
                                whiskyProfile.sweetness,
                                whiskyProfile.complexity
                            ],
                            backgroundColor: 'rgba(78, 205, 196, 0.2)',
                            borderColor: 'rgba(78, 205, 196, 1)',
                            pointBackgroundColor: 'rgba(78, 205, 196, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(78, 205, 196, 1)'
                        }
                    ]
                },
                options: {
                    elements: {
                        line: {
                            borderWidth: 2
                        }
                    },
                    scales: {
                        r: {
                            angleLines: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.2)'
                            },
                            pointLabels: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 12
                                }
                            },
                            ticks: {
                                color: 'rgba(0, 0, 0, 0)',
                                backdropColor: 'rgba(0, 0, 0, 0)',
                                // チャート内の数字を削除
                                display: false,
                                // ブロックの表示を削除
                                showLabelBackdrop: false
                            },
                            suggestedMin: 0,
                            suggestedMax: 5,
                            beginAtZero: true
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: 'rgba(255, 255, 255, 0.7)',
                                font: {
                                    size: 12
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // 蒸留所マップの更新
        function updateDistilleryMap(whisky) {
            if (!whisky || !distilleryMap) return;
            
            // 蒸留所名の抽出（可能なフィールドから）
            let distilleryName = null;
            if (whisky.distillery) {
                distilleryName = whisky.distillery;
            } else if (whisky.name.includes(' ')) {
                distilleryName = whisky.name.split(' ')[0]; // 最初の単語を試す
            }
            
            // マーカーの更新
            updateDistilleryMarkers(distilleryName);
            
            // 蒸留所が見つかった場合、マップを中心に
            const distillery = distilleryDatabase[distilleryName];
            if (distillery && distillery.location) {
                distilleryMap.setView([distillery.location.lat, distillery.location.lng], 8);
            } else {
                // 蒸留所が見つからない場合、リージョンに基づいた場所にマップの中心を設定
                const regionCoords = getRegionCoordinates(whisky.region);
                distilleryMap.setView([regionCoords.lat, regionCoords.lng], regionCoords.zoom);
            }
            
            // 蒸留所セクションの表示
            const distillerySection = document.getElementById('distillerySection');
            if (distillerySection) {
                distillerySection.classList.add('active');
            }
        }
        
        // 地域の代表座標を取得
        function getRegionCoordinates(region) {
            const defaultCoords = { lat: 55.0, lng: -3.0, zoom: 5 }; // スコットランド
            
            const regionMap = {
                'Scotland': { lat: 57.0, lng: -4.0, zoom: 6 },
                'Islay': { lat: 55.75, lng: -6.15, zoom: 10 },
                'Speyside': { lat: 57.5, lng: -3.2, zoom: 9 },
                'Highland': { lat: 57.9, lng: -4.5, zoom: 7 },
                'Japan': { lat: 35.7, lng: 139.7, zoom: 5 },
                'Ireland': { lat: 53.4, lng: -8.0, zoom: 6 },
                'USA': { lat: 37.8, lng: -85.0, zoom: 5 }
            };
            
            if (!region) return defaultCoords;
            
            // 正確な地域名または地域を含む文字列にマッチ
            for (const [key, coords] of Object.entries(regionMap)) {
                if (region.includes(key)) {
                    return coords;
                }
            }
            
            return defaultCoords;
        }
        
        // デフォルトの蒸留所データ（緊急用）
        function getDefaultDistilleryData() {
            return {
                "Macallan": {
                    "name": "マッカラン蒸溜所 (The Macallan Distillery)",
                    "location": {
                        "lat": 57.4845,
                        "lng": -3.2082
                    },
                    "region": "Scotland, Speyside",
                    "founded": 1824,
                    "status": "active",
                    "description": "スペイサイド地方のクレイゲラキー村近くに位置し、シェリー樽熟成の最高峰として世界的な評価を得ています。2018年に新しい最先端の蒸留所施設を開設。独自の小型スチルと厳格な樽選定ポリシーにより、豊かな果実味と複雑さを持つウイスキーを生産しています。"
                },
                "Port Ellen": {
                    "name": "ポートエレン蒸溜所 (Port Ellen Distillery)",
                    "location": {
                        "lat": 55.6306,
                        "lng": -6.1929
                    },
                    "region": "Scotland, Islay",
                    "founded": 1825,
                    "status": "closed",
                    "description": "1983年に閉鎖されたアイラ島の伝説的な蒸溜所。強い泥炭と海風の特徴を持つウイスキーを生産していました。閉鎖後のボトルは高額で取引される希少品となっています。Diageo社が2020年代に再建を発表し、ファンから注目されています。"
                },
                "Talisker": {
                    "name": "タリスカー蒸溜所 (Talisker Distillery)",
                    "location": {
                        "lat": 57.3027,
                        "lng": -6.3562
                    },
                    "region": "Scotland, Isle of Skye",
                    "founded": 1830,
                    "status": "active",
                    "description": "スコットランドのスカイ島で最も古い蒸溜所。海辺の岩場に囲まれた環境で、潮気と胡椒のスパイシーさが特徴的なウイスキーを生産。独特の製法と5つの蒸留器で複雑な風味を作り出しています。"
                },
                "Karuizawa": {
                    "name": "軽井沢蒸溜所 (Karuizawa Distillery)",
                    "location": {
                        "lat": 36.3481,
                        "lng": 138.5966
                    },
                    "region": "Japan, Nagano",
                    "founded": 1955,
                    "status": "closed",
                    "description": "2001年に閉鎖された日本の伝説的な蒸溜所。標高の高い環境で、主にシェリー樽を使用して熟成させた濃厚で複雑なウイスキーを生産。閉鎖後、残存ボトルは世界的なコレクターアイテムとなっています。"
                }
            };
        }
        
        // デフォルトのウィスキーデータ（緊急用）
        function getDefaultWhiskyData() {
            return [
                {
                    "id": 1,
                    "name": "タリスカー44年オフィシャルボトル",
                    "price": 80400,
                    "region": "Scotland (Isle of Skye)",
                    "category": "Single Malt Scotch Whisky",
                    "description": "Limited to 1,997 bottles, this is the oldest official bottling of Talisker. Distilled in 1978, it was bottled in 2021 at the age of 44 years with an outturn of 1,997 bottles.",
                    "description_jp": "1,997本限定の、タリスカーの公式ボトリングとしては最も古いエディション。1978年に蒸留され、44年熟成後の2021年にボトリングされました。",
                    "profile": {
                        "fruity": 3,
                        "smoky": 4,
                        "body": 5,
                        "spicy": 4,
                        "sweetness": 3,
                        "complexity": 5
                    },
                    "distillery": "Talisker"
                },
                {
                    "id": 2,
                    "name": "ポートエレン25年 one of only bottles",
                    "price": 20400,
                    "region": "Scotland, Islay",
                    "category": "Single Malt Scotch Whisky",
                    "description": "A very rare Islay whisky from the closed Port Ellen distillery, bottled by independent bottler 'One of Only' at 25 years of age. Shows powerful maritime character and complex peat smoke.",
                    "description_jp": "閉鎖されたポートエレン蒸溜所による希少なアイラウイスキー。インディペンデントボトラー「One of Only」による25年熟成ボトル。強い海洋性の特徴と複雑な泥炭の煙が特徴。",
                    "profile": {
                        "fruity": 2,
                        "smoky": 5,
                        "body": 4,
                        "spicy": 3,
                        "sweetness": 2,
                        "complexity": 5
                    },
                    "distillery": "Port Ellen"
                },
                {
                    "id": 3,
                    "name": "マッカラン1990年SAMAROLI",
                    "price": 12200,
                    "region": "Scotland",
                    "category": "Single Malt Scotch Whisky - Speyside",
                    "description": "Bottled by the legendary independent bottler Samaroli, this 1990 Macallan shows rich sherry influences with notes of dried fruits, orange peel, and Christmas cake, complemented by complex oak spices that harmonize with honey, toffee, and dark chocolate.",
                    "description_jp": "有名な独立系ボトラー、サマローリによってボトリングされた希少なマッカラン1990年。豊かなシェリーの影響があり、ドライフルーツ、オレンジピール、クリスマスケーキの風味が特徴。複雑な樽のスパイスが蜂蜜、トフィー、ダークチョコレートと調和しています。",
                    "profile": {
                        "fruity": 4,
                        "smoky": 1,
                        "body": 4,
                        "spicy": 3,
                        "sweetness": 4,
                        "complexity": 5
                    },
                    "distillery": "Macallan"
                },
                {
                    "id": 4,
                    "name": "ボウモア26年ダンカンテイラー",
                    "price": 15000,
                    "region": "Scotland, Islay",
                    "category": "Single Malt Scotch Whisky",
                    "description": "A beautifully matured expression from Bowmore distillery, bottled by Duncan Taylor. Shows the perfect balance between Islay's smokiness and the fruit development from extended maturation.",
                    "description_jp": "ボウモア蒸溜所の美しく熟成された表現で、ダンカンテイラー社によってボトリング。アイラ島のスモーキーさと長期熟成による果実味の発達のバランスが絶妙。",
                    "profile": {
                        "fruity": 3,
                        "smoky": 4,
                        "body": 4,
                        "spicy": 3,
                        "sweetness": 3,
                        "complexity": 5
                    },
                    "distillery": "Bowmore"
                },
                {
                    "id": 5,
                    "name": "軽井沢25年",
                    "price": 25000,
                    "region": "Japan",
                    "category": "Japanese Whisky",
                    "description": "A rare gem from the closed Karuizawa distillery, this 25-year-old expression showcases the intricate balance of Japanese precision with rich fruity character. Deep complexity and long-lasting finish.",
                    "description_jp": "閉鎖された軽井沢蒸溜所からの希少な逸品。25年熟成されたこの表現は、日本の繊細さと果実の豊かさのバランスが見事。深い複雑さと長く続く余韻が特徴。",
                    "profile": {
                        "fruity": 4,
                        "smoky": 2,
                        "body": 4,
                        "spicy": 3,
                        "sweetness": 3,
                        "complexity": 5
                    },
                    "distillery": "Karuizawa"
                },
                {
                    "id": 6,
                    "name": "キルホーマン2013-2021信濃屋",
                    "price": 2000,
                    "region": "Scotland, Islay",
                    "category": "Single Malt Scotch Whisky",
                    "description": "A young but characterful Islay whisky from Kilchoman, bottled exclusively for Shinanoya in Japan. Shows strong peat smoke combined with fresh citrus and maritime saltiness.",
                    "description_jp": "若いながらも個性的なキルホーマンのアイラウイスキー。日本の信濃屋向けの限定ボトル。強いピート香に新鮮な柑橘類と海の塩気が組み合わさっています。",
                    "profile": {
                        "fruity": 2,
                        "smoky": 5,
                        "body": 3,
                        "spicy": 2,
                        "sweetness": 2,
                        "complexity": 4
                    },
                    "distillery": "Kilchoman"
                }
            ];
        }
    </script>


    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDk2CYipYg1kZdCc9NIuFgIr1gHtLAABHPPEDrfWVWFviZPFyM1RvqUQcnuPQsRwqJ%2FNe%2F1b6uamb8oTq7lxs8mnoCJs2PeqIm9dho4gDSFspUa8jvfICEI4HVtzOdGPCXM7egsEPxETDGXbCqwfwKi1inyTmH1FUv1H4HjUjErg9mF3HrXSZbCbf4eMyCipsxvxv5kY4uIIc6U0Anf7tzbnFjPU6z41az46REP724x5TRjAY62V%2FmyBQl4RNYxd3imhc%2FkCyPlu9UUIu4zK%2BymNOo0umJBtMn7eAHYfQs4hyQ8gdNmeSUAWwgOFUP0ekVfLp4Tsoyth86v%2FTzdSF5TGlWlqez%2Fod9XovMwuqTBVFO2asihjz0yZvYZFAWTdk359L5ILyKvPe0QrInWlJT432AU4RAp%2BQyUW0VGtVZJKSFWDkFG%2FoB1ORuwoooPSl5FnDQVNgDL5PppGmlgh5zGQ%2Fpxergr3lDcAC5BuONsoS%2F0d9kBCjKVzzl6y9Ju8tng%3D%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDk2CYipYg1kZdCc9NIuFgIr1gHtLAABHPPEDrfWVWFviZPFyM1RvqUQcnuPQsRwqJ/Ne/1b6uamb8oTq7lxs8mnoCJs2PeqIm9dho4gDSFspUa8jvfICEI4HVtzOdGPCXM7egsEPxETDGXbCqwfwKi1inyTmH1FUv1H4HjUjErg9mF3HrXSZbCbf4eMyCipsxvxv5kY4uIIc6U0Anf7tzbnFjPU6z41az46REP724x5TRjAY62V/myBQl4RNYxd3imhc/kCyPlu9UUIu4zK+ymNOo0umJBtMn7eAHYfQs4hyQ8gdNmeSUAWwgOFUP0ekVfLp4Tsoyth86v/TzdSF5TGlWlqez/od9XovMwuqTBVFO2asihjz0yZvYZFAWTdk359L5ILyKvPe0QrInWlJT432AU4RAp+QyUW0VGtVZJKSFWDkFG/oB1ORuwoooPSl5FnDQVNgDL5PppGmlgh5zGQ/pxergr3lDcAC5BuONsoS/0d9kBCjKVzzl6y9Ju8tng==";
    </script>
    
    <script id="html_notice_dialog_script" src="./index_files/notice_dialog.js.ダウンロード"></script>
    </body></html>