<!DOCTYPE html>
<!-- saved from url=(0130)https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse_LBd2w0vdTtOf_OswSt8juA/whisky_sommelier_final.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- HTMLのheadタグ内にGoogle Fontsのリンクを追加 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>昼の月。AIソムリエ</title>
    <link href="./index_files/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="./index_files/all.min.css">
    <script src="./index_files/chart.js.ダウンロード"></script>
    <!-- Leaflet.js地図ライブラリ -->
    <link rel="stylesheet" href="./index_files/leaflet.css" crossorigin="">
    <script src="./index_files/leaflet.js.ダウンロード" crossorigin=""></script>
    <style>
        body {
            background-color: #000;
            color: #fff;
            font-family: 'Noto Sans JP', sans-serif;
        }
        .header-container {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 15px 0;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .logo {
            width: 90px;
            height: 90px;
            object-fit: contain;
            border-radius: 8px;
            background: rgba(78, 205, 197, 0);
            border: 2px solid #4ecdc500;
            padding: 5px;
        }
        
        /* タイトルのスタイルを変更 */
        .header-title {
            color: #fff;
            font-size: 28px;
            font-weight: bold;
            text-align: center;
            margin: 0;
            text-shadow: 0 0 10px rgba(78, 205, 196, 0.7);
            letter-spacing: 2px;
            background: linear-gradient(45deg, #ffffff, #4ecdc4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
        }

        .header-title:after {
            content: "";
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 70%;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.7), transparent);
        }

        @keyframes glow {
            from {
                text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
            }
            to {
                text-shadow: 0 0 15px rgba(78, 205, 196, 0.8), 0 0 20px rgba(255, 107, 107, 0.5);
            }
        }

        /* 翻訳ボタンのスタイル */
        .translate-link {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 5px 10px;
            margin-left: 10px;
            transition: all 0.3s ease;
        }

        .translate-link:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-2px);
        }

        .translate-icon {
            margin-right: 6px;
        }

        /* 言語リンクのスタイル */
        .language-links {
            display: flex;
            margin-left: 15px;
        }

        .language-links .nav-link {
            margin-left: 10px;
            font-size: 14px;
            padding: 5px 8px;
        }

        /* レスポンシブ対応 - 画面が狭い場合 */
        @media (max-width: 768px) {
            .nav-links {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .language-links {
                margin-top: 10px;
                width: 100%;
                justify-content: center;
            }
        }

        .container-custom {
            max-width: 1200px;
            margin: 0 auto;
            padding: 100px 20px 20px;
        }
        .taste-matrix {
            width: 300px;
            height: 300px;
            border: 2px solid #fff;
            position: relative;
            background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%), 
                        linear-gradient(to top, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%);
        }
        .taste-dot {
            width: 24px;
            height: 24px;
            background-color: #ff6b6b;
            border-radius: 50%;
            position: absolute;
            transform: translate(-50%, -50%);
            cursor: pointer;
            box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
        }
        .dual-matrix-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 20px;
        }
        .matrix-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .matrix-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        .btn-primary {
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        .btn-secondary {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        .card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 24px;
            backdrop-filter: blur(10px);
        }

        /* 見出しの余白を調整するカスタムスタイル */
        .card h2 {
            padding-top: 0px;      /* 上部の余白を追加 */
            padding-bottom: 15px;   /* 下部の余白を追加 */
            line-height: 0.8;       /* 行の高さを調整 */
            margin-bottom: 20px;    /* 下のマージンを設定（mb-4を上書き） */
        }

        /* split-layoutの調整 - パネル間の間隔を広げる */
        .split-layout {
            gap: 400px;               /* パネル間の間隔をより広く */
        }

        .whisky-card {
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }
        .whisky-card:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: #4ecdc4;
            transform: translateY(-2px);
        }
        .whisky-card.selected {
            background: rgba(78, 205, 196, 0.15);
            border-color: #4ecdc4;
            box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
        }
        .whisky-card.featured {
            background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.10));
            border: 2px solid #FFA500;
            box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
            animation: pulse-orange 2s infinite;
        }
        @keyframes pulse-orange {
            0% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
            50% { box-shadow: 0 0 30px rgba(255, 165, 0, 0.6); }
            100% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
        }
        .featured-label {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(45deg, #FFA500, #FFD700);
            color: #000;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
        }
        .loading {
            display: none;
            text-align: center;
            color: #4ecdc4;
        }
        .progress-container {
            display: none;
            margin-top: 20px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 10px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
            width: 0%;
            transition: width 0.3s ease;
        }
        .progress-text {
            color: #4ecdc4;
            font-size: 14px;
            margin-bottom: 5px;
        }
        .progress-percentage {
            color: #fff;
            font-size: 16px;
            font-weight: bold;
        }
        .error {
            color: #ff6b6b;
            background: rgba(255, 107, 107, 0.1);
            border: 1px solid rgba(255, 107, 107, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        .success {
            color: #4ecdc4;
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
        }
        .price-slider {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
            margin: 10px 0;
        }
        .price-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
        }
        .price-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #4ecdc4;
            cursor: pointer;
            border: none;
        }
        .voice-input-btn {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .voice-input-btn:hover {
            background: rgba(78, 205, 196, 0.3);
        }
        .voice-input-btn.recording {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
        }
        
       /* split-layoutの修正 - 余白を増やす */
        .split-layout {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 均等に分割 */
            gap: 30px; /* 間隔を広げる（元は20px） */
            align-items: start;
            margin-bottom: 30px; /* 下部に余白を追加 */
        }
        
        /* レコメンデーションパネルの修正 */
        .recommendations-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            backdrop-filter: blur(10px);
            max-height: 85vh; /* 少し高さを増やす */
            overflow-y: auto;
            margin-bottom: 30px; /* 下部の余白を追加 */
        }
        
        /* チャートパネルの修正 - 重要な修正部分 */
        .chart-panel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 30px 20px; /* 上下のパディングを増やす */
            backdrop-filter: blur(10px);
            position: sticky;
            top: 130px; /* 少し下げる */
            max-height: 85vh; /* 少し高さを増やす */
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(78, 205, 196, 0.5) rgba(255, 255, 255, 0.1);
            margin-bottom: 20px; /* 下部の余白を追加 */
        }
        
        .chart-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .chart-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .chart-panel::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 4px;
        }
        
        /* チャートコンテナの修正 */
        .chart-container {
            height: 380px; /* 高さを増やす（元は350px） */
            width: 100%;
            position: relative;
            margin-bottom: 30px; /* 下部の余白を追加 */
        }
        /* チャートコンテナの見出し修正 */
        .chart-container h3 {
            text-align: center;
            margin-bottom: 25px; /* 余白を増やす */
            color: #4ecdc4;
            font-size: 16px;
            padding-top: 10px; /* 上部の余白を追加 */
        }
        /* チャートキャンバスの修正 */
        .chart-canvas {
            height: 350px !important;
            width: 100% !important;
            margin-top: 15px; /* 上部の余白を追加 */
        }

        #combinedProfileChart {
            height: 350px !important; /* 高さを増やす（元は320px） */
            width: 100% !important;
            margin-top: 20px; /* 上部の余白を追加 */
            margin-bottom: 20px; /* 下部の余白を追加 */
        }
        .recommendation-summary {
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 20px;
            color: #4ecdc4;
        }
        
        .custom-footer {
            display: none;
            text-align: center;
            padding: 20px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
            margin-top: 40px;
        }
        
        .whisky-overview {
            background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
            border: 2px solid rgba(78, 205, 196, 0.3);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        
        .whisky-overview::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .whisky-overview h2 {
            font-size: 2.5rem;
            font-weight: bold;
            background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }
        
        .whisky-overview .subtitle {
            font-size: 1.2rem;
            color: #4ecdc4;
            margin-bottom: 15px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }
        
        .whisky-overview .description {
            font-size: 1.1rem;
            line-height: 1.6;
            color: rgba(255, 255, 255, 0.9);
            position: relative;
            z-index: 1;
        }
        
        .whisky-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 25px;
            margin-bottom: 24px;  /* 下マージンを増やす（数値は調整可能） */
            position: relative;
            z-index: 1;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #ff6b6b;
            display: block;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.7);
            margin-top: 5px;
        }
        
        .taste-icon {
            width: 24px;
            height: 24px;
            margin-right: 8px;
            fill: #4ecdc4;
        }

        .chat-section {
            margin-top: 30px;
        }

        .chat-examples {
            display: grid;
            grid-template-columns: 1fr 1fr;  /* 2列に設定 */
            grid-template-rows: auto auto;   /* 2行に設定 */
            gap: 10px;
            background: rgba(78, 205, 196, 0.05);
            border: 1px solid rgba(78, 205, 196, 0.2);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        /* 質問例タイトルを全幅に */
        .chat-examples .mb-3 {
            grid-column: 1 / -1;  /* 1列目から最後の列まで広げる */
        }

        .question-example {
            /* レイアウト */
            display: flex;
            align-items: center;
            justify-content: center;  /* 横方向も中央揃え */
            height: 100%;
            margin-bottom: 0;
            padding: 8px 12px;
            
            /* スタイル */
            background: rgba(78, 205, 196, 0.1);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 6px;
            color: #4ecdc4;
            
            /* インタラクション */
            cursor: pointer;
            transition: all 0.3s ease;
        }

        /* ホバー効果は維持 */
        .question-example:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-1px);
        }

        .question-example:hover {
            background: rgba(78, 205, 196, 0.2);
            transform: translateY(-1px);
        }

        .chat-input-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            padding: 12px;
            color: #fff;
            font-size: 14px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4ecdc4;
            box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
        }

        .chat-history {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
            margin-bottom: 15px;
            display: none;
        }

        .chat-message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            word-wrap: break-word;
            white-space: pre-wrap;
            line-height: 1.6;
            font-size: 14px;
        }

        /* AIメッセージのスタイル修正 */
        .ai-message {
            text-align: left;  /* 左寄せに設定 */
            background: rgba(78, 205, 196, 0.15);
            border-left: 3px solid #4ecdc4;
            color: #fff;
        }

        /* 必要に応じて通常のチャットメッセージも左寄せに */
        .chat-message {
            text-align: left;  /* 左寄せに設定 */
            /* その他の既存スタイル */
        }

        .user-message {
            background: rgba(255, 107, 107, 0.15);
            border-left: 3px solid #ff6b6b;
            color: #fff;
        }

        .chat-history::-webkit-scrollbar {
            width: 6px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 3px;
        }
        
       /* レスポンシブ対応の修正 */
        @media (max-width: 1024px) {
            .split-layout {
                grid-template-columns: 1fr;
                gap: 30px; /* 間隔を広げる */
            }
            
            .chart-panel {
                position: static;
                margin-top: 30px; /* 上部の余白を追加 */
                padding: 30px; /* パディングを均等に */
            }
            
            .whisky-overview h2 {
                font-size: 2rem;
            }
            
            .whisky-stats {
                flex-direction: column;
                gap: 15px;
            }
            
            .dual-matrix-container {
                grid-template-columns: 1fr;
                gap: 30px;
            }
        }
        
        @media (max-width: 768px) {
            .custom-footer {
                display: block;
            }
            
            .whisky-overview h2 {
                font-size: 1.8rem;
            }
            
            .whisky-overview .subtitle {
                font-size: 1rem;
            }
            
            .whisky-overview .description {
                font-size: 1rem;
            }
        }
        
        .recommendations-panel::-webkit-scrollbar {
            width: 8px;
        }
        
        .recommendations-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        .recommendations-panel::-webkit-scrollbar-thumb {
            background: rgba(78, 205, 196, 0.5);
            border-radius: 4px;
        }
        
        .recommendations-panel::-webkit-scrollbar-thumb:hover {
            background: rgba(78, 205, 196, 0.7);
        }

        /* 蒸留所マップと情報パネル */
        .distillery-section {
            margin-top: 20px;
            opacity: 0;
            height: 0;
            overflow: hidden;
            transition: opacity 0.8s ease, height 0.8s ease;
        }

        .distillery-section.active {
            opacity: 1;
            height: auto;
        }

        .distillery-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .map-container {
            height: 300px;
            border-radius: 12px;
            overflow: hidden;
            border: 2px solid rgba(78, 205, 196, 0.3);
            background-color: #1a1a1a;
        }

        #distilleryMap {
            height: 100%;
            width: 100%;
            background-color: #242424;
        }

        .distillery-info {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(78, 205, 196, 0.3);
            border-radius: 12px;
            padding: 16px;
            color: #fff;
        }

        .distillery-info h3 {
            color: #4ecdc4;
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(78, 205, 196, 0.3);
            padding-bottom: 8px;
        }

        .distillery-info-grid {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 8px 16px;
            margin-top: 15px;
        }

        .info-label {
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        .info-value {
            color: rgba(255, 255, 255, 0.9);
        }

        /* distilleryDescriptionを左寄せにするCSS修正 */
        .distillery-description {
            margin-top: 15px;
            line-height: 1.6;
            text-align: left; /* 左寄せを明示的に指定 */
        }
        .status-active {
            color: #4ecdc4;
            font-weight: bold;
        }

        .status-closed {
            color: #ff6b6b;
            font-weight: bold;
        }

        .status-unknown {
            color: #ffb347;
            font-weight: bold;
        }

        /* Leafletマップスタイルのカスタマイズ */
        .leaflet-container {
            background-color: #242424 !important;
        }
        .leaflet-tile-pane {
            opacity: 0.9;
        }
        .leaflet-popup-content-wrapper {
            background-color: rgba(40, 44, 52, 0.95) !important;
            color: #fff !important;
            border: 1px solid rgba(78, 205, 196, 0.5);
        }
        .leaflet-popup-tip {
            background-color: rgba(40, 44, 52, 0.95) !important;
        }
        .leaflet-control-zoom a {
            background-color: rgba(40, 44, 52, 0.8) !important;
            color: #fff !important;
            border-color: rgba(78, 205, 196, 0.3) !important;
        }
        .leaflet-control-zoom a:hover {
            background-color: rgba(78, 205, 196, 0.3) !important;
        }
        
        /* 音声入力ボタンのスタイル */
        .voice-input-btn {
            background: rgba(78, 205, 196, 0.2);
            border: 1px solid #4ecdc4;
            color: #4ecdc4;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18px;
        }

        .voice-input-btn:hover {
            background: rgba(78, 205, 196, 0.3);
            transform: translateY(-2px);
        }

        .voice-input-btn.recording {
            background: rgba(255, 107, 107, 0.3);
            border-color: #ff6b6b;
            color: #ff6b6b;
            animation: pulse-recording 1.5s infinite;
        }

        @keyframes pulse-recording {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .error-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            animation: slide-in 0.5s ease-out;
        }

        .notification-content {
            background-color: rgba(255, 107, 107, 0.9);
            color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
        }

        .notification-icon {
            font-size: 24px;
            margin-right: 15px;
        }

        .notification-message {
            flex-grow: 1;
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
        }

        @keyframes slide-in {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ヘッダーナビゲーションのスタイル修正 - 右端に配置 */
        .nav-links {
            position: absolute;
            right: 20px;
            display: flex;
            gap: 15px;
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.2s ease;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.05);
        }
        
        .nav-link:hover {
            color: #fff;
            background: rgba(78, 205, 196, 0.2);
        }
        
        .nav-link.active {
            color: #fff;
            background: rgba(78, 205, 196, 0.3);
            border-bottom: 2px solid #4ecdc4;
        }

        /* AI提案メッセージの修正 */
        .ai-recommendation-message {
            background: rgba(78, 205, 196, 0.15);
            border-left: 3px solid #4ecdc4;
            color: #fff;
            padding: 20px; /* パディングを増やす */
            border-radius: 8px;
            margin-bottom: 25px; /* 下部の余白を増やす */
            line-height: 1.8; /* 行間を広げる */
        }

        @keyframes thinking {
            0% { content: "考えています"; }
            25% { content: "考えています."; }
            50% { content: "考えています.."; }
            75% { content: "考えています..."; }
            100% { content: "考えています...."; }
        }

        .thinking-animation {
            position: relative;
        }

        .thinking-animation::after {
            content: "考えています";
            animation: thinking 1.5s infinite;
        }

    </style>
<style>
    .genspark-notice-dialog {
      display: flex;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      align-items: center;
      justify-content: center;
    }

    .genspark-notice-content {
      background-color: white;
      border-radius: 8px;
      max-width: 600px;
      width: 90%;
      box-sizing: border-box;
      padding: 10px 30px 30px 30px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-size: 16px;
    }

    .genspark-notice-title {
      color: #000;
      font-family: Arial;
      font-size: 20px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 
    }

    .genspark-notice-list {
      margin: 24px 0;
      
      color: #606366;
      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: 150%;
      padding-left: 12px;
    }

    .genspark-notice-list li {
      margin-bottom: 12px;
      list-style-type: disc;
    }

    .genspark-notice-list li a {
      color: #606366;
      text-decoration: underline;
    }

    .genspark-notice-checkbox {
      display: flex;
      align-items: center;
      margin-top: 20px;
      gap: 10px;

      color: #232425;

      font-family: Arial;
      font-size: 14px;
      font-style: normal;
      font-weight: 400;
      line-height: normal;
    }

    .genspark-notice-actions {
      display: flex;
      justify-content: center;
      margin-top: 20px;
    }
      
    .genspark-notice-ok {
      color: #232425;

      text-align: center;
      font-family: Arial;
      font-size: 16px;
      font-style: normal;
      font-weight: 700;
      line-height: 150%; 

      cursor: pointer;
      display: flex;
      height: 40px;
      padding: 6px 14px;
      justify-content: center;
      align-items: center;
      gap: 10px;
      align-self: stretch;
      border-radius: 8px;
      border: 1px solid #000;
      box-sizing: border-box;
      width: 100%;
    }
    /* 蒸溜所マーカーのツールチップ */
.distillery-tooltip {
    background-color: rgba(40, 44, 52, 0.95);
    color: #fff;
    border: 1px solid rgba(78, 205, 196, 0.5);
    border-radius: 4px;
    padding: 5px 8px;
    font-size: 12px;
    font-weight: bold;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}

    
  </style></head>
        <body>
        <div class="header-container">
            <a href="https://www.hirunotsuki.com/" target="_blank" style="position: absolute; left: 20px; width: 90px; height: 90px; display: block;">
    <img class="logo" src="./NH_bar_logo_fin_white.png" alt="昼の月バーロゴ">
</a>
            <h1 class="header-title">昼の月。AIソムリエ</h1>
            <div class="nav-links">
                <a href="whisky_list.html" class="nav-link" id="listLink">メニューリスト一覧</a>
                
                <!-- 1つの翻訳ボタンに統合 -->
                <a href="#" onclick="openGoogleTranslate(); return false;" class="nav-link translate-link">
                    <span class="translate-icon">🌐</span> 翻訳
                </a>
            </div>
        </div>
    
    <div class="container-custom">
        <div class="whisky-overview">
            <h2>🍷 プレミアムウィスキーコレクション</h2>
            <div class="subtitle">本日は厳選された<span id="whiskyCount">0</span>本のウィスキーから</div>
            <div class="description">
                <strong>あなたの味覚に完璧にマッチする</strong>最高の一本を<br>
                AI技術で分析・提案いたします
            </div>
            <div class="whisky-stats">
            <div class="stat-item">
                <span class="stat-number" id="totalWhiskies">0</span>
                <div class="stat-label">厳選銘柄</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="uniqueRegions">0</span>
                <div class="stat-label">産地</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="distilleryCount">0</span>
                <div class="stat-label">蒸溜所の数</div>
            </div>
            <div class="stat-item">
                <span class="stat-number" id="aiTechnology">AI</span>
                <div class="stat-label">分析技術</div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="text-2xl font-bold mb-4">
                💎 価格帯設定
            </h2>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="block mb-2">下限価格: <span id="minPriceDisplay">¥5,000</span></label>
                    <input type="range" id="minPrice" class="price-slider" min="1" max="80" value="5" step="1">
                </div>
                <div>
                    <label class="block mb-2">上限価格: <span id="maxPriceDisplay">¥50,000</span></label>
                    <input type="range" id="maxPrice" class="price-slider" min="1" max="80" value="50" step="1">
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
                🌟 味覚プロファイル設定
            </h2>
            <p class="mb-6">2つの四角内をクリックして、それぞれの好みの位置を選択してください</p>
            
            <div class="dual-matrix-container">
                <div class="matrix-wrapper">
                    <div class="matrix-title">基本的な味の傾向</div>
                    <div class="relative">
                        <div class="taste-matrix" id="tasteMatrix1">
                            <div class="taste-dot" id="tasteDot1" style="left: 50%; top: 50%;"></div>
                        </div>
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">フルーティー</div>
                        <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">スモーキー</div>
                        <div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">ライト</div>
                        <div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ヘビー</div>
                    </div>
                    <div class="text-center mt-4">
                        <span id="coordinates1" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
                    </div>
                </div>
                
                <div class="matrix-wrapper">
                    <div class="matrix-title">複雑さの好み</div>
                    <div class="relative">
                        <div class="taste-matrix" id="tasteMatrix2">
                            <div class="taste-dot" id="tasteDot2" style="left: 50%; top: 50%;"></div>
                        </div>
                        <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">まろやか</div>
                        <div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">強烈</div>
                        <div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">若い</div>
                        <div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">熟成</div>
                    </div>
                    <div class="text-center mt-4">
                        <span id="coordinates2" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card chat-section">
            <h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
                🗨️ AIソムリエとチャット
            </h2>
            
            <div class="chat-examples">
                <div class="mb-3 text-sm text-gray-300">質問例（クリックで入力）：</div>
                <div class="question-example" data-question="タリスカー44年（最高額80,400円）について詳しく教えて">💎 タリスカー44年（最高額80,400円）について詳しく教えて</div>
                <div class="question-example" data-question="3000円以下でスモーキーなアイラ島のウィスキーはある？">🌊 3000円以下でスモーキーなアイラ島のウィスキーはある？</div>
                <div class="question-example" data-question="日本の軽井沢や長濱などフルーティーなウィスキーを比較して">🍯 日本の軽井沢や長濱などフルーティーなウィスキーを比較して</div>
                <div class="question-example" data-question="5000円前後で複雑な味わいのウィスキーのおすすめは？">⭐ 5000円前後で複雑な味わいのウィスキーのおすすめは？</div>
            </div>

            <div class="chat-input-container">
                <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力してください...">
                <button id="voiceInputBtn" class="voice-input-btn">
                    🎙️
                </button>
                <button id="sendChatBtn" class="btn-primary">💬 質問する</button>
            </div>

            <div id="chatHistory" class="chat-history" style="display: none;"></div>
        </div>
        
        <div class="text-center mb-8">
            <button id="getRecommendation" class="btn-primary text-lg mr-4">🎯 AIウィスキー提案を受ける</button>
            <button id="refreshRecommendation" class="btn-secondary text-lg">
                🔄 リフレッシュして再提案
            </button>
        </div>
        
        <div id="loadingIndicator" class="loading" style="display: none;">
            <div class="animate-spin text-4xl mb-4">🍷</div>
            <p class="mt-2">AIが最適なウィスキーを分析中...</p>
        </div>
        
        <div id="progressContainer" class="progress-container" style="display: none;">
            <div id="progressText" class="progress-text">結果を生成中...</div>
            <div class="progress-bar">
                <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
            </div>
            <div id="progressPercentage" class="progress-percentage">0%</div>
        </div>
        
        <div id="splitLayoutContainer" class="split-layout" style="display: none;">
            <div id="recommendationsPanel" class="recommendations-panel">
                <h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
                    🌙 AI提案結果
                </h2>
                <div id="preferencesSummary" class="recommendation-summary" style="display: block;">
                    <h3 class="text-lg font-bold mb-3">🎯 あなたの好みの傾向</h3>
                    <div class="space-y-2 text-sm">
                        <div><strong>基本的な味の傾向:</strong> <span id="tasteDescription">バランスの取れた</span></div>
                        <div><strong>複雑さの好み:</strong> <span id="complexityDescription">バランスの良い複雑さを好む</span></div>
                        <div><strong>価格帯:</strong> <span id="priceRange">¥5,000 - ¥50,000</span></div>
                
                        <div class="mt-3 pt-2 border-t border-gray-600">
                            AIが総合的にプロファイルに基づいて、最適な3銘柄を厳選しました。
                        </div>
                    </div>
                </div>
                <div id="recommendationContent"></div>
                <div class="text-center mt-6">
                    <button id="getAnotherRecommendation" class="btn-secondary">
                        🔄 別の提案を受ける
                    </button>
                </div>
            </div>
            
            <div id="chartPanel" class="chart-panel">
                <h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
                    🕸️ 味覚プロファイル比較
                </h2>
                <div class="chart-container">
                    <h3 id="chartTitle">あなたの好み</h3>
                    <canvas id="combinedProfileChart" class="chart-canvas"></canvas>
                </div>
                
                <!-- 蒸留所マップと情報セクション -->
                <div id="distillerySection" class="distillery-section">
                    <h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
                        🗾 蒸溜所情報
                    </h2>
                    <div class="distillery-container">
                        <div class="map-container">
                            <div id="distilleryMap"></div>
                        </div>
                        
                        <div class="distillery-info" id="distilleryInfo">
                            <h3 id="distilleryName">蒸留所名</h3>
                            <div class="distillery-info-grid" id="distilleryDetails">
                                <div class="info-label">所在地:</div>
                                <div class="info-value" id="distilleryRegion">-</div>
                                
                                <div class="info-label">創業年:</div>
                                <div class="info-value" id="distilleryFounded">-</div>
                                
                                <div class="info-label">現在の状況:</div>
                                <div class="info-value" id="distilleryStatus">-</div>
                            </div>
                            
                            <div class="distillery-description" id="distilleryDescription">
                                現在情報登録されていません。
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="custom-footer">
            Powered by Nebula Hirozon Technology
        </div>
    </div>
    
       <script>
        // グローバル変数
 // ウィスキーデータの設定（既存コードとの互換性のため残しておく）
    let whiskyData = [];
    
    // ユーザー好みの状態を保持する変数
    let x1 = 0.5, y1 = 0.5;  // 味覚マトリックス1の座標
    let x2 = 0.5, y2 = 0.5;  // 複雑さマトリックスの座標
    let savedUserPreferences = "";  // チャットから抽出された追加好み
    
    // 蒸溜所情報
    const distilleryDatabase = {
        "アードベッグ": {
            name: "アードベッグ蒸溜所 (Ardbeg Distillery)",
            location: "スコットランド, アイラ島",
            founded: "1815年",
            status: "稼働中",
            latitude: 55.6406,
            longitude: -6.1089,
            description: "アードベッグはアイラ島南部に位置する蒸溜所で、強い泥炭とスモーキーな特徴を持つウイスキーで知られています。その独特な風味はピート（泥炭）の使用量が多いことに起因します。"
        },
        "タリスカー": {
            name: "タリスカー蒸溜所 (Talisker Distillery)",
            location: "スコットランド, スカイ島",
            founded: "1830年",
            status: "稼働中",
            latitude: 57.302,
            longitude: -6.356,
            description: "スカイ島唯一の蒸溜所であるタリスカーは、海の近くに位置し、そのウイスキーは海の塩気と煙の特徴を併せ持ちます。波打ち際の蒸溜所から生まれる力強い風味は、多くの愛好家に支持されています。"
        },
        "マッカラン": {
            name: "マッカラン蒸溜所 (The Macallan Distillery)",
            location: "スコットランド, スペイサイド",
            founded: "1824年",
            status: "稼働中",
            latitude: 57.4843,
            longitude: -3.2079,
            description: "マッカランはシェリー樽熟成のシングルモルトウイスキーの代表格で、高品質なオーク樽の選定に定評があります。スペイサイド地方の蒸溜所の中でも特に高級ウイスキーのブランドとして世界的に知られています。"
        },
        "山崎": {
            name: "サントリー山崎蒸溜所",
            location: "日本, 大阪府",
            founded: "1923年",
            status: "稼働中",
            latitude: 34.8916,
            longitude: 135.6733,
            description: "日本最古のモルトウイスキー蒸溜所である山崎は、京都と大阪の境界にある自然豊かな地に位置しています。その水質の良さと四季の変化が、複雑で繊細な日本のウイスキーを生み出しています。"
        },
        "ポウモア": {
            name: "ポウモア蒸溜所 (Bowmore Distillery)",
            location: "スコットランド, アイラ島",
            founded: "1779年",
            status: "稼働中",
            latitude: 55.7561,
            longitude: -6.2897,
            description: "アイラ島で最も古い蒸溜所の一つであるポウモアは、バランスの取れたピート香と海の風味が特徴です。伝統的な製法を守りながらも、近代的な技術も取り入れた高品質なウイスキーを生産しています。"
        }
    };
    
    // 初期化関数
    document.addEventListener('DOMContentLoaded', function() {
        // デフォルトのウィスキーデータをロード
        whiskyData = getDefaultWhiskyData();
        
        // 推薦ボタンのイベントリスナー
        document.getElementById("getRecommendationBtn").addEventListener("click", getRecommendation);
        
        // 価格スライダーのイベントリスナー
        document.getElementById("minPrice").addEventListener("input", updateMinPriceDisplay);
        document.getElementById("maxPrice").addEventListener("input", updateMaxPriceDisplay);
        
        // チャット送信ボタンのイベントリスナー
        document.getElementById("sendChatBtn").addEventListener("click", sendChatMessage);
        
        // チャットインプットのキーボードイベント
        document.getElementById("chatInput").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                e.preventDefault();
                sendChatMessage();
            }
        });
        
        // 質問例のイベントリスナー
        document.querySelectorAll(".question-example").forEach(example => {
            example.addEventListener("click", function() {
                document.getElementById("chatInput").value = this.textContent;
                sendChatMessage();
            });
        });

         // チャット履歴表示を有効化
        const chatHistoryElement = document.getElementById("chatHistory");
        if (chatHistoryElement) {
            chatHistoryElement.style.display = "block";
        }

        // 質問例クリックイベントを設定
        document.querySelectorAll('.question-example').forEach(question => {
            question.addEventListener('click', function() {
                document.getElementById("chatInput").value = this.textContent.trim();
            });
        });

        // チャット送信ボタンのイベントリスナー
        const sendButton = document.getElementById("sendChatButton");
        if (sendButton) {
            sendButton.addEventListener('click', () => sendChatMessage());
        }

        // Enterキーでの送信
        const chatInput = document.getElementById("chatInput");
        if (chatInput) {
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
        }
    });
        
        // 音声入力ボタンの設定（対応ブラウザのみ）
        const voiceInputBtn = document.getElementById("voiceInputBtn");
        if (voiceInputBtn && 'webkitSpeechRecognition' in window) {
            setupVoiceInput();
        }
        
        // 味覚マトリックスの初期化
        initializeTasteMatrix();
        
        // 統計情報の更新
        updateStatistics(whiskyData.length);
    });
    
    // 味覚マトリックスの初期化
    function initializeTasteMatrix() {
        const tasteMatrix1 = document.getElementById("tasteMatrix1");
        const tasteDot1 = document.getElementById("tasteDot1");
        
        const tasteMatrix2 = document.getElementById("tasteMatrix2");
        const tasteDot2 = document.getElementById("tasteDot2");
        
        if (tasteMatrix1 && tasteDot1) {
            // マトリックス1のイベントリスナー
            tasteMatrix1.addEventListener("click", function(e) {
                const rect = tasteMatrix1.getBoundingClientRect();
                x1 = (e.clientX - rect.left) / rect.width;
                y1 = (e.clientY - rect.top) / rect.height;
                
                tasteDot1.style.left = (x1 * 100) + "%";
                tasteDot1.style.top = (y1 * 100) + "%";
                
                document.getElementById("tasteCoordinates1").textContent = 
                    `座標: X: ${x1.toFixed(2)}, Y: ${y1.toFixed(2)}`;
            });
        }
        
        if (tasteMatrix2 && tasteDot2) {
            // マトリックス2のイベントリスナー
            tasteMatrix2.addEventListener("click", function(e) {
                const rect = tasteMatrix2.getBoundingClientRect();
                x2 = (e.clientX - rect.left) / rect.width;
                y2 = (e.clientY - rect.top) / rect.height;
                
                tasteDot2.style.left = (x2 * 100) + "%";
                tasteDot2.style.top = (y2 * 100) + "%";
                
                document.getElementById("tasteCoordinates2").textContent = 
                    `座標: X: ${x2.toFixed(2)}, Y: ${y2.toFixed(2)}`;
            });
        }
    }
    
    // 価格表示の更新関数
    function updateMinPriceDisplay() {
        const value = document.getElementById("minPrice").value;
        document.getElementById("minPriceDisplay").textContent = `¥${numberWithCommas(value * 1000)}`;
    }
    
    function updateMaxPriceDisplay() {
        const value = document.getElementById("maxPrice").value;
        document.getElementById("maxPriceDisplay").textContent = `¥${numberWithCommas(value * 1000)}`;
    }
    
    // 数値にカンマを追加する関数
    function numberWithCommas(x) {
        return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }
    
    // デフォルトのウィスキーデータを取得する関数
    function getDefaultWhiskyData() {
        return [
            {
                id: "1",
                name: "タリスカー 44年 オフィシャルボトル",
                price: "¥80,400",
                region: "スコットランド / スカイ島",
                subcategory: "シングルモルト",
                abv: "48.0",
                tastingNote_ja: "タリスカー独特のピートと海の風味に加え、44年の熟成による深いフルーティーさと複雑さが特徴。スカイ島の潮風と長い年月がもたらす稀少な一本。",
                taste_profile: {
                    fruity: 3,
                    spicy: 4,
                    smoky: 4,
                    body: 5,
                    sweetness: 3,
                    complexity: 5
                },
                distillery_info: {
                    name: "タリスカー蒸溜所",
                    location: "スコットランド, スカイ島",
                    founded: "1830年",
                    status: "稼働中",
                    latitude: 57.302,
                    longitude: -6.356,
                    description: "スカイ島唯一の蒸溜所であるタリスカーは、海の近くに位置し、そのウイスキーは海の塩気と煙の特徴を併せ持ちます。"
                }
            },
            {
                id: "2",
                name: "ポートエレン 25年 one of only bottles",
                price: "¥21,500",
                region: "スコットランド / アイラ島",
                subcategory: "シングルモルト",
                abv: "56.2",
                tastingNote_ja: "ポートエレン25年は考えられるかぎり希少な銘柄。強烈なスモーキー感と熟成によるコクが特徴。長い余韻とダークチョコレートとバランスが取れています。黒糖、コード、ターメリック、完熟果実の広がりがあります。",
                taste_profile: {
                    fruity: 2,
                    spicy: 4,
                    smoky: 5,
                    body: 4,
                    sweetness: 2,
                    complexity: 5
                },
                distillery_info: {
                    name: "ポートエレン蒸溜所",
                    location: "スコットランド, アイラ島",
                    founded: "1825年",
                    status: "閉鎖（1983年）",
                    latitude: 55.6301,
                    longitude: -6.2035,
                    description: "1983年に閉鎖されたポートエレンはアイラ島のアイコンとされ、残されたボトルは希少価値が高いコレクターズアイテムとなっています。"
                }
            },
            {
                id: "3",
                name: "マッカラン 1990年 SAMAROLI",
                price: "¥58,000",
                region: "スコットランド / スペイサイド",
                subcategory: "シングルモルト",
                abv: "45.0",
                tastingNote_ja: "伝説のボトラー、サマローリによるマッカラン1990年。シェリー樽の影響による豊かな果実味と複雑な香りが特徴。長い余韻と洗練された味わいが楽しめます。",
                taste_profile: {
                    fruity: 4,
                    spicy: 3,
                    smoky: 1,
                    body: 5,
                    sweetness: 4,
                    complexity: 5
                },
                distillery_info: {
                    name: "マッカラン蒸溜所",
                    location: "スコットランド, スペイサイド",
                    founded: "1824年",
                    status: "稼働中",
                    latitude: 57.4843,
                    longitude: -3.2079,
                    description: "マッカランはシェリー樽熟成のシングルモルトウイスキーの代表格で、高品質なオーク樽の選定に定評があります。"
                }
            },
            {
                id: "4",
                name: "ポウモア18年 ディープ&コンプレックス",
                price: "¥8,200",
                region: "スコットランド / アイラ島",
                subcategory: "シングルモルト",
                abv: "43.0",
                tastingNote_ja: "Body:4、Smoky:4、Complexity:4のプロファイルを持つ、アイラ島の定番銘柄。ヘビーでスモーキーなプロファイルをお探しの方におすすめです。18年熟成により、アイラモルトの特有の海の香りや、複雑な味の展開が楽しめます。",
                taste_profile: {
                    fruity: 2,
                    spicy: 3,
                    smoky: 4,
                    body: 4,
                    sweetness: 2,
                    complexity: 4
                },
                distillery_info: {
                    name: "ポウモア蒸溜所",
                    location: "スコットランド, アイラ島",
                    founded: "1779年",
                    status: "稼働中",
                    latitude: 55.7561,
                    longitude: -6.2897,
                    description: "アイラ島で最も古い蒸溜所の一つであるポウモアは、バランスの取れたピート香と海の風味が特徴です。"
                }
            },
            {
                id: "5",
                name: "ボウモアIsBS ディープコンプレックス",
                price: "¥8,200",
                region: "スコットランド / アイラ島",
                subcategory: "シングルモルト",
                abv: "43.0",
                tastingNote_ja: "Body:4、Smoky:4、Complexity:4のプロファイル、ヘビーでスモーキーなプロファイルをお探しの方におすすめです。18年熟成により、アイラモルトの特有の海の香りや、複雑な味の展開が楽しめます。より強いスモーキーさを求めるなら、同じアイラ島の「ポートエレン25年」もおすすめです。",
                taste_profile: {
                    fruity: 2,
                    spicy: 3,
                    smoky: 4,
                    body: 4,
                    sweetness: 2,
                    complexity: 4
                },
                distillery_info: {
                    name: "ポウモア蒸溜所",
                    location: "スコットランド, アイラ島",
                    founded: "1779年",
                    status: "稼働中",
                    latitude: 55.7561,
                    longitude: -6.2897,
                    description: "アイラ島で最も古い蒸溜所の一つであるポウモア(Bowmore)は、バランスの取れたピート香と海の風味が特徴です。"
                }
            }
        ];
    }
    
    // AI推薦を取得する関数（改修）
async function getRecommendation() {
    // プログレスバーの表示
    showProgress();
    try {
        // ユーザー設定を取得
        const userPreferences = {
            minPrice: parseFloat(document.getElementById("minPrice").value) * 1000,
            maxPrice: parseFloat(document.getElementById("maxPrice").value) * 1000,
            tasteX: x1,
            tasteY: y1,
            complexityX: x2,
            complexityY: y2,
            additionalPreferences: savedUserPreferences || "",
            chatHistory: chatHistory // チャット履歴全体を送信
        };
        
        // Claude APIにリクエスト
        const response = await fetch('/.netlify/functions/claude-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...userPreferences,
                requestType: "full_recommendation",
                outputFormat: "json"
            })
        });
        
        if (!response.ok) throw new Error('APIリクエストに失敗しました');
        
        const data = await response.json();
        
        // APIからのJSONレスポンスを処理
        if (data.success && data.data && data.data.content) {
            // APIからのレスポンステキストをJSON解析
            const responseText = data.data.content[0].text;
            let jsonStartIndex = responseText.indexOf('{');
            let jsonEndIndex = responseText.lastIndexOf('}') + 1;
            
            if (jsonStartIndex >= 0 && jsonEndIndex > jsonStartIndex) {
                const jsonString = responseText.substring(jsonStartIndex, jsonEndIndex);
                try {
                    const apiResponse = JSON.parse(jsonString);
                    // 推薦結果の表示
                    displayApiRecommendations(apiResponse);
                    
                    // 成功したらAIからのメッセージとして追加
                    if (apiResponse && apiResponse.summary) {
                        const aiMessage = `以下の3つのウィスキーをおすすめします:\n\n${apiResponse.summary}`;
                        addMessageToHistory("assistant", aiMessage);
                    }
                } catch (error) {
                    console.error('JSON解析エラー:', error);
                    // エラー時はローカルデータでフォールバック
                    const matchingWhiskies = findMatchingWhiskies();
                    displayLocalRecommendations(matchingWhiskies);
                }
            } else {
                // JSON形式でない場合もローカルデータでフォールバック
                const matchingWhiskies = findMatchingWhiskies();
                displayLocalRecommendations(matchingWhiskies);
            }
        } else {
            throw new Error('APIからの応答が不正です');
        }
    } catch (error) {
        console.error('推薦取得エラー:', error);
        // エラー時はローカルデータで対応
        const matchingWhiskies = findMatchingWhiskies();
        displayLocalRecommendations(matchingWhiskies);
    } finally {
        hideProgress();
    }
}
    
    // APIからの推薦結果を表示する関数（改修）
function displayApiRecommendations(apiResponse) {
    const recommendationContent = document.getElementById("recommendationContent");
    recommendationContent.innerHTML = "";
    
    // 要約の表示
    if (apiResponse.summary) {
        const summary = document.createElement('div');
        summary.className = 'recommendation-summary';
        summary.innerHTML = `<p>${escapeHtml(apiResponse.summary)}</p>`;
        recommendationContent.appendChild(summary);
    }
    
    // 各ウィスキーのカード表示
    apiResponse.recommendations.forEach((whisky, index) => {
        const whiskeyCard = document.createElement('div');
        whiskeyCard.className = 'whisky-card';
        if (index === 0) {
            whiskeyCard.classList.add('featured', 'selected');
        }
        
        // ウィスキーカードの内容を設定
        whiskeyCard.innerHTML = `
            ${index === 0 ? '<div class="featured-label">おすすめ</div>' : ''}
            <div class="flex justify-between mb-2">
                <h3 class="text-lg font-bold text-cyan-400">${escapeHtml(whisky.name)}</h3>
                <span class="text-pink-500 font-bold">${escapeHtml(whisky.price)}</span>
            </div>
            <div class="mb-2">
                <span class="text-gray-400 text-sm">
                    ${escapeHtml(whisky.region || 'N/A')} | ${escapeHtml(whisky.type || 'Whisky')}
                    ${whisky.abv ? ` | ${whisky.abv}% ABV` : ''}
                </span>
            </div>
            <p class="text-sm mb-3 text-left">${escapeHtml(whisky.description || '情報がありません。')}</p>
            <div class="grid grid-cols-3 gap-2 text-center text-xs">
                <div>
                    <span class="block text-yellow-400">フルーティー</span>
                    <span class="block">${'★'.repeat((whisky.taste_profile?.fruity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.fruity || 0))}</span>
                </div>
                <div>
                    <span class="block text-yellow-400">スモーキー</span>
                    <span class="block">${'★'.repeat((whisky.taste_profile?.smoky || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.smoky || 0))}</span>
                </div>
                <div>
                    <span class="block text-yellow-400">複雑さ</span>
                    <span class="block">${'★'.repeat((whisky.taste_profile?.complexity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.complexity || 0))}</span>
                </div>
            </div>
        `;
        
        // カードクリックイベントの追加
        whiskeyCard.addEventListener('click', () => selectWhisky(whisky, index));
        recommendationContent.appendChild(whiskeyCard);
        
        // 蒸留所情報を設定（存在する場合）
        if (whisky.distillery_info && whisky.distillery_info.latitude && whisky.distillery_info.longitude) {
            updateDistilleryInfo(whisky.distillery_info);
        }
    });
    
    // 最初のウィスキーを選択状態に
    if (apiResponse.recommendations.length > 0) {
        selectWhisky(apiResponse.recommendations[0], 0);
    }
    
    // 統計情報の更新
    updateStatistics(apiResponse.recommendations.length);
    
    // レコメンドセクションを表示
    document.querySelector(".recommendations-panel").style.display = "block";
}
    
    // ローカルデータからの推薦結果を表示する関数（APIフォールバック用）
    function displayLocalRecommendations(whiskies) {
        const recommendationContent = document.getElementById("recommendationContent");
        recommendationContent.innerHTML = "";
        
        whiskies.forEach((whisky, index) => {
            const whiskeyCard = document.createElement('div');
            whiskeyCard.className = 'whisky-card';
            if (index === 0) {
                whiskeyCard.classList.add('featured', 'selected');
            }
            
            whiskeyCard.innerHTML = `
                ${index === 0 ? '<div class="featured-label">おすすめ</div>' : ''}
                <div class="flex justify-between mb-2">
                    <h3 class="text-lg font-bold text-cyan-400">${escapeHtml(whisky.name)}</h3>
                    <span class="text-pink-500 font-bold">${escapeHtml(whisky.price)}</span>
                </div>
                <div class="mb-2">
                    <span class="text-gray-400 text-sm">
                        ${escapeHtml(whisky.region || 'N/A')} | ${escapeHtml(whisky.subcategory || 'Whisky')}
                        ${whisky.abv ? ` | ${whisky.abv}% ABV` : ''}
                    </span>
                </div>
                <p class="text-sm mb-3 text-left">${escapeHtml(whisky.tastingNote_ja || '情報がありません。')}</p>
                <div class="grid grid-cols-3 gap-2 text-center text-xs">
                    <div>
                        <span class="block text-yellow-400">フルーティー</span>
                        <span class="block">${'★'.repeat((whisky.taste_profile?.fruity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.fruity || 0))}</span>
                    </div>
                    <div>
                        <span class="block text-yellow-400">スモーキー</span>
                        <span class="block">${'★'.repeat((whisky.taste_profile?.smoky || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.smoky || 0))}</span>
                    </div>
                    <div>
                        <span class="block text-yellow-400">複雑さ</span>
                        <span class="block">${'★'.repeat((whisky.taste_profile?.complexity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.complexity || 0))}</span>
                    </div>
                </div>
            `;
            
            // カードクリックイベントの追加
            whiskeyCard.addEventListener('click', () => selectWhisky(whisky, index));
            
            recommendationContent.appendChild(whiskeyCard);
        });
        
        // 最初のウィスキーを選択状態に
        if (whiskies.length > 0) {
            selectWhisky(whiskies[0], 0);
        }
        
        // 統計情報の更新
        updateStatistics(whiskies.length);
    }
    
    // ウィスキー選択時の処理関数
    function selectWhisky(whisky, index) {
        // すべてのカードから選択状態を解除
        const cards = document.querySelectorAll('.whisky-card');
        cards.forEach(card => card.classList.remove('selected'));
        
        // 選択されたカードを強調表示
        if (cards[index]) {
            cards[index].classList.add('selected');
        }
        
        // レーダーチャートの更新
        updateTasteProfileChart(whisky);
        
        // 蒸溜所情報の更新
        if (whisky.distillery_info) {
            updateDistilleryInfo(whisky.distillery_info);
        } else {
            // 蒸溜所情報がない場合、銘柄名から推測
            const distilleryName = whisky.name.split(' ')[0];
            const distillery = distilleryDatabase[distilleryName];
            if (distillery) {
                updateDistilleryInfo(distillery);
            }
        }
    }
    
    // レーダーチャートの更新関数
    function updateTasteProfileChart(whisky) {
        // 既存のチャートがあれば破棄
        if (window.tasteProfileChart) {
            window.tasteProfileChart.destroy();
        }
        
        // 味覚プロファイルデータの取得
        const tasteProfile = whisky.taste_profile || {};
        
        // チャートデータ
        const data = {
            labels: ['フルーティー', 'スパイシー', 'ボディ', 'スモーキー', '甘さ', '複雑さ'],
            datasets: [
                {
                    label: whisky.name,
                    data: [
                        tasteProfile.fruity || 0,
                        tasteProfile.spicy || 0,
                        tasteProfile.body || 0,
                        tasteProfile.smoky || 0,
                        tasteProfile.sweetness || 0,
                        tasteProfile.complexity || 0
                    ],
                    fill: true,
                    backgroundColor: 'rgba(255, 107, 107, 0.2)',
                    borderColor: 'rgb(255, 107, 107)',
                    pointBackgroundColor: 'rgb(255, 107, 107)',
                    pointBorderColor: '#fff',
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: 'rgb(255, 107, 107)'
                }
            ]
        };
        
        // チャート設定
        const config = {
            type: 'radar',
            data: data,
            options: {
                scales: {
                    r: {
                        angleLines: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        },
                        grid: {
                            color: 'rgba(255, 255, 255, 0.2)'
                        },
                        pointLabels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            font: {
                                size: 12
                            }
                        },
                        ticks: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            backdropColor: 'transparent',
                            z: 100,
                            font: {
                                size: 10
                            }
                        },
                        suggestedMin: 0,
                        suggestedMax: 5
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: 'rgba(255, 255, 255, 0.8)',
                            font: {
                                size: 12
                            }
                        }
                    }
                }
            }
        };
        
        // チャートの作成
        const ctx = document.getElementById('tasteProfileChart').getContext('2d');
        window.tasteProfileChart = new Chart(ctx, config);
    }
    
    // 蒸溜所情報の更新関数
    function updateDistilleryInfo(distilleryInfo) {
        // 蒸溜所セクションの表示
        const distillerySection = document.getElementById('distillerySection');
        if (distillerySection) {
            distillerySection.classList.add('active');
        }
        
        // 蒸溜所情報の更新
        const distilleryName = document.getElementById('distilleryName');
        const distilleryLocation = document.getElementById('distilleryLocation');
        const distilleryFounded = document.getElementById('distilleryFounded');
        const distilleryStatus = document.getElementById('distilleryStatus');
        const distilleryDescription = document.getElementById('distilleryDescription');
        
        if (distilleryName) distilleryName.textContent = distilleryInfo.name || 'N/A';
        if (distilleryLocation) distilleryLocation.textContent = distilleryInfo.location || 'N/A';
        if (distilleryFounded) distilleryFounded.textContent = distilleryInfo.founded || 'N/A';
        if (distilleryStatus) {
            distilleryStatus.textContent = distilleryInfo.status || 'N/A';
            distilleryStatus.className = getStatusClass(distilleryInfo.status);
        }
        if (distilleryDescription) distilleryDescription.textContent = distilleryInfo.description || '詳細情報はありません。';
        
        // マップの更新
        updateDistilleryMap(distilleryInfo);
    }
    
    // 蒸溜所のマップ更新関数
    function updateDistilleryMap(distilleryInfo) {
        // マップの初期化
        if (!window.distilleryMap) {
            window.distilleryMap = L.map('distilleryMap').setView([57.5, -4.5], 6);
            
            // タイルレイヤーの追加
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 18
            }).addTo(window.distilleryMap);
        }
        
        // 既存のマーカーがあれば削除
        if (window.distilleryMarker) {
            window.distilleryMap.removeLayer(window.distilleryMarker);
        }
        
        // 緯度・経度があれば、マーカーを追加
        if (distilleryInfo.latitude && distilleryInfo.longitude) {
            const lat = distilleryInfo.latitude;
            const lng = distilleryInfo.longitude;
            
            // マップの中心を更新
            window.distilleryMap.setView([lat, lng], 10);
            
            // マーカーの作成と追加
            const customIcon = L.divIcon({
                className: 'distillery-marker',
                html: `<div style="background-color: rgba(255,107,107,0.8); width: 20px; height: 20px; border-radius: 50%; border: 2px solid white;"></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10],
                popupAnchor: [0, -10]
            });
            
            window.distilleryMarker = L.marker([lat, lng], { icon: customIcon })
                .addTo(window.distilleryMap)
                .bindPopup(`<b>${distilleryInfo.name}</b><br>${distilleryInfo.location || ''}`)
                .openPopup();
        }
    }
    
    // 統計情報の更新関数
    function updateStatistics(whiskyCount) {
        // ウィスキー数の更新
        document.getElementById('whiskyCount').textContent = whiskyCount;
        document.getElementById('totalWhiskies').textContent = whiskyCount;
        
        // 他の統計情報も必要に応じて更新
        const regions = new Set();
        const distilleries = new Set();
        
        // レコメンデーションコンテンツから情報を取得
        const cards = document.querySelectorAll('.whisky-card');
        cards.forEach(card => {
            const regionText = card.querySelector('.text-gray-400').textContent;
            const region = regionText.split('|')[0].trim();
            regions.add(region);
            
            // 蒸溜所情報があれば追加
            const name = card.querySelector('.text-lg').textContent;
            distilleries.add(name.split(' ')[0]); // 簡易的に銘柄の最初の単語を蒸溜所とみなす
        });
        
        // 統計表示の更新
        document.getElementById('uniqueRegions').textContent = regions.size;
        document.getElementById('distilleryCount').textContent = distilleries.size;
    }
    
    // チャットでの質問に対するAI応答を取得する関数（改修）
async function getAIResponse(message) {
    try {
        // ユーザー設定を取得
        const userPreferences = {
            minPrice: parseFloat(document.getElementById("minPrice").value) * 1000,
            maxPrice: parseFloat(document.getElementById("maxPrice").value) * 1000,
            tasteX: x1,
            tasteY: y1,
            complexityX: x2,
            complexityY: y2,
            additionalPreferences: message
        };
        
        // APIにリクエスト（チャット履歴も含める）
        const response = await fetch('/.netlify/functions/claude-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...userPreferences,
                chatHistory: chatHistory.slice(-10) // 直近10件の履歴を送信
            })
        });
        
        if (!response.ok) throw new Error('APIリクエストに失敗しました');
        
        const data = await response.json();
        
        // APIからのレスポンスを処理
        if (data.success && data.data && data.data.content) {
            return data.data.content[0].text;
        } else {
            throw new Error('APIからの応答が不正です');
        }
    } catch (error) {
        console.error('AI応答取得エラー:', error);
        // エラー時のフォールバック応答
        return "申し訳ありません、現在AIチャット機能が使えません。後ほどお試しください。";
    }
}

// チャット内容からAI提案を更新する関数（新規）
async function updateRecommendationsFromChatAI(message) {
    try {
        showProgress();
        
        // ユーザー設定を取得（チャットメッセージを追加好みとして）
        const userPreferences = {
            minPrice: parseFloat(document.getElementById("minPrice").value) * 1000,
            maxPrice: parseFloat(document.getElementById("maxPrice").value) * 1000,
            tasteX: x1,
            tasteY: y1,
            complexityX: x2,
            complexityY: y2,
            additionalPreferences: message,
            chatHistory: chatHistory.slice(-10) // 直近10件の履歴を送信
        };
        
        // API呼び出し（推薦リクエスト）
        const response = await fetch('/.netlify/functions/claude-api', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                ...userPreferences,
                requestType: "full_recommendation",
                outputFormat: "json"
            })
        });
        
        if (!response.ok) throw new Error('APIリクエストに失敗しました');
        
        const data = await response.json();
        
        // APIからのレスポンスを処理
        if (data.success && data.data && data.data.content) {
            const responseText = data.data.content[0].text;
            let jsonStartIndex = responseText.indexOf('{');
            let jsonEndIndex = responseText.lastIndexOf('}') + 1;
            
            if (jsonStartIndex >= 0 && jsonEndIndex > jsonStartIndex) {
                const jsonString = responseText.substring(jsonStartIndex, jsonEndIndex);
                try {
                    const apiResponse = JSON.parse(jsonString);
                    displayApiRecommendations(apiResponse);
                } catch (error) {
                    console.error('JSON解析エラー:', error);
                    // ローカルデータでフォールバック
                    const matchingWhiskies = findMatchingWhiskies();
                    displayLocalRecommendations(matchingWhiskies);
                }
            } else {
                // JSON形式でない場合
                const matchingWhiskies = findMatchingWhiskies();
                displayLocalRecommendations(matchingWhiskies);
            }
        } else {
            throw new Error('APIからの応答が不正です');
        }
    } catch (error) {
        console.error('推薦更新エラー:', error);
        // ローカルデータでフォールバック
        const matchingWhiskies = findMatchingWhiskies();
        displayLocalRecommendations(matchingWhiskies);
    } finally {
        hideProgress();
    }
}
    
    // チャットから推薦を更新する関数
    async function updateRecommendationsFromChatAI(message) {
        // ユーザー設定を取得
        const userPreferences = {
            minPrice: parseFloat(document.getElementById("minPrice").value) * 1000,
            maxPrice: parseFloat(document.getElementById("maxPrice").value) * 1000,
            tasteX: x1,
            tasteY: y1,
            complexityX: x2,
            complexityY: y2,
            additionalPreferences: message // チャットメッセージを追加要望として使用
        };
        
        try {
            // チャット完了後、自動的に推薦リストも更新
            const response = await fetch('/.netlify/functions/claude-api', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    ...userPreferences,
                    requestType: "full_recommendation",
                    outputFormat: "json"
                })
            });
            
            if (!response.ok) return;
            
            const data = await response.json();
            
            if (data.success && data.data && data.data.content) {
                try {
                    // APIからのレスポンステキストをJSON解析
                    const responseText = data.data.content[0].text;
                    let jsonStartIndex = responseText.indexOf('{');
                    let jsonEndIndex = responseText.lastIndexOf('}') + 1;
                    
                    if (jsonStartIndex >= 0 && jsonEndIndex > jsonStartIndex) {
                        const jsonString = responseText.substring(jsonStartIndex, jsonEndIndex);
                        const apiResponse = JSON.parse(jsonString);
                        
                        // 新しい推薦リストを表示
                        displayApiRecommendations(apiResponse);
                    }
                } catch (error) {
                    console.error('推薦JSONパースエラー:', error);
                }
            }
        } catch (error) {
            console.error('推薦更新エラー:', error);
        }
    }
    
    // メッセージを履歴に追加する関数（改修）
function addMessageToHistory(role, message) {
    // チャット履歴に追加
    chatHistory.push({ role: role, content: message });
    
    // チャット履歴が20件を超えたら古いものを削除
    if (chatHistory.length > 20) {
        chatHistory.shift();
    }
    
    // UIに表示
    const chatHistoryElement = document.getElementById("chatHistory");
    const messageElement = document.createElement('div');
    messageElement.className = `chat-message ${role}-message`;
    messageElement.textContent = message;
    chatHistoryElement.appendChild(messageElement);
    
    // スクロールを一番下に
    chatHistoryElement.scrollTop = chatHistoryElement.scrollHeight;
    
    // チャット履歴を表示状態に
    chatHistoryElement.style.display = "block";
}
    
    // AIメッセージを更新する関数
    function updateAIMessage(messageId, text) {
        const messageElement = document.getElementById(messageId);
        if (messageElement) {
            messageElement.innerHTML = escapeHtml(text);
        }
    }
    
    // チャットメッセージを送信する関数（改修）
async function sendChatMessage() {
    const chatInput = document.getElementById("chatInput");
    const message = chatInput.value.trim();
    
    if (!message) return;
    
    // 入力欄をクリア
    chatInput.value = "";
    
    // ユーザーメッセージを履歴に追加
    addMessageToHistory("user", message);
    
    // AIの「考え中」メッセージを表示
    const aiThinkingMessage = document.createElement('div');
    aiThinkingMessage.className = 'chat-message ai-message thinking-animation';
    aiThinkingMessage.id = 'aiThinkingMessage';
    document.getElementById("chatHistory").appendChild(aiThinkingMessage);
    document.getElementById("chatHistory").scrollTop = document.getElementById("chatHistory").scrollHeight;
    
    try {
        // AI応答を取得
        const response = await getAIResponse(message);
        
        // 考え中メッセージを削除
        const thinkingMessage = document.getElementById('aiThinkingMessage');
        if (thinkingMessage) {
            thinkingMessage.remove();
        }
        
        // AI応答を履歴に追加
        addMessageToHistory("assistant", response);
        
        // チャット内容からAI推薦も更新
        updateRecommendationsFromChatAI(message);
        
    } catch (error) {
        console.error('チャット処理エラー:', error);
        // 考え中メッセージを削除
        const thinkingMessage = document.getElementById('aiThinkingMessage');
        if (thinkingMessage) {
            thinkingMessage.remove();
        }
        
        // エラーメッセージを表示
        addMessageToHistory("assistant", "申し訳ありません、エラーが発生しました。もう一度お試しください。");
    }
}
    
    // プログレスバーの表示関数
    function showProgress() {
        document.getElementById("progressContainer").style.display = "block";
        document.getElementById("getRecommendationBtn").disabled = true;
        
        // プログレスバーのアニメーション
        const progressFill = document.getElementById("progressFill");
        let width = 0;
        const interval = setInterval(() => {
            if (width >= 100) {
                clearInterval(interval);
            } else {
                width += 2;
                progressFill.style.width = width + "%";
                document.getElementById("progressPercentage").textContent = width + "%";
            }
        }, 100);
        
        window.progressInterval = interval;
    }
    
    // プログレスバーの非表示関数
    function hideProgress() {
        clearInterval(window.progressInterval);
        document.getElementById("progressFill").style.width = "100%";
        document.getElementById("progressPercentage").textContent = "100%";
        
        setTimeout(() => {
            document.getElementById("progressContainer").style.display = "none";
            document.getElementById("getRecommendationBtn").disabled = false;
        }, 500);
    }
    
    // HTML特殊文字のエスケープ関数
    function escapeHtml(text) {
        if (!text) return '';
        return text
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
    
    // 蒸溜所ステータスのクラス取得関数
    function getStatusClass(status) {
        if (!status) return 'status-unknown';
        
        status = status.toLowerCase();
        if (status.includes('active') || status.includes('稼働中')) {
            return 'status-active';
        } else if (status.includes('closed') || status.includes('閉鎖')) {
            return 'status-closed';
        } else {
            return 'status-unknown';
        }
    }
    
    // 音声入力のセットアップ関数
    function setupVoiceInput() {
        const voiceInputBtn = document.getElementById("voiceInputBtn");
        const chatInput = document.getElementById("chatInput");
        
        if (!voiceInputBtn || !chatInput) return;
        
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) return;
        
        const recognition = new SpeechRecognition();
        recognition.lang = 'ja-JP';
        recognition.interimResults = false;
        recognition.maxAlternatives = 1;
        
        let isRecording = false;
        
        voiceInputBtn.addEventListener("click", () => {
            if (isRecording) {
                recognition.stop();
                voiceInputBtn.classList.remove("recording");
                isRecording = false;
            } else {
                recognition.start();
                voiceInputBtn.classList.add("recording");
                isRecording = true;
            }
        });
        
        recognition.onresult = (event) => {
            const speechResult = event.results[0][0].transcript;
            chatInput.value = speechResult;
            
            // 自動送信オプション（必要に応じてコメント解除）
            // sendChatMessage();
        };
        
        recognition.onend = () => {
            voiceInputBtn.classList.remove("recording");
            isRecording = false;
        };
        
        recognition.onerror = (event) => {
            console.error('音声認識エラー:', event.error);
            voiceInputBtn.classList.remove("recording");
            isRecording = false;
            
            // 通知を表示
            showErrorNotification("音声認識に失敗しました。マイクへのアクセスを許可し、もう一度お試しください。");
        };
    }
    
    // エラー通知表示関数
    function showErrorNotification(message) {
        // 既存の通知を削除
        const existingNotification = document.querySelector('.error-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // 新しい通知を作成
        const notification = document.createElement('div');
        notification.className = 'error-notification';
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">⚠️</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // 閉じるボタンのイベント
        const closeBtn = notification.querySelector('.notification-close');
        closeBtn.addEventListener('click', () => {
            notification.remove();
        });
        
        // 5秒後に自動的に消える
        setTimeout(() => {
            if (document.body.contains(notification)) {
                notification.remove();
            }
        }, 5000);
    }
    
    // ローカルウィスキーデータからの検索関数（APIフォールバック用）
    function findMatchingWhiskies() {
        const minPrice = parseFloat(document.getElementById("minPrice").value) * 1000;
        const maxPrice = parseFloat(document.getElementById("maxPrice").value) * 1000;
        
        // 価格を数値に変換
        const whiskiesWithNumericPrice = whiskyData.map(whisky => {
            const priceString = whisky.price || "¥0";
            const priceValue = parseFloat(priceString.replace(/[^\d]/g, ''));
            return { ...whisky, numericPrice: priceValue };
        });
        
        // 価格フィルター
        const priceFiltered = whiskiesWithNumericPrice.filter(whisky => {
            return whisky.numericPrice >= minPrice && whisky.numericPrice <= maxPrice;
        });
        
        // 味と複雑さのスコア計算
        const scored = priceFiltered.map(whisky => {
            const tasteProfile = whisky.taste_profile || {};
            
            // フルーティー(0) vs スモーキー(1)のスコア (y軸)
            const fruityVsSmoky = tasteProfile.smoky / 5 || 0.5;
            
            // ライト(0) vs ヘビー(1)のスコア (x軸)
            const lightVsHeavy = tasteProfile.body / 5 || 0.5;
            
            // 若い(0) vs 熟成(1)のスコア (x軸)
            const youngVsMature = tasteProfile.complexity / 5 || 0.5;
            
            // まろやか(0) vs 強烈(1)のスコア (y軸)
            const smoothVsIntense = (tasteProfile.spicy || 0) / 5;
            
            // 味覚スコアの計算
            const tasteDistance = Math.sqrt(
                Math.pow(x1 - lightVsHeavy, 2) + 
                Math.pow(y1 - fruityVsSmoky, 2)
            );
            
            // 複雑さスコアの計算
            const complexityDistance = Math.sqrt(
                Math.pow(x2 - youngVsMature, 2) + 
                Math.pow(y2 - smoothVsIntense, 2)
            );
            
            // 総合スコア（値が小さいほど好みに近い）
            const totalScore = tasteDistance + complexityDistance;
            
            return { ...whisky, score: totalScore };
        });
        
        // スコア順にソート
        const sorted = scored.sort((a, b) => a.score - b.score);
        
        // 上位3件を返す
        return sorted.slice(0, 3);
    }
    
    // Googleの翻訳を開く関数
    function openGoogleTranslate() {
        const currentUrl = window.location.href;
        const translateUrl = `https://translate.google.com/translate?sl=auto&tl=en&u=${encodeURIComponent(currentUrl)}`;
        window.open(translateUrl, '_blank');
    }

</script>
<script>
// 「別の提案を受ける」ボタン機能の修正パッチ - 正確なIDを使用
(function() {
  // DOMが完全に読み込まれたことを確認
  function initializeCustomButton() {
    // 正確なIDでボタンを取得
    const refreshButton = document.getElementById('getAnotherRecommendation');
    
    if (refreshButton) {
      console.log('「別の提案を受ける」ボタンを正確なIDで発見しました');
      
      // 既存のすべてのイベントリスナーを削除してクローン
      const newButton = refreshButton.cloneNode(true);
      refreshButton.parentNode.replaceChild(newButton, refreshButton);
      
      // 新しいボタンに同じIDを設定（重要）
      newButton.id = 'getAnotherRecommendation';
      
      // 完全に新しいイベントリスナーを設定
      newButton.addEventListener('click', function(e) {
        // デフォルトの動作とイベント伝播を停止
        if (e) {
          e.preventDefault();
          e.stopPropagation();
        }
        
        console.log('完全ランダム選択の「別の提案を受ける」処理を実行');
        
        // 現在の価格設定を取得
        const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
        const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;
        
        // 価格でフィルタリング
        const priceFiltered = whiskyData.filter(whisky => {
          try {
            const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
            return numericPrice >= minPrice && numericPrice <= maxPrice;
          } catch (err) {
            return false;
          }
        });
        
        if (priceFiltered.length < 3) {
          alert('条件に合うウィスキーが足りません。価格範囲を広げてください。');
          return false;
        }
        
        // 現在表示中のウィスキー名を取得して除外
        const currentlyShown = [];
        document.querySelectorAll('.whisky-card h3').forEach(h3 => {
          if (h3.textContent) currentlyShown.push(h3.textContent.trim());
        });
        
        // 現在表示されていないウィスキーのみをフィルタリング
        const notCurrentlyShown = priceFiltered.filter(w => 
          !currentlyShown.includes(w.name)
        );
        
        // 候補が十分にあるかチェック
        const sourceArray = notCurrentlyShown.length >= 3 ? notCurrentlyShown : priceFiltered;
        
        // 完全にランダム化して選択
        const randomWhiskies = [];
        const shuffled = [...sourceArray].sort(() => 0.5 - Math.random());
        
        // 最大3つ選択
        for (let i = 0; i < Math.min(3, shuffled.length); i++) {
          randomWhiskies.push(shuffled[i]);
        }
        
        console.log('ランダムに選択したウィスキー:', randomWhiskies.map(w => w.name));
        
        // 表示関数を呼び出し
        if (typeof displayLocalRecommendations === 'function') {
          try {
            displayLocalRecommendations(randomWhiskies);
            if (randomWhiskies.length > 0 && typeof selectWhisky === 'function') {
              selectWhisky(randomWhiskies[0]);
            }
          } catch (error) {
            console.error('表示処理中にエラーが発生:', error);
          }
        } else {
          console.error('displayLocalRecommendations関数が見つかりません');
        }
        
        return false;
      });
      
      console.log('「別の提案を受ける」ボタンの処理を完全に上書きしました');
    } else {
      console.error('ID「getAnotherRecommendation」のボタンが見つかりません');
    }
  }

  // 既存の処理が完了した後に実行されるようタイミングを調整
  if (document.readyState === 'complete') {
    // ページが既に完全に読み込まれている場合
    setTimeout(initializeCustomButton, 1500);
  } else {
    // まだページ読み込み中の場合はloadイベントを待つ
    window.addEventListener('load', function() {
      setTimeout(initializeCustomButton, 1500);
    });
  }
})();
</script>
<script>
// AIチャットからの銘柄抽出と推奨リストの連携を改善（類似度マッチング版）
(function() {
  // AIの応答を処理する関数を改善する
  function enhanceAIResponseProcessing() {
    // 元のgetAIResponse関数をバックアップ
    const originalGetAIResponse = window.getAIResponse;
    
    // もし元の関数が存在しなければ終了
    if (typeof originalGetAIResponse !== 'function') {
      console.error('元のgetAIResponse関数が見つかりません');
      return;
    }
    
    // 拡張版のgetAIResponse関数
    window.getAIResponse = async function(message) {
      // まず銘柄名を探索
      const mentionedWhiskies = findWhiskiesInText(message);
      console.log('チャットメッセージから抽出した銘柄:', mentionedWhiskies);
      
      // 元の関数を呼び出して応答を取得
      const result = await originalGetAIResponse.apply(this, arguments);
      
      // メッセージ内で言及された銘柄を表示リストに含める
      if (mentionedWhiskies.length > 0) {
        setTimeout(() => {
          updateRecommendationsWithMentioned(mentionedWhiskies);
        }, 1000); // AIの応答が表示された後に実行
      }
      
      return result;
    };
    
    console.log('getAIResponse関数を拡張しました - チャット内の銘柄名抽出と表示を連携');
  }
  
  // テキスト内で言及されている銘柄を検出する関数（類似度を使用）
  function findWhiskiesInText(text) {
    if (!text || typeof text !== 'string') return [];
    if (!window.whiskyData || !Array.isArray(window.whiskyData)) return [];
    
    // 結果を格納する配列
    const result = [];
    
    // テキストを前処理（小文字化、空白の正規化）
    const normalizedText = text.toLowerCase().replace(/\s+/g, ' ');
    
    // 特徴的なキーワード（主要銘柄名）
    const commonWhiskyNames = [
      '山崎', '白州', '響', '軽井沢', '長濱', 'タリスカー', 'マッカラン', 'アードベッグ', 
      'ポートエレン', 'NAGAHAMA', 'DAILUAINE', 'キルホーマン', 'GLENLIVET', 'ABERFELDY', 
      'SPRINGBANK', 'MORTLACH', 'CAOL ILA', 'KILCHOMAN', '秩父'
    ];
    
    // 直接的な銘柄名の検索（完全一致または主要部分が一致）
    const matches = [];
    window.whiskyData.forEach(whisky => {
      // 銘柄名を正規化
      const whiskyName = whisky.name.toLowerCase();
      
      // 完全一致または部分一致
      if (normalizedText.includes(whiskyName) || 
          whiskyName.includes(normalizedText) || 
          textSimilarity(normalizedText, whiskyName) > 0.7) {
        matches.push({
          whisky: whisky,
          score: 1.0,
          matchType: 'direct'
        });
        return;
      }
      
      // 主要キーワードのチェック
      for (const keyword of commonWhiskyNames) {
        const normalizedKeyword = keyword.toLowerCase();
        if ((whiskyName.includes(normalizedKeyword) || 
             normalizedKeyword.includes(whiskyName)) && 
            normalizedText.includes(normalizedKeyword)) {
          matches.push({
            whisky: whisky,
            score: 0.9,
            matchType: 'keyword'
          });
          return;
        }
      }
      
      // トークンベースの部分一致チェック
      const whiskyTokens = whiskyName.split(/[\s\d]+/);
      const textTokens = normalizedText.split(/[\s\d]+/);
      
      for (const whiskyToken of whiskyTokens) {
        if (whiskyToken.length < 2) continue; // 短すぎるトークンは無視
        
        for (const textToken of textTokens) {
          if (textToken.length < 2) continue; // 短すぎるトークンは無視
          
          if (whiskyToken === textToken || 
              whiskyToken.includes(textToken) || 
              textToken.includes(whiskyToken)) {
            matches.push({
              whisky: whisky,
              score: 0.8,
              matchType: 'token',
              token: whiskyToken
            });
            return;
          }
        }
      }
    });
    
    // スコアでソート
    matches.sort((a, b) => b.score - a.score);
    
    // 結果の抽出
    return matches.map(match => match.whisky);
  }
  
  // テキストの類似度を計算する関数
  function textSimilarity(text1, text2) {
    // 簡易的な類似度計算（Levenshtein距離の正規化版）
    function levenshteinDistance(a, b) {
      const matrix = [];
      
      // 初期化
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      // 計算
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i-1) === a.charAt(j-1)) {
            matrix[i][j] = matrix[i-1][j-1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i-1][j-1] + 1, // 置換
              Math.min(
                matrix[i][j-1] + 1, // 挿入
                matrix[i-1][j] + 1  // 削除
              )
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    }
    
    // 最大の長さ
    const maxLength = Math.max(text1.length, text2.length);
    if (maxLength === 0) return 1.0; // 両方が空文字列
    
    // 距離を計算
    const distance = levenshteinDistance(text1, text2);
    
    // 正規化（0-1の範囲に）
    return 1.0 - (distance / maxLength);
  }
  
  // AIの応答から銘柄名を抽出する関数
  function extractWhiskyNamesFromAIResponse(response) {
    if (!response || typeof response !== 'string') return [];
    if (!window.whiskyData || !Array.isArray(window.whiskyData)) return [];
    
    // 結果を格納する配列
    const result = [];
    
    // 「」や『』で囲まれた部分を抽出
    const quotedMatches = response.match(/[「『]([^」』]+)[」』]/g) || [];
    for (const match of quotedMatches) {
      const extractedName = match.replace(/[「『」』]/g, '');
      // データベース内で類似する銘柄を検索
      const similarWhisky = findSimilarWhisky(extractedName);
      if (similarWhisky && !result.includes(similarWhisky)) {
        result.push(similarWhisky);
      }
    }
    
    // 年数を含む特徴的なパターンを抽出（例：タリスカー44年）
    const ageMatches = response.match(/(\S+\s?\d+年[^\s、。,.]+)/g) || [];
    for (const match of ageMatches) {
      const similarWhisky = findSimilarWhisky(match);
      if (similarWhisky && !result.includes(similarWhisky)) {
        result.push(similarWhisky);
      }
    }
    
    return result;
  }
  
  // テキストに最も類似した銘柄を見つける関数
  function findSimilarWhisky(text) {
    if (!text || !window.whiskyData) return null;
    
    let bestMatch = null;
    let highestScore = 0;
    
    for (const whisky of window.whiskyData) {
      const similarityScore = textSimilarity(
        text.toLowerCase(), 
        whisky.name.toLowerCase()
      );
      
      if (similarityScore > highestScore && similarityScore > 0.6) {
        highestScore = similarityScore;
        bestMatch = whisky;
      }
    }
    
    return bestMatch;
  }
  
  // 言及された銘柄を推奨リストに含める
  function updateRecommendationsWithMentioned(mentionedWhiskies) {
    if (!mentionedWhiskies || mentionedWhiskies.length === 0) return;
    
    console.log('銘柄推奨リストに含める:', mentionedWhiskies.map(w => w.name));
    
    // 現在の価格設定を取得
    const minPrice = parseInt(document.getElementById('minPrice').value) * 1000 || 0;
    const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000 || 100000;
    
    // 価格範囲内の言及銘柄をフィルタリング
    const filteredWhiskies = mentionedWhiskies.filter(whisky => {
      try {
        const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
        return numericPrice >= minPrice && numericPrice <= maxPrice;
      } catch (err) {
        return true; // 価格解析エラーの場合は含める
      }
    });
    
    if (filteredWhiskies.length === 0) {
      console.log('言及された銘柄が価格範囲外です');
      return;
    }
    
    // 足りない場合はランダムに追加
    const finalSelection = [...filteredWhiskies];
    if (finalSelection.length < 3) {
      // 現在のウィスキーと言及されたものを除外してランダム選択
      const currentNames = finalSelection.map(w => w.name);
      const additionalCandidates = window.whiskyData.filter(w => {
        try {
          const numericPrice = parseInt(w.price.replace(/[^\d]/g, '')) || 0;
          return numericPrice >= minPrice && numericPrice <= maxPrice && !currentNames.includes(w.name);
        } catch (err) {
          return false;
        }
      });
      
      // ランダムに並べ替えて必要な数だけ追加
      const shuffled = additionalCandidates.sort(() => 0.5 - Math.random());
      while (finalSelection.length < 3 && shuffled.length > 0) {
        finalSelection.push(shuffled.pop());
      }
    }
    
    // 最終的な選択結果が得られた場合、表示を更新
    if (finalSelection.length > 0) {
      console.log('最終的に選択された銘柄:', finalSelection.map(w => w.name));
      
      try {
        // 推奨パネルを表示
        document.getElementById('splitLayoutContainer').style.display = 'grid';
        
        // 銘柄を表示
        if (typeof displayLocalRecommendations === 'function') {
          displayLocalRecommendations(finalSelection);
          
          // 最初の銘柄を選択（言及された銘柄を優先）
          if (filteredWhiskies.length > 0 && typeof selectWhisky === 'function') {
            selectWhisky(filteredWhiskies[0]);
          } else if (finalSelection.length > 0 && typeof selectWhisky === 'function') {
            selectWhisky(finalSelection[0]);
          }
        }
      } catch (err) {
        console.error('表示更新中にエラー:', err);
      }
    }
  }
  
  // 実行タイミングの調整
  if (document.readyState === 'complete') {
    setTimeout(enhanceAIResponseProcessing, 2000);
  } else {
    window.addEventListener('load', function() {
      setTimeout(enhanceAIResponseProcessing, 2000);
    });
  }
})();
</script>


    <script id="html_badge_script1">
        window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
            "remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3%2FDuBA6s%2F4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE%2FG0eL9qcC2PHM%2FfezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4%2B0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c%2BiEGpY7DMnGKNiptaLE9nF%2BYMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP%2Fhc2Wel1QtoQ08mJNhlTFLw%2F66U%2FBoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2%2Bu5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk%2F1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g%3D%3D";
        window.__genspark_locale = "ja-JP";
        window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3/DuBA6s/4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE/G0eL9qcC2PHM/fezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4+0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c+iEGpY7DMnGKNiptaLE9nF+YMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP/hc2Wel1QtoQ08mJNhlTFLw/66U/BoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2+u5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk/1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g==";
    </script>
    
    <script id="html_notice_dialog_script" src="./index_files/notice_dialog.js.ダウンロード"></script>
        <!-- ページ末尾に追加 -->
        <script type="text/javascript">
        function openGoogleTranslate() {
            const currentUrl = window.location.href;
            const translateUrl = `https://translate.google.com/translate?sl=auto&u=${encodeURIComponent(currentUrl)}`;
            window.open(translateUrl, '_blank');
        }
        </script>
        <script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
    </body></html>