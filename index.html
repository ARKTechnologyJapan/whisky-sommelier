<!DOCTYPE html>
<!-- saved from url=(0130)https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse_LBd2w0vdTtOf_OswSt8juA/whisky_sommelier_final.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- HTMLã®headã‚¿ã‚°å†…ã«Google Fontsã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ  -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜¼ã®æœˆã€‚AIã‚½ãƒ ãƒªã‚¨</title>
<link href="./index_files/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="./index_files/all.min.css">
<script src="./index_files/chart.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"></script>
<!-- Leaflet.jsåœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<link rel="stylesheet" href="./index_files/leaflet.css" crossorigin="">
<script src="./index_files/leaflet.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" crossorigin=""></script>
<style>
body {
background-color: #000;
color: #fff;
font-family: 'Noto Sans JP', sans-serif;
}
.header-container {
background: rgba(0, 0, 0, 0.9);
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
padding: 15px 0;
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 1000;
display: flex;
align-items: center;
justify-content: center;
}
.logo {
width: 90px;
height: 90px;
object-fit: contain;
border-radius: 8px;
background: rgba(78, 205, 197, 0);
border: 2px solid #4ecdc500;
padding: 5px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ */
.header-title {
color: #fff;
font-size: 28px;
font-weight: bold;
text-align: center;
margin: 0;
text-shadow: 0 0 10px rgba(78, 205, 196, 0.7);
letter-spacing: 2px;
background: linear-gradient(45deg, #ffffff, #4ecdc4);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
position: relative;
}

.header-title:after {
content: "";
position: absolute;
bottom: -5px;
left: 50%;
transform: translateX(-50%);
width: 70%;
height: 1px;
background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.7), transparent);
}

@keyframes glow {
from {
text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
}
to {
text-shadow: 0 0 15px rgba(78, 205, 196, 0.8), 0 0 20px rgba(255, 107, 107, 0.5);
}
}

/* ç¿»è¨³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.translate-link {
display: flex;
align-items: center;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 4px;
padding: 5px 10px;
margin-left: 10px;
transition: all 0.3s ease;
}

.translate-link:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-2px);
}

.translate-icon {
margin-right: 6px;
}

/* è¨€èªãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.language-links {
display: flex;
margin-left: 15px;
}

.language-links .nav-link {
margin-left: 10px;
font-size: 14px;
padding: 5px 8px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ - å³ç«¯ã«é…ç½® */
.nav-links {
position: absolute;
right: 20px;
display: flex;
gap: 15px;
}

.nav-link {
color: rgba(255, 255, 255, 0.8);
text-decoration: none;
font-size: 15px;
font-weight: 600;
transition: all 0.2s ease;
padding: 5px 10px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.05);
}

.nav-link:hover {
color: #fff;
background: rgba(78, 205, 196, 0.2);
}

.nav-link.active {
color: #fff;
background: rgba(78, 205, 196, 0.3);
border-bottom: 2px solid #4ecdc4;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ç”»é¢ã§é‡ãªã‚Šå›é¿ */
@media (max-width: 768px) {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å¢—ã‚„ã—ã¦ä½™è£•ã‚’æŒãŸã›ã‚‹ */
  .header-container {
    padding: 15px 0 30px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    flex-wrap: wrap;      /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
  }
  
  /* ãƒ­ã‚´ã‚µã‚¤ã‚ºèª¿æ•´ */
  .logo {
    width: 90px;
    height: 90px;
  }
  
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª¿æ•´ */
  .header-title {
    font-size: 24px;
    margin: 0 auto 10px;
    width: 100%;
    text-align: center;
  }
  
  /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹éƒ¨ã«ç§»å‹•ã—ã¦ä¸­å¤®æƒãˆ */
  .nav-links {
    position: relative;
    top: 10px;
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .nav-link {
    font-size: 13px;
    padding: 4px 8px;
  }

  .language-links {
    margin-top: 10px;
    width: 100%;
    justify-content: center;
  }
}

.container-custom {
max-width: 1200px;
margin: 0 auto;
padding: 100px 20px 20px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ç”»é¢ã§é‡ãªã‚Šå›é¿ */
@media (max-width: 768px) {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤§å¹…ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
  .header-container {
    padding: 5px 0 20px; /* ã•ã‚‰ã«å°ã•ãï¼šä¸Š5pxã€ä¸‹20px */
    flex-wrap: wrap;
    min-height: auto; /* æœ€å°é«˜ã•ã‚’è‡ªå‹•ã« */
  }
  
  /* ãƒ­ã‚´ã‚’ã•ã‚‰ã«å°ã•ã */
  .logo {
    width: 70px; /* ã•ã‚‰ã«å°ã•ã */
    height: 70px;
  }
  
/* ãƒ­ã‚´ã®ä½ç½®èª¿æ•´ - æœ€ã‚‚å·¦ä¸Šã« */
.header-container a[target="_blank"] {
  position: absolute;
  left: -10px;   /* ã•ã‚‰ã«å·¦ã« */
  top: 0px;    /* æœ€ä¸Šéƒ¨ã« */
}
  
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã•ã‚‰ã«å°ã•ã */
  .header-title {
    font-size: 18px; /* ã•ã‚‰ã«å°ã•ã */
    margin: 0 auto 3px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æœ€å°ã« */
    width: 100%;
    text-align: center;
  }
  
  /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã•ã‚‰ã«ä¸Šã« */
  .nav-links {
    position: relative;
    top: 20px; /* ä¸Šã®ä½™ç™½ã‚’ãªãã™ */
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px; /* é–“éš”ã‚’ç‹­ã */
  }
  
  /* ãƒªãƒ³ã‚¯ã‚’ã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  .nav-link {
    font-size: 11px; /* ã•ã‚‰ã«å°ã•ã */
    padding: 2px 6px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æœ€å°ã« */
  }

  /* è¨€èªãƒªãƒ³ã‚¯ã®ä½™ç™½ã‚’æœ€å°ã« */
  .language-links {
    margin-top: 2px; /* æœ€å°ã®ãƒãƒ¼ã‚¸ãƒ³ */
    width: 100%;
    justify-content: center;
  }
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®èª¿æ•´ */
@media (max-width: 768px) {
  .container-custom {
    padding-top: 90px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã•ã‚‰ã«å°ã•ããªã£ãŸã®ã§å¤§å¹…ã«å‰Šæ¸› */
  }
}

/* ã•ã‚‰ã«å°ã•ã„ç”»é¢ã‚µã‚¤ã‚ºå‘ã‘ */
@media (max-width: 360px) {
  .container-custom {
    padding-top: 180px; /* ã•ã‚‰ã«å°ã•ã„ç”»é¢ã§ã¯ã‚ˆã‚Šå¤§ããªãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
  }
}

/* å‘³è¦šãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.taste-matrix {
width: 300px; /* PCè¡¨ç¤ºæ™‚ã®ã‚µã‚¤ã‚º */
height: 300px;
border: 2px solid #fff;
position: relative;
background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%), 
linear-gradient(to top, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%);
}

.taste-dot {
width: 24px;
height: 24px;
background-color: #ff6b6b;
border-radius: 50%;
position: absolute;
transform: translate(-50%, -50%);
cursor: pointer;
box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.dual-matrix-container {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 40px;
margin-top: 20px;
}

.matrix-wrapper {
display: flex;
flex-direction: column;
align-items: center;
}

.matrix-title {
font-size: 18px;
font-weight: bold;
margin-bottom: 20px;
color: #4ecdc4;
}

/* ãƒãƒˆãƒªã‚¯ã‚¹ã®è»¸ãƒ©ãƒ™ãƒ«ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆåŸºæœ¬ï¼‰ */
.absolute.-top-6, .absolute.-bottom-6, .absolute.-left-12, .absolute.-right-12 {
  white-space: nowrap; /* ãƒ†ã‚­ã‚¹ãƒˆã‚’æŠ˜ã‚Šè¿”ã•ãªã„ */
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã«å·¦å³ã®è»¸ãƒ©ãƒ™ãƒ«ã‚’ç¸¦æ›¸ãã« */
@media (max-width: 768px) {
  /* å³å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆã€Œãƒ˜ãƒ“ãƒ¼ã€ã¨ã€Œç†Ÿæˆã€ï¼‰ã‚’ç¸¦æ›¸ãã« */
  .absolute.-right-12 {
    writing-mode: vertical-rl; /* ç¸¦æ›¸ãï¼ˆå³ã‹ã‚‰å·¦ï¼‰ */
    text-orientation: upright; /* æ–‡å­—ã‚’æ­£ç«‹ï¼ˆå›è»¢ãªã—ï¼‰ã« */
    right: -25px; /* ä½ç½®èª¿æ•´ */
    height: auto; /* é«˜ã•ã‚’è‡ªå‹•ã« */
    transform: translateY(-50%); /* ç¸¦ä¸­å¤®æƒãˆ */
  }
  
  /* å·¦å´ã®ãƒ©ãƒ™ãƒ«ï¼ˆã€Œãƒ©ã‚¤ãƒˆã€ã¨ã€Œè‹¥ã„ã€ï¼‰ã‚‚ç¸¦æ›¸ãã« */
  .absolute.-left-12 {
    writing-mode: vertical-rl; /* ç¸¦æ›¸ãï¼ˆå³ã‹ã‚‰å·¦ï¼‰ */
    text-orientation: upright; /* æ–‡å­—ã‚’æ­£ç«‹ã« */
    left: -25px; /* ä½ç½®èª¿æ•´ */
    height: auto;
    transform: translateY(-50%); /* ç¸¦ä¸­å¤®æƒãˆ */
  }
  
  /* ä¸Šä¸‹ã®ãƒ©ãƒ™ãƒ«ä½ç½®ã‚‚èª¿æ•´ */
  .absolute.-top-6 {
    top: -20px; /* å°‘ã—ä¸Šã« */
  }
  
  .absolute.-bottom-6 {
    bottom: -20px; /* å°‘ã—ä¸‹ã« */
  }
}

/* ã•ã‚‰ã«å°ã•ã„ç”»é¢ç”¨ã®èª¿æ•´ */
@media (max-width: 360px) {
  .absolute.-right-12 {
    right: -22px; /* ã•ã‚‰ã«ä½ç½®èª¿æ•´ */
    font-size: 10px; /* ãƒ•ã‚©ãƒ³ãƒˆã‚µã‚¤ã‚ºã‚’å°ã•ã */
  }
  
  .absolute.-left-12 {
    left: -22px; /* å·¦å´ã‚‚åŒæ§˜ã«èª¿æ•´ */
    font-size: 10px;
  }
  
  .absolute.-top-6, .absolute.-bottom-6 {
    font-size: 10px;
  }
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºã®ä¿®æ­£ */
@media (max-width: 1024px) {
  .dual-matrix-container {
    grid-template-columns: 1fr;
    gap: 30px;
  }
}

/* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«åã‚ã‚‹ */
@media (max-width: 768px) {
  .taste-matrix {
    width: 250px; /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯å¹…ã‚’ç¸®å° */
    height: 250px;
  }
  
  .matrix-wrapper {
    max-width: 100%;
  }
  
  /* ä½™ç™½èª¿æ•´ */
  .absolute.left-1\/2 {
    width: 100%;
  }
}

/* ã•ã‚‰ã«å°ã•ã„ã‚¹ãƒãƒ›ç”»é¢ã®å¯¾å¿œ */
@media (max-width: 360px) {
  .taste-matrix {
    width: 220px; /* ã‚ˆã‚Šå°ã•ã„ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯ã•ã‚‰ã«ç¸®å° */
    height: 220px;
  }
  
  /* è»¸ãƒ©ãƒ™ãƒ«ã®ä½ç½®èª¿æ•´ */
  .absolute.-left-12 {
    left: -10px;
  }
  
  .absolute.-right-12 {
    right: -10px;
  }
}

.btn-primary {
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
border: none;
color: white;
padding: 12px 24px;
border-radius: 8px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
}
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}
.btn-secondary {
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
}
.card {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px;
margin-bottom: 24px;
backdrop-filter: blur(10px);
}

/* è¦‹å‡ºã—ã®ä½™ç™½ã‚’èª¿æ•´ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
.card h2 {
padding-top: 0px;      /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
padding-bottom: 15px;   /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
line-height: 0.8;       /* è¡Œã®é«˜ã•ã‚’èª¿æ•´ */
margin-bottom: 20px;    /* ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’è¨­å®šï¼ˆmb-4ã‚’ä¸Šæ›¸ãï¼‰ */
}

/* split-layoutã®èª¿æ•´ - ãƒ‘ãƒãƒ«é–“ã®é–“éš”ã‚’åºƒã’ã‚‹ */
.split-layout {
gap: 400px;               /* ãƒ‘ãƒãƒ«é–“ã®é–“éš”ã‚’ã‚ˆã‚Šåºƒã */
}

.whisky-card {
background: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.15);
border-radius: 8px;
padding: 16px;
margin-bottom: 16px;
cursor: pointer;
transition: all 0.3s ease;
position: relative;
}
.whisky-card:hover {
background: rgba(255, 255, 255, 0.12);
border-color: #4ecdc4;
transform: translateY(-2px);
}
.whisky-card.selected {
background: rgba(78, 205, 196, 0.15);
border-color: #4ecdc4;
box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
}
.whisky-card.featured {
background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.10));
border: 2px solid #FFA500;
box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
animation: pulse-orange 2s infinite;
}
@keyframes pulse-orange {
0% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
50% { box-shadow: 0 0 30px rgba(255, 165, 0, 0.6); }
100% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
}
.featured-label {
position: absolute;
top: -10px;
right: 10px;
background: linear-gradient(45deg, #FFA500, #FFD700);
color: #000;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
}
.loading {
display: none;
text-align: center;
color: #4ecdc4;
}
.progress-container {
display: none;
margin-top: 20px;
}
.progress-bar {
width: 100%;
height: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 10px;
overflow: hidden;
margin-bottom: 10px;
}
.progress-fill {
height: 100%;
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
width: 0%;
transition: width 0.3s ease;
}
.progress-text {
color: #4ecdc4;
font-size: 14px;
margin-bottom: 5px;
}
.progress-percentage {
color: #fff;
font-size: 16px;
font-weight: bold;
}
.error {
color: #ff6b6b;
background: rgba(255, 107, 107, 0.1);
border: 1px solid rgba(255, 107, 107, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.success {
color: #4ecdc4;
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.price-slider {
-webkit-appearance: none;
width: 100%;
height: 8px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.2);
outline: none;
margin: 10px 0;
}
.price-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
}
.price-slider::-moz-range-thumb {
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
border: none;
}
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
}
.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
}

/* split-layoutã®ä¿®æ­£ - ä½™ç™½ã‚’å¢—ã‚„ã™ */
.split-layout {
display: grid;
grid-template-columns: 1fr 1fr; /* å‡ç­‰ã«åˆ†å‰² */
gap: 30px; /* é–“éš”ã‚’åºƒã’ã‚‹ï¼ˆå…ƒã¯20pxï¼‰ */
align-items: start;
margin-bottom: 30px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
}

/* ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«ã®ä¿®æ­£ */
.recommendations-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 24px;
backdrop-filter: blur(10px);
max-height: 85vh; /* å°‘ã—é«˜ã•ã‚’å¢—ã‚„ã™ */
overflow-y: auto;
margin-bottom: 30px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

/* ãƒãƒ£ãƒ¼ãƒˆãƒ‘ãƒãƒ«ã®ä¿®æ­£ - é‡è¦ãªä¿®æ­£éƒ¨åˆ† */
.chart-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px 20px; /* ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
backdrop-filter: blur(10px);
position: sticky;
top: 130px; /* å°‘ã—ä¸‹ã’ã‚‹ */
max-height: 85vh; /* å°‘ã—é«˜ã•ã‚’å¢—ã‚„ã™ */
overflow-y: auto;
scrollbar-width: thin;
scrollbar-color: rgba(78, 205, 196, 0.5) rgba(255, 255, 255, 0.1);
margin-bottom: 20px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

.chart-panel::-webkit-scrollbar {
width: 8px;
}

.chart-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.chart-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ä¿®æ­£ */
.chart-container {
height: 380px; /* é«˜ã•ã‚’å¢—ã‚„ã™ï¼ˆå…ƒã¯350pxï¼‰ */
width: 100%;
position: relative;
margin-bottom: 30px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®è¦‹å‡ºã—ä¿®æ­£ */
.chart-container h3 {
text-align: center;
margin-bottom: 25px; /* ä½™ç™½ã‚’å¢—ã‚„ã™ */
color: #4ecdc4;
font-size: 16px;
padding-top: 10px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
/* ãƒãƒ£ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¿®æ­£ */
.chart-canvas {
height: 350px !important;
width: 100% !important;
margin-top: 15px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

#combinedProfileChart {
height: 350px !important; /* é«˜ã•ã‚’å¢—ã‚„ã™ï¼ˆå…ƒã¯320pxï¼‰ */
width: 100% !important;
margin-top: 20px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
margin-bottom: 20px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
.recommendation-summary {
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 8px;
padding: 16px;
margin-bottom: 20px;
color: #4ecdc4;
}

.custom-footer {
display: none;
text-align: center;
padding: 20px;
color: rgba(255, 255, 255, 0.6);
font-size: 12px;
margin-top: 40px;
}

.whisky-overview {
background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
border: 2px solid rgba(78, 205, 196, 0.3);
border-radius: 16px;
padding: 30px;
margin-bottom: 30px;
text-align: center;
position: relative;
overflow: hidden;
}

.whisky-overview::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
animation: shimmer 3s infinite;
}

@keyframes shimmer {
0% { transform: translateX(-100%); }
100% { transform: translateX(100%); }
}

.whisky-overview h2 {
font-size: 2.5rem;
font-weight: bold;
background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
margin-bottom: 20px;
position: relative;
z-index: 1;
}

.whisky-overview .subtitle {
font-size: 1.2rem;
color: #4ecdc4;
margin-bottom: 15px;
font-weight: 600;
position: relative;
z-index: 1;
}

.whisky-overview .description {
font-size: 1.1rem;
line-height: 1.6;
color: rgba(255, 255, 255, 0.9);
position: relative;
z-index: 1;
}

.whisky-stats {
display: flex;
justify-content: space-around;
margin-top: 25px;
margin-bottom: 24px;  /* ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™ï¼ˆæ•°å€¤ã¯èª¿æ•´å¯èƒ½ï¼‰ */
position: relative;
z-index: 1;
}

.stat-item {
text-align: center;
}

.stat-number {
font-size: 2rem;
font-weight: bold;
color: #ff6b6b;
display: block;
}

.stat-label {
font-size: 0.9rem;
color: rgba(255, 255, 255, 0.7);
margin-top: 5px;
}

.taste-icon {
width: 24px;
height: 24px;
margin-right: 8px;
fill: #4ecdc4;
}

.chat-section {
margin-top: 30px;
}

.chat-examples {
display: grid;
grid-template-columns: 1fr 1fr;  /* 2åˆ—ã«è¨­å®š */
grid-template-rows: auto auto;   /* 2è¡Œã«è¨­å®š */
gap: 10px;
background: rgba(78, 205, 196, 0.05);
border: 1px solid rgba(78, 205, 196, 0.2);
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

/* è³ªå•ä¾‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¨å¹…ã« */
.chat-examples .mb-3 {
grid-column: 1 / -1;  /* 1åˆ—ç›®ã‹ã‚‰æœ€å¾Œã®åˆ—ã¾ã§åºƒã’ã‚‹ */
}

.question-example {
/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
display: flex;
align-items: center;
justify-content: center;  /* æ¨ªæ–¹å‘ã‚‚ä¸­å¤®æƒãˆ */
height: 100%;
margin-bottom: 0;
padding: 8px 12px;

/* ã‚¹ã‚¿ã‚¤ãƒ« */
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 6px;
color: #4ecdc4;

/* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ */
cursor: pointer;
transition: all 0.3s ease;
}

/* ãƒ›ãƒãƒ¼åŠ¹æœã¯ç¶­æŒ */
.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.chat-input-container {
display: flex;
gap: 10px;
margin-bottom: 20px;
}

.chat-input {
flex: 1;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
border-radius: 8px;
padding: 12px;
color: #fff;
font-size: 14px;
}

.chat-input:focus {
outline: none;
border-color: #4ecdc4;
box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ä¿®æ­£ */
@media (max-width: 768px) {
  .chat-input-container {
    flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
    gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®ä½™ç™½ */
  }
  
  .chat-input {
    width: 100%; /* å…¥åŠ›æ¬„ã‚’å…¨å¹…ã« */
    margin-bottom: 10px; /* å…¥åŠ›æ¬„ã®ä¸‹ã«ä½™ç™½ */
  }
  
  /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’æ¨ªä¸¦ã³ã« */
  .chat-buttons {
    display: flex;
    gap: 10px;
    width: 100%;
  }
  
  .voice-input-btn {
    flex: 0 0 auto; /* ã‚µã‚¤ã‚ºå›ºå®š */
    min-width: 50px; /* æœ€å°å¹…ã‚’ç¢ºä¿ */
  }
  
  .btn-primary {
    flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ */
    min-width: 0; /* æœ€å°å¹…åˆ¶é™ã‚’è§£é™¤ */
  }
}

.chat-history {
max-height: 400px;
overflow-y: auto;
padding: 15px;
background: rgba(0, 0, 0, 0.3);
border-radius: 8px;
margin-bottom: 15px;
display: none;
}

.chat-message {
margin-bottom: 15px;
padding: 12px;
border-radius: 8px;
word-wrap: break-word;
white-space: pre-wrap;
line-height: 1.6;
font-size: 14px;
}

/* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
.ai-message {
text-align: left;  /* å·¦å¯„ã›ã«è¨­å®š */
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
}

/* å¿…è¦ã«å¿œã˜ã¦é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å·¦å¯„ã›ã« */
.chat-message {
text-align: left;  /* å·¦å¯„ã›ã«è¨­å®š */
/* ãã®ä»–ã®æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« */
}

.user-message {
background: rgba(255, 107, 107, 0.15);
border-left: 3px solid #ff6b6b;
color: #fff;
}

.chat-history::-webkit-scrollbar {
width: 6px;
}

.chat-history::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 3px;
}

.chat-history::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 3px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ä¿®æ­£ */
@media (max-width: 1024px) {
.split-layout {
grid-template-columns: 1fr;
gap: 30px; /* é–“éš”ã‚’åºƒã’ã‚‹ */
}

.chart-panel {
position: static;
margin-top: 30px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
padding: 30px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‡ç­‰ã« */
}

.whisky-overview h2 {
font-size: 2rem;
}

.whisky-stats {
flex-direction: column;
gap: 15px;
}

.dual-matrix-container {
grid-template-columns: 1fr;
gap: 30px;
}
}

@media (max-width: 768px) {
.custom-footer {
display: block;
}

.whisky-overview h2 {
font-size: 1.8rem;
}

.whisky-overview .subtitle {
font-size: 1rem;
}

.whisky-overview .description {
font-size: 1rem;
}
}

.recommendations-panel::-webkit-scrollbar {
width: 8px;
}

.recommendations-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb:hover {
background: rgba(78, 205, 196, 0.7);
}

/* è’¸ç•™æ‰€ãƒãƒƒãƒ—ã¨æƒ…å ±ãƒ‘ãƒãƒ« */
.distillery-section {
margin-top: 20px;
opacity: 0;
height: 0;
overflow: hidden;
transition: opacity 0.8s ease, height 0.8s ease;
}

.distillery-section.active {
opacity: 1;
height: auto;
}

.distillery-container {
display: flex;
flex-direction: column;
gap: 20px;
}

.map-container {
height: 300px;
border-radius: 12px;
overflow: hidden;
border: 2px solid rgba(78, 205, 196, 0.3);
background-color: #1a1a1a;
}

#distilleryMap {
height: 100%;
width: 100%;
background-color: #242424;
}

.distillery-info {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 12px;
padding: 16px;
color: #fff;
}

.distillery-info h3 {
color: #4ecdc4;
font-size: 18px;
font-weight: bold;
margin-bottom: 10px;
border-bottom: 1px solid rgba(78, 205, 196, 0.3);
padding-bottom: 8px;
}

.distillery-info-grid {
display: grid;
grid-template-columns: auto 1fr;
gap: 8px 16px;
margin-top: 15px;
}

.info-label {
color: rgba(255, 255, 255, 0.7);
font-weight: 600;
}

.info-value {
color: rgba(255, 255, 255, 0.9);
}

/* distilleryDescriptionã‚’å·¦å¯„ã›ã«ã™ã‚‹CSSä¿®æ­£ */
.distillery-description {
margin-top: 15px;
line-height: 1.6;
text-align: left; /* å·¦å¯„ã›ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š */
}
.status-active {
color: #4ecdc4;
font-weight: bold;
}

.status-closed {
color: #ff6b6b;
font-weight: bold;
}

.status-unknown {
color: #ffb347;
font-weight: bold;
}

/* Leafletãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
.leaflet-container {
background-color: #242424 !important;
}
.leaflet-tile-pane {
opacity: 0.9;
}
.leaflet-popup-content-wrapper {
background-color: rgba(40, 44, 52, 0.95) !important;
color: #fff !important;
border: 1px solid rgba(78, 205, 196, 0.5);
}
.leaflet-popup-tip {
background-color: rgba(40, 44, 52, 0.95) !important;
}
.leaflet-control-zoom a {
background-color: rgba(40, 44, 52, 0.8) !important;
color: #fff !important;
border-color: rgba(78, 205, 196, 0.3) !important;
}
.leaflet-control-zoom a:hover {
background-color: rgba(78, 205, 196, 0.3) !important;
}

/* éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 18px;
}

.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
transform: translateY(-2px);
}

.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
animation: pulse-recording 1.5s infinite;
}

@keyframes pulse-recording {
0% { transform: scale(1); }
50% { transform: scale(1.1); }
100% { transform: scale(1); }
}

.error-notification {
position: fixed;
top: 20px;
right: 20px;
z-index: 9999;
max-width: 400px;
animation: slide-in 0.5s ease-out;
}

.notification-content {
background-color: rgba(255, 107, 107, 0.9);
color: white;
border-radius: 8px;
padding: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
display: flex;
align-items: center;
}

.notification-icon {
font-size: 24px;
margin-right: 15px;
}

.notification-message {
flex-grow: 1;
}

.notification-close {
background: none;
border: none;
color: white;
font-size: 20px;
cursor: pointer;
padding: 0;
margin-left: 10px;
}

@keyframes slide-in {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

/* ãƒãƒ£ãƒƒãƒˆæ¨è–¦éŠ˜æŸ„ã®å¼·èª¿ã‚¹ã‚¿ã‚¤ãƒ« */
.whisky-card.chat-mentioned {
    border: 2px solid #4ecdc4;
    box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
}

.chat-label {
    position: absolute;
    top: -8px;
    right: 8px;
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    z-index: 10;
}

/* AIææ¡ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£ */
.ai-recommendation-message {
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
padding: 20px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
border-radius: 8px;
margin-bottom: 25px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
line-height: 1.8; /* è¡Œé–“ã‚’åºƒã’ã‚‹ */
}

@keyframes thinking {
0% { content: "è€ƒãˆã¦ã„ã¾ã™"; }
25% { content: "è€ƒãˆã¦ã„ã¾ã™."; }
50% { content: "è€ƒãˆã¦ã„ã¾ã™.."; }
75% { content: "è€ƒãˆã¦ã„ã¾ã™..."; }
100% { content: "è€ƒãˆã¦ã„ã¾ã™...."; }
}

.thinking-animation {
position: relative;
}

.thinking-animation::after {
content: "è€ƒãˆã¦ã„ã¾ã™";
animation: thinking 1.5s infinite;
}

/* è’¸æºœæ‰€ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
.distillery-tooltip {
background-color: rgba(40, 44, 52, 0.95);
color: #fff;
border: 1px solid rgba(78, 205, 196, 0.5);
border-radius: 4px;
padding: 5px 8px;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}


</style></head>
<body>
<div class="header-container">
<a href="https://www.hirunotsuki.com/" target="_blank" style="position: absolute; left: 20px; width: 90px; height: 90px; display: block;">
<img class="logo" src="./NH_bar_logo_fin_white.png" alt="æ˜¼ã®æœˆãƒãƒ¼ãƒ­ã‚´">
</a>
<h1 class="header-title">æ˜¼ã®æœˆã€‚AIã‚½ãƒ ãƒªã‚¨</h1>
<div class="nav-links">
<a href="whisky_list.html" class="nav-link" id="listLink">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆä¸€è¦§</a>

<!-- 1ã¤ã®ç¿»è¨³ãƒœã‚¿ãƒ³ã«çµ±åˆ -->
<a href="#" onclick="openGoogleTranslate(); return false;" class="nav-link translate-link">
<span class="translate-icon">ğŸŒ</span> ç¿»è¨³
</a>
</div>
</div>

<div class="container-custom">
<div class="whisky-overview">
<h2>ğŸ· ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
<div class="subtitle">æœ¬æ—¥ã¯å³é¸ã•ã‚ŒãŸ<span id="whiskyCount">0</span>æœ¬ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‹ã‚‰</div>
<div class="description">
<strong>ã‚ãªãŸã®å‘³è¦šã«å®Œç’§ã«ãƒãƒƒãƒã™ã‚‹</strong>æœ€é«˜ã®ä¸€æœ¬ã‚’<br>
AIæŠ€è¡“ã§åˆ†æãƒ»ææ¡ˆã„ãŸã—ã¾ã™
</div>
<div class="whisky-stats">
<div class="stat-item">
<span class="stat-number" id="totalWhiskies">0</span>
<div class="stat-label">å³é¸éŠ˜æŸ„</div>
</div>
<div class="stat-item">
<span class="stat-number" id="uniqueRegions">0</span>
<div class="stat-label">ç”£åœ°</div>
</div>
<div class="stat-item">
<span class="stat-number" id="distilleryCount">0</span>
<div class="stat-label">è’¸æºœæ‰€ã®æ•°</div>
</div>
<div class="stat-item">
<span class="stat-number" id="aiTechnology">AI</span>
<div class="stat-label">åˆ†ææŠ€è¡“</div>
</div>
</div>

<div class="card">
<h2 class="text-2xl font-bold mb-4">
ğŸ’ ä¾¡æ ¼å¸¯è¨­å®š
</h2>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block mb-2">ä¸‹é™ä¾¡æ ¼: <span id="minPriceDisplay">Â¥5,000</span></label>
<input type="range" id="minPrice" class="price-slider" min="1" max="80" value="5" step="1">
</div>
<div>
<label class="block mb-2">ä¸Šé™ä¾¡æ ¼: <span id="maxPriceDisplay">Â¥50,000</span></label>
<input type="range" id="maxPrice" class="price-slider" min="1" max="80" value="50" step="1">
</div>
</div>
</div>

<div class="card">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸŒŸ å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
</h2>
<p class="mb-6">2ã¤ã®å››è§’å†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãã‚Œãã‚Œã®å¥½ã¿ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

<div class="dual-matrix-container">
<div class="matrix-wrapper">
<div class="matrix-title">åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix1">
<div class="taste-dot" id="tasteDot1" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">ãƒ©ã‚¤ãƒˆ</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ãƒ˜ãƒ“ãƒ¼</div>
</div>
<div class="text-center mt-4">
<span id="coordinates1" class="text-xs text-gray-400">åº§æ¨™: X: 0.50, Y: 0.50</span>
</div>
</div>

<div class="matrix-wrapper">
<div class="matrix-title">è¤‡é›‘ã•ã®å¥½ã¿</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix2">
<div class="taste-dot" id="tasteDot2" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">ã¾ã‚ã‚„ã‹</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">å¼·çƒˆ</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">è‹¥ã„</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ç†Ÿæˆ</div>
</div>
<div class="text-center mt-4">
<span id="coordinates2" class="text-xs text-gray-400">åº§æ¨™: X: 0.50, Y: 0.50</span>
</div>
</div>
</div>
</div>

<div class="card chat-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ—¨ï¸ AIã‚½ãƒ ãƒªã‚¨ã¨ãƒãƒ£ãƒƒãƒˆ
</h2>

<div class="chat-examples">
<div class="mb-3 text-sm text-gray-300">è³ªå•ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰ï¼š</div>
<div class="question-example" data-question="ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ï¼ˆæœ€é«˜é¡80,400å††ï¼‰ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦">ğŸ’ ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ï¼ˆæœ€é«˜é¡80,400å††ï¼‰ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦</div>
<div class="question-example" data-question="3000å††ä»¥ä¸‹ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªã‚¢ã‚¤ãƒ©å³¶ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯ã‚ã‚‹ï¼Ÿ">ğŸŒŠ 3000å††ä»¥ä¸‹ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªã‚¢ã‚¤ãƒ©å³¶ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯ã‚ã‚‹ï¼Ÿ</div>
<div class="question-example" data-question="æ—¥æœ¬ã®è»½äº•æ²¢ã‚„é•·æ¿±ãªã©ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’æ¯”è¼ƒã—ã¦">ğŸ¯ æ—¥æœ¬ã®è»½äº•æ²¢ã‚„é•·æ¿±ãªã©ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’æ¯”è¼ƒã—ã¦</div>
<div class="question-example" data-question="5000å††å‰å¾Œã§è¤‡é›‘ãªå‘³ã‚ã„ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãŠã™ã™ã‚ã¯ï¼Ÿ">â­ 5000å††å‰å¾Œã§è¤‡é›‘ãªå‘³ã‚ã„ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãŠã™ã™ã‚ã¯ï¼Ÿ</div>
</div>

<div class="chat-input-container">
  <input type="text" id="chatInput" class="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
  <div class="chat-buttons">
    <button id="voiceInputBtn" class="voice-input-btn">ğŸ™ï¸</button>
    <button id="sendChatBtn" class="btn-primary">ğŸ’¬ è³ªå•ã™ã‚‹</button>
  </div>
</div>

<div id="chatHistory" class="chat-history" style="display: none;"></div>
</div>

<div class="text-center mb-8">
<button id="getRecommendation" class="btn-primary text-lg mr-4">ğŸ¯ AIææ¡ˆã‚’é–‹å§‹</button>
<button id="refreshRecommendation" class="btn-secondary text-lg">
ğŸ”„ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦å†ææ¡ˆ
</button>
</div>

<div id="loadingIndicator" class="loading" style="display: none;">
<div class="animate-spin text-4xl mb-4">ğŸ·</div>
<p class="mt-2">AIãŒæœ€é©ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’åˆ†æä¸­...</p>
</div>

<div id="progressContainer" class="progress-container" style="display: none;">
<div id="progressText" class="progress-text">çµæœã‚’ç”Ÿæˆä¸­...</div>
<div class="progress-bar">
<div id="progressFill" class="progress-fill" style="width: 0%;"></div>
</div>
<div id="progressPercentage" class="progress-percentage">0%</div>
</div>

<div id="splitLayoutContainer" class="split-layout" style="display: none;">
<div id="recommendationsPanel" class="recommendations-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸŒ™ AIææ¡ˆçµæœ
</h2>
<div id="preferencesSummary" class="recommendation-summary" style="display: block;">
<h3 class="text-lg font-bold mb-3">ğŸ¯ ã‚ãªãŸã®å¥½ã¿ã®å‚¾å‘</h3>
<div class="space-y-2 text-sm">
<div><strong>åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘:</strong> <span id="tasteDescription">ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ</span></div>
<div><strong>è¤‡é›‘ã•ã®å¥½ã¿:</strong> <span id="complexityDescription">ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€</span></div>
<div><strong>ä¾¡æ ¼å¸¯:</strong> <span id="priceRange">Â¥5,000 - Â¥50,000</span></div>

<div class="mt-3 pt-2 border-t border-gray-600">
AIãŒç·åˆçš„ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ã€æœ€é©ãª3éŠ˜æŸ„ã‚’å³é¸ã—ã¾ã—ãŸã€‚
</div>
</div>
</div>
<div id="recommendationContent"></div>
<div class="text-center mt-6">
<button id="getAnotherRecommendation" class="btn-secondary">
ğŸ”„ åˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹
</button>
</div>
</div>

<div id="chartPanel" class="chart-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ•¸ï¸ å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¯”è¼ƒ
</h2>
<div class="chart-container">
<h3 id="chartTitle">ã‚ãªãŸã®å¥½ã¿</h3>
<canvas id="combinedProfileChart" class="chart-canvas"></canvas>
</div>

<!-- è’¸ç•™æ‰€ãƒãƒƒãƒ—ã¨æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div id="distillerySection" class="distillery-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ—¾ è’¸æºœæ‰€æƒ…å ±
</h2>
<div class="distillery-container">
<div class="map-container">
<div id="distilleryMap"></div>
</div>

<div class="distillery-info" id="distilleryInfo">
<h3 id="distilleryName">è’¸ç•™æ‰€å</h3>
<div class="distillery-info-grid" id="distilleryDetails">
<div class="info-label">æ‰€åœ¨åœ°:</div>
<div class="info-value" id="distilleryRegion">-</div>

<div class="info-label">å‰µæ¥­å¹´:</div>
<div class="info-value" id="distilleryFounded">-</div>

<div class="info-label">ç¾åœ¨ã®çŠ¶æ³:</div>
<div class="info-value" id="distilleryStatus">-</div>
</div>

<div class="distillery-description" id="distilleryDescription">
ç¾åœ¨æƒ…å ±ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
</div>
</div>
</div>
</div>
</div>
</div>

<div class="custom-footer">
Powered by Nebula Hirozon Technology
</div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã®ä¿®æ­£ï¼ˆæ—¢å­˜ã®éƒ¨åˆ†ã‚’ä»¥ä¸‹ã«ç½®ãæ›ãˆï¼‰
let whiskyData = [];
let distilleryDatabase = {}; // â† ã“ã‚Œã‚’ distilleryData ã«çµ±ä¸€
let distilleryMarkers = {};
let distilleryMap = null;
let profileChartInstance = null;
let brandToDistilleryMapping = {}; // â† ã“ã‚Œã‚’ brandToDistilleryData ã«çµ±ä¸€

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let excludedWhiskies = []; // é™¤å¤–ã™ã‚‹éŠ˜æŸ„ã®ãƒªã‚¹ãƒˆ
let lastRecommendedWhisky = null; // æœ€å¾Œã«æ¨è–¦ã—ãŸéŠ˜æŸ„

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ä¿å­˜ã™ã‚‹é…åˆ—
let chatHistory = [];
let distilleryData = {}; // ãƒ¡ã‚¤ãƒ³ä½¿ç”¨
let brandToDistilleryData = {}; // ãƒ¡ã‚¤ãƒ³ä½¿ç”¨

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ã‚’ä¿å­˜ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let savedUserPreferences = {
minPrice: null,
maxPrice: null,
tasteX: null,
tasteY: null,
complexityX: null,
complexityY: null,
region: null
};

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
function animateCounter(elementId, targetValue) {
const element = document.getElementById(elementId);
if (!element) return;

// ç¾åœ¨ã®å€¤ã‚’å–å¾—ï¼ˆæ•°å€¤ã§ãªã„å ´åˆã¯0ã‚’è¨­å®šï¼‰
let currentValue = 0;

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—
const duration = 1000; // 1000ms = 1ç§’
const steps = 60;
const stepTime = duration / steps;

// ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®å¢—åŠ é‡
const increment = targetValue / steps;

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
function updateCounter(currentStep) {
if (currentStep <= steps) {
// ç¾åœ¨ã®å€¤ã‚’è¨ˆç®—
currentValue = Math.min(Math.ceil(increment * currentStep), targetValue);

// è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆAIã®å ´åˆã¯æ–‡å­—åˆ—ã®ã¾ã¾ï¼‰
if (elementId === 'aiTechnology') {
element.textContent = 'AI';
} else {
element.textContent = currentValue.toString();
}

// æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’äºˆç´„
setTimeout(() => updateCounter(currentStep + 1), stepTime);
}
}

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—é–‹å§‹
updateCounter(1);
}

// DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('DOMContentLoaded', function() {
console.log('DOM fully loaded');

// ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
clearChatHistory();
resetTasteMatrices();

// å¤‰æ•°ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
if (typeof whiskyData === 'undefined') {
whiskyData = [];
}

if (typeof distilleryDatabase === 'undefined') {
distilleryDatabase = {};
}

if (typeof distilleryMarkers === 'undefined') {
distilleryMarkers = {};
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
setActiveNavLinks();

// å››è±¡é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
initializeTasteMatrix();

// çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ - éåŒæœŸå‡¦ç†
loadUnifiedWhiskyData().then(data => {
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸå¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
console.log('çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
setupEventListeners();

// çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
updateStatistics();

}).catch(err => {
console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
});
});

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
function setActiveNavLinks() {
const currentPage = window.location.pathname.split('/').pop() || 'index.html';
const links = document.querySelectorAll('.nav-links a');

links.forEach(link => {
const href = link.getAttribute('href').split('/').pop();
if (currentPage === href) {
link.classList.add('active');
} else {
link.classList.remove('active');
}
});
}

// çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ï¼ˆä¿®æ­£ç‰ˆï¼‰
async function loadUnifiedWhiskyData() {
    console.log('çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');
    
    try {
        // JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        const response = await fetch('unified_whisky_data.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('JSONãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸ:', data);
        
        // ãƒ‡ãƒ¼ã‚¿ã‚’å„å¤‰æ•°ã«æ ¼ç´ï¼ˆçµ±ä¸€ã•ã‚ŒãŸå¤‰æ•°åã‚’ä½¿ç”¨ï¼‰
        whiskyData = data.whiskies || [];
        distilleryData = data.distilleries || {};
        distilleryDatabase = data.distilleries || {}; // æ—¢å­˜ã®ãƒãƒƒãƒ—æ©Ÿèƒ½ç”¨
        brandToDistilleryData = data.brandToDistillery || {};
        brandToDistilleryMapping = data.brandToDistillery || {}; // æ—¢å­˜ã®ãƒãƒƒãƒ—æ©Ÿèƒ½ç”¨
        
        console.log('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿:', whiskyData.length, 'ä»¶');
        console.log('è’¸æºœæ‰€ãƒ‡ãƒ¼ã‚¿:', Object.keys(distilleryData).length, 'ä»¶');
        console.log('ãƒ–ãƒ©ãƒ³ãƒ‰-è’¸æºœæ‰€ãƒãƒƒãƒ”ãƒ³ã‚°:', Object.keys(brandToDistilleryData).length, 'ä»¶');
        
        // çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
        updateStatistics();
        
        // åˆæœŸæ¨è–¦ã‚’ç”Ÿæˆ
        generateAIRecommendations();
        
        console.log('çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');
        return true;
        
    } catch (error) {
        console.error('çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        showError('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        return false;
    }
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
function extractKeywordsFromChat() {
    const keywords = {
        brands: [],
        tastes: [],
        regions: [],
        priceRange: null
    };
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰ãƒ†ã‚­ã‚¹ãƒˆã‚’åé›†
    const chatMessages = document.querySelectorAll('.chat-message.user-message');
    const allChatText = Array.from(chatMessages).map(msg => msg.textContent.toLowerCase()).join(' ');
    
    if (!allChatText) return keywords;
    
    // ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„åã‚’æ¤œç´¢
    whiskyData.forEach(whisky => {
        const whiskyName = whisky.name.toLowerCase();
        const brandParts = whiskyName.split(/[\sã€€å¹´]/);
        
        brandParts.forEach(part => {
            if (part.length > 2 && allChatText.includes(part)) {
                if (!keywords.brands.includes(whisky.name)) {
                    keywords.brands.push(whisky.name);
                }
            }
        });
        
        // å®Œå…¨ãªãƒ–ãƒ©ãƒ³ãƒ‰åã®æ¤œç´¢
        if (allChatText.includes(whiskyName)) {
            if (!keywords.brands.includes(whisky.name)) {
                keywords.brands.push(whisky.name);
            }
        }
    });
    
    // å‘³è¦šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢
    const tasteKeywords = {
        'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼': ['smoky', 'smoke', 'ãƒ”ãƒ¼ãƒˆ'],
        'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼': ['fruity', 'fruit', 'æœå®Ÿ'],
        'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼': ['spicy', 'spice', 'ã‚¹ãƒ‘ã‚¤ã‚¹'],
        'ã‚¹ã‚¤ãƒ¼ãƒˆ': ['sweet', 'sweetness', 'ç”˜ã„'],
        'ãƒ˜ãƒ“ãƒ¼': ['heavy', 'body', 'é‡ã„'],
        'ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹': ['complex', 'complexity', 'è¤‡é›‘']
    };
    
    Object.entries(tasteKeywords).forEach(([japanese, englishWords]) => {
        if (allChatText.includes(japanese.toLowerCase()) || 
            englishWords.some(word => allChatText.includes(word))) {
            keywords.tastes.push(japanese);
        }
    });
    
    // åœ°åŸŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢
    const regionKeywords = [
        'scotland', 'japan', 'ireland', 'america', 
        'ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰', 'æ—¥æœ¬', 'ã‚¢ã‚¤ãƒ«ãƒ©ãƒ³ãƒ‰', 'ã‚¢ãƒ¡ãƒªã‚«',
        'islay', 'speyside', 'highland', 'ã‚¢ã‚¤ãƒ©', 'ã‚¹ãƒšã‚¤ã‚µã‚¤ãƒ‰', 'ãƒã‚¤ãƒ©ãƒ³ãƒ‰'
    ];
    regionKeywords.forEach(region => {
        if (allChatText.includes(region.toLowerCase())) {
            keywords.regions.push(region);
        }
    });
    
    return keywords;
}

// AIæ¨è–¦ç”Ÿæˆé–¢æ•°
function generateAIRecommendations() {
    const recommendations = document.getElementById('recommendations');
    const summary = document.getElementById('recommendationSummary');
    
    if (!whiskyData || whiskyData.length === 0) {
        if (recommendations) {
            recommendations.innerHTML = '<p class="error">ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚</p>';
        }
        return;
    }
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‹ã‚‰ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡º
    const keywords = extractKeywordsFromChat();
    let filteredWhiskies = [...whiskyData];
    let recommendationReason = '';
    
    // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
    const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;
    
    filteredWhiskies = filteredWhiskies.filter(whisky => {
        const price = parseInt(whisky.price.replace(/[Â¥,]/g, ''));
        return price >= minPrice && price <= maxPrice;
    });
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«åŸºã¥ãæ¨è–¦
    if (keywords.brands.length > 0) {
        // éŠ˜æŸ„åãŒè¨€åŠã•ã‚ŒãŸå ´åˆã€ãã®éŠ˜æŸ„ã‚’å„ªå…ˆ
        const brandRecommendations = filteredWhiskies.filter(whisky =>
            keywords.brands.some(brand => whisky.name === brand)
        );
        
        if (brandRecommendations.length > 0) {
            filteredWhiskies = brandRecommendations;
            recommendationReason = `ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸã€Œ${keywords.brands.join('ã€')}ã€ã«åŸºã¥ãæ¨è–¦`;
        }
    } else if (keywords.tastes.length > 0) {
        // å‘³è¦šã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ãæ¨è–¦
        filteredWhiskies.sort((a, b) => {
            let aScore = 0, bScore = 0;
            
            keywords.tastes.forEach(taste => {
                switch(taste) {
                    case 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼':
                        aScore += a.taste_profile?.smoky || 0;
                        bScore += b.taste_profile?.smoky || 0;
                        break;
                    case 'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼':
                        aScore += a.taste_profile?.fruity || 0;
                        bScore += b.taste_profile?.fruity || 0;
                        break;
                    case 'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼':
                        aScore += a.taste_profile?.spicy || 0;
                        bScore += b.taste_profile?.spicy || 0;
                        break;
                    case 'ã‚¹ã‚¤ãƒ¼ãƒˆ':
                        aScore += a.taste_profile?.sweetness || 0;
                        bScore += b.taste_profile?.sweetness || 0;
                        break;
                    case 'ãƒ˜ãƒ“ãƒ¼':
                        aScore += a.taste_profile?.body || 0;
                        bScore += b.taste_profile?.body || 0;
                        break;
                    case 'ã‚³ãƒ³ãƒ—ãƒ¬ãƒƒã‚¯ã‚¹':
                        aScore += a.taste_profile?.complexity || 0;
                        bScore += b.taste_profile?.complexity || 0;
                        break;
                }
            });
            
            return bScore - aScore;
        });
        
        recommendationReason = `ã€Œ${keywords.tastes.join('ã€')}ã€ã®ç‰¹å¾´ã«åŸºã¥ãæ¨è–¦`;
    } else if (keywords.regions.length > 0) {
        // åœ°åŸŸã«åŸºã¥ãæ¨è–¦
        filteredWhiskies = filteredWhiskies.filter(whisky =>
            keywords.regions.some(region => {
                const whiskyRegion = whisky.region ? whisky.region.toLowerCase() : '';
                const whiskySubcategory = whisky.subcategory ? whisky.subcategory.toLowerCase() : '';
                const regionLower = region.toLowerCase();
                
                return whiskyRegion.includes(regionLower) ||
                       whiskySubcategory.includes(regionLower) ||
                       (regionLower.includes('ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰') && whiskyRegion.includes('scotland')) ||
                       (regionLower.includes('scotland') && whiskyRegion.includes('scotland')) ||
                       (regionLower.includes('æ—¥æœ¬') && whiskyRegion.includes('japan')) ||
                       (regionLower.includes('japan') && whiskyRegion.includes('japan'));
            })
        );
        
        recommendationReason = `ã€Œ${keywords.regions.join('ã€')}ã€åœ°åŸŸã«åŸºã¥ãæ¨è–¦`;
    } else {
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®æ¨è–¦ï¼ˆé«˜è©•ä¾¡é †ï¼‰
        filteredWhiskies.sort((a, b) => {
            const aScore = Object.values(a.taste_profile || {}).reduce((sum, val) => sum + val, 0);
            const bScore = Object.values(b.taste_profile || {}).reduce((sum, val) => sum + val, 0);
            return bScore - aScore;
        });
        
        recommendationReason = 'ç·åˆè©•ä¾¡ã®é«˜ã„éŠ˜æŸ„';
    }
    
    // ä¸Šä½5ä»¶ã‚’é¸æŠ
    const topRecommendations = filteredWhiskies.slice(0, 5);
    
    // ã‚µãƒãƒªãƒ¼ã‚’æ›´æ–°
    if (summary) {
        summary.innerHTML = `
            <div class="ai-recommendation-message">
                ğŸ¤– <strong>AIæ¨è–¦ç†ç”±:</strong> ${recommendationReason}<br>
                ğŸ“Š ${topRecommendations.length}ä»¶ã®æ¨è–¦éŠ˜æŸ„ã‚’é¸å‡ºã—ã¾ã—ãŸ
                ${keywords.brands.length > 0 ? `<br>ğŸ¯ ç‰¹åˆ¥æ¨è–¦: ${keywords.brands.join('ã€')}` : ''}
            </div>
        `;
    }
    
    // æ¨è–¦ãƒªã‚¹ãƒˆã‚’è¡¨ç¤º
    if (recommendations) {
        recommendations.innerHTML = topRecommendations.map(whisky => `
            <div class="whisky-card ${keywords.brands.includes(whisky.name) ? 'featured' : ''}" 
                 onclick="selectWhisky('${whisky.id}')">
                ${keywords.brands.includes(whisky.name) ? '<div class="featured-label">ğŸ¯ ãƒãƒ£ãƒƒãƒˆæ¨è–¦</div>' : ''}
                <div class="flex items-center mb-3">
                    <img src="${whisky.photoUrl}" alt="${whisky.name}" 
                         class="w-16 h-20 object-cover rounded mr-4"
                         onerror="this.src='placeholder-whisky.jpg'">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-1">${whisky.name}</h4>
                        <p class="text-sm opacity-75 mb-1">${whisky.region} | ${whisky.subcategory}</p>
                        <p class="text-lg font-bold text-yellow-400">${whisky.price}</p>
                    </div>
                </div>
                <div class="taste-profile-mini grid grid-cols-3 gap-2 text-xs">
                    <span>ğŸ‡ ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼: ${whisky.taste_profile?.fruity || 0}/5</span>
                    <span>ğŸŒ¶ï¸ ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼: ${whisky.taste_profile?.spicy || 0}/5</span>
                    <span>ğŸ’¨ ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼: ${whisky.taste_profile?.smoky || 0}/5</span>
                </div>
            </div>
        `).join('');
    }
}

// ç°¡å˜ãªAIå¿œç­”ç”Ÿæˆé–¢æ•°
function generateSimpleAIResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();
    
    // ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã®æ¤œç´¢
    const mentionedWhiskies = whiskyData.filter(whisky =>
        whisky.name.split(/[\sã€€å¹´]/).some(part => 
            part.length > 2 && lowerMessage.includes(part.toLowerCase())
        )
    );
    
    if (mentionedWhiskies.length > 0) {
        const whisky = mentionedWhiskies[0];
        return `${whisky.name}ã«ã¤ã„ã¦ãŠèãã§ã™ã­ï¼ã“ã®éŠ˜æŸ„ã¯${whisky.region}ã®${whisky.subcategory}ã§ã€ä¾¡æ ¼ã¯${whisky.price}ã¨ãªã£ã¦ãŠã‚Šã¾ã™ã€‚å³å´ã®æ¨è–¦ãƒªã‚¹ãƒˆã«è¡¨ç¤ºã„ãŸã—ã¾ã™ï¼`;
    }
    
    // å‘³è¦šç‰¹å¾´ã®å¿œç­”
    if (lowerMessage.includes('ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼') || lowerMessage.includes('smoky')) {
        return 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªå‘³ã‚ã„ãŒãŠå¥½ã¿ã§ã™ã­ï¼æ³¥ç‚­ã‚’ä½¿ã£ãŸç‹¬ç‰¹ãªé¦™ã‚Šã¨å‘³ã‚ã„ãŒç‰¹å¾´çš„ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ãŠæ¢ã—ã„ãŸã—ã¾ã™ã€‚';
    }
    
    if (lowerMessage.includes('ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼') || lowerMessage.includes('fruity')) {
        return 'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãªå‘³ã‚ã„ãŒãŠå¥½ã¿ã§ã™ã­ï¼æœå®Ÿã®ç”˜ã‚„ã‹ãªé¦™ã‚Šã¨å‘³ã‚ã„ãŒæ¥½ã—ã‚ã‚‹éŠ˜æŸ„ã‚’ã”ææ¡ˆã„ãŸã—ã¾ã™ã€‚';
    }
    
    if (lowerMessage.includes('ãŠã™ã™ã‚') || lowerMessage.includes('æ¨è–¦')) {
        return 'ã‚ãªãŸã®å¥½ã¿ã«åˆã‚ã›ã¦æœ€é©ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ãŠé¸ã³ã„ãŸã—ã¾ã™ã€‚ä¾¡æ ¼å¸¯ã‚„å‘³ã®å¥½ã¿ã‚’ãŠèã‹ã›ãã ã•ã„ï¼';
    }
    
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¿œç­”
    return 'ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ã‚ãªãŸã®ã”è³ªå•ã‚’å‚è€ƒã«ã€æœ€é©ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ãŠé¸ã³ã„ãŸã—ã¾ã™ã€‚å³å´ã®æ¨è–¦ãƒªã‚¹ãƒˆã‚’ã”è¦§ãã ã•ã„ï¼';
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‹ã‚‰è’¸æºœæ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆçµ±åˆJSONå¯¾å¿œãƒ»ä¿®æ­£ç‰ˆï¼‰
function getDistilleryForWhisky(whisky) {
    console.log('è’¸æºœæ‰€æ¤œç´¢é–‹å§‹:', whisky.name);
    
    // 1. brandToDistilleryã‹ã‚‰ç›´æ¥å–å¾—ã‚’è©¦ã™
    if (brandToDistilleryData[whisky.name]) {
        const distilleryKey = brandToDistilleryData[whisky.name];
        console.log('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã§ç™ºè¦‹:', whisky.name, '->', distilleryKey);
        
        if (distilleryData[distilleryKey]) {
            console.log('è’¸æºœæ‰€ãƒ‡ãƒ¼ã‚¿ç™ºè¦‹:', distilleryData[distilleryKey]);
            return {
                name: distilleryKey,
                ...distilleryData[distilleryKey]
            };
        }
    }

    // 2. éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢
    const whiskyNameLower = whisky.name.toLowerCase();
    console.log('éƒ¨åˆ†ä¸€è‡´æ¤œç´¢é–‹å§‹:', whiskyNameLower);
    
    for (const distilleryKey in distilleryData) {
        const distilleryNameLower = distilleryKey.toLowerCase().replace(/è’¸æºœæ‰€/g, '');
        console.log('æ¯”è¼ƒä¸­:', whiskyNameLower, 'vs', distilleryNameLower);
        
        if (whiskyNameLower.includes(distilleryNameLower) || distilleryNameLower.includes(whiskyNameLower)) {
            console.log('éƒ¨åˆ†ä¸€è‡´ã§ç™ºè¦‹:', whisky.name, '->', distilleryKey);
            return {
                name: distilleryKey,
                ...distilleryData[distilleryKey]
            };
        }
    }

    // 3. ã‚ˆã‚ŠæŸ”è»Ÿãªæ¤œç´¢ï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ™ãƒ¼ã‚¹ï¼‰
    const keywords = ['jura', 'nagahama', 'established'];
    for (const keyword of keywords) {
        if (whiskyNameLower.includes(keyword)) {
            for (const distilleryKey in distilleryData) {
                if (distilleryKey.toLowerCase().includes(keyword)) {
                    console.log('ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ä¸€è‡´ã§ç™ºè¦‹:', whisky.name, '->', distilleryKey);
                    return {
                        name: distilleryKey,
                        ...distilleryData[distilleryKey]
                    };
                }
            }
        }
    }

    console.log('è’¸æºœæ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', whisky.name);
    return null;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿
function getDefaultWhiskyData() {
return [
{
id: "1",
name: "ã‚¿ãƒªã‚¹ã‚«ãƒ¼ 44å¹´ ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ãƒœãƒˆãƒ«",
price: "Â¥80,400",
region: "Scotland, Isle of Skye",
subcategory: "Single Malt Scotch Whisky",
abv: 45.8,
tastingNote_ja: "ã“ã®éå¸¸ã«å¸Œå°‘ãªã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ã¯ã€å¼·ã„æµ·å²¸ã®å¡©æ°—ã‚’æŒã¤è¤‡é›‘ãªæµ·æ´‹æ€§ã®ç‰¹å¾´ã‚’æä¾›ã—ã¾ã™ã€‚è±Šã‹ãªãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã€ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯ãƒ¬ã‚¶ãƒ¼ã®å±¤ãŒã‚¿ãƒªã‚¹ã‚«ãƒ¼ç‰¹æœ‰ã®ãƒ”ãƒªãƒƒã¨ã—ãŸã‚¹ãƒ¢ãƒ¼ã‚¯ã¨èª¿å’Œã—ã¦ã„ã¾ã™ã€‚é•·æœŸç†Ÿæˆã«ã‚ˆã‚Šã€ãƒˆãƒ­ãƒ”ã‚«ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ã€ãƒŸãƒ„ãƒ­ã‚¦ã€ç¹Šç´°ãªæ¨½ã®ã‚¹ãƒ‘ã‚¤ã‚¹ã®ãƒãƒ¼ãƒˆã‚’æŒã¤é©šãã¹ãæ·±ã¿ãŒç”Ÿã¾ã‚Œã€éå¸¸ã«é•·ãæ¸©ã‹ã¿ã®ã‚ã‚‹ä½™éŸ»ã¸ã¨ç¶šãã¾ã™ã€‚",
taste_profile: {
fruity: 3,
spicy: 4,
body: 5,
smoky: 4,
sweetness: 2,
complexity: 5
}
},
{
id: "2",
name: "ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³ 25å¹´ one of only bottles",
price: "Â¥20,400",
region: "Scotland, Islay",
subcategory: "Single Malt Scotch Whisky",
abv: 40,
tastingNote_ja: "ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³25å¹´ã¯å¸Œå°‘ã§é«˜ãè©•ä¾¡ã•ã‚Œã‚‹ã‚¢ã‚¤ãƒ©ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ã§ã€å¼·ã„æµ·æ´‹æ€§ã®ç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚è¤‡é›‘ãªæ³¥ç‚­ã®ç…™ã€æµ·å¡©ã€ãƒ¨ãƒ¼ãƒ‰ã®å±¤ãŒæŸ‘æ©˜é¡ã®çš®ã€ãƒãƒ‹ãƒ©ã€å¾®å¦™ãªãƒˆãƒ­ãƒ”ã‚«ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ã¨ãƒãƒ©ãƒ³ã‚¹ã‚ˆãèª¿å’Œã—ã¦ã„ã¾ã™ã€‚é•·ã„ä½™éŸ»ã«ã¯ã€ã‚ªãƒ¼ã‚¯ã‚¿ãƒ³ãƒ‹ãƒ³ã€ç™½èƒ¡æ¤’ã€ãã—ã¦é•·ãç¶šãç”˜ã„ç…™ãŒç¾ã‚Œã¾ã™ã€‚",
taste_profile: {
fruity: 2,
spicy: 3,
body: 4,
smoky: 5,
sweetness: 2,
complexity: 5
}
},
{
id: "3",
name: "ãƒãƒƒã‚«ãƒ©ãƒ³ 1990å¹´ SAMAROLI",
price: "Â¥12,200",
region: "Scotland",
subcategory: "Single Malt Scotch Whisky - Speyside",
abv: 40,
tastingNote_ja: "æœ‰åãªç‹¬ç«‹ç³»ãƒœãƒˆãƒ©ãƒ¼ã€ã‚µãƒãƒ­ãƒ¼ãƒªã«ã‚ˆã£ã¦ãƒœãƒˆãƒªãƒ³ã‚°ã•ã‚ŒãŸå¸Œå°‘ãªãƒãƒƒã‚«ãƒ©ãƒ³1990å¹´ã€‚è±Šã‹ãªã‚·ã‚§ãƒªãƒ¼ã®å½±éŸ¿ãŒã‚ã‚Šã€ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã€ã‚ªãƒ¬ãƒ³ã‚¸ãƒ”ãƒ¼ãƒ«ã€ã‚¯ãƒªã‚¹ãƒã‚¹ã‚±ãƒ¼ã‚­ã®é¢¨å‘³ãŒç‰¹å¾´ã€‚è¤‡é›‘ãªæ¨½ã®ã‚¹ãƒ‘ã‚¤ã‚¹ãŒèœ‚èœœã€ãƒˆãƒ•ã‚£ãƒ¼ã€ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã¨èª¿å’Œã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã¯é•·ãã€é©ã€ã‚¿ãƒã‚³ã€ãã—ã¦ä½™éŸ»ã®æ®‹ã‚‹ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã®ç”˜ã•ãŒæ„Ÿã˜ã‚‰ã‚Œã¾ã™ã€‚",
taste_profile: {
fruity: 4,
spicy: 3,
body: 5,
smoky: 1,
sweetness: 4,
complexity: 5
}
}
];
}

// å››è±¡é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
function initializeTasteMatrix() {
const matrix1 = document.getElementById('tasteMatrix1');
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');

const matrix2 = document.getElementById('tasteMatrix2');
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');

// ä¸­å¤®ä½ç½®ã«åˆæœŸåŒ–
resetTasteMatrices();

// ãƒãƒˆãƒªãƒƒã‚¯ã‚¹1ã®ã‚¤ãƒ™ãƒ³ãƒˆ
matrix1.addEventListener('click', function(e) {
updateDotPosition(e, matrix1, dot1, coords1, 1);
});

matrix1.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // å·¦ã‚¯ãƒªãƒƒã‚¯æŠ¼ä¸‹ä¸­
updateDotPosition(e, matrix1, dot1, coords1, 1);
}
});

// ãƒãƒˆãƒªãƒƒã‚¯ã‚¹2ã®ã‚¤ãƒ™ãƒ³ãƒˆ
matrix2.addEventListener('click', function(e) {
updateDotPosition(e, matrix2, dot2, coords2, 2);
});

matrix2.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // å·¦ã‚¯ãƒªãƒƒã‚¯æŠ¼ä¸‹ä¸­
updateDotPosition(e, matrix2, dot2, coords2, 2);
}
});
}

// ãƒ‰ãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°
function updateDotPosition(event, matrix, dot, coords, matrixNum) {
const rect = matrix.getBoundingClientRect();
let x = event.clientX - rect.left;
let y = event.clientY - rect.top;

// å¢ƒç•Œãƒã‚§ãƒƒã‚¯
x = Math.max(0, Math.min(x, rect.width));
y = Math.max(0, Math.min(y, rect.height));

// ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›
const xPercent = (x / rect.width) * 100;
const yPercent = (y / rect.height) * 100;

// ãƒ‰ãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°
dot.style.left = `${xPercent}%`;
dot.style.top = `${yPercent}%`;

// åº§æ¨™è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå°æ•°ç‚¹2æ¡ã¾ã§ï¼‰
const xCoord = (x / rect.width).toFixed(2);
const yCoord = (y / rect.height).toFixed(2);
coords.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}

// å››è±¡é™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ä¸­å¤®ã«é…ç½®
function resetTasteMatrices() {
// å››è±¡é™1ï¼ˆåŸºæœ¬çš„ãªå‘³ã®å‚¾å‘ï¼‰
const dot1 = document.getElementById('tasteDot1');
dot1.style.left = '50%';
dot1.style.top = '50%';
document.getElementById('coordinates1').textContent = 'åº§æ¨™: X: 0.50, Y: 0.50';

// å››è±¡é™2ï¼ˆè¤‡é›‘ã•ã®å¥½ã¿ï¼‰
const dot2 = document.getElementById('tasteDot2');
dot2.style.left = '50%';
dot2.style.top = '50%';
document.getElementById('coordinates2').textContent = 'åº§æ¨™: X: 0.50, Y: 0.50';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®šï¼ˆå®Œå…¨ç‰ˆï¼‰
function setupEventListeners() {
    // æ¨è–¦å–å¾—ãƒœã‚¿ãƒ³
    const getRecommendationBtn = document.getElementById('getRecommendation');
    if (getRecommendationBtn) {
        getRecommendationBtn.addEventListener('click', function() {
            getRecommendation();
            
            // ææ¡ˆçµæœã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
            setTimeout(() => {
                const recommendationsPanel = document.getElementById('recommendationsPanel');
                if (recommendationsPanel) {
                    recommendationsPanel.scrollIntoView({ behavior: 'smooth' });
                }
            }, 500);
        });
    }
    
    // åˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ãƒœã‚¿ãƒ³ï¼ˆanotherRecommendationï¼‰
    const anotherRecommendationBtn = document.getElementById('anotherRecommendation');
    if (anotherRecommendationBtn) {
        anotherRecommendationBtn.addEventListener('click', function() {
            console.log('anotherRecommendationãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // å‰å›æ¨è–¦ã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é™¤å¤–ãƒªã‚¹ãƒˆã«è¿½åŠ 
            if (lastRecommendedWhisky) {
                if (!excludedWhiskies.includes(lastRecommendedWhisky.name)) {
                    excludedWhiskies.push(lastRecommendedWhisky.name);
                    console.log('é™¤å¤–ãƒªã‚¹ãƒˆã«è¿½åŠ :', lastRecommendedWhisky.name);
                }
            }
            
            // æ–°ã—ã„æ¨è–¦ã‚’å®Ÿè¡Œ
            getRecommendation();
        });
    }
    
    // getAnotherRecommendationãƒœã‚¿ãƒ³ï¼ˆæ—¢å­˜ï¼‰
    const getAnotherRecommendationBtn = document.getElementById('getAnotherRecommendation');
    if (getAnotherRecommendationBtn) {
        getAnotherRecommendationBtn.addEventListener('click', function() {
            console.log('getAnotherRecommendationãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ');
            
            // å‰å›æ¨è–¦ã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é™¤å¤–ãƒªã‚¹ãƒˆã«è¿½åŠ 
            if (lastRecommendedWhisky) {
                if (!excludedWhiskies.includes(lastRecommendedWhisky.name)) {
                    excludedWhiskies.push(lastRecommendedWhisky.name);
                    console.log('é™¤å¤–ãƒªã‚¹ãƒˆã«è¿½åŠ :', lastRecommendedWhisky.name);
                }
            }
            
            getRecommendation();
        });
    }
    
    // ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ãƒœã‚¿ãƒ³
    const sendMessageBtn = document.getElementById('sendMessage');
    const chatInput = document.getElementById('chatInput');
    
    if (sendMessageBtn && chatInput) {
        sendMessageBtn.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage('user', message);
                chatInput.value = '';
                
                chatHistory.push({role: 'user', content: message});
                
                setTimeout(() => {
                    const response = "ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ã€‚ãŠå®¢æ§˜ã®å¥½ã¿ã‚’ç†è§£ã—ã¾ã—ãŸã€‚æ¨è–¦æ©Ÿèƒ½ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚";
                    addChatMessage('assistant', response);
                    chatHistory.push({role: 'assistant', content: response});
                }, 1000);
            }
        });
        
        // Enterã‚­ãƒ¼ã§ã‚‚é€ä¿¡å¯èƒ½ã«ã™ã‚‹
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });
    }
    
    // sendChatBtnãƒœã‚¿ãƒ³ï¼ˆã‚‚ã—å­˜åœ¨ã™ã‚‹å ´åˆï¼‰
    const sendChatBtn = document.getElementById('sendChatBtn');
    if (sendChatBtn && chatInput) {
        sendChatBtn.addEventListener('click', function() {
            const input = chatInput.value.trim();
            if (input) {
                sendChatMessage();
            }
        });
    }
    
    // ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã®Enterã‚­ãƒ¼ï¼ˆsendChatBtnç”¨ï¼‰
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const input = this.value.trim();
                if (input) {
                    sendChatMessage();
                }
            }
        });
    }
    
    // è³ªå•ä¾‹ã‚¯ãƒªãƒƒã‚¯
    document.querySelectorAll('.question-example').forEach(function(elem) {
        elem.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            if (chatInput) {
                chatInput.value = question;
                sendChatMessage();
            }
        });
    });
    
    // ä¾¡æ ¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ - é€£å‹•æ©Ÿèƒ½è¿½åŠ 
    const minPriceSlider = document.getElementById('minPrice');
    const maxPriceSlider = document.getElementById('maxPrice');
    
    if (minPriceSlider) {
        minPriceSlider.addEventListener('input', function() {
            const minVal = parseInt(this.value);
            const maxPriceElement = document.getElementById('maxPrice');
            const maxVal = maxPriceElement ? parseInt(maxPriceElement.value) : 80;
            
            // ä¸‹é™ãŒä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
            if (minVal > maxVal) {
                this.value = maxVal;
                const minPriceDisplay = document.getElementById('minPriceDisplay');
                if (minPriceDisplay) {
                    minPriceDisplay.textContent = `Â¥${formatPrice(maxVal * 1000)}`;
                }
            } else {
                const minPriceDisplay = document.getElementById('minPriceDisplay');
                if (minPriceDisplay) {
                    minPriceDisplay.textContent = `Â¥${formatPrice(minVal * 1000)}`;
                }
            }
        });
    }
    
    if (maxPriceSlider) {
        maxPriceSlider.addEventListener('input', function() {
            const maxVal = parseInt(this.value);
            const minPriceElement = document.getElementById('minPrice');
            const minVal = minPriceElement ? parseInt(minPriceElement.value) : 1;
            
            // ä¸Šé™ãŒä¸‹é™ã‚’ä¸‹å›ã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
            if (maxVal < minVal) {
                this.value = minVal;
                const maxPriceDisplay = document.getElementById('maxPriceDisplay');
                if (maxPriceDisplay) {
                    maxPriceDisplay.textContent = `Â¥${formatPrice(minVal * 1000)}`;
                }
            } else {
                const maxPriceDisplay = document.getElementById('maxPriceDisplay');
                if (maxPriceDisplay) {
                    maxPriceDisplay.textContent = `Â¥${formatPrice(maxVal * 1000)}`;
                }
            }
        });
    }
    
    // ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ãƒœã‚¿ãƒ³
    const refreshRecommendationBtn = document.getElementById('refreshRecommendation');
    if (refreshRecommendationBtn) {
        refreshRecommendationBtn.addEventListener('click', function() {
            // å››è±¡é™ã®ãƒªã‚»ãƒƒãƒˆã¨å±¥æ­´ã‚¯ãƒªã‚¢
            resetTasteMatrices();
            clearChatHistory();
            
            // é™¤å¤–ãƒªã‚¹ãƒˆã‚‚ã‚¯ãƒªã‚¢
            excludedWhiskies.length = 0;
            lastRecommendedWhisky = null;
            
            // ææ¡ˆãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
            const splitLayoutContainer = document.getElementById('splitLayoutContainer');
            if (splitLayoutContainer) {
                splitLayoutContainer.style.display = 'none';
            }
            
            // ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
            if (profileChartInstance) {
                profileChartInstance.destroy();
                profileChartInstance = null;
            }
            
            // è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
            const distillerySection = document.getElementById('distillerySection');
            if (distillerySection) {
                distillerySection.classList.remove('active');
            }
        });
    }
    
    // ãƒã‚¤ã‚¯å…¥åŠ›è¨­å®š
    setupVoiceInput();
}

// ãƒã‚¤ã‚¯å…¥åŠ›ã®å‡¦ç†
function setupVoiceInput() {
const voiceButton = document.getElementById('voiceInputBtn');
const chatInput = document.getElementById('chatInput');

// SpeechRecognition APIã®ç¢ºèª
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
console.warn('Speech recognition not supported');
voiceButton.style.display = 'none';
return;
}

const recognition = new SpeechRecognition();
recognition.lang = 'ja-JP';
recognition.interimResults = true;
recognition.continuous = false;

let isRecording = false;

voiceButton.addEventListener('click', () => {
if (!isRecording) {
// éŒ²éŸ³é–‹å§‹
recognition.start();
voiceButton.classList.add('recording');
voiceButton.textContent = 'ğŸ”´';
isRecording = true;
} else {
// éŒ²éŸ³çµ‚äº†
recognition.stop();
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;
}
});

// éŸ³å£°èªè­˜çµæœ
recognition.onresult = (event) => {
const transcript = Array.from(event.results)
.map(result => result[0])
.map(result => result.transcript)
.join('');

chatInput.value = transcript;
};

// ã‚¨ãƒ©ãƒ¼å‡¦ç†
recognition.onerror = (event) => {
console.error('Speech recognition error', event.error);
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;

if (event.error === 'not-allowed') {
showNotification('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
}
};

// çµ‚äº†å‡¦ç†
recognition.onend = () => {
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;
};
}

// sendChatMessageé–¢æ•°ã®å®Œå…¨ç‰ˆï¼ˆAPIé€£æºä»˜ãï¼‰
async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
    chatHistory.push({
        type: 'user',
        message: message,
        timestamp: new Date()
    });
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
    const chatHistoryDiv = document.getElementById('chatHistory');
    chatHistoryDiv.style.display = 'block';
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const userMessage = document.createElement('div');
    userMessage.className = 'chat-message user-message';
    userMessage.textContent = message;
    chatHistoryDiv.appendChild(userMessage);
    
    input.value = '';
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    
    // ç¾åœ¨ã®å‘³è¦šåº§æ¨™ã‚’ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã«ä¿å­˜
    const dot1 = document.getElementById('tasteDot1');
    const dot2 = document.getElementById('tasteDot2');
    if (dot1 && dot2) {
        window.currentX = parseFloat(dot1.style.left) || 150;
        window.currentY = parseFloat(dot1.style.top) || 150;
    }

    // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¥½ã¿ã‚’æŠ½å‡º
    try {
        const prefs = extractPreferencesFromMessage(message);
        if (prefs && Object.keys(prefs).length > 0) {
            Object.assign(savedUserPreferences, prefs);
            updateUIWithPreferences(prefs);
        }
    } catch (error) {
        console.error('å¥½ã¿æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
    }

    // AIã®å¿œç­”ã‚’ç”Ÿæˆï¼ˆAPIé€£æºç‰ˆï¼‰
    await getAIResponse(message);
}

// AIå¿œç­”ã®å–å¾—ï¼ˆAPIé€£æºç‰ˆã‚’å¾©æ´»ï¼‰
async function getAIResponse(message) {
    const chatHistoryDiv = document.getElementById('chatHistory');
    
    // è€ƒãˆä¸­ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
    const thinkingMessage = document.createElement('div');
    thinkingMessage.className = 'chat-message ai-message thinking-animation';
    thinkingMessage.textContent = '';
    chatHistoryDiv.appendChild(thinkingMessage);
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    try {
        // ç¾åœ¨ã®è¨­å®šå€¤ã‚’å–å¾—
        const minPriceValue = parseInt(document.getElementById('minPrice').value);
        const maxPriceValue = parseInt(document.getElementById('maxPrice').value);
        const minPrice = minPriceValue * 1000;
        const maxPrice = maxPriceValue * 1000;

        // å‘³è¦šåº§æ¨™ã‚’å–å¾—
        const tasteX = window.currentX || 150;
        const tasteY = window.currentY || 150;

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åé›†
        const chatHistoryData = collectChatHistoryForAPI();

        // ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®æ§‹ç¯‰
        const requestData = {
            minPrice: minPrice,
            maxPrice: maxPrice,
            tasteX: parseFloat(tasteX.toFixed(2)),
            tasteY: parseFloat(tasteY.toFixed(2)),
            additionalPreferences: message,
            chatHistory: chatHistoryData,
            timestamp: new Date().toISOString()
        };

        console.log('ğŸš€ é€ä¿¡ãƒ‡ãƒ¼ã‚¿:', requestData);
        
        const apiUrl = 'https://ai-whisky-sommelier.netlify.app/.netlify/functions/claude-api';
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('âŒ HTTP Error:', response.status, errorText);
            throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('âœ… æˆåŠŸãƒ¬ã‚¹ãƒãƒ³ã‚¹:', result);

        // è€ƒãˆä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        thinkingMessage.remove();

        if (result.success) {
            // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‹ã‚‰AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å–å¾—
            const aiMessage = result.data.choices?.[0]?.message?.content || 
                            result.data.content?.[0]?.text ||
                            'ã™ã¿ã¾ã›ã‚“ã€å¿œç­”ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚';
            
            // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const responseMessage = document.createElement('div');
            responseMessage.className = 'chat-message ai-message';
            responseMessage.textContent = aiMessage;
            chatHistoryDiv.appendChild(responseMessage);

            // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
            chatHistory.push({
                type: 'ai',
                message: aiMessage,
                timestamp: new Date()
            });

            // ãƒãƒ£ãƒƒãƒˆæ¨è–¦ã‹ã‚‰å®Ÿéš›ã®JSONéŠ˜æŸ„ã‚’æ¤œç´¢ã—ã¦AIææ¡ˆã«åæ˜ 
            await processAIRecommendationFromChat(aiMessage);

        } else {
            throw new Error(result.error || 'APIå¿œç­”ã‚¨ãƒ©ãƒ¼');
        }

    } catch (error) {
        console.error('âŒ AIå¿œç­”å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        
        // è€ƒãˆä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
        if (thinkingMessage.parentNode) {
            thinkingMessage.remove();
        }
        
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šç°¡å˜ãªAIå¿œç­”ã‚’ç”Ÿæˆ
        const fallbackResponse = generateSimpleAIResponse(message);
        const responseMessage = document.createElement('div');
        responseMessage.className = 'chat-message ai-message';
        responseMessage.textContent = fallbackResponse;
        chatHistoryDiv.appendChild(responseMessage);

        // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã«è¿½åŠ 
        chatHistory.push({
            type: 'ai',
            message: fallbackResponse,
            timestamp: new Date()
        });
    }

    // æ¨è–¦ã‚’æ›´æ–°
    generateAIRecommendations();
    
    // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
}

// ãƒãƒ£ãƒƒãƒˆæ¨è–¦ã‹ã‚‰ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’æŠ½å‡ºã—ã¦è¡¨ç¤ºã«åæ˜ ã™ã‚‹é–¢æ•°
async function processAIRecommendationFromChat(aiMessage) {
    try {
        console.log('ğŸ” AIæ¨è–¦ã‹ã‚‰ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’æŠ½å‡ºé–‹å§‹...');
        
        // AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’æŠ½å‡º
        const mentionedWhiskies = [];
        
        // ç¾åœ¨ã®whiskyDataã‹ã‚‰éŠ˜æŸ„åã‚’æ¤œç´¢
        whiskyData.forEach(whisky => {
            const whiskyName = whisky.name.toLowerCase();
            const aiMessageLower = aiMessage.toLowerCase();
            
            // éŠ˜æŸ„åã®éƒ¨åˆ†ä¸€è‡´ã‚’ç¢ºèª
            const nameParts = whiskyName.split(/[\sã€€å¹´]/);
            for (const part of nameParts) {
                if (part.length > 2 && aiMessageLower.includes(part)) {
                    if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                        mentionedWhiskies.push(whisky);
                    }
                    break;
                }
            }
        });
        
        console.log('ğŸ¥ƒ æŠ½å‡ºã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼:', mentionedWhiskies.map(w => w.name));
        
        if (mentionedWhiskies.length > 0) {
            // ç¾åœ¨ã®ä¾¡æ ¼ç¯„å›²ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;
            
            const filteredWhiskies = mentionedWhiskies.filter(whisky => {
                try {
                    const numericPrice = parseInt(whisky.price.replace(/[Â¥,]/g, '')) || 0;
                    return numericPrice >= minPrice && numericPrice <= maxPrice;
                } catch (err) {
                    return true;
                }
            });
            
            if (filteredWhiskies.length > 0) {
                // è¶³ã‚Šãªã„å ´åˆã¯ä»–ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã§è£œå®Œ
                const finalSelection = [...filteredWhiskies];
                if (finalSelection.length < 3) {
                    const additionalWhiskies = whiskyData.filter(w => {
                        try {
                            const numericPrice = parseInt(w.price.replace(/[Â¥,]/g, '')) || 0;
                            return numericPrice >= minPrice && 
                                   numericPrice <= maxPrice && 
                                   !finalSelection.find(selected => selected.name === w.name);
                        } catch (err) {
                            return false;
                        }
                    }).sort(() => 0.5 - Math.random());
                    
                    while (finalSelection.length < 3 && additionalWhiskies.length > 0) {
                        finalSelection.push(additionalWhiskies.pop());
                    }
                }
                
                // æ¨è–¦ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤ºã—ã¦æ›´æ–°
                document.getElementById('splitLayoutContainer').style.display = 'grid';
                displayLocalRecommendations(finalSelection);
                
                if (finalSelection.length > 0) {
                    selectWhisky(finalSelection[0]);
                }
                
                console.log('âœ… ãƒãƒ£ãƒƒãƒˆæ¨è–¦ã®çµ±åˆãŒå®Œäº†ã—ã¾ã—ãŸ');
            }
        }
        
    } catch (error) {
        console.error('âŒ ãƒãƒ£ãƒƒãƒˆæ¨è–¦å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// APIé€ä¿¡ç”¨ã®ãƒãƒ£ãƒƒãƒˆå±¥æ­´åé›†é–¢æ•°
function collectChatHistoryForAPI() {
    const chatHistoryDiv = document.getElementById('chatHistory');
    if (!chatHistoryDiv) return [];

    const messages = [];
    const messageElements = chatHistoryDiv.querySelectorAll('.chat-message');

    messageElements.forEach(element => {
        // è€ƒãˆä¸­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é™¤å¤–
        if (element.classList.contains('thinking-animation')) {
            return;
        }

        const content = element.textContent.trim();
        if (content && content !== '') {
            if (element.classList.contains('user-message')) {
                messages.push({
                    role: 'user',
                    content: content
                });
            } else if (element.classList.contains('ai-message')) {
                messages.push({
                    role: 'assistant',
                    content: content
                });
            }
        }
    });

    // ç›´è¿‘10ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã«åˆ¶é™ï¼ˆAPIã®åˆ¶é™å¯¾å¿œï¼‰
    return messages.slice(-10);
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¥½ã¿ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
function extractPreferencesFromMessage(message) {
if (!message) return {};

message = message.toLowerCase();
const preferences = {};

// ä¾¡æ ¼æ¡ä»¶ã®æŠ½å‡º
const maxPriceRegex = /([\d,]+)å††?(ä»¥ä¸‹|ã¾ã§|æœªæº€|ã‚ˆã‚Šå®‰ã„)/;
const minPriceRegex = /([\d,]+)å††?(ä»¥ä¸Š|ã‹ã‚‰|ã‚ˆã‚Šé«˜ã„)/;
const priceRangeRegex = /([\d,]+)å††?[ã€œï½-]+([\d,]+)å††?/;

// ä¾¡æ ¼ç¯„å›²ã®æŠ½å‡º
const priceRangeMatch = message.match(priceRangeRegex);
if (priceRangeMatch) {
const minPrice = parseInt(priceRangeMatch[1].replace(/,/g, ''));
const maxPrice = parseInt(priceRangeMatch[2].replace(/,/g, ''));
preferences.minPrice = minPrice;
preferences.maxPrice = maxPrice;
} else {
// æœ€ä½ä¾¡æ ¼ã®æŠ½å‡º
const minPriceMatch = message.match(minPriceRegex);
if (minPriceMatch) {
preferences.minPrice = parseInt(minPriceMatch[1].replace(/,/g, ''));
}

// æœ€é«˜ä¾¡æ ¼ã®æŠ½å‡º
const maxPriceMatch = message.match(maxPriceRegex);
if (maxPriceMatch) {
preferences.maxPrice = parseInt(maxPriceMatch[1].replace(/,/g, ''));
}
}

// åœ°åŸŸã®æŠ½å‡ºï¼ˆä¿®æ­£ç‰ˆï¼‰
if (message.includes('ã‚¢ã‚¤ãƒ©') || message.includes('islay')) {
preferences.region = 'Islay';
} else if (message.includes('ã‚¹ãƒšã‚¤ã‚µã‚¤ãƒ‰') || message.includes('speyside')) {
preferences.region = 'Speyside';
} else if (message.includes('ãƒã‚¤ãƒ©ãƒ³ãƒ‰') || message.includes('highland')) {
preferences.region = 'Highland';
} else if (message.includes('æ—¥æœ¬') || message.includes('ã‚¸ãƒ£ãƒ‘ãƒ³') || message.includes('ã‚¸ãƒ£ãƒ‘ãƒ‹ãƒ¼ã‚º') || 
message.includes('japan') || message.includes('japanese')) {
preferences.region = 'Japan';
}

// å‘³ã®å‚¾å‘ã®æŠ½å‡º
if (message.includes('ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼') || message.includes('ãƒ”ãƒ¼ãƒˆ') || message.includes('smoke')) {
preferences.tasteY = 0.8; // ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼æ–¹å‘
} else if (message.includes('ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼') || message.includes('fruity') || message.includes('æœå®Ÿ')) {
preferences.tasteY = 0.2; // ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼æ–¹å‘
}

if (message.includes('ãƒ˜ãƒ“ãƒ¼') || message.includes('heavy') || message.includes('é‡ã„')) {
preferences.tasteX = 0.8; // ãƒ˜ãƒ“ãƒ¼æ–¹å‘
} else if (message.includes('ãƒ©ã‚¤ãƒˆ') || message.includes('light') || message.includes('è»½ã„')) {
preferences.tasteX = 0.2; // ãƒ©ã‚¤ãƒˆæ–¹å‘
}

return preferences;
}

// æŠ½å‡ºã—ãŸå¥½ã¿ã«åŸºã¥ã„ã¦UIè¦ç´ ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateUIWithPreferences(preferences) {
try {
// ä¾¡æ ¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°
if (preferences.minPrice) {
const minSlider = document.getElementById('minPrice');
if (minSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.minPrice / 1000)));
minSlider.value = value;
const minPriceDisplay = document.getElementById('minPriceDisplay');
if (minPriceDisplay) {
minPriceDisplay.textContent = `Â¥${value},000`;
}
}
}

if (preferences.maxPrice) {
const maxSlider = document.getElementById('maxPrice');
if (maxSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.maxPrice / 1000)));
maxSlider.value = value;
const maxPriceDisplay = document.getElementById('maxPriceDisplay');
if (maxPriceDisplay) {
maxPriceDisplay.textContent = `Â¥${value},000`;
}
}
}

// å‘³è¦šãƒãƒˆãƒªã‚¯ã‚¹ã®æ›´æ–°
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');

if (preferences.tasteX !== undefined && dot1) {
dot1.style.left = `${preferences.tasteX * 100}%`;
}

if (preferences.tasteY !== undefined && dot1) {
dot1.style.top = `${preferences.tasteY * 100}%`;
}

if (preferences.complexityX !== undefined && dot2) {
dot2.style.left = `${preferences.complexityX * 100}%`;
}

if (preferences.complexityY !== undefined && dot2) {
dot2.style.top = `${preferences.complexityY * 100}%`;
}

// åº§æ¨™è¡¨ç¤ºã®æ›´æ–°
updateCoordinatesDisplay();
} catch (error) {
console.error('UIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
}
}

// åº§æ¨™è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCoordinatesDisplay() {
try {
// å››è±¡é™1ã®åº§æ¨™æ›´æ–°
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');
if (dot1 && coords1) {
const xCoord = (parseFloat(dot1.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot1.style.top) / 100).toFixed(2);
coords1.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}

// å››è±¡é™2ã®åº§æ¨™æ›´æ–°
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');
if (dot2 && coords2) {
const xCoord = (parseFloat(dot2.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot2.style.top) / 100).toFixed(2);
coords2.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}
} catch (error) {
console.error('åº§æ¨™è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
}
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
function clearChatHistory() {
const chatHistory = document.getElementById('chatHistory');
chatHistory.innerHTML = '';
chatHistory.style.display = 'none';
document.getElementById('chatInput').value = '';
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®è’¸ç•™æ‰€æƒ…å ±ã‚’æ›´æ–°ï¼ˆçµ±åˆJSONå¯¾å¿œï¼‰
function updateDistilleryInfo(whisky) {
try {
// çµ±åˆJSONã‹ã‚‰è’¸æºœæ‰€ã‚’å–å¾—
const distillery = getDistilleryForWhisky(whisky);

// è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
const distillerySection = document.getElementById('distillerySection');
distillerySection.classList.add('active');

if (distillery) {
console.log(`è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:`, distillery.name);

// ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆLeaflet.jsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿ï¼‰
let mapInitialized = false;
if (typeof L !== 'undefined') {
if (!distilleryMap) {
mapInitialized = initializeCommonMap();
} else {
mapInitialized = true;
}

// ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã§ããŸå ´åˆã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
if (mapInitialized && distillery.location) {
try {
showDistilleryOnMap(distillery);
} catch (e) {
console.warn('ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
}
}
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
showDistilleryInfo(distillery);
} else {
// è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
console.log('è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

// ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}

// ç°¡æ˜“æƒ…å ±ã‚’è¡¨ç¤º
document.getElementById('distilleryName').textContent = whisky.name || 'æƒ…å ±ãªã—';
document.getElementById('distilleryRegion').textContent = whisky.region || 'æƒ…å ±ãªã—';
document.getElementById('distilleryFounded').textContent = 'æƒ…å ±ãªã—';

const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = 'æƒ…å ±ãªã—';
statusElement.className = 'status-unknown';

document.getElementById('distilleryDescription').textContent = 
`${whisky.name}ã®è’¸ç•™æ‰€æƒ…å ±ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯${whisky.region || 'ä¸æ˜ãªåœ°åŸŸ'}ã§è£½é€ ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
}
} catch (error) {
console.error('è’¸ç•™æ‰€æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// è’¸æºœæ‰€ã‚’ãƒãƒƒãƒ—ã«è¡¨ç¤ºï¼ˆçµ±åˆJSONå¯¾å¿œãƒ»ä¿®æ­£ç‰ˆï¼‰
function showDistilleryOnMap(distillery) {
    if (!distilleryMap || !distillery.location) {
        console.log('ãƒãƒƒãƒ—ã¾ãŸã¯ä½ç½®æƒ…å ±ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return;
    }

    console.log('ãƒãƒƒãƒ—ã«è’¸æºœæ‰€ã‚’è¡¨ç¤º:', distillery);

    // ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’æ›´æ–°
    distilleryMap.setView([distillery.location.lat, distillery.location.lng], distillery.zoomLevel || 10);

    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†
    if (window.activeMarker) {
        distilleryMap.removeLayer(window.activeMarker);
    }
    if (window.pulseMarker) {
        distilleryMap.removeLayer(window.pulseMarker);
        clearInterval(window.pulseInterval);
    }

    // æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
    distilleryMap.eachLayer(function(layer) {
        if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
            distilleryMap.removeLayer(layer);
        }
    });

    // ã™ã¹ã¦ã®è’¸æºœæ‰€ã‚’ã‚°ãƒªãƒ¼ãƒ³ã§è¡¨ç¤ºï¼ˆä¿®æ­£ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿æ§‹é€ ã«å¯¾å¿œï¼‰
    Object.keys(distilleryData).forEach(distilleryKey => {
        const dist = distilleryData[distilleryKey];
        console.log('ãƒãƒ¼ã‚«ãƒ¼ä½œæˆä¸­:', distilleryKey, dist);
        
        if (dist.location && dist.location.lat && dist.location.lng) {
            const marker = L.circleMarker([dist.location.lat, dist.location.lng], {
                radius: 6,
                fillColor: '#4ecdc4',  // ã‚°ãƒªãƒ¼ãƒ³
                color: '#4ecdc4',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
            }).addTo(distilleryMap);

            // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
            marker.on('click', function() {
                // ç¾åœ¨ã®è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
                const clickedDistillery = {
                    name: distilleryKey,
                    ...dist
                };

                // è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
                displayDistilleryInfo(clickedDistillery);

                // æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
                if (window.activeMarker) {
                    distilleryMap.removeLayer(window.activeMarker);
                }
                if (window.pulseMarker) {
                    distilleryMap.removeLayer(window.pulseMarker);
                    clearInterval(window.pulseInterval);
                }

                // æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                window.activeMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
                    radius: 10,
                    fillColor: '#ff6b6b',  // èµ¤
                    color: '#ff6b6b',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(distilleryMap);

                // ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
                window.pulseMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
                    radius: 15,
                    fillColor: 'rgba(255, 107, 107, 0.3)',
                    color: '#ff6b6b',
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 0.2
                }).addTo(distilleryMap);

                // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
                let currentRadius = 15;
                let growing = true;
                window.pulseInterval = setInterval(() => {
                    if (growing) {
                        currentRadius += 0.5;
                        if (currentRadius >= 25) growing = false;
                    } else {
                        currentRadius -= 0.5;
                        if (currentRadius <= 12) growing = true;
                    }
                    window.pulseMarker.setRadius(currentRadius);
                }, 100);

                // ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’æ›´æ–°
                distilleryMap.setView([dist.location.lat, dist.location.lng], 10);
            });

            // ãƒ›ãƒãƒ¼åŠ¹æœ
            marker.on('mouseover', function() {
                marker.setStyle({
                    radius: 8,
                    fillOpacity: 0.9
                });

                // ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
                marker.bindTooltip(distilleryKey, {
                    permanent: false,
                    direction: 'top',
                    className: 'distillery-tooltip'
                }).openTooltip();
            });

            marker.on('mouseout', function() {
                marker.setStyle({
                    radius: 6,
                    fillOpacity: 0.7
                });
            });
        }
    });

    // é¸æŠã•ã‚ŒãŸè’¸æºœæ‰€ã‚’èµ¤ã„ãƒ“ãƒ¼ã‚³ãƒ³ã§è¡¨ç¤º
    window.activeMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
        radius: 10,
        fillColor: '#ff6b6b',  // èµ¤
        color: '#ff6b6b',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(distilleryMap);

    // ãƒ“ãƒ¼ã‚³ãƒ³åŠ¹æœï¼ˆãƒ‘ãƒ«ã‚¹ï¼‰
    window.pulseMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
        radius: 15,
        fillColor: 'rgba(255, 107, 107, 0.3)',
        color: '#ff6b6b',
        weight: 1,
        opacity: 0.6,
        fillOpacity: 0.2
    }).addTo(distilleryMap);

    // ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let currentRadius = 15;
    let growing = true;
    window.pulseInterval = setInterval(() => {
        if (growing) {
            currentRadius += 0.5;
            if (currentRadius >= 25) growing = false;
        } else {
            currentRadius -= 0.5;
            if (currentRadius <= 12) growing = true;
        }
        window.pulseMarker.setRadius(currentRadius);
    }, 100);

    // ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
    setTimeout(function() {
        if (distilleryMap) {
            distilleryMap.invalidateSize();
        }
    }, 100);
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
function displayDistilleryInfo(distillery) {
// è’¸ç•™æ‰€åã¨åœ°åŸŸã‚’è¡¨ç¤º
document.getElementById('distilleryName').textContent = distillery.name || 'ä¸æ˜';
document.getElementById('distilleryRegion').textContent = distillery.region || 'ä¸æ˜';

// è¨­ç«‹å¹´
if (distillery.foundedYear) {
document.getElementById('distilleryFounded').textContent = distillery.foundedYear + 'å¹´';
} else {
document.getElementById('distilleryFounded').textContent = 'ä¸æ˜';
}

// çŠ¶æ…‹ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€é–‰é–ãªã©ï¼‰
const statusElement = document.getElementById('distilleryStatus');
const status = distillery.status || 'ä¸æ˜';
statusElement.textContent = status;

// èª¬æ˜æ–‡
document.getElementById('distilleryDescription').textContent = 
distillery.description || 'è’¸ç•™æ‰€ã®è©³ç´°æƒ…å ±ã¯æº–å‚™ä¸­ã§ã™ã€‚';

// æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
document.getElementById('distilleryInfoSection').style.display = 'block';
}

// çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°ï¼ˆä¿®æ­£ç‰ˆï¼‰
function updateStatistics() {
    if (!whiskyData || !whiskyData.length) return;

    // ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ç·æ•°
    document.getElementById('whiskyCount').textContent = whiskyData.length;
    animateCounter('totalWhiskies', whiskyData.length);

    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç”£åœ°æ•°
    const uniqueRegions = new Set();
    whiskyData.forEach(whisky => {
        if (whisky.region) {
            uniqueRegions.add(whisky.region.split(',')[0].trim());
        }
    });
    animateCounter('uniqueRegions', uniqueRegions.size);

    // è’¸æºœæ‰€æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆï¼ˆä¿®æ­£ï¼‰
    if (distilleryData && typeof distilleryData === 'object') {
        const distilleryCount = Object.keys(distilleryData).length;
        animateCounter('distilleryCount', distilleryCount);
        console.log('è’¸æºœæ‰€æ•°ã‚«ã‚¦ãƒ³ãƒˆ:', distilleryCount);
    }
}

// ä¾¡æ ¼å¸¯
let minPrice = Infinity;
let maxPrice = 0;

whiskyData.forEach(whisky => {
const price = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
if (price > 0) {
minPrice = Math.min(minPrice, price);
maxPrice = Math.max(maxPrice, price);
}
});

if (minPrice !== Infinity && maxPrice !== 0) {
document.getElementById('priceRange').textContent = `Â¥${formatPrice(minPrice)}ã€œÂ¥${formatPrice(maxPrice)}`;
}

// ä¾¡æ ¼ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatPrice(price) {
return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// AIæ¨è–¦ã‚’å–å¾—ï¼ˆå®Œå…¨ç‰ˆãƒ»çµ±ä¸€ç‰ˆï¼‰
async function getRecommendation() {
    try {
        // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }

        // å‘³è¦šåº§æ¨™ã®å–å¾—ï¼ˆå®‰å…¨ç‰ˆï¼‰
        const dot1 = document.getElementById('tasteDot1');
        const dot2 = document.getElementById('tasteDot2');
        
        let tasteX = 0.5, tasteY = 0.5, complexityX = 0.5, complexityY = 0.5;
        
        if (dot1 && dot1.style.left && dot1.style.top) {
            tasteX = parseFloat(dot1.style.left) / 100;
            tasteY = parseFloat(dot1.style.top) / 100;
        }
        
        if (dot2 && dot2.style.left && dot2.style.top) {
            complexityX = parseFloat(dot2.style.left) / 100;
            complexityY = parseFloat(dot2.style.top) / 100;
        }

        // ä¾¡æ ¼å¸¯ã®å–å¾—ï¼ˆå®‰å…¨ç‰ˆï¼‰
        const minPriceElement = document.getElementById('minPrice');
        const maxPriceElement = document.getElementById('maxPrice');
        const minPrice = minPriceElement ? parseInt(minPriceElement.value) * 1000 : 0;
        const maxPrice = maxPriceElement ? parseInt(maxPriceElement.value) * 1000 : 999999;

        console.log('ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—å®Œäº†:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice });
        console.log('ç¾åœ¨ã®é™¤å¤–ãƒªã‚¹ãƒˆ:', excludedWhiskies);

        // ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡ºã—ãŸå¥½ã¿ã¨ç¾åœ¨ã®UIå€¤ã‚’çµ±åˆ
        const combinedPreferences = {
            tasteX: savedUserPreferences.tasteX !== null ? savedUserPreferences.tasteX : tasteX,
            tasteY: savedUserPreferences.tasteY !== null ? savedUserPreferences.tasteY : tasteY,
            complexityX: savedUserPreferences.complexityX !== null ? savedUserPreferences.complexityX : complexityX,
            complexityY: savedUserPreferences.complexityY !== null ? savedUserPreferences.complexityY : complexityY,
            minPrice: savedUserPreferences.minPrice !== null ? savedUserPreferences.minPrice : minPrice,
            maxPrice: savedUserPreferences.maxPrice !== null ? savedUserPreferences.maxPrice : maxPrice,
            region: savedUserPreferences.region
        };

        console.log('æ¤œç´¢é–‹å§‹ - å¥½ã¿æƒ…å ±:', {
            savedPreferences: savedUserPreferences,
            combinedPreferences: combinedPreferences
        });

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤º
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        const progressContainer = document.getElementById('progressContainer');
        if (progressContainer) {
            progressContainer.style.display = 'block';
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’é€²è¡Œ
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress > 100) {
                clearInterval(progressInterval);
                const progressContainer = document.getElementById('progressContainer');
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }

                // ææ¡ˆçµæœã‚’è¡¨ç¤º
                showRecommendationResult(
                    combinedPreferences.tasteX, 
                    combinedPreferences.tasteY, 
                    combinedPreferences.complexityX, 
                    combinedPreferences.complexityY, 
                    combinedPreferences.minPrice, 
                    combinedPreferences.maxPrice, 
                    '',
                    combinedPreferences.region
                );
                return;
            }

            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressText = document.getElementById('progressText');

            if (progressFill) progressFill.style.width = `${progress}%`;
            if (progressPercentage) progressPercentage.textContent = `${progress}%`;

            if (progressText) {
                if (progress === 30) {
                    progressText.textContent = 'ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æä¸­...';
                } else if (progress === 60) {
                    progressText.textContent = 'æœ€é©ãªãƒãƒƒãƒãƒ³ã‚°ã‚’è¨ˆç®—ä¸­...';
                } else if (progress === 90) {
                    progressText.textContent = 'çµæœã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™...';
                }
            }
        }, 50);

        // å‘³ã®å‚¾å‘ã®èª¬æ˜ã‚’æ›´æ–°
        updateTasteDescription(
            combinedPreferences.tasteX, 
            combinedPreferences.tasteY, 
            combinedPreferences.complexityX, 
            combinedPreferences.complexityY
        );

        // ä¾¡æ ¼å¸¯ã®è¡¨ç¤ºã‚’æ›´æ–°
        const priceRangeElement = document.getElementById('priceRange');
        if (priceRangeElement) {
            priceRangeElement.textContent = 
                `Â¥${formatPrice(combinedPreferences.minPrice)} - Â¥${formatPrice(combinedPreferences.maxPrice)}`;
        }

    } catch (error) {
        console.error('Error getting recommendations:', error);
        const loadingIndicator = document.getElementById('loadingIndicator');
        const progressContainer = document.getElementById('progressContainer');
        
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (progressContainer) progressContainer.style.display = 'none';
        
        alert('ææ¡ˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
    }
}

// å‘³ã®å‚¾å‘ã®èª¬æ˜ã‚’æ›´æ–°
function updateTasteDescription(tasteX, tasteY, complexityX, complexityY) {
let tasteDesc = '';
let complexityDesc = '';

// åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘ã®èª¬æ˜
if (tasteX < 0.33) {
if (tasteY < 0.33) {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„';
}
} else if (tasteX > 0.66) {
if (tasteY < 0.33) {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„';
}
} else {
if (tasteY < 0.33) {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ';
}
}

// è¤‡é›‘ã•ã®å¥½ã¿ã®èª¬æ˜
if (complexityX < 0.33) {
if (complexityY < 0.33) {
complexityDesc = 'è‹¥ãã¦ã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'è‹¥ãã¦å¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'è‹¥ãã¦ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
} else if (complexityX > 0.66) {
if (complexityY < 0.33) {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸå¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
} else {
if (complexityY < 0.33) {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„å¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
}

// èª¬æ˜æ–‡ã‚’æ›´æ–°
document.getElementById('tasteDescription').textContent = tasteDesc;
document.getElementById('complexityDescription').textContent = complexityDesc;
}

// æ¨è–¦çµæœã‚’è¡¨ç¤ºï¼ˆãƒãƒ£ãƒƒãƒˆé€£æºå¼·åŒ–ç‰ˆï¼‰
async function showRecommendationResult(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, chatPreferences, region = null) {
    console.log('showRecommendationResult é–‹å§‹:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region });

    try {
        document.getElementById('splitLayoutContainer').style.display = 'grid';

        // ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’æœ€å„ªå…ˆã§å–å¾—
        const chatMentionedWhiskies = getChatMentionedWhiskies();
        console.log('ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„:', chatMentionedWhiskies.map(w => w.name));

        // ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ãƒãƒƒãƒãƒ³ã‚°
        console.log('findMatchingWhiskies å‘¼ã³å‡ºã—å‰...');
        const matchedWhiskies = findMatchingWhiskies(
            tasteX, tasteY, complexityX, complexityY, 
            minPrice, maxPrice, region, 
            excludedWhiskies
        );
        console.log('findMatchingWhiskies çµæœ:', matchedWhiskies);

        // ãƒãƒ£ãƒƒãƒˆè¨€åŠéŠ˜æŸ„ã‚’æœ€å„ªå…ˆã§çµ„ã¿åˆã‚ã›
        const finalRecommendations = combineRecommendations(chatMentionedWhiskies, matchedWhiskies, minPrice, maxPrice);
        console.log('æœ€çµ‚æ¨è–¦ãƒªã‚¹ãƒˆ:', finalRecommendations.map(w => w.name));

        if (!finalRecommendations || finalRecommendations.length === 0) {
            if (excludedWhiskies.length > 0) {
                console.log('é™¤å¤–ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è©¦è¡Œ');
                excludedWhiskies.length = 0;
                return showRecommendationResult(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, chatPreferences, region);
            }
            
            console.error('æ¨è–¦ã§ãã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            displayDefaultRecommendations();
            return;
        }

        console.log('displayLocalRecommendations å‘¼ã³å‡ºã—å‰...');
        displayLocalRecommendations(finalRecommendations);

        if (finalRecommendations.length > 0) {
            lastRecommendedWhisky = finalRecommendations[0];
            console.log('selectWhisky å‘¼ã³å‡ºã—å‰:', finalRecommendations[0]);
            selectWhisky(finalRecommendations[0]);
        }
    } catch (error) {
        console.error('showRecommendationResult ã‚¨ãƒ©ãƒ¼:', error);
        displayDefaultRecommendations();
    }
}

// ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getChatMentionedWhiskies() {
    const mentionedWhiskies = [];
    
    // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åé›†
    const chatMessages = document.querySelectorAll('.chat-message');
    const allChatText = Array.from(chatMessages)
        .map(msg => msg.textContent.toLowerCase())
        .join(' ');
    
    console.log('ãƒãƒ£ãƒƒãƒˆå†…å®¹ã‚’åˆ†æ:', allChatText);
    
    if (!allChatText) return mentionedWhiskies;
    
    // whiskyDataã‹ã‚‰éŠ˜æŸ„åã‚’æ¤œç´¢
    whiskyData.forEach(whisky => {
        const whiskyName = whisky.name.toLowerCase();
        const whiskyNameParts = whiskyName.split(/[\sã€€å¹´]/);
        
        // å®Œå…¨ä¸€è‡´ã‚’å„ªå…ˆ
        if (allChatText.includes(whiskyName)) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('å®Œå…¨ä¸€è‡´ã§ç™ºè¦‹:', whisky.name);
            }
            return;
        }
        
        // éƒ¨åˆ†ä¸€è‡´ï¼ˆãƒ–ãƒ©ãƒ³ãƒ‰åãªã©ï¼‰
        for (const part of whiskyNameParts) {
            if (part.length > 2 && allChatText.includes(part)) {
                if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                    mentionedWhiskies.push(whisky);
                    console.log('éƒ¨åˆ†ä¸€è‡´ã§ç™ºè¦‹:', whisky.name, '(ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰:', part, ')');
                }
                break;
            }
        }
        
        // ç‰¹åˆ¥ãªãƒ–ãƒ©ãƒ³ãƒ‰åã®å‡¦ç†ï¼ˆæ—¥æœ¬èªå¯¾å¿œï¼‰
        if (allChatText.includes('ãƒãƒƒã‚«ãƒ©ãƒ³') && whiskyName.includes('macallan')) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('ç‰¹åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ç™ºè¦‹:', whisky.name);
            }
        }
        
        // ãã®ä»–ã®ç‰¹åˆ¥ãªå¯¾å¿œ
        if (allChatText.includes('ã‚°ãƒ¬ãƒ³ãƒ•ã‚£ãƒ‡ã‚£ãƒƒã‚¯') && whiskyName.includes('glenfiddich')) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('ç‰¹åˆ¥ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§ç™ºè¦‹:', whisky.name);
            }
        }
    });
    
    return mentionedWhiskies;
}

// ãƒãƒ£ãƒƒãƒˆè¨€åŠéŠ˜æŸ„ã¨å‘³è¦šãƒãƒƒãƒãƒ³ã‚°éŠ˜æŸ„ã‚’çµ„ã¿åˆã‚ã›ã‚‹é–¢æ•°ï¼ˆé™¤å¤–æ©Ÿèƒ½å¼·åŒ–ç‰ˆï¼‰
function combineRecommendations(chatMentioned, matchedWhiskies, minPrice, maxPrice) {
    const finalList = [];
    
    console.log('æ¨è–¦çµ„ã¿åˆã‚ã›é–‹å§‹ - é™¤å¤–ãƒªã‚¹ãƒˆ:', excludedWhiskies);
    
    // 1. ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’æœ€å„ªå…ˆã§è¿½åŠ ï¼ˆé™¤å¤–ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
    const filteredChatMentioned = chatMentioned.filter(whisky => {
        // é™¤å¤–ãƒªã‚¹ãƒˆã«ãªã„ã‹ãƒã‚§ãƒƒã‚¯
        if (excludedWhiskies.includes(whisky.name)) {
            console.log('ãƒãƒ£ãƒƒãƒˆéŠ˜æŸ„ãŒé™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™:', whisky.name);
            return false;
        }
        
        // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
        try {
            const price = parseInt(whisky.price.replace(/[Â¥,]/g, ''));
            const inPriceRange = price >= minPrice && price <= maxPrice;
            if (!inPriceRange) {
                console.log('ãƒãƒ£ãƒƒãƒˆéŠ˜æŸ„ãŒä¾¡æ ¼ç¯„å›²å¤–:', whisky.name, price, 'ç¯„å›²:', minPrice, '-', maxPrice);
            }
            return inPriceRange;
        } catch (err) {
            console.error('ä¾¡æ ¼ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', whisky.name, err);
            return true;
        }
    });
    
    // ãƒãƒ£ãƒƒãƒˆè¨€åŠéŠ˜æŸ„ã‚’æœ€åˆã«è¿½åŠ 
    filteredChatMentioned.forEach(whisky => {
        if (!finalList.find(w => w.name === whisky.name)) {
            finalList.push(whisky);
            console.log('ãƒãƒ£ãƒƒãƒˆéŠ˜æŸ„ã‚’å„ªå…ˆè¿½åŠ :', whisky.name);
        }
    });
    
    // 2. å‘³è¦šãƒãƒƒãƒãƒ³ã‚°éŠ˜æŸ„ã§ä¸è¶³åˆ†ã‚’è£œå®Œï¼ˆé™¤å¤–ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
    if (finalList.length < 3) {
        const remainingSlots = 3 - finalList.length;
        const additionalWhiskies = matchedWhiskies.filter(whisky => {
            // æ—¢ã«å«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (finalList.find(w => w.name === whisky.name)) return false;
            
            // é™¤å¤–ãƒªã‚¹ãƒˆã«ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (excludedWhiskies.includes(whisky.name)) {
                console.log('å‘³è¦šãƒãƒƒãƒãƒ³ã‚°éŠ˜æŸ„ãŒé™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™:', whisky.name);
                return false;
            }
            
            return true;
        }).slice(0, remainingSlots);
        
        additionalWhiskies.forEach(whisky => {
            finalList.push(whisky);
            console.log('å‘³è¦šãƒãƒƒãƒãƒ³ã‚°éŠ˜æŸ„ã§è£œå®Œ:', whisky.name);
        });
    }
    
    // 3. ã¾ã è¶³ã‚Šãªã„å ´åˆã¯ã€ä¾¡æ ¼ç¯„å›²å†…ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‹ã‚‰è¿½åŠ ï¼ˆé™¤å¤–ãƒã‚§ãƒƒã‚¯å¼·åŒ–ï¼‰
    if (finalList.length < 3) {
        const remainingSlots = 3 - finalList.length;
        const additionalWhiskies = whiskyData.filter(whisky => {
            // æ—¢ã«å«ã¾ã‚Œã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (finalList.find(w => w.name === whisky.name)) return false;
            
            // é™¤å¤–ãƒªã‚¹ãƒˆã«ãªã„ã‹ãƒã‚§ãƒƒã‚¯
            if (excludedWhiskies.includes(whisky.name)) {
                console.log('è£œå®ŒéŠ˜æŸ„ãŒé™¤å¤–ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã¾ã™:', whisky.name);
                return false;
            }
            
            // ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            try {
                const price = parseInt(whisky.price.replace(/[Â¥,]/g, ''));
                return price >= minPrice && price <= maxPrice;
            } catch (err) {
                return true;
            }
        })
        .sort(() => 0.5 - Math.random()) // ãƒ©ãƒ³ãƒ€ãƒ ã‚½ãƒ¼ãƒˆ
        .slice(0, remainingSlots);
        
        additionalWhiskies.forEach(whisky => {
            finalList.push(whisky);
            console.log('ä¾¡æ ¼ç¯„å›²å†…éŠ˜æŸ„ã§è£œå®Œ:', whisky.name);
        });
    }
    
    // 4. ãã‚Œã§ã‚‚è¶³ã‚Šãªã„å ´åˆã¯é™¤å¤–ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¦å†è©¦è¡Œ
    if (finalList.length === 0 && excludedWhiskies.length > 0) {
        console.log('æ¨è–¦éŠ˜æŸ„ãŒ0ä»¶ã®ãŸã‚ã€é™¤å¤–ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™');
        excludedWhiskies.length = 0; // é…åˆ—ã‚’ã‚¯ãƒªã‚¢
        return combineRecommendations(chatMentioned, matchedWhiskies, minPrice, maxPrice);
    }
    
    console.log('æœ€çµ‚æ¨è–¦æ§‹æˆ:', finalList.map(w => w.name));
    console.log('ç¾åœ¨ã®é™¤å¤–ãƒªã‚¹ãƒˆ:', excludedWhiskies);
    return finalList;
}

// ãƒãƒƒãƒã™ã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
function findMatchingWhiskies(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region = null, excludedNames = []) {
    console.log('findMatchingWhiskies é–‹å§‹:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region, excludedNames });
    console.log('whiskyData ã®çŠ¶æ…‹:', whiskyData ? `${whiskyData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š` : 'ãƒ‡ãƒ¼ã‚¿ãªã—');

    if (!whiskyData || whiskyData.length === 0) {
        console.error('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return [];
    }

    try {
        // ä¾¡æ ¼ã‚’æ•°å€¤ã«å¤‰æ›
        const whiskiesWithNumericPrice = whiskyData.map(whisky => {
            try {
                const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
                return { ...whisky, numericPrice };
            } catch (err) {
                console.error('ä¾¡æ ¼å¤‰æ›ã‚¨ãƒ©ãƒ¼:', whisky, err);
                return { ...whisky, numericPrice: 0 };
            }
        });
        console.log('ä¾¡æ ¼å¤‰æ›å¾Œ:', `${whiskiesWithNumericPrice.length}ä»¶`);

        // **æ–°è¦è¿½åŠ ï¼šé™¤å¤–ãƒªã‚¹ãƒˆã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°**
        const excludeFiltered = whiskiesWithNumericPrice.filter(whisky => {
            const isExcluded = excludedNames.includes(whisky.name);
            if (isExcluded) {
                console.log('é™¤å¤–:', whisky.name);
            }
            return !isExcluded;
        });
        console.log('é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', `${excludeFiltered.length}ä»¶`);

        // ä¾¡æ ¼å¸¯ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆé™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ï¼‰
        const priceFiltered = excludeFiltered.filter(
            whisky => whisky.numericPrice >= minPrice && whisky.numericPrice <= maxPrice
        );
        console.log('ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', `${priceFiltered.length}ä»¶`);

        // åœ°åŸŸã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
        let regionFiltered = priceFiltered;
        if (region) {
            console.log(`åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: "${region}" ã‚’æ¤œç´¢ä¸­...`);

            // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®åœ°åŸŸæƒ…å ±ã‚’è¡¨ç¤º
            console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿åœ°åŸŸæƒ…å ±:');
            priceFiltered.slice(0, 5).forEach(w => console.log(`- ${w.name}: region=${w.region}, subcategory=${w.subcategory}`));

            // åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
            regionFiltered = priceFiltered.filter(whisky => 
                (whisky.region && whisky.region.toLowerCase().includes(region.toLowerCase())) ||
                (whisky.subcategory && whisky.subcategory.toLowerCase().includes(region.toLowerCase())) ||
                (region.toLowerCase() === 'japan' && whisky.name && (
                    whisky.name.toLowerCase().includes('japan') ||
                    whisky.name.toLowerCase().includes('japanese') ||
                    whisky.name.toLowerCase().includes('è»½äº•æ²¢') ||
                    whisky.name.toLowerCase().includes('å±±å´') ||
                    whisky.name.toLowerCase().includes('ç™½å·') ||
                    whisky.name.toLowerCase().includes('éŸ¿') ||
                    whisky.name.toLowerCase().includes('é•·æ¿±')
                ))
            );
            console.log('åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', `${regionFiltered.length}ä»¶`);

            // çµæœãŒãªã„å ´åˆã¯ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ã®ã¿é©ç”¨
            if (regionFiltered.length === 0) {
                console.log('åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çµæœãŒ0ä»¶ã®ãŸã‚ã€ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ã®ã¿ã‚’é©ç”¨ã—ã¾ã™');
                regionFiltered = priceFiltered;
            }
        }

        if (regionFiltered.length === 0) {
            // **ä¿®æ­£ï¼šé™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨**
            console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœãŒ0ä»¶ã®ãŸã‚ã€é™¤å¤–ãƒ•ã‚£ãƒ«ã‚¿æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸æŠã—ã¾ã™');
            return excludeFiltered.slice(0, 3);
        }

        // å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæº–
        console.log('å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæº–ã‚’è¨­å®š...');
        const targetFruity = tasteY < 0.5 ? 4 : 2;
        const targetSmoky = tasteY > 0.5 ? 4 : 2;
        const targetBody = tasteX > 0.5 ? 4 : 3;
        const targetComplexity = complexityX > 0.5 ? 4 : 3;
        console.log('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€¤:', { targetFruity, targetSmoky, targetBody, targetComplexity });

// ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°
function scoreWhisky(whisky) {
try {
if (!whisky.taste_profile) {
console.log(`${whisky.name}: taste_profileãªã—`);
return 0;
}

const fruityScore = 5 - Math.abs((whisky.taste_profile.fruity || 0) - targetFruity);
const smokyScore = 5 - Math.abs((whisky.taste_profile.smoky || 0) - targetSmoky);
const bodyScore = 5 - Math.abs((whisky.taste_profile.body || 0) - targetBody);
const complexityScore = 5 - Math.abs((whisky.taste_profile.complexity || 0) - targetComplexity);

return fruityScore + smokyScore + bodyScore + complexityScore;
} catch (err) {
console.error('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', whisky, err);
return 0;
}
}

// ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
console.log('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–‹å§‹...');
const scored = regionFiltered.map(whisky => {
try {
return {
whisky: whisky,
score: scoreWhisky(whisky)
};
} catch (err) {
console.error('ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', whisky, err);
return { whisky: whisky, score: 0 };
}
}).sort((a, b) => b.score - a.score);

console.log('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Œäº†ã€‚ä¸Šä½ã‚¹ã‚³ã‚¢:');
scored.slice(0, 5).forEach(item => console.log(`- ${item.whisky.name}: ${item.score}`));

// ä¸Šä½3ã¤ã‚’è¿”ã™
const result = scored.slice(0, 3).map(item => item.whisky);
console.log('æœ€çµ‚çµæœ:', result.map(w => w.name));
return result;
} catch (error) {
console.error('findMatchingWhiskies ã‚¨ãƒ©ãƒ¼:', error);
console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
return [];
}
}

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ææ¡ˆã‚’è¡¨ç¤ºï¼ˆãƒãƒ£ãƒƒãƒˆå¼·èª¿ç‰ˆï¼‰
function displayLocalRecommendations(whiskies) {
    console.log('displayLocalRecommendations é–‹å§‹:', whiskies);

    try {
        const recommendationContent = document.getElementById('recommendationContent');
        if (!recommendationContent) {
            console.error('recommendationContent è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
            return;
        }

        recommendationContent.innerHTML = '';

        if (!whiskies || whiskies.length === 0) {
            console.error('è¡¨ç¤ºã™ã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
            displayDefaultRecommendations();
            return;
        }

        // ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’å–å¾—ï¼ˆå¼·èª¿è¡¨ç¤ºç”¨ï¼‰
        const chatMentioned = getChatMentionedWhiskies().map(w => w.name);

        whiskies.forEach((whisky, index) => {
            try {
                console.log(`ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ä½œæˆ ${index}:`, whisky.name);

                const whiskeyCard = document.createElement('div');
                whiskeyCard.className = 'whisky-card';
                
                // ãƒãƒ£ãƒƒãƒˆã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã¯ç‰¹åˆ¥ãªå¼·èª¿è¡¨ç¤º
                const isChatMentioned = chatMentioned.includes(whisky.name);
                
                if (index === 0) {
                    whiskeyCard.classList.add('featured', 'selected');
                }
                
                if (isChatMentioned) {
                    whiskeyCard.classList.add('chat-mentioned');
                }

                // HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
                function escapeHtml(text) {
                    if (text === undefined || text === null) return '';
                    return String(text)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }

                // å®‰å…¨ãªHTMLã®ä½œæˆ
                whiskeyCard.innerHTML = `
                    ${index === 0 ? '<div class="featured-label">ãŠã™ã™ã‚</div>' : ''}
                    ${isChatMentioned ? '<div class="chat-label">ğŸ¯ ãƒãƒ£ãƒƒãƒˆæ¨è–¦</div>' : ''}
                    <div class="flex justify-between mb-2">
                        <h3 class="text-lg font-bold text-cyan-400">${escapeHtml(whisky.name)}</h3>
                        <span class="text-pink-500 font-bold">${escapeHtml(whisky.price)}</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-gray-400 text-sm">
                            ${escapeHtml(whisky.region || 'N/A')} | ${escapeHtml(whisky.subcategory || 'Whisky')}
                            ${whisky.abv ? ` | ${whisky.abv}% ABV` : ''}
                        </span>
                    </div>
                    <p class="text-sm mb-3 text-left">${escapeHtml(whisky.tastingNote_ja || 'æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')}</p>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <span class="block text-yellow-400">ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼</span>
                            <span class="block">${'â˜…'.repeat((whisky.taste_profile?.fruity || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.fruity || 0))}</span>
                        </div>
                        <div>
                            <span class="block text-yellow-400">ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼</span>
                            <span class="block">${'â˜…'.repeat((whisky.taste_profile?.smoky || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.smoky || 0))}</span>
                        </div>
                        <div>
                            <span class="block text-yellow-400">è¤‡é›‘ã•</span>
                            <span class="block">${'â˜…'.repeat((whisky.taste_profile?.complexity || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.complexity || 0))}</span>
                        </div>
                    </div>
                `;

                // ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
                whiskeyCard.addEventListener('click', function() {
                    document.querySelectorAll('.whisky-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    whiskeyCard.classList.add('selected');
                    selectWhisky(whisky);
                });

                recommendationContent.appendChild(whiskeyCard);
            } catch (err) {
                console.error(`ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ ${index} ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:`, err);
            }
        });
    } catch (error) {
        console.error('displayLocalRecommendations ã‚¨ãƒ©ãƒ¼:', error);
        displayDefaultRecommendations();
    }
}



// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ææ¡ˆã‚’è¡¨ç¤º
function displayDefaultRecommendations() {
const recommendationContent = document.getElementById('recommendationContent');
recommendationContent.innerHTML = `
               <div class="text-center p-4">
                   <p class="mb-4">ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ç¾åœ¨ææ¡ˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚</p>
                   <p>åˆ¥ã®å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠè©¦ã—ã„ãŸã ãã‹ã€ãƒãƒ£ãƒƒãƒˆã§ãŠå¥½ã¿ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</p>
               </div>
           `;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
function getUserProfile() {
// å‘³è¦šåº§æ¨™ã®å–å¾—
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');
const tasteX = parseFloat(dot1.style.left) / 100;
const tasteY = parseFloat(dot1.style.top) / 100;
const complexityX = parseFloat(dot2.style.left) / 100;
const complexityY = parseFloat(dot2.style.top) / 100;

// åº§æ¨™ã‹ã‚‰å„æŒ‡æ¨™ã®å€¤ï¼ˆ0-5ï¼‰ã‚’è¨ˆç®—
const fruity = Math.round(5 * (1 - tasteY));
const smoky = Math.round(5 * tasteY);
const body = Math.round(5 * tasteX);
const spicy = Math.round(2.5 * (tasteX + tasteY));
const sweetness = Math.round(2.5 * (2 - tasteX - tasteY));
const complexity = Math.round(5 * complexityX);

return {
fruity,
spicy,
body,
smoky,
sweetness,
complexity
};
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼é¸æŠæ™‚ã®å‡¦ç†ï¼ˆãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼å¯¾å¿œç‰ˆï¼‰
function selectWhisky(whisky) {
// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
updateProfileChart(whisky.taste_profile, whisky.name);

try {
// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒãƒƒãƒ—é–¢é€£ã®å‡¦ç†ã‚’ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
if (typeof updateDistilleryInfo === 'function') {
updateDistilleryInfo(whisky);
} else {
console.warn('updateDistilleryInfoé–¢æ•°ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€è’¸ç•™æ‰€æƒ…å ±ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“');
// ä»£æ›¿ã®å‡¦ç†ï¼ˆç°¡æ˜“çš„ãªè’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºï¼‰
showSimpleDistilleryInfo(whisky);
}
} catch (err) {
console.error('è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
// ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
showSimpleDistilleryInfo(whisky);
}

// ãƒãƒ£ãƒ¼ãƒˆãƒ‘ãƒãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã‚’æ”¹å–„
const chartPanel = document.getElementById('chartPanel');
if (chartPanel) {
// 1. ãƒ‘ãƒãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸Šéƒ¨ã«è¨­å®š
chartPanel.scrollTop = 0;

// 2. ãƒ¢ãƒã‚¤ãƒ«ãªã©å°ã•ã„ç”»é¢ã‚µã‚¤ã‚ºã§ã¯ã€ãƒ‘ãƒãƒ«è‡ªä½“ã‚‚è¦–ç•Œã«å…¥ã‚Œã‚‹
if (window.innerWidth <= 1024) {
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
} else {
// PCã‚µã‚¤ã‚ºã®å ´åˆã¯ã€ãƒ‘ãƒãƒ«ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
// ã—ã‹ã—ã€æ€¥æ¿€ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã¯ãªãã‚¹ãƒ ãƒ¼ã‚ºã«
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
}
}

// è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºé–¢æ•°ï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
function showSimpleDistilleryInfo(whisky) {
try {
// è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
const distillerySection = document.getElementById('distillerySection');
if (distillerySection) {
distillerySection.classList.add('active');
}

// è’¸ç•™æ‰€åã®æ¨æ¸¬
let distilleryName = "æƒ…å ±ãªã—";
if (whisky.name && whisky.name.includes('è»½äº•æ²¢')) {
distilleryName = "è»½äº•æ²¢è’¸æºœæ‰€";
} else if (whisky.name && whisky.name.includes('å±±å´')) {
distilleryName = "å±±å´è’¸æºœæ‰€";
} else if (whisky.name && whisky.name.includes('ç™½å·')) {
distilleryName = "ç™½å·è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Japan')) {
distilleryName = "æ—¥æœ¬ã®è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Islay')) {
distilleryName = "ã‚¢ã‚¤ãƒ©å³¶ã®è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Speyside')) {
distilleryName = "ã‚¹ãƒšã‚¤ã‚µã‚¤ãƒ‰ã®è’¸æºœæ‰€";
} else if (whisky.region) {
distilleryName = `${whisky.region}ã®è’¸æºœæ‰€`;
}

// è’¸ç•™æ‰€æƒ…å ±ã®è¡¨ç¤ºï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
const distilleryNameElement = document.getElementById('distilleryName');
if (distilleryNameElement) {
distilleryNameElement.textContent = distilleryName;
distilleryNameElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const distilleryRegionElement = document.getElementById('distilleryRegion');
if (distilleryRegionElement) {
distilleryRegionElement.textContent = whisky.region || 'æƒ…å ±ãªã—';
distilleryRegionElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const distilleryFoundedElement = document.getElementById('distilleryFounded');
if (distilleryFoundedElement) {
distilleryFoundedElement.textContent = 'æƒ…å ±ãªã—';
distilleryFoundedElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const statusElement = document.getElementById('distilleryStatus');
if (statusElement) {
statusElement.textContent = 'æƒ…å ±ãªã—';
statusElement.className = 'status-unknown';
statusElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

// è’¸ç•™æ‰€ã®èª¬æ˜ï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
const distilleryDescriptionElement = document.getElementById('distilleryDescription');
if (distilleryDescriptionElement) {
distilleryDescriptionElement.textContent = 
`${whisky.name}ã®è’¸ç•™æ‰€æƒ…å ±ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯${whisky.region || 'ä¸æ˜ãªåœ°åŸŸ'}ã§è£½é€ ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
distilleryDescriptionElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

// æƒ…å ±ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã‚‚å·¦å¯„ã›ã«
const distilleryInfoGrid = document.querySelector('.distillery-info-grid');
if (distilleryInfoGrid) {
distilleryInfoGrid.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

} catch (err) {
console.error('ç°¡æ˜“è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
}
}

// ãƒãƒƒãƒ—åˆæœŸåŒ–
function initializeCommonMap() {
const mapElement = document.getElementById('distilleryMap');
if (!mapElement) return;

console.log('Initializing map with dark theme...');

// æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
if (distilleryMap) {
distilleryMap.remove();
}

// æ–°ã—ã„ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆï¼ˆæš—ã„ãƒ†ãƒ¼ãƒï¼‰
distilleryMap = L.map('distilleryMap', {
center: [55.0, -3.0],  // ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ä¸­å¿ƒ
zoom: 5,
zoomControl: false
});

// æš—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
subdomains: 'abcd',
maxZoom: 19
}).addTo(distilleryMap);

// ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³ä¸‹ã«
L.control.zoom({
position: 'bottomright'
}).addTo(distilleryMap);

// ã‚µã‚¤ã‚ºã‚’æ›´æ–°
setTimeout(() => {
distilleryMap.invalidateSize();
}, 100);

console.log('Map initialized with dark theme.');
return true;
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆå®‰å…¨ç‰ˆï¼‰
function showDistilleryInfo(distillery) {
if (!distillery) return;

try {
// åœ°å›³ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
if (distilleryMap && typeof distilleryMap.setView === 'function' && 
distillery.location && distillery.location.lat && distillery.location.lng) {
// åœ°å›³ã‚’ã‚ºãƒ¼ãƒ ã—ã¦è©²å½“è’¸ç•™æ‰€ã®ä½ç½®ã‚’ä¸­å¿ƒã«
const zoomLevel = distillery.zoomLevel || 8;
distilleryMap.setView([distillery.location.lat, distillery.location.lng], zoomLevel);

// ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'block';
}
} else {
// ãƒãƒƒãƒ—ãŒä½¿ç”¨ä¸å¯ã®å ´åˆã¯éè¡¨ç¤ºã«
console.warn('ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€è’¸ç•™æ‰€ã®ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}

// è’¸ç•™æ‰€æƒ…å ±ã®è¡¨ç¤ºã‚’æ›´æ–°
document.getElementById('distilleryName').textContent = distillery.name || 'æƒ…å ±ãªã—';
document.getElementById('distilleryRegion').textContent = distillery.region || 'æƒ…å ±ãªã—';
document.getElementById('distilleryFounded').textContent = distillery.foundedYear ? distillery.foundedYear + 'å¹´' : 'æƒ…å ±ãªã—';

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è¨­å®š
const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = distillery.status || 'æƒ…å ±ãªã—';
statusElement.className = '';  // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ

if (distillery.status) {
if (distillery.status.includes('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–') || distillery.status.includes('ç¨¼åƒä¸­')) {
statusElement.classList.add('status-active');
} else if (distillery.status.includes('é–‰é–')) {
statusElement.classList.add('status-closed');
} else {
statusElement.classList.add('status-unknown');
}
}

// è’¸ç•™æ‰€ã®èª¬æ˜ã‚’æ›´æ–°
document.getElementById('distilleryDescription').textContent = distillery.description || 'è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
} catch (error) {
console.error('è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);

// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã¨é¸æŠã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é‡ã­ã¦è¡¨ç¤ºï¼‰
function updateProfileChart(profile, name) {
if (!profile) return;

const ctx = document.getElementById('combinedProfileChart');
if (!ctx) return;

const chartTitle = document.getElementById('chartTitle');
chartTitle.textContent = name ? `ã‚ãªãŸã®å¥½ã¿ vs ${name}` : 'ã‚ãªãŸã®å¥½ã¿';

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
const userProfile = getUserProfile();

// Canvasã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®š
ctx.style.width = '100%';
ctx.style.height = '320px';
ctx.width = ctx.offsetWidth;
ctx.height = 320;

// Chart.jsã®è¨­å®š
const chartOptions = {
plugins: {
legend: {
display: true,
position: 'bottom',
labels: {
color: 'rgba(255, 255, 255, 0.8)',
font: {
size: 14
}
}
},
tooltip: {
enabled: true
}
},
scales: {
r: {
angleLines: {
color: 'rgba(255, 255, 255, 0.1)'
},
grid: {
color: 'rgba(255, 255, 255, 0.1)'
},
pointLabels: {
font: {
size: 16
},
color: 'rgba(255, 255, 255, 0.9)'
},
ticks: {
display: false,
backdropColor: 'transparent'
},
beginAtZero: true,
min: 0,
max: 5
}
},
maintainAspectRatio: false,
responsive: true
};

// ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æº–å‚™ï¼ˆ2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è¡¨ç¤ºï¼‰
const datasets = [
{
label: 'ã‚ãªãŸã®å¥½ã¿',
data: [
userProfile.fruity, 
userProfile.spicy, 
userProfile.body, 
userProfile.smoky, 
userProfile.sweetness, 
userProfile.complexity
],
backgroundColor: 'rgba(78, 205, 196, 0.2)',
borderColor: '#4ecdc4',
pointBackgroundColor: '#4ecdc4',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#4ecdc4',
fill: true
}
];

// é¸æŠã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¿½åŠ 
if (name) {
datasets.push({
label: name,
data: [
profile.fruity || 0,
profile.spicy || 0,
profile.body || 0,
profile.smoky || 0,
profile.sweetness || 0,
profile.complexity || 0
],
backgroundColor: 'rgba(255, 107, 107, 0.2)',
borderColor: '#ff6b6b',
pointBackgroundColor: '#ff6b6b',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#ff6b6b',
fill: true
});
}

// Chart.jsã®æ›´æ–°ã¾ãŸã¯ä½œæˆ
if (profileChartInstance) {
// æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„ã—ã¦ã‹ã‚‰å†ä½œæˆ
profileChartInstance.destroy();
}

// æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
profileChartInstance = new Chart(ctx, {
type: 'radar',
data: {
labels: ['ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼', 'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼', 'ãƒœãƒ‡ã‚£', 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼', 'ç”˜ã•', 'è¤‡é›‘ã•'],
datasets: datasets
},
options: chartOptions
});

console.log('Radar chart updated with new data');
}

// é€šçŸ¥ã‚’è¡¨ç¤º
function showNotification(message) {
const notification = document.createElement('div');
notification.className = 'error-notification';

notification.innerHTML = `
               <div class="notification-content">
                   <div class="notification-icon">
                       <i class="fas fa-exclamation-circle"></i>
                   </div>
                   <div class="notification-message">
                       ${message}
                   </div>
                   <button class="notification-close">&times;</button>
               </div>
           `;

document.body.appendChild(notification);

// é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
notification.querySelector('.notification-close').addEventListener('click', function() {
notification.remove();
});

// 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
setTimeout(function() {
if (notification.parentNode) {
notification.remove();
}
}, 5000);
}

// ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºé–¢æ•°
function showError(message) {
console.error('Error:', message);
// å¿…è¦ã«å¿œã˜ã¦è¿½åŠ ã®ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«è¿½åŠ 
}

</script>


<script id="html_badge_script1">
window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
"remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3%2FDuBA6s%2F4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE%2FG0eL9qcC2PHM%2FfezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4%2B0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c%2BiEGpY7DMnGKNiptaLE9nF%2BYMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP%2Fhc2Wel1QtoQ08mJNhlTFLw%2F66U%2FBoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2%2Bu5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk%2F1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g%3D%3D";
window.__genspark_locale = "ja-JP";
window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3/DuBA6s/4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE/G0eL9qcC2PHM/fezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4+0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c+iEGpY7DMnGKNiptaLE9nF+YMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP/hc2Wel1QtoQ08mJNhlTFLw/66U/BoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2+u5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk/1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g==";
</script>

<script id="html_notice_dialog_script" src="./index_files/notice_dialog.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"></script>
<!-- ãƒšãƒ¼ã‚¸æœ«å°¾ã«è¿½åŠ  -->
<script type="text/javascript">
function openGoogleTranslate() {
const currentUrl = window.location.href;
const translateUrl = `https://translate.google.com/translate?sl=auto&u=${encodeURIComponent(currentUrl)}`;
window.open(translateUrl, '_blank');
}
</script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>