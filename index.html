<!DOCTYPE html>
<!-- saved from url=(0130)https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse_LBd2w0vdTtOf_OswSt8juA/whisky_sommelier_final.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- HTMLのheadタグ内にGoogle Fontsのリンクを追加 -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>昼の月。AIソムリエ</title>
<link href="./index_files/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="./index_files/all.min.css">
<script src="./index_files/chart.js.ダウンロード"></script>
<!-- Leaflet.js地図ライブラリ -->
<link rel="stylesheet" href="./index_files/leaflet.css" crossorigin="">
<script src="./index_files/leaflet.js.ダウンロード" crossorigin=""></script>
<style>
body {
background-color: #000;
color: #fff;
font-family: 'Noto Sans JP', sans-serif;
}
.header-container {
background: rgba(0, 0, 0, 0.9);
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
padding: 15px 0;
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 1000;
display: flex;
align-items: center;
justify-content: center;
}
.logo {
width: 90px;
height: 90px;
object-fit: contain;
border-radius: 8px;
background: rgba(78, 205, 197, 0);
border: 2px solid #4ecdc500;
padding: 5px;
}

/* タイトルのスタイルを変更 */
.header-title {
color: #fff;
font-size: 28px;
font-weight: bold;
text-align: center;
margin: 0;
text-shadow: 0 0 10px rgba(78, 205, 196, 0.7);
letter-spacing: 2px;
background: linear-gradient(45deg, #ffffff, #4ecdc4);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
position: relative;
}

.header-title:after {
content: "";
position: absolute;
bottom: -5px;
left: 50%;
transform: translateX(-50%);
width: 70%;
height: 1px;
background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.7), transparent);
}

@keyframes glow {
from {
text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
}
to {
text-shadow: 0 0 15px rgba(78, 205, 196, 0.8), 0 0 20px rgba(255, 107, 107, 0.5);
}
}

/* 翻訳ボタンのスタイル */
.translate-link {
display: flex;
align-items: center;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 4px;
padding: 5px 10px;
margin-left: 10px;
transition: all 0.3s ease;
}

.translate-link:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-2px);
}

.translate-icon {
margin-right: 6px;
}

/* 言語リンクのスタイル */
.language-links {
display: flex;
margin-left: 15px;
}

.language-links .nav-link {
margin-left: 10px;
font-size: 14px;
padding: 5px 8px;
}

/* ヘッダーナビゲーションのスタイル修正 - 右端に配置 */
.nav-links {
position: absolute;
right: 20px;
display: flex;
gap: 15px;
}

.nav-link {
color: rgba(255, 255, 255, 0.8);
text-decoration: none;
font-size: 15px;
font-weight: 600;
transition: all 0.2s ease;
padding: 5px 10px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.05);
}

.nav-link:hover {
color: #fff;
background: rgba(78, 205, 196, 0.2);
}

.nav-link.active {
color: #fff;
background: rgba(78, 205, 196, 0.3);
border-bottom: 2px solid #4ecdc4;
}

/* レスポンシブ対応 - スマホ画面で重なり回避 */
@media (max-width: 768px) {
  /* ヘッダーの高さを増やして余裕を持たせる */
  .header-container {
    padding: 15px 0 30px; /* 下部に余白を追加 */
    flex-wrap: wrap;      /* 折り返しを許可 */
  }
  
  /* ロゴサイズ調整 */
  .logo {
    width: 90px;
    height: 90px;
  }
  
  /* タイトルを調整 */
  .header-title {
    font-size: 24px;
    margin: 0 auto 10px;
    width: 100%;
    text-align: center;
  }
  
  /* ナビゲーションをヘッダー下部に移動して中央揃え */
  .nav-links {
    position: relative;
    top: 10px;
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .nav-link {
    font-size: 13px;
    padding: 4px 8px;
  }

  .language-links {
    margin-top: 10px;
    width: 100%;
    justify-content: center;
  }
}

.container-custom {
max-width: 1200px;
margin: 0 auto;
padding: 100px 20px 20px;
}

/* レスポンシブ対応 - スマホ画面で重なり回避 */
@media (max-width: 768px) {
  /* ヘッダーを大幅にコンパクト化 */
  .header-container {
    padding: 5px 0 20px; /* さらに小さく：上5px、下20px */
    flex-wrap: wrap;
    min-height: auto; /* 最小高さを自動に */
  }
  
  /* ロゴをさらに小さく */
  .logo {
    width: 70px; /* さらに小さく */
    height: 70px;
  }
  
/* ロゴの位置調整 - 最も左上に */
.header-container a[target="_blank"] {
  position: absolute;
  left: -10px;   /* さらに左に */
  top: 0px;    /* 最上部に */
}
  
  /* タイトルをさらに小さく */
  .header-title {
    font-size: 18px; /* さらに小さく */
    margin: 0 auto 3px; /* マージンを最小に */
    width: 100%;
    text-align: center;
  }
  
  /* ナビゲーションをさらに上に */
  .nav-links {
    position: relative;
    top: 20px; /* 上の余白をなくす */
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px; /* 間隔を狭く */
  }
  
  /* リンクをさらにコンパクトに */
  .nav-link {
    font-size: 11px; /* さらに小さく */
    padding: 2px 6px; /* パディングを最小に */
  }

  /* 言語リンクの余白を最小に */
  .language-links {
    margin-top: 2px; /* 最小のマージン */
    width: 100%;
    justify-content: center;
  }
}

/* スマホ表示時の調整 */
@media (max-width: 768px) {
  .container-custom {
    padding-top: 90px; /* ヘッダーがさらに小さくなったので大幅に削減 */
  }
}

/* さらに小さい画面サイズ向け */
@media (max-width: 360px) {
  .container-custom {
    padding-top: 180px; /* さらに小さい画面ではより大きなパディング */
  }
}

/* 味覚マトリックスのスタイル */
.taste-matrix {
width: 300px; /* PC表示時のサイズ */
height: 300px;
border: 2px solid #fff;
position: relative;
background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%), 
linear-gradient(to top, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%);
}

.taste-dot {
width: 24px;
height: 24px;
background-color: #ff6b6b;
border-radius: 50%;
position: absolute;
transform: translate(-50%, -50%);
cursor: pointer;
box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.dual-matrix-container {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 40px;
margin-top: 20px;
}

.matrix-wrapper {
display: flex;
flex-direction: column;
align-items: center;
}

.matrix-title {
font-size: 18px;
font-weight: bold;
margin-bottom: 20px;
color: #4ecdc4;
}

/* マトリクスの軸ラベルスタイル（基本） */
.absolute.-top-6, .absolute.-bottom-6, .absolute.-left-12, .absolute.-right-12 {
  white-space: nowrap; /* テキストを折り返さない */
}

/* スマホ表示時に左右の軸ラベルを縦書きに */
@media (max-width: 768px) {
  /* 右側のラベル（「ヘビー」と「熟成」）を縦書きに */
  .absolute.-right-12 {
    writing-mode: vertical-rl; /* 縦書き（右から左） */
    text-orientation: upright; /* 文字を正立（回転なし）に */
    right: -25px; /* 位置調整 */
    height: auto; /* 高さを自動に */
    transform: translateY(-50%); /* 縦中央揃え */
  }
  
  /* 左側のラベル（「ライト」と「若い」）も縦書きに */
  .absolute.-left-12 {
    writing-mode: vertical-rl; /* 縦書き（右から左） */
    text-orientation: upright; /* 文字を正立に */
    left: -25px; /* 位置調整 */
    height: auto;
    transform: translateY(-50%); /* 縦中央揃え */
  }
  
  /* 上下のラベル位置も調整 */
  .absolute.-top-6 {
    top: -20px; /* 少し上に */
  }
  
  .absolute.-bottom-6 {
    bottom: -20px; /* 少し下に */
  }
}

/* さらに小さい画面用の調整 */
@media (max-width: 360px) {
  .absolute.-right-12 {
    right: -22px; /* さらに位置調整 */
    font-size: 10px; /* フォントサイズを小さく */
  }
  
  .absolute.-left-12 {
    left: -22px; /* 左側も同様に調整 */
    font-size: 10px;
  }
  
  .absolute.-top-6, .absolute.-bottom-6 {
    font-size: 10px;
  }
}

/* スマホ表示の修正 */
@media (max-width: 1024px) {
  .dual-matrix-container {
    grid-template-columns: 1fr;
    gap: 30px;
  }
}

/* スマホサイズでマトリックスをスクリーンに収める */
@media (max-width: 768px) {
  .taste-matrix {
    width: 250px; /* スマホ表示時は幅を縮小 */
    height: 250px;
  }
  
  .matrix-wrapper {
    max-width: 100%;
  }
  
  /* 余白調整 */
  .absolute.left-1\/2 {
    width: 100%;
  }
}

/* さらに小さいスマホ画面の対応 */
@media (max-width: 360px) {
  .taste-matrix {
    width: 220px; /* より小さいスマホ表示時はさらに縮小 */
    height: 220px;
  }
  
  /* 軸ラベルの位置調整 */
  .absolute.-left-12 {
    left: -10px;
  }
  
  .absolute.-right-12 {
    right: -10px;
  }
}

.btn-primary {
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
border: none;
color: white;
padding: 12px 24px;
border-radius: 8px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
}
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}
.btn-secondary {
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
}
.card {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px;
margin-bottom: 24px;
backdrop-filter: blur(10px);
}

/* 見出しの余白を調整するカスタムスタイル */
.card h2 {
padding-top: 0px;      /* 上部の余白を追加 */
padding-bottom: 15px;   /* 下部の余白を追加 */
line-height: 0.8;       /* 行の高さを調整 */
margin-bottom: 20px;    /* 下のマージンを設定（mb-4を上書き） */
}

/* split-layoutの調整 - パネル間の間隔を広げる */
.split-layout {
gap: 400px;               /* パネル間の間隔をより広く */
}

.whisky-card {
background: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.15);
border-radius: 8px;
padding: 16px;
margin-bottom: 16px;
cursor: pointer;
transition: all 0.3s ease;
position: relative;
}
.whisky-card:hover {
background: rgba(255, 255, 255, 0.12);
border-color: #4ecdc4;
transform: translateY(-2px);
}
.whisky-card.selected {
background: rgba(78, 205, 196, 0.15);
border-color: #4ecdc4;
box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
}
.whisky-card.featured {
background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.10));
border: 2px solid #FFA500;
box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
animation: pulse-orange 2s infinite;
}
@keyframes pulse-orange {
0% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
50% { box-shadow: 0 0 30px rgba(255, 165, 0, 0.6); }
100% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
}
.featured-label {
position: absolute;
top: -10px;
right: 10px;
background: linear-gradient(45deg, #FFA500, #FFD700);
color: #000;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
}
.loading {
display: none;
text-align: center;
color: #4ecdc4;
}
.progress-container {
display: none;
margin-top: 20px;
}
.progress-bar {
width: 100%;
height: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 10px;
overflow: hidden;
margin-bottom: 10px;
}
.progress-fill {
height: 100%;
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
width: 0%;
transition: width 0.3s ease;
}
.progress-text {
color: #4ecdc4;
font-size: 14px;
margin-bottom: 5px;
}
.progress-percentage {
color: #fff;
font-size: 16px;
font-weight: bold;
}
.error {
color: #ff6b6b;
background: rgba(255, 107, 107, 0.1);
border: 1px solid rgba(255, 107, 107, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.success {
color: #4ecdc4;
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.price-slider {
-webkit-appearance: none;
width: 100%;
height: 8px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.2);
outline: none;
margin: 10px 0;
}
.price-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
}
.price-slider::-moz-range-thumb {
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
border: none;
}
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
}
.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
}

/* split-layoutの修正 - 余白を増やす */
.split-layout {
display: grid;
grid-template-columns: 1fr 1fr; /* 均等に分割 */
gap: 30px; /* 間隔を広げる（元は20px） */
align-items: start;
margin-bottom: 30px; /* 下部に余白を追加 */
}

/* レコメンデーションパネルの修正 */
.recommendations-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 24px;
backdrop-filter: blur(10px);
max-height: 85vh; /* 少し高さを増やす */
overflow-y: auto;
margin-bottom: 30px; /* 下部の余白を追加 */
}

/* チャートパネルの修正 - 重要な修正部分 */
.chart-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px 20px; /* 上下のパディングを増やす */
backdrop-filter: blur(10px);
position: sticky;
top: 130px; /* 少し下げる */
max-height: 85vh; /* 少し高さを増やす */
overflow-y: auto;
scrollbar-width: thin;
scrollbar-color: rgba(78, 205, 196, 0.5) rgba(255, 255, 255, 0.1);
margin-bottom: 20px; /* 下部の余白を追加 */
}

.chart-panel::-webkit-scrollbar {
width: 8px;
}

.chart-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.chart-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

/* チャートコンテナの修正 */
.chart-container {
height: 380px; /* 高さを増やす（元は350px） */
width: 100%;
position: relative;
margin-bottom: 30px; /* 下部の余白を追加 */
}
/* チャートコンテナの見出し修正 */
.chart-container h3 {
text-align: center;
margin-bottom: 25px; /* 余白を増やす */
color: #4ecdc4;
font-size: 16px;
padding-top: 10px; /* 上部の余白を追加 */
}
/* チャートキャンバスの修正 */
.chart-canvas {
height: 350px !important;
width: 100% !important;
margin-top: 15px; /* 上部の余白を追加 */
}

#combinedProfileChart {
height: 350px !important; /* 高さを増やす（元は320px） */
width: 100% !important;
margin-top: 20px; /* 上部の余白を追加 */
margin-bottom: 20px; /* 下部の余白を追加 */
}
.recommendation-summary {
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 8px;
padding: 16px;
margin-bottom: 20px;
color: #4ecdc4;
}

.custom-footer {
display: none;
text-align: center;
padding: 20px;
color: rgba(255, 255, 255, 0.6);
font-size: 12px;
margin-top: 40px;
}

.whisky-overview {
background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
border: 2px solid rgba(78, 205, 196, 0.3);
border-radius: 16px;
padding: 30px;
margin-bottom: 30px;
text-align: center;
position: relative;
overflow: hidden;
}

.whisky-overview::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
animation: shimmer 3s infinite;
}

@keyframes shimmer {
0% { transform: translateX(-100%); }
100% { transform: translateX(100%); }
}

.whisky-overview h2 {
font-size: 2.5rem;
font-weight: bold;
background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
margin-bottom: 20px;
position: relative;
z-index: 1;
}

.whisky-overview .subtitle {
font-size: 1.2rem;
color: #4ecdc4;
margin-bottom: 15px;
font-weight: 600;
position: relative;
z-index: 1;
}

.whisky-overview .description {
font-size: 1.1rem;
line-height: 1.6;
color: rgba(255, 255, 255, 0.9);
position: relative;
z-index: 1;
}

.whisky-stats {
display: flex;
justify-content: space-around;
margin-top: 25px;
margin-bottom: 24px;  /* 下マージンを増やす（数値は調整可能） */
position: relative;
z-index: 1;
}

.stat-item {
text-align: center;
}

.stat-number {
font-size: 2rem;
font-weight: bold;
color: #ff6b6b;
display: block;
}

.stat-label {
font-size: 0.9rem;
color: rgba(255, 255, 255, 0.7);
margin-top: 5px;
}

.taste-icon {
width: 24px;
height: 24px;
margin-right: 8px;
fill: #4ecdc4;
}

.chat-section {
margin-top: 30px;
}

.chat-examples {
display: grid;
grid-template-columns: 1fr 1fr;  /* 2列に設定 */
grid-template-rows: auto auto;   /* 2行に設定 */
gap: 10px;
background: rgba(78, 205, 196, 0.05);
border: 1px solid rgba(78, 205, 196, 0.2);
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

/* 質問例タイトルを全幅に */
.chat-examples .mb-3 {
grid-column: 1 / -1;  /* 1列目から最後の列まで広げる */
}

.question-example {
/* レイアウト */
display: flex;
align-items: center;
justify-content: center;  /* 横方向も中央揃え */
height: 100%;
margin-bottom: 0;
padding: 8px 12px;

/* スタイル */
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 6px;
color: #4ecdc4;

/* インタラクション */
cursor: pointer;
transition: all 0.3s ease;
}

/* ホバー効果は維持 */
.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.chat-input-container {
display: flex;
gap: 10px;
margin-bottom: 20px;
}

.chat-input {
flex: 1;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
border-radius: 8px;
padding: 12px;
color: #fff;
font-size: 14px;
}

.chat-input:focus {
outline: none;
border-color: #4ecdc4;
box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

/* スマホ表示時のチャット入力エリア修正 */
@media (max-width: 768px) {
  .chat-input-container {
    flex-direction: column; /* 縦並びに変更 */
    gap: 10px; /* ボタン間の余白 */
  }
  
  .chat-input {
    width: 100%; /* 入力欄を全幅に */
    margin-bottom: 10px; /* 入力欄の下に余白 */
  }
  
  /* ボタンエリアを横並びに */
  .chat-buttons {
    display: flex;
    gap: 10px;
    width: 100%;
  }
  
  .voice-input-btn {
    flex: 0 0 auto; /* サイズ固定 */
    min-width: 50px; /* 最小幅を確保 */
  }
  
  .btn-primary {
    flex: 1; /* 残りのスペースを使用 */
    min-width: 0; /* 最小幅制限を解除 */
  }
}

.chat-history {
max-height: 400px;
overflow-y: auto;
padding: 15px;
background: rgba(0, 0, 0, 0.3);
border-radius: 8px;
margin-bottom: 15px;
display: none;
}

.chat-message {
margin-bottom: 15px;
padding: 12px;
border-radius: 8px;
word-wrap: break-word;
white-space: pre-wrap;
line-height: 1.6;
font-size: 14px;
}

/* AIメッセージのスタイル修正 */
.ai-message {
text-align: left;  /* 左寄せに設定 */
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
}

/* 必要に応じて通常のチャットメッセージも左寄せに */
.chat-message {
text-align: left;  /* 左寄せに設定 */
/* その他の既存スタイル */
}

.user-message {
background: rgba(255, 107, 107, 0.15);
border-left: 3px solid #ff6b6b;
color: #fff;
}

.chat-history::-webkit-scrollbar {
width: 6px;
}

.chat-history::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 3px;
}

.chat-history::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 3px;
}

/* レスポンシブ対応の修正 */
@media (max-width: 1024px) {
.split-layout {
grid-template-columns: 1fr;
gap: 30px; /* 間隔を広げる */
}

.chart-panel {
position: static;
margin-top: 30px; /* 上部の余白を追加 */
padding: 30px; /* パディングを均等に */
}

.whisky-overview h2 {
font-size: 2rem;
}

.whisky-stats {
flex-direction: column;
gap: 15px;
}

.dual-matrix-container {
grid-template-columns: 1fr;
gap: 30px;
}
}

@media (max-width: 768px) {
.custom-footer {
display: block;
}

.whisky-overview h2 {
font-size: 1.8rem;
}

.whisky-overview .subtitle {
font-size: 1rem;
}

.whisky-overview .description {
font-size: 1rem;
}
}

.recommendations-panel::-webkit-scrollbar {
width: 8px;
}

.recommendations-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb:hover {
background: rgba(78, 205, 196, 0.7);
}

/* 蒸留所マップと情報パネル */
.distillery-section {
margin-top: 20px;
opacity: 0;
height: 0;
overflow: hidden;
transition: opacity 0.8s ease, height 0.8s ease;
}

.distillery-section.active {
opacity: 1;
height: auto;
}

.distillery-container {
display: flex;
flex-direction: column;
gap: 20px;
}

.map-container {
height: 300px;
border-radius: 12px;
overflow: hidden;
border: 2px solid rgba(78, 205, 196, 0.3);
background-color: #1a1a1a;
}

#distilleryMap {
height: 100%;
width: 100%;
background-color: #242424;
}

.distillery-info {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 12px;
padding: 16px;
color: #fff;
}

.distillery-info h3 {
color: #4ecdc4;
font-size: 18px;
font-weight: bold;
margin-bottom: 10px;
border-bottom: 1px solid rgba(78, 205, 196, 0.3);
padding-bottom: 8px;
}

.distillery-info-grid {
display: grid;
grid-template-columns: auto 1fr;
gap: 8px 16px;
margin-top: 15px;
}

.info-label {
color: rgba(255, 255, 255, 0.7);
font-weight: 600;
}

.info-value {
color: rgba(255, 255, 255, 0.9);
}

/* distilleryDescriptionを左寄せにするCSS修正 */
.distillery-description {
margin-top: 15px;
line-height: 1.6;
text-align: left; /* 左寄せを明示的に指定 */
}
.status-active {
color: #4ecdc4;
font-weight: bold;
}

.status-closed {
color: #ff6b6b;
font-weight: bold;
}

.status-unknown {
color: #ffb347;
font-weight: bold;
}

/* Leafletマップスタイルのカスタマイズ */
.leaflet-container {
background-color: #242424 !important;
}
.leaflet-tile-pane {
opacity: 0.9;
}
.leaflet-popup-content-wrapper {
background-color: rgba(40, 44, 52, 0.95) !important;
color: #fff !important;
border: 1px solid rgba(78, 205, 196, 0.5);
}
.leaflet-popup-tip {
background-color: rgba(40, 44, 52, 0.95) !important;
}
.leaflet-control-zoom a {
background-color: rgba(40, 44, 52, 0.8) !important;
color: #fff !important;
border-color: rgba(78, 205, 196, 0.3) !important;
}
.leaflet-control-zoom a:hover {
background-color: rgba(78, 205, 196, 0.3) !important;
}

/* 音声入力ボタンのスタイル */
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 18px;
}

.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
transform: translateY(-2px);
}

.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
animation: pulse-recording 1.5s infinite;
}

@keyframes pulse-recording {
0% { transform: scale(1); }
50% { transform: scale(1.1); }
100% { transform: scale(1); }
}

.error-notification {
position: fixed;
top: 20px;
right: 20px;
z-index: 9999;
max-width: 400px;
animation: slide-in 0.5s ease-out;
}

.notification-content {
background-color: rgba(255, 107, 107, 0.9);
color: white;
border-radius: 8px;
padding: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
display: flex;
align-items: center;
}

.notification-icon {
font-size: 24px;
margin-right: 15px;
}

.notification-message {
flex-grow: 1;
}

.notification-close {
background: none;
border: none;
color: white;
font-size: 20px;
cursor: pointer;
padding: 0;
margin-left: 10px;
}

@keyframes slide-in {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

/* チャット推薦銘柄の強調スタイル */
.whisky-card.chat-mentioned {
    border: 2px solid #4ecdc4;
    box-shadow: 0 0 10px rgba(78, 205, 196, 0.3);
}

.chat-label {
    position: absolute;
    top: -8px;
    right: 8px;
    background: linear-gradient(45deg, #4ecdc4, #44a08d);
    color: white;
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 10px;
    font-weight: bold;
    z-index: 10;
}

/* AI提案メッセージの修正 */
.ai-recommendation-message {
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
padding: 20px; /* パディングを増やす */
border-radius: 8px;
margin-bottom: 25px; /* 下部の余白を増やす */
line-height: 1.8; /* 行間を広げる */
}

@keyframes thinking {
0% { content: "考えています"; }
25% { content: "考えています."; }
50% { content: "考えています.."; }
75% { content: "考えています..."; }
100% { content: "考えています...."; }
}

.thinking-animation {
position: relative;
}

.thinking-animation::after {
content: "考えています";
animation: thinking 1.5s infinite;
}

/* 蒸溜所マーカーのツールチップ */
.distillery-tooltip {
background-color: rgba(40, 44, 52, 0.95);
color: #fff;
border: 1px solid rgba(78, 205, 196, 0.5);
border-radius: 4px;
padding: 5px 8px;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}


</style></head>
<body>
<div class="header-container">
<a href="https://www.hirunotsuki.com/" target="_blank" style="position: absolute; left: 20px; width: 90px; height: 90px; display: block;">
<img class="logo" src="./NH_bar_logo_fin_white.png" alt="昼の月バーロゴ">
</a>
<h1 class="header-title">昼の月。AIソムリエ</h1>
<div class="nav-links">
<a href="whisky_list.html" class="nav-link" id="listLink">メニューリスト一覧</a>

<!-- 1つの翻訳ボタンに統合 -->
<a href="#" onclick="openGoogleTranslate(); return false;" class="nav-link translate-link">
<span class="translate-icon">🌐</span> 翻訳
</a>
</div>
</div>

<div class="container-custom">
<div class="whisky-overview">
<h2>🍷 プレミアムウィスキーコレクション</h2>
<div class="subtitle">本日は厳選された<span id="whiskyCount">0</span>本のウィスキーから</div>
<div class="description">
<strong>あなたの味覚に完璧にマッチする</strong>最高の一本を<br>
AI技術で分析・提案いたします
</div>
<div class="whisky-stats">
<div class="stat-item">
<span class="stat-number" id="totalWhiskies">0</span>
<div class="stat-label">厳選銘柄</div>
</div>
<div class="stat-item">
<span class="stat-number" id="uniqueRegions">0</span>
<div class="stat-label">産地</div>
</div>
<div class="stat-item">
<span class="stat-number" id="distilleryCount">0</span>
<div class="stat-label">蒸溜所の数</div>
</div>
<div class="stat-item">
<span class="stat-number" id="aiTechnology">AI</span>
<div class="stat-label">分析技術</div>
</div>
</div>

<div class="card">
<h2 class="text-2xl font-bold mb-4">
💎 価格帯設定
</h2>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block mb-2">下限価格: <span id="minPriceDisplay">¥5,000</span></label>
<input type="range" id="minPrice" class="price-slider" min="1" max="80" value="5" step="1">
</div>
<div>
<label class="block mb-2">上限価格: <span id="maxPriceDisplay">¥50,000</span></label>
<input type="range" id="maxPrice" class="price-slider" min="1" max="80" value="50" step="1">
</div>
</div>
</div>

<div class="card">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
🌟 味覚プロファイル設定
</h2>
<p class="mb-6">2つの四角内をクリックして、それぞれの好みの位置を選択してください</p>

<div class="dual-matrix-container">
<div class="matrix-wrapper">
<div class="matrix-title">基本的な味の傾向</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix1">
<div class="taste-dot" id="tasteDot1" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">フルーティー</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">スモーキー</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">ライト</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ヘビー</div>
</div>
<div class="text-center mt-4">
<span id="coordinates1" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
</div>
</div>

<div class="matrix-wrapper">
<div class="matrix-title">複雑さの好み</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix2">
<div class="taste-dot" id="tasteDot2" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">まろやか</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">強烈</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">若い</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">熟成</div>
</div>
<div class="text-center mt-4">
<span id="coordinates2" class="text-xs text-gray-400">座標: X: 0.50, Y: 0.50</span>
</div>
</div>
</div>
</div>

<div class="card chat-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
🗨️ AIソムリエとチャット
</h2>

<div class="chat-examples">
<div class="mb-3 text-sm text-gray-300">質問例（クリックで入力）：</div>
<div class="question-example" data-question="タリスカー44年（最高額80,400円）について詳しく教えて">💎 タリスカー44年（最高額80,400円）について詳しく教えて</div>
<div class="question-example" data-question="3000円以下でスモーキーなアイラ島のウィスキーはある？">🌊 3000円以下でスモーキーなアイラ島のウィスキーはある？</div>
<div class="question-example" data-question="日本の軽井沢や長濱などフルーティーなウィスキーを比較して">🍯 日本の軽井沢や長濱などフルーティーなウィスキーを比較して</div>
<div class="question-example" data-question="5000円前後で複雑な味わいのウィスキーのおすすめは？">⭐ 5000円前後で複雑な味わいのウィスキーのおすすめは？</div>
</div>

<div class="chat-input-container">
  <input type="text" id="chatInput" class="chat-input" placeholder="質問を入力してください...">
  <div class="chat-buttons">
    <button id="voiceInputBtn" class="voice-input-btn">🎙️</button>
    <button id="sendChatBtn" class="btn-primary">💬 質問する</button>
  </div>
</div>

<div id="chatHistory" class="chat-history" style="display: none;"></div>
</div>

<div class="text-center mb-8">
<button id="getRecommendation" class="btn-primary text-lg mr-4">🎯 AI提案を開始</button>
<button id="refreshRecommendation" class="btn-secondary text-lg">
🔄 リフレッシュして再提案
</button>
</div>

<div id="loadingIndicator" class="loading" style="display: none;">
<div class="animate-spin text-4xl mb-4">🍷</div>
<p class="mt-2">AIが最適なウィスキーを分析中...</p>
</div>

<div id="progressContainer" class="progress-container" style="display: none;">
<div id="progressText" class="progress-text">結果を生成中...</div>
<div class="progress-bar">
<div id="progressFill" class="progress-fill" style="width: 0%;"></div>
</div>
<div id="progressPercentage" class="progress-percentage">0%</div>
</div>

<div id="splitLayoutContainer" class="split-layout" style="display: none;">
<div id="recommendationsPanel" class="recommendations-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
🌙 AI提案結果
</h2>
<div id="preferencesSummary" class="recommendation-summary" style="display: block;">
<h3 class="text-lg font-bold mb-3">🎯 あなたの好みの傾向</h3>
<div class="space-y-2 text-sm">
<div><strong>基本的な味の傾向:</strong> <span id="tasteDescription">バランスの取れた</span></div>
<div><strong>複雑さの好み:</strong> <span id="complexityDescription">バランスの良い複雑さを好む</span></div>
<div><strong>価格帯:</strong> <span id="priceRange">¥5,000 - ¥50,000</span></div>

<div class="mt-3 pt-2 border-t border-gray-600">
AIが総合的にプロファイルに基づいて、最適な3銘柄を厳選しました。
</div>
</div>
</div>
<div id="recommendationContent"></div>
<div class="text-center mt-6">
<button id="getAnotherRecommendation" class="btn-secondary">
🔄 別の提案を受ける
</button>
</div>
</div>

<div id="chartPanel" class="chart-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
🕸️ 味覚プロファイル比較
</h2>
<div class="chart-container">
<h3 id="chartTitle">あなたの好み</h3>
<canvas id="combinedProfileChart" class="chart-canvas"></canvas>
</div>

<!-- 蒸留所マップと情報セクション -->
<div id="distillerySection" class="distillery-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
🗾 蒸溜所情報
</h2>
<div class="distillery-container">
<div class="map-container">
<div id="distilleryMap"></div>
</div>

<div class="distillery-info" id="distilleryInfo">
<h3 id="distilleryName">蒸留所名</h3>
<div class="distillery-info-grid" id="distilleryDetails">
<div class="info-label">所在地:</div>
<div class="info-value" id="distilleryRegion">-</div>

<div class="info-label">創業年:</div>
<div class="info-value" id="distilleryFounded">-</div>

<div class="info-label">現在の状況:</div>
<div class="info-value" id="distilleryStatus">-</div>
</div>

<div class="distillery-description" id="distilleryDescription">
現在情報登録されていません。
</div>
</div>
</div>
</div>
</div>
</div>

<div class="custom-footer">
Powered by Nebula Hirozon Technology
</div>
</div>

<script>
// グローバル変数の修正（既存の部分を以下に置き換え）
let whiskyData = [];
let distilleryDatabase = {}; // ← これを distilleryData に統一
let distilleryMarkers = {};
let distilleryMap = null;
let profileChartInstance = null;
let brandToDistilleryMapping = {}; // ← これを brandToDistilleryData に統一

// グローバル変数
let excludedWhiskies = []; // 除外する銘柄のリスト
let lastRecommendedWhisky = null; // 最後に推薦した銘柄

// チャット履歴を保存する配列
let chatHistory = [];
let distilleryData = {}; // メイン使用
let brandToDistilleryData = {}; // メイン使用

// ユーザー好みを保存するグローバル変数
let savedUserPreferences = {
minPrice: null,
maxPrice: null,
tasteX: null,
tasteY: null,
complexityX: null,
complexityY: null,
region: null
};

// カウントアップアニメーション関数
function animateCounter(elementId, targetValue) {
const element = document.getElementById(elementId);
if (!element) return;

// 現在の値を取得（数値でない場合は0を設定）
let currentValue = 0;

// アニメーションのタイムステップ
const duration = 1000; // 1000ms = 1秒
const steps = 60;
const stepTime = duration / steps;

// ステップごとの増加量
const increment = targetValue / steps;

// カウントアップ関数
function updateCounter(currentStep) {
if (currentStep <= steps) {
// 現在の値を計算
currentValue = Math.min(Math.ceil(increment * currentStep), targetValue);

// 表示を更新（AIの場合は文字列のまま）
if (elementId === 'aiTechnology') {
element.textContent = 'AI';
} else {
element.textContent = currentValue.toString();
}

// 次のステップを予約
setTimeout(() => updateCounter(currentStep + 1), stepTime);
}
}

// カウントアップ開始
updateCounter(1);
}

// DOMContentLoaded イベント
document.addEventListener('DOMContentLoaded', function() {
console.log('DOM fully loaded');

// ページがロードされたときに履歴をクリア
clearChatHistory();
resetTasteMatrices();

// 変数の初期化を確実に行う
if (typeof whiskyData === 'undefined') {
whiskyData = [];
}

if (typeof distilleryDatabase === 'undefined') {
distilleryDatabase = {};
}

if (typeof distilleryMarkers === 'undefined') {
distilleryMarkers = {};
}

// ナビゲーションリンクのアクティブ状態を設定
setActiveNavLinks();

// 四象限マトリックスの初期化
initializeTasteMatrix();

// 統合データ読み込み - 非同期処理
loadUnifiedWhiskyData().then(data => {
// データ読み込み成功後のコールバック
console.log('統合データ読み込み完了');

// イベントリスナーの設定
setupEventListeners();

// 統計情報を更新
updateStatistics();

}).catch(err => {
console.error('データ読み込みエラー:', err);
});
});

// ナビゲーションリンクのアクティブ状態を設定
function setActiveNavLinks() {
const currentPage = window.location.pathname.split('/').pop() || 'index.html';
const links = document.querySelectorAll('.nav-links a');

links.forEach(link => {
const href = link.getAttribute('href').split('/').pop();
if (currentPage === href) {
link.classList.add('active');
} else {
link.classList.remove('active');
}
});
}

// 統合ウィスキーデータ読み込み（修正版）
async function loadUnifiedWhiskyData() {
    console.log('統合ウィスキーデータ読み込み開始...');
    
    try {
        // JSONファイルを読み込み
        const response = await fetch('unified_whisky_data.json');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        console.log('JSONデータ読み込み成功:', data);
        
        // データを各変数に格納（統一された変数名を使用）
        whiskyData = data.whiskies || [];
        distilleryData = data.distilleries || {};
        distilleryDatabase = data.distilleries || {}; // 既存のマップ機能用
        brandToDistilleryData = data.brandToDistillery || {};
        brandToDistilleryMapping = data.brandToDistillery || {}; // 既存のマップ機能用
        
        console.log('ウィスキーデータ:', whiskyData.length, '件');
        console.log('蒸溜所データ:', Object.keys(distilleryData).length, '件');
        console.log('ブランド-蒸溜所マッピング:', Object.keys(brandToDistilleryData).length, '件');
        
        // 統計情報を更新
        updateStatistics();
        
        // 初期推薦を生成
        generateAIRecommendations();
        
        console.log('統合ウィスキーデータ読み込み完了');
        return true;
        
    } catch (error) {
        console.error('統合データ読み込みエラー:', error);
        showError('ウィスキーデータの読み込みに失敗しました: ' + error.message);
        return false;
    }
}

// チャット履歴からキーワードを抽出する関数
function extractKeywordsFromChat() {
    const keywords = {
        brands: [],
        tastes: [],
        regions: [],
        priceRange: null
    };
    
    // チャット履歴からテキストを収集
    const chatMessages = document.querySelectorAll('.chat-message.user-message');
    const allChatText = Array.from(chatMessages).map(msg => msg.textContent.toLowerCase()).join(' ');
    
    if (!allChatText) return keywords;
    
    // ウィスキー銘柄名を検索
    whiskyData.forEach(whisky => {
        const whiskyName = whisky.name.toLowerCase();
        const brandParts = whiskyName.split(/[\s　年]/);
        
        brandParts.forEach(part => {
            if (part.length > 2 && allChatText.includes(part)) {
                if (!keywords.brands.includes(whisky.name)) {
                    keywords.brands.push(whisky.name);
                }
            }
        });
        
        // 完全なブランド名の検索
        if (allChatText.includes(whiskyName)) {
            if (!keywords.brands.includes(whisky.name)) {
                keywords.brands.push(whisky.name);
            }
        }
    });
    
    // 味覚キーワードを検索
    const tasteKeywords = {
        'スモーキー': ['smoky', 'smoke', 'ピート'],
        'フルーティー': ['fruity', 'fruit', '果実'],
        'スパイシー': ['spicy', 'spice', 'スパイス'],
        'スイート': ['sweet', 'sweetness', '甘い'],
        'ヘビー': ['heavy', 'body', '重い'],
        'コンプレックス': ['complex', 'complexity', '複雑']
    };
    
    Object.entries(tasteKeywords).forEach(([japanese, englishWords]) => {
        if (allChatText.includes(japanese.toLowerCase()) || 
            englishWords.some(word => allChatText.includes(word))) {
            keywords.tastes.push(japanese);
        }
    });
    
    // 地域キーワードを検索
    const regionKeywords = [
        'scotland', 'japan', 'ireland', 'america', 
        'スコットランド', '日本', 'アイルランド', 'アメリカ',
        'islay', 'speyside', 'highland', 'アイラ', 'スペイサイド', 'ハイランド'
    ];
    regionKeywords.forEach(region => {
        if (allChatText.includes(region.toLowerCase())) {
            keywords.regions.push(region);
        }
    });
    
    return keywords;
}

// AI推薦生成関数
function generateAIRecommendations() {
    const recommendations = document.getElementById('recommendations');
    const summary = document.getElementById('recommendationSummary');
    
    if (!whiskyData || whiskyData.length === 0) {
        if (recommendations) {
            recommendations.innerHTML = '<p class="error">ウィスキーデータが読み込まれていません。</p>';
        }
        return;
    }
    
    // チャット履歴からキーワードを抽出
    const keywords = extractKeywordsFromChat();
    let filteredWhiskies = [...whiskyData];
    let recommendationReason = '';
    
    // 価格フィルタリング
    const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
    const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;
    
    filteredWhiskies = filteredWhiskies.filter(whisky => {
        const price = parseInt(whisky.price.replace(/[¥,]/g, ''));
        return price >= minPrice && price <= maxPrice;
    });
    
    // チャット履歴に基づく推薦
    if (keywords.brands.length > 0) {
        // 銘柄名が言及された場合、その銘柄を優先
        const brandRecommendations = filteredWhiskies.filter(whisky =>
            keywords.brands.some(brand => whisky.name === brand)
        );
        
        if (brandRecommendations.length > 0) {
            filteredWhiskies = brandRecommendations;
            recommendationReason = `チャットで言及された「${keywords.brands.join('、')}」に基づく推薦`;
        }
    } else if (keywords.tastes.length > 0) {
        // 味覚キーワードに基づく推薦
        filteredWhiskies.sort((a, b) => {
            let aScore = 0, bScore = 0;
            
            keywords.tastes.forEach(taste => {
                switch(taste) {
                    case 'スモーキー':
                        aScore += a.taste_profile?.smoky || 0;
                        bScore += b.taste_profile?.smoky || 0;
                        break;
                    case 'フルーティー':
                        aScore += a.taste_profile?.fruity || 0;
                        bScore += b.taste_profile?.fruity || 0;
                        break;
                    case 'スパイシー':
                        aScore += a.taste_profile?.spicy || 0;
                        bScore += b.taste_profile?.spicy || 0;
                        break;
                    case 'スイート':
                        aScore += a.taste_profile?.sweetness || 0;
                        bScore += b.taste_profile?.sweetness || 0;
                        break;
                    case 'ヘビー':
                        aScore += a.taste_profile?.body || 0;
                        bScore += b.taste_profile?.body || 0;
                        break;
                    case 'コンプレックス':
                        aScore += a.taste_profile?.complexity || 0;
                        bScore += b.taste_profile?.complexity || 0;
                        break;
                }
            });
            
            return bScore - aScore;
        });
        
        recommendationReason = `「${keywords.tastes.join('、')}」の特徴に基づく推薦`;
    } else if (keywords.regions.length > 0) {
        // 地域に基づく推薦
        filteredWhiskies = filteredWhiskies.filter(whisky =>
            keywords.regions.some(region => {
                const whiskyRegion = whisky.region ? whisky.region.toLowerCase() : '';
                const whiskySubcategory = whisky.subcategory ? whisky.subcategory.toLowerCase() : '';
                const regionLower = region.toLowerCase();
                
                return whiskyRegion.includes(regionLower) ||
                       whiskySubcategory.includes(regionLower) ||
                       (regionLower.includes('スコットランド') && whiskyRegion.includes('scotland')) ||
                       (regionLower.includes('scotland') && whiskyRegion.includes('scotland')) ||
                       (regionLower.includes('日本') && whiskyRegion.includes('japan')) ||
                       (regionLower.includes('japan') && whiskyRegion.includes('japan'));
            })
        );
        
        recommendationReason = `「${keywords.regions.join('、')}」地域に基づく推薦`;
    } else {
        // デフォルトの推薦（高評価順）
        filteredWhiskies.sort((a, b) => {
            const aScore = Object.values(a.taste_profile || {}).reduce((sum, val) => sum + val, 0);
            const bScore = Object.values(b.taste_profile || {}).reduce((sum, val) => sum + val, 0);
            return bScore - aScore;
        });
        
        recommendationReason = '総合評価の高い銘柄';
    }
    
    // 上位5件を選択
    const topRecommendations = filteredWhiskies.slice(0, 5);
    
    // サマリーを更新
    if (summary) {
        summary.innerHTML = `
            <div class="ai-recommendation-message">
                🤖 <strong>AI推薦理由:</strong> ${recommendationReason}<br>
                📊 ${topRecommendations.length}件の推薦銘柄を選出しました
                ${keywords.brands.length > 0 ? `<br>🎯 特別推薦: ${keywords.brands.join('、')}` : ''}
            </div>
        `;
    }
    
    // 推薦リストを表示
    if (recommendations) {
        recommendations.innerHTML = topRecommendations.map(whisky => `
            <div class="whisky-card ${keywords.brands.includes(whisky.name) ? 'featured' : ''}" 
                 onclick="selectWhisky('${whisky.id}')">
                ${keywords.brands.includes(whisky.name) ? '<div class="featured-label">🎯 チャット推薦</div>' : ''}
                <div class="flex items-center mb-3">
                    <img src="${whisky.photoUrl}" alt="${whisky.name}" 
                         class="w-16 h-20 object-cover rounded mr-4"
                         onerror="this.src='placeholder-whisky.jpg'">
                    <div class="flex-1">
                        <h4 class="font-bold text-lg mb-1">${whisky.name}</h4>
                        <p class="text-sm opacity-75 mb-1">${whisky.region} | ${whisky.subcategory}</p>
                        <p class="text-lg font-bold text-yellow-400">${whisky.price}</p>
                    </div>
                </div>
                <div class="taste-profile-mini grid grid-cols-3 gap-2 text-xs">
                    <span>🍇 フルーティー: ${whisky.taste_profile?.fruity || 0}/5</span>
                    <span>🌶️ スパイシー: ${whisky.taste_profile?.spicy || 0}/5</span>
                    <span>💨 スモーキー: ${whisky.taste_profile?.smoky || 0}/5</span>
                </div>
            </div>
        `).join('');
    }
}

// 簡単なAI応答生成関数
function generateSimpleAIResponse(userMessage) {
    const lowerMessage = userMessage.toLowerCase();
    
    // ウィスキー銘柄の検索
    const mentionedWhiskies = whiskyData.filter(whisky =>
        whisky.name.split(/[\s　年]/).some(part => 
            part.length > 2 && lowerMessage.includes(part.toLowerCase())
        )
    );
    
    if (mentionedWhiskies.length > 0) {
        const whisky = mentionedWhiskies[0];
        return `${whisky.name}についてお聞きですね！この銘柄は${whisky.region}の${whisky.subcategory}で、価格は${whisky.price}となっております。右側の推薦リストに表示いたします！`;
    }
    
    // 味覚特徴の応答
    if (lowerMessage.includes('スモーキー') || lowerMessage.includes('smoky')) {
        return 'スモーキーな味わいがお好みですね！泥炭を使った独特な香りと味わいが特徴的なウィスキーをお探しいたします。';
    }
    
    if (lowerMessage.includes('フルーティー') || lowerMessage.includes('fruity')) {
        return 'フルーティーな味わいがお好みですね！果実の甘やかな香りと味わいが楽しめる銘柄をご提案いたします。';
    }
    
    if (lowerMessage.includes('おすすめ') || lowerMessage.includes('推薦')) {
        return 'あなたの好みに合わせて最適なウィスキーをお選びいたします。価格帯や味の好みをお聞かせください！';
    }
    
    // デフォルト応答
    return 'ありがとうございます。あなたのご質問を参考に、最適なウィスキーをお選びいたします。右側の推薦リストをご覧ください！';
}

// ウィスキーから蒸溜所を取得する関数（統合JSON対応・修正版）
function getDistilleryForWhisky(whisky) {
    console.log('蒸溜所検索開始:', whisky.name);
    
    // 1. brandToDistilleryから直接取得を試す
    if (brandToDistilleryData[whisky.name]) {
        const distilleryKey = brandToDistilleryData[whisky.name];
        console.log('ブランドマッピングで発見:', whisky.name, '->', distilleryKey);
        
        if (distilleryData[distilleryKey]) {
            console.log('蒸溜所データ発見:', distilleryData[distilleryKey]);
            return {
                name: distilleryKey,
                ...distilleryData[distilleryKey]
            };
        }
    }

    // 2. 部分一致で検索
    const whiskyNameLower = whisky.name.toLowerCase();
    console.log('部分一致検索開始:', whiskyNameLower);
    
    for (const distilleryKey in distilleryData) {
        const distilleryNameLower = distilleryKey.toLowerCase().replace(/蒸溜所/g, '');
        console.log('比較中:', whiskyNameLower, 'vs', distilleryNameLower);
        
        if (whiskyNameLower.includes(distilleryNameLower) || distilleryNameLower.includes(whiskyNameLower)) {
            console.log('部分一致で発見:', whisky.name, '->', distilleryKey);
            return {
                name: distilleryKey,
                ...distilleryData[distilleryKey]
            };
        }
    }

    // 3. より柔軟な検索（キーワードベース）
    const keywords = ['jura', 'nagahama', 'established'];
    for (const keyword of keywords) {
        if (whiskyNameLower.includes(keyword)) {
            for (const distilleryKey in distilleryData) {
                if (distilleryKey.toLowerCase().includes(keyword)) {
                    console.log('キーワード一致で発見:', whisky.name, '->', distilleryKey);
                    return {
                        name: distilleryKey,
                        ...distilleryData[distilleryKey]
                    };
                }
            }
        }
    }

    console.log('蒸溜所が見つかりません:', whisky.name);
    return null;
}

// デフォルトウィスキーデータ
function getDefaultWhiskyData() {
return [
{
id: "1",
name: "タリスカー 44年 オフィシャルボトル",
price: "¥80,400",
region: "Scotland, Isle of Skye",
subcategory: "Single Malt Scotch Whisky",
abv: 45.8,
tastingNote_ja: "この非常に希少なタリスカー44年は、強い海岸の塩気を持つ複雑な海洋性の特徴を提供します。豊かなドライフルーツ、ダークチョコレート、アンティークレザーの層がタリスカー特有のピリッとしたスモークと調和しています。長期熟成により、トロピカルフルーツ、ミツロウ、繊細な樽のスパイスのノートを持つ驚くべき深みが生まれ、非常に長く温かみのある余韻へと続きます。",
taste_profile: {
fruity: 3,
spicy: 4,
body: 5,
smoky: 4,
sweetness: 2,
complexity: 5
}
},
{
id: "2",
name: "ポートエレン 25年 one of only bottles",
price: "¥20,400",
region: "Scotland, Islay",
subcategory: "Single Malt Scotch Whisky",
abv: 40,
tastingNote_ja: "ポートエレン25年は希少で高く評価されるアイラウイスキーで、強い海洋性の特徴を持ちます。複雑な泥炭の煙、海塩、ヨードの層が柑橘類の皮、バニラ、微妙なトロピカルフルーツとバランスよく調和しています。長い余韻には、オークタンニン、白胡椒、そして長く続く甘い煙が現れます。",
taste_profile: {
fruity: 2,
spicy: 3,
body: 4,
smoky: 5,
sweetness: 2,
complexity: 5
}
},
{
id: "3",
name: "マッカラン 1990年 SAMAROLI",
price: "¥12,200",
region: "Scotland",
subcategory: "Single Malt Scotch Whisky - Speyside",
abv: 40,
tastingNote_ja: "有名な独立系ボトラー、サマローリによってボトリングされた希少なマッカラン1990年。豊かなシェリーの影響があり、ドライフルーツ、オレンジピール、クリスマスケーキの風味が特徴。複雑な樽のスパイスが蜂蜜、トフィー、ダークチョコレートと調和しています。フィニッシュは長く、革、タバコ、そして余韻の残るドライフルーツの甘さが感じられます。",
taste_profile: {
fruity: 4,
spicy: 3,
body: 5,
smoky: 1,
sweetness: 4,
complexity: 5
}
}
];
}

// 四象限マトリックスの初期化
function initializeTasteMatrix() {
const matrix1 = document.getElementById('tasteMatrix1');
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');

const matrix2 = document.getElementById('tasteMatrix2');
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');

// 中央位置に初期化
resetTasteMatrices();

// マトリックス1のイベント
matrix1.addEventListener('click', function(e) {
updateDotPosition(e, matrix1, dot1, coords1, 1);
});

matrix1.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // 左クリック押下中
updateDotPosition(e, matrix1, dot1, coords1, 1);
}
});

// マトリックス2のイベント
matrix2.addEventListener('click', function(e) {
updateDotPosition(e, matrix2, dot2, coords2, 2);
});

matrix2.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // 左クリック押下中
updateDotPosition(e, matrix2, dot2, coords2, 2);
}
});
}

// ドットの位置を更新
function updateDotPosition(event, matrix, dot, coords, matrixNum) {
const rect = matrix.getBoundingClientRect();
let x = event.clientX - rect.left;
let y = event.clientY - rect.top;

// 境界チェック
x = Math.max(0, Math.min(x, rect.width));
y = Math.max(0, Math.min(y, rect.height));

// パーセンテージに変換
const xPercent = (x / rect.width) * 100;
const yPercent = (y / rect.height) * 100;

// ドットの位置を更新
dot.style.left = `${xPercent}%`;
dot.style.top = `${yPercent}%`;

// 座標表示を更新（小数点2桁まで）
const xCoord = (x / rect.width).toFixed(2);
const yCoord = (y / rect.height).toFixed(2);
coords.textContent = `座標: X: ${xCoord}, Y: ${yCoord}`;
}

// 四象限をリセットして中央に配置
function resetTasteMatrices() {
// 四象限1（基本的な味の傾向）
const dot1 = document.getElementById('tasteDot1');
dot1.style.left = '50%';
dot1.style.top = '50%';
document.getElementById('coordinates1').textContent = '座標: X: 0.50, Y: 0.50';

// 四象限2（複雑さの好み）
const dot2 = document.getElementById('tasteDot2');
dot2.style.left = '50%';
dot2.style.top = '50%';
document.getElementById('coordinates2').textContent = '座標: X: 0.50, Y: 0.50';
}

// イベントリスナーの設定（完全版）
function setupEventListeners() {
    // 推薦取得ボタン
    const getRecommendationBtn = document.getElementById('getRecommendation');
    if (getRecommendationBtn) {
        getRecommendationBtn.addEventListener('click', function() {
            getRecommendation();
            
            // 提案結果エリアにスクロール
            setTimeout(() => {
                const recommendationsPanel = document.getElementById('recommendationsPanel');
                if (recommendationsPanel) {
                    recommendationsPanel.scrollIntoView({ behavior: 'smooth' });
                }
            }, 500);
        });
    }
    
    // 別の提案を受けるボタン（anotherRecommendation）
    const anotherRecommendationBtn = document.getElementById('anotherRecommendation');
    if (anotherRecommendationBtn) {
        anotherRecommendationBtn.addEventListener('click', function() {
            console.log('anotherRecommendationボタンがクリックされました');
            
            // 前回推薦したウィスキーを除外リストに追加
            if (lastRecommendedWhisky) {
                if (!excludedWhiskies.includes(lastRecommendedWhisky.name)) {
                    excludedWhiskies.push(lastRecommendedWhisky.name);
                    console.log('除外リストに追加:', lastRecommendedWhisky.name);
                }
            }
            
            // 新しい推薦を実行
            getRecommendation();
        });
    }
    
    // getAnotherRecommendationボタン（既存）
    const getAnotherRecommendationBtn = document.getElementById('getAnotherRecommendation');
    if (getAnotherRecommendationBtn) {
        getAnotherRecommendationBtn.addEventListener('click', function() {
            console.log('getAnotherRecommendationボタンがクリックされました');
            
            // 前回推薦したウィスキーを除外リストに追加
            if (lastRecommendedWhisky) {
                if (!excludedWhiskies.includes(lastRecommendedWhisky.name)) {
                    excludedWhiskies.push(lastRecommendedWhisky.name);
                    console.log('除外リストに追加:', lastRecommendedWhisky.name);
                }
            }
            
            getRecommendation();
        });
    }
    
    // チャットメッセージ送信ボタン
    const sendMessageBtn = document.getElementById('sendMessage');
    const chatInput = document.getElementById('chatInput');
    
    if (sendMessageBtn && chatInput) {
        sendMessageBtn.addEventListener('click', function() {
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage('user', message);
                chatInput.value = '';
                
                chatHistory.push({role: 'user', content: message});
                
                setTimeout(() => {
                    const response = "ありがとうございます。お客様の好みを理解しました。推薦機能をお試しください。";
                    addChatMessage('assistant', response);
                    chatHistory.push({role: 'assistant', content: response});
                }, 1000);
            }
        });
        
        // Enterキーでも送信可能にする
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessageBtn.click();
            }
        });
    }
    
    // sendChatBtnボタン（もし存在する場合）
    const sendChatBtn = document.getElementById('sendChatBtn');
    if (sendChatBtn && chatInput) {
        sendChatBtn.addEventListener('click', function() {
            const input = chatInput.value.trim();
            if (input) {
                sendChatMessage();
            }
        });
    }
    
    // チャット入力のEnterキー（sendChatBtn用）
    if (chatInput) {
        chatInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                const input = this.value.trim();
                if (input) {
                    sendChatMessage();
                }
            }
        });
    }
    
    // 質問例クリック
    document.querySelectorAll('.question-example').forEach(function(elem) {
        elem.addEventListener('click', function() {
            const question = this.getAttribute('data-question');
            if (chatInput) {
                chatInput.value = question;
                sendChatMessage();
            }
        });
    });
    
    // 価格スライダーイベント - 連動機能追加
    const minPriceSlider = document.getElementById('minPrice');
    const maxPriceSlider = document.getElementById('maxPrice');
    
    if (minPriceSlider) {
        minPriceSlider.addEventListener('input', function() {
            const minVal = parseInt(this.value);
            const maxPriceElement = document.getElementById('maxPrice');
            const maxVal = maxPriceElement ? parseInt(maxPriceElement.value) : 80;
            
            // 下限が上限を超えないように制限
            if (minVal > maxVal) {
                this.value = maxVal;
                const minPriceDisplay = document.getElementById('minPriceDisplay');
                if (minPriceDisplay) {
                    minPriceDisplay.textContent = `¥${formatPrice(maxVal * 1000)}`;
                }
            } else {
                const minPriceDisplay = document.getElementById('minPriceDisplay');
                if (minPriceDisplay) {
                    minPriceDisplay.textContent = `¥${formatPrice(minVal * 1000)}`;
                }
            }
        });
    }
    
    if (maxPriceSlider) {
        maxPriceSlider.addEventListener('input', function() {
            const maxVal = parseInt(this.value);
            const minPriceElement = document.getElementById('minPrice');
            const minVal = minPriceElement ? parseInt(minPriceElement.value) : 1;
            
            // 上限が下限を下回らないように制限
            if (maxVal < minVal) {
                this.value = minVal;
                const maxPriceDisplay = document.getElementById('maxPriceDisplay');
                if (maxPriceDisplay) {
                    maxPriceDisplay.textContent = `¥${formatPrice(minVal * 1000)}`;
                }
            } else {
                const maxPriceDisplay = document.getElementById('maxPriceDisplay');
                if (maxPriceDisplay) {
                    maxPriceDisplay.textContent = `¥${formatPrice(maxVal * 1000)}`;
                }
            }
        });
    }
    
    // リフレッシュボタン
    const refreshRecommendationBtn = document.getElementById('refreshRecommendation');
    if (refreshRecommendationBtn) {
        refreshRecommendationBtn.addEventListener('click', function() {
            // 四象限のリセットと履歴クリア
            resetTasteMatrices();
            clearChatHistory();
            
            // 除外リストもクリア
            excludedWhiskies.length = 0;
            lastRecommendedWhisky = null;
            
            // 提案パネルを非表示
            const splitLayoutContainer = document.getElementById('splitLayoutContainer');
            if (splitLayoutContainer) {
                splitLayoutContainer.style.display = 'none';
            }
            
            // チャート初期化
            if (profileChartInstance) {
                profileChartInstance.destroy();
                profileChartInstance = null;
            }
            
            // 蒸留所セクション初期化
            const distillerySection = document.getElementById('distillerySection');
            if (distillerySection) {
                distillerySection.classList.remove('active');
            }
        });
    }
    
    // マイク入力設定
    setupVoiceInput();
}

// マイク入力の処理
function setupVoiceInput() {
const voiceButton = document.getElementById('voiceInputBtn');
const chatInput = document.getElementById('chatInput');

// SpeechRecognition APIの確認
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
console.warn('Speech recognition not supported');
voiceButton.style.display = 'none';
return;
}

const recognition = new SpeechRecognition();
recognition.lang = 'ja-JP';
recognition.interimResults = true;
recognition.continuous = false;

let isRecording = false;

voiceButton.addEventListener('click', () => {
if (!isRecording) {
// 録音開始
recognition.start();
voiceButton.classList.add('recording');
voiceButton.textContent = '🔴';
isRecording = true;
} else {
// 録音終了
recognition.stop();
voiceButton.classList.remove('recording');
voiceButton.textContent = '🎙️';
isRecording = false;
}
});

// 音声認識結果
recognition.onresult = (event) => {
const transcript = Array.from(event.results)
.map(result => result[0])
.map(result => result.transcript)
.join('');

chatInput.value = transcript;
};

// エラー処理
recognition.onerror = (event) => {
console.error('Speech recognition error', event.error);
voiceButton.classList.remove('recording');
voiceButton.textContent = '🎙️';
isRecording = false;

if (event.error === 'not-allowed') {
showNotification('マイクへのアクセスが許可されていません。ブラウザの設定を確認してください。');
}
};

// 終了処理
recognition.onend = () => {
voiceButton.classList.remove('recording');
voiceButton.textContent = '🎙️';
isRecording = false;
};
}

// sendChatMessage関数の完全版（API連携付き）
async function sendChatMessage() {
    const input = document.getElementById('chatInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // チャット履歴に追加
    chatHistory.push({
        type: 'user',
        message: message,
        timestamp: new Date()
    });
    
    // チャット履歴を表示
    const chatHistoryDiv = document.getElementById('chatHistory');
    chatHistoryDiv.style.display = 'block';
    
    // ユーザーメッセージを追加
    const userMessage = document.createElement('div');
    userMessage.className = 'chat-message user-message';
    userMessage.textContent = message;
    chatHistoryDiv.appendChild(userMessage);
    
    input.value = '';
    
    // スクロールを最下部に
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
    
    // 現在の味覚座標をグローバル変数に保存
    const dot1 = document.getElementById('tasteDot1');
    const dot2 = document.getElementById('tasteDot2');
    if (dot1 && dot2) {
        window.currentX = parseFloat(dot1.style.left) || 150;
        window.currentY = parseFloat(dot1.style.top) || 150;
    }

    // メッセージから好みを抽出
    try {
        const prefs = extractPreferencesFromMessage(message);
        if (prefs && Object.keys(prefs).length > 0) {
            Object.assign(savedUserPreferences, prefs);
            updateUIWithPreferences(prefs);
        }
    } catch (error) {
        console.error('好み抽出エラー:', error);
    }

    // AIの応答を生成（API連携版）
    await getAIResponse(message);
}

// AI応答の取得（API連携版を復活）
async function getAIResponse(message) {
    const chatHistoryDiv = document.getElementById('chatHistory');
    
    // 考え中のメッセージを追加
    const thinkingMessage = document.createElement('div');
    thinkingMessage.className = 'chat-message ai-message thinking-animation';
    thinkingMessage.textContent = '';
    chatHistoryDiv.appendChild(thinkingMessage);
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;

    try {
        // 現在の設定値を取得
        const minPriceValue = parseInt(document.getElementById('minPrice').value);
        const maxPriceValue = parseInt(document.getElementById('maxPrice').value);
        const minPrice = minPriceValue * 1000;
        const maxPrice = maxPriceValue * 1000;

        // 味覚座標を取得
        const tasteX = window.currentX || 150;
        const tasteY = window.currentY || 150;

        // チャット履歴を収集
        const chatHistoryData = collectChatHistoryForAPI();

        // リクエストデータの構築
        const requestData = {
            minPrice: minPrice,
            maxPrice: maxPrice,
            tasteX: parseFloat(tasteX.toFixed(2)),
            tasteY: parseFloat(tasteY.toFixed(2)),
            additionalPreferences: message,
            chatHistory: chatHistoryData,
            timestamp: new Date().toISOString()
        };

        console.log('🚀 送信データ:', requestData);
        
        const apiUrl = 'https://ai-whisky-sommelier.netlify.app/.netlify/functions/claude-api';
        
        const response = await fetch(apiUrl, {
            method: 'POST',
            mode: 'cors',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            const errorText = await response.text();
            console.error('❌ HTTP Error:', response.status, errorText);
            throw new Error(`HTTP Error: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        console.log('✅ 成功レスポンス:', result);

        // 考え中メッセージを削除
        thinkingMessage.remove();

        if (result.success) {
            // レスポンスからAIメッセージを取得
            const aiMessage = result.data.choices?.[0]?.message?.content || 
                            result.data.content?.[0]?.text ||
                            'すみません、応答を取得できませんでした。';
            
            // AIメッセージを表示
            const responseMessage = document.createElement('div');
            responseMessage.className = 'chat-message ai-message';
            responseMessage.textContent = aiMessage;
            chatHistoryDiv.appendChild(responseMessage);

            // チャット履歴に追加
            chatHistory.push({
                type: 'ai',
                message: aiMessage,
                timestamp: new Date()
            });

            // チャット推薦から実際のJSON銘柄を検索してAI提案に反映
            await processAIRecommendationFromChat(aiMessage);

        } else {
            throw new Error(result.error || 'API応答エラー');
        }

    } catch (error) {
        console.error('❌ AI応答取得エラー:', error);
        
        // 考え中メッセージを削除
        if (thinkingMessage.parentNode) {
            thinkingMessage.remove();
        }
        
        // フォールバック：簡単なAI応答を生成
        const fallbackResponse = generateSimpleAIResponse(message);
        const responseMessage = document.createElement('div');
        responseMessage.className = 'chat-message ai-message';
        responseMessage.textContent = fallbackResponse;
        chatHistoryDiv.appendChild(responseMessage);

        // チャット履歴に追加
        chatHistory.push({
            type: 'ai',
            message: fallbackResponse,
            timestamp: new Date()
        });
    }

    // 推薦を更新
    generateAIRecommendations();
    
    // スクロールを最下部に
    chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
}

// チャット推薦からウィスキー銘柄を抽出して表示に反映する関数
async function processAIRecommendationFromChat(aiMessage) {
    try {
        console.log('🔍 AI推薦からウィスキー銘柄を抽出開始...');
        
        // AIメッセージからウィスキー銘柄を抽出
        const mentionedWhiskies = [];
        
        // 現在のwhiskyDataから銘柄名を検索
        whiskyData.forEach(whisky => {
            const whiskyName = whisky.name.toLowerCase();
            const aiMessageLower = aiMessage.toLowerCase();
            
            // 銘柄名の部分一致を確認
            const nameParts = whiskyName.split(/[\s　年]/);
            for (const part of nameParts) {
                if (part.length > 2 && aiMessageLower.includes(part)) {
                    if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                        mentionedWhiskies.push(whisky);
                    }
                    break;
                }
            }
        });
        
        console.log('🥃 抽出されたウィスキー:', mentionedWhiskies.map(w => w.name));
        
        if (mentionedWhiskies.length > 0) {
            // 現在の価格範囲でフィルタリング
            const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
            const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;
            
            const filteredWhiskies = mentionedWhiskies.filter(whisky => {
                try {
                    const numericPrice = parseInt(whisky.price.replace(/[¥,]/g, '')) || 0;
                    return numericPrice >= minPrice && numericPrice <= maxPrice;
                } catch (err) {
                    return true;
                }
            });
            
            if (filteredWhiskies.length > 0) {
                // 足りない場合は他のウィスキーで補完
                const finalSelection = [...filteredWhiskies];
                if (finalSelection.length < 3) {
                    const additionalWhiskies = whiskyData.filter(w => {
                        try {
                            const numericPrice = parseInt(w.price.replace(/[¥,]/g, '')) || 0;
                            return numericPrice >= minPrice && 
                                   numericPrice <= maxPrice && 
                                   !finalSelection.find(selected => selected.name === w.name);
                        } catch (err) {
                            return false;
                        }
                    }).sort(() => 0.5 - Math.random());
                    
                    while (finalSelection.length < 3 && additionalWhiskies.length > 0) {
                        finalSelection.push(additionalWhiskies.pop());
                    }
                }
                
                // 推薦パネルを表示して更新
                document.getElementById('splitLayoutContainer').style.display = 'grid';
                displayLocalRecommendations(finalSelection);
                
                if (finalSelection.length > 0) {
                    selectWhisky(finalSelection[0]);
                }
                
                console.log('✅ チャット推薦の統合が完了しました');
            }
        }
        
    } catch (error) {
        console.error('❌ チャット推薦処理エラー:', error);
    }
}

// API送信用のチャット履歴収集関数
function collectChatHistoryForAPI() {
    const chatHistoryDiv = document.getElementById('chatHistory');
    if (!chatHistoryDiv) return [];

    const messages = [];
    const messageElements = chatHistoryDiv.querySelectorAll('.chat-message');

    messageElements.forEach(element => {
        // 考え中メッセージは除外
        if (element.classList.contains('thinking-animation')) {
            return;
        }

        const content = element.textContent.trim();
        if (content && content !== '') {
            if (element.classList.contains('user-message')) {
                messages.push({
                    role: 'user',
                    content: content
                });
            } else if (element.classList.contains('ai-message')) {
                messages.push({
                    role: 'assistant',
                    content: content
                });
            }
        }
    });

    // 直近10メッセージに制限（APIの制限対応）
    return messages.slice(-10);
}

// チャットメッセージから好みを抽出する関数
function extractPreferencesFromMessage(message) {
if (!message) return {};

message = message.toLowerCase();
const preferences = {};

// 価格条件の抽出
const maxPriceRegex = /([\d,]+)円?(以下|まで|未満|より安い)/;
const minPriceRegex = /([\d,]+)円?(以上|から|より高い)/;
const priceRangeRegex = /([\d,]+)円?[〜～-]+([\d,]+)円?/;

// 価格範囲の抽出
const priceRangeMatch = message.match(priceRangeRegex);
if (priceRangeMatch) {
const minPrice = parseInt(priceRangeMatch[1].replace(/,/g, ''));
const maxPrice = parseInt(priceRangeMatch[2].replace(/,/g, ''));
preferences.minPrice = minPrice;
preferences.maxPrice = maxPrice;
} else {
// 最低価格の抽出
const minPriceMatch = message.match(minPriceRegex);
if (minPriceMatch) {
preferences.minPrice = parseInt(minPriceMatch[1].replace(/,/g, ''));
}

// 最高価格の抽出
const maxPriceMatch = message.match(maxPriceRegex);
if (maxPriceMatch) {
preferences.maxPrice = parseInt(maxPriceMatch[1].replace(/,/g, ''));
}
}

// 地域の抽出（修正版）
if (message.includes('アイラ') || message.includes('islay')) {
preferences.region = 'Islay';
} else if (message.includes('スペイサイド') || message.includes('speyside')) {
preferences.region = 'Speyside';
} else if (message.includes('ハイランド') || message.includes('highland')) {
preferences.region = 'Highland';
} else if (message.includes('日本') || message.includes('ジャパン') || message.includes('ジャパニーズ') || 
message.includes('japan') || message.includes('japanese')) {
preferences.region = 'Japan';
}

// 味の傾向の抽出
if (message.includes('スモーキー') || message.includes('ピート') || message.includes('smoke')) {
preferences.tasteY = 0.8; // スモーキー方向
} else if (message.includes('フルーティー') || message.includes('fruity') || message.includes('果実')) {
preferences.tasteY = 0.2; // フルーティー方向
}

if (message.includes('ヘビー') || message.includes('heavy') || message.includes('重い')) {
preferences.tasteX = 0.8; // ヘビー方向
} else if (message.includes('ライト') || message.includes('light') || message.includes('軽い')) {
preferences.tasteX = 0.2; // ライト方向
}

return preferences;
}

// 抽出した好みに基づいてUI要素を更新する関数
function updateUIWithPreferences(preferences) {
try {
// 価格スライダーの更新
if (preferences.minPrice) {
const minSlider = document.getElementById('minPrice');
if (minSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.minPrice / 1000)));
minSlider.value = value;
const minPriceDisplay = document.getElementById('minPriceDisplay');
if (minPriceDisplay) {
minPriceDisplay.textContent = `¥${value},000`;
}
}
}

if (preferences.maxPrice) {
const maxSlider = document.getElementById('maxPrice');
if (maxSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.maxPrice / 1000)));
maxSlider.value = value;
const maxPriceDisplay = document.getElementById('maxPriceDisplay');
if (maxPriceDisplay) {
maxPriceDisplay.textContent = `¥${value},000`;
}
}
}

// 味覚マトリクスの更新
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');

if (preferences.tasteX !== undefined && dot1) {
dot1.style.left = `${preferences.tasteX * 100}%`;
}

if (preferences.tasteY !== undefined && dot1) {
dot1.style.top = `${preferences.tasteY * 100}%`;
}

if (preferences.complexityX !== undefined && dot2) {
dot2.style.left = `${preferences.complexityX * 100}%`;
}

if (preferences.complexityY !== undefined && dot2) {
dot2.style.top = `${preferences.complexityY * 100}%`;
}

// 座標表示の更新
updateCoordinatesDisplay();
} catch (error) {
console.error('UI更新エラー:', error);
}
}

// 座標表示を更新する関数
function updateCoordinatesDisplay() {
try {
// 四象限1の座標更新
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');
if (dot1 && coords1) {
const xCoord = (parseFloat(dot1.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot1.style.top) / 100).toFixed(2);
coords1.textContent = `座標: X: ${xCoord}, Y: ${yCoord}`;
}

// 四象限2の座標更新
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');
if (dot2 && coords2) {
const xCoord = (parseFloat(dot2.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot2.style.top) / 100).toFixed(2);
coords2.textContent = `座標: X: ${xCoord}, Y: ${yCoord}`;
}
} catch (error) {
console.error('座標表示更新エラー:', error);
}
}

// チャット履歴をクリア
function clearChatHistory() {
const chatHistory = document.getElementById('chatHistory');
chatHistory.innerHTML = '';
chatHistory.style.display = 'none';
document.getElementById('chatInput').value = '';
}

// ウィスキーの蒸留所情報を更新（統合JSON対応）
function updateDistilleryInfo(whisky) {
try {
// 統合JSONから蒸溜所を取得
const distillery = getDistilleryForWhisky(whisky);

// 蒸留所セクションを表示
const distillerySection = document.getElementById('distillerySection');
distillerySection.classList.add('active');

if (distillery) {
console.log(`蒸留所情報が見つかりました:`, distillery.name);

// マップの初期化を試みる（Leaflet.jsが利用可能な場合のみ）
let mapInitialized = false;
if (typeof L !== 'undefined') {
if (!distilleryMap) {
mapInitialized = initializeCommonMap();
} else {
mapInitialized = true;
}

// マップが初期化できた場合はマーカーを更新
if (mapInitialized && distillery.location) {
try {
showDistilleryOnMap(distillery);
} catch (e) {
console.warn('マーカー更新エラー:', e);
}
}
}

// 蒸留所情報を表示
showDistilleryInfo(distillery);
} else {
// 蒸留所情報が見つからない場合
console.log('蒸留所情報が見つかりません');

// マップを非表示に
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}

// 簡易情報を表示
document.getElementById('distilleryName').textContent = whisky.name || '情報なし';
document.getElementById('distilleryRegion').textContent = whisky.region || '情報なし';
document.getElementById('distilleryFounded').textContent = '情報なし';

const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = '情報なし';
statusElement.className = 'status-unknown';

document.getElementById('distilleryDescription').textContent = 
`${whisky.name}の蒸留所情報は利用できません。このウィスキーは${whisky.region || '不明な地域'}で製造されています。`;
}
} catch (error) {
console.error('蒸留所情報更新エラー:', error);

// エラー時はマップを非表示にする
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// 蒸溜所をマップに表示（統合JSON対応・修正版）
function showDistilleryOnMap(distillery) {
    if (!distilleryMap || !distillery.location) {
        console.log('マップまたは位置情報が利用できません');
        return;
    }

    console.log('マップに蒸溜所を表示:', distillery);

    // マップの中心を更新
    distilleryMap.setView([distillery.location.lat, distillery.location.lng], distillery.zoomLevel || 10);

    // グローバル変数でアクティブマーカーとパルスマーカーを管理
    if (window.activeMarker) {
        distilleryMap.removeLayer(window.activeMarker);
    }
    if (window.pulseMarker) {
        distilleryMap.removeLayer(window.pulseMarker);
        clearInterval(window.pulseInterval);
    }

    // 既存のマーカーをクリア
    distilleryMap.eachLayer(function(layer) {
        if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
            distilleryMap.removeLayer(layer);
        }
    });

    // すべての蒸溜所をグリーンで表示（修正されたデータ構造に対応）
    Object.keys(distilleryData).forEach(distilleryKey => {
        const dist = distilleryData[distilleryKey];
        console.log('マーカー作成中:', distilleryKey, dist);
        
        if (dist.location && dist.location.lat && dist.location.lng) {
            const marker = L.circleMarker([dist.location.lat, dist.location.lng], {
                radius: 6,
                fillColor: '#4ecdc4',  // グリーン
                color: '#4ecdc4',
                weight: 2,
                opacity: 1,
                fillOpacity: 0.7
            }).addTo(distilleryMap);

            // クリックイベントを追加
            marker.on('click', function() {
                // 現在の蒸留所情報を表示
                const clickedDistillery = {
                    name: distilleryKey,
                    ...dist
                };

                // 蒸留所情報を表示
                displayDistilleryInfo(clickedDistillery);

                // 既存のアクティブマーカーを削除
                if (window.activeMarker) {
                    distilleryMap.removeLayer(window.activeMarker);
                }
                if (window.pulseMarker) {
                    distilleryMap.removeLayer(window.pulseMarker);
                    clearInterval(window.pulseInterval);
                }

                // 新しいアクティブマーカーを作成
                window.activeMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
                    radius: 10,
                    fillColor: '#ff6b6b',  // 赤
                    color: '#ff6b6b',
                    weight: 3,
                    opacity: 1,
                    fillOpacity: 0.8
                }).addTo(distilleryMap);

                // パルスマーカーを作成
                window.pulseMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
                    radius: 15,
                    fillColor: 'rgba(255, 107, 107, 0.3)',
                    color: '#ff6b6b',
                    weight: 1,
                    opacity: 0.6,
                    fillOpacity: 0.2
                }).addTo(distilleryMap);

                // パルスアニメーション
                let currentRadius = 15;
                let growing = true;
                window.pulseInterval = setInterval(() => {
                    if (growing) {
                        currentRadius += 0.5;
                        if (currentRadius >= 25) growing = false;
                    } else {
                        currentRadius -= 0.5;
                        if (currentRadius <= 12) growing = true;
                    }
                    window.pulseMarker.setRadius(currentRadius);
                }, 100);

                // マップの中心を更新
                distilleryMap.setView([dist.location.lat, dist.location.lng], 10);
            });

            // ホバー効果
            marker.on('mouseover', function() {
                marker.setStyle({
                    radius: 8,
                    fillOpacity: 0.9
                });

                // ツールチップ表示
                marker.bindTooltip(distilleryKey, {
                    permanent: false,
                    direction: 'top',
                    className: 'distillery-tooltip'
                }).openTooltip();
            });

            marker.on('mouseout', function() {
                marker.setStyle({
                    radius: 6,
                    fillOpacity: 0.7
                });
            });
        }
    });

    // 選択された蒸溜所を赤いビーコンで表示
    window.activeMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
        radius: 10,
        fillColor: '#ff6b6b',  // 赤
        color: '#ff6b6b',
        weight: 3,
        opacity: 1,
        fillOpacity: 0.8
    }).addTo(distilleryMap);

    // ビーコン効果（パルス）
    window.pulseMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
        radius: 15,
        fillColor: 'rgba(255, 107, 107, 0.3)',
        color: '#ff6b6b',
        weight: 1,
        opacity: 0.6,
        fillOpacity: 0.2
    }).addTo(distilleryMap);

    // パルスアニメーション
    let currentRadius = 15;
    let growing = true;
    window.pulseInterval = setInterval(() => {
        if (growing) {
            currentRadius += 0.5;
            if (currentRadius >= 25) growing = false;
        } else {
            currentRadius -= 0.5;
            if (currentRadius <= 12) growing = true;
        }
        window.pulseMarker.setRadius(currentRadius);
    }, 100);

    // マップのサイズを調整
    setTimeout(function() {
        if (distilleryMap) {
            distilleryMap.invalidateSize();
        }
    }, 100);
}

// 蒸留所情報を表示
function displayDistilleryInfo(distillery) {
// 蒸留所名と地域を表示
document.getElementById('distilleryName').textContent = distillery.name || '不明';
document.getElementById('distilleryRegion').textContent = distillery.region || '不明';

// 設立年
if (distillery.foundedYear) {
document.getElementById('distilleryFounded').textContent = distillery.foundedYear + '年';
} else {
document.getElementById('distilleryFounded').textContent = '不明';
}

// 状態（アクティブ、閉鎖など）
const statusElement = document.getElementById('distilleryStatus');
const status = distillery.status || '不明';
statusElement.textContent = status;

// 説明文
document.getElementById('distilleryDescription').textContent = 
distillery.description || '蒸留所の詳細情報は準備中です。';

// 情報セクションを表示
document.getElementById('distilleryInfoSection').style.display = 'block';
}

// 統計情報を更新（修正版）
function updateStatistics() {
    if (!whiskyData || !whiskyData.length) return;

    // ウィスキーの総数
    document.getElementById('whiskyCount').textContent = whiskyData.length;
    animateCounter('totalWhiskies', whiskyData.length);

    // ユニークな産地数
    const uniqueRegions = new Set();
    whiskyData.forEach(whisky => {
        if (whisky.region) {
            uniqueRegions.add(whisky.region.split(',')[0].trim());
        }
    });
    animateCounter('uniqueRegions', uniqueRegions.size);

    // 蒸溜所数のカウント（修正）
    if (distilleryData && typeof distilleryData === 'object') {
        const distilleryCount = Object.keys(distilleryData).length;
        animateCounter('distilleryCount', distilleryCount);
        console.log('蒸溜所数カウント:', distilleryCount);
    }
}

// 価格帯
let minPrice = Infinity;
let maxPrice = 0;

whiskyData.forEach(whisky => {
const price = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
if (price > 0) {
minPrice = Math.min(minPrice, price);
maxPrice = Math.max(maxPrice, price);
}
});

if (minPrice !== Infinity && maxPrice !== 0) {
document.getElementById('priceRange').textContent = `¥${formatPrice(minPrice)}〜¥${formatPrice(maxPrice)}`;
}

// 価格をフォーマット
function formatPrice(price) {
return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// AI推薦を取得（完全版・統一版）
async function getRecommendation() {
    try {
        // ローディング表示
        const loadingIndicator = document.getElementById('loadingIndicator');
        if (loadingIndicator) {
            loadingIndicator.style.display = 'block';
        }

        // 味覚座標の取得（安全版）
        const dot1 = document.getElementById('tasteDot1');
        const dot2 = document.getElementById('tasteDot2');
        
        let tasteX = 0.5, tasteY = 0.5, complexityX = 0.5, complexityY = 0.5;
        
        if (dot1 && dot1.style.left && dot1.style.top) {
            tasteX = parseFloat(dot1.style.left) / 100;
            tasteY = parseFloat(dot1.style.top) / 100;
        }
        
        if (dot2 && dot2.style.left && dot2.style.top) {
            complexityX = parseFloat(dot2.style.left) / 100;
            complexityY = parseFloat(dot2.style.top) / 100;
        }

        // 価格帯の取得（安全版）
        const minPriceElement = document.getElementById('minPrice');
        const maxPriceElement = document.getElementById('maxPrice');
        const minPrice = minPriceElement ? parseInt(minPriceElement.value) * 1000 : 0;
        const maxPrice = maxPriceElement ? parseInt(maxPriceElement.value) * 1000 : 999999;

        console.log('パラメータ取得完了:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice });
        console.log('現在の除外リスト:', excludedWhiskies);

        // チャットから抽出した好みと現在のUI値を統合
        const combinedPreferences = {
            tasteX: savedUserPreferences.tasteX !== null ? savedUserPreferences.tasteX : tasteX,
            tasteY: savedUserPreferences.tasteY !== null ? savedUserPreferences.tasteY : tasteY,
            complexityX: savedUserPreferences.complexityX !== null ? savedUserPreferences.complexityX : complexityX,
            complexityY: savedUserPreferences.complexityY !== null ? savedUserPreferences.complexityY : complexityY,
            minPrice: savedUserPreferences.minPrice !== null ? savedUserPreferences.minPrice : minPrice,
            maxPrice: savedUserPreferences.maxPrice !== null ? savedUserPreferences.maxPrice : maxPrice,
            region: savedUserPreferences.region
        };

        console.log('検索開始 - 好み情報:', {
            savedPreferences: savedUserPreferences,
            combinedPreferences: combinedPreferences
        });

        // プログレスバーの表示
        if (loadingIndicator) {
            loadingIndicator.style.display = 'none';
        }
        
        const progressContainer = document.getElementById('progressContainer');
        if (progressContainer) {
            progressContainer.style.display = 'block';
        }

        // プログレスバーを進行
        let progress = 0;
        const progressInterval = setInterval(() => {
            progress += 5;
            if (progress > 100) {
                clearInterval(progressInterval);
                const progressContainer = document.getElementById('progressContainer');
                if (progressContainer) {
                    progressContainer.style.display = 'none';
                }

                // 提案結果を表示
                showRecommendationResult(
                    combinedPreferences.tasteX, 
                    combinedPreferences.tasteY, 
                    combinedPreferences.complexityX, 
                    combinedPreferences.complexityY, 
                    combinedPreferences.minPrice, 
                    combinedPreferences.maxPrice, 
                    '',
                    combinedPreferences.region
                );
                return;
            }

            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            const progressText = document.getElementById('progressText');

            if (progressFill) progressFill.style.width = `${progress}%`;
            if (progressPercentage) progressPercentage.textContent = `${progress}%`;

            if (progressText) {
                if (progress === 30) {
                    progressText.textContent = 'ウィスキープロファイルを分析中...';
                } else if (progress === 60) {
                    progressText.textContent = '最適なマッチングを計算中...';
                } else if (progress === 90) {
                    progressText.textContent = '結果をまとめています...';
                }
            }
        }, 50);

        // 味の傾向の説明を更新
        updateTasteDescription(
            combinedPreferences.tasteX, 
            combinedPreferences.tasteY, 
            combinedPreferences.complexityX, 
            combinedPreferences.complexityY
        );

        // 価格帯の表示を更新
        const priceRangeElement = document.getElementById('priceRange');
        if (priceRangeElement) {
            priceRangeElement.textContent = 
                `¥${formatPrice(combinedPreferences.minPrice)} - ¥${formatPrice(combinedPreferences.maxPrice)}`;
        }

    } catch (error) {
        console.error('Error getting recommendations:', error);
        const loadingIndicator = document.getElementById('loadingIndicator');
        const progressContainer = document.getElementById('progressContainer');
        
        if (loadingIndicator) loadingIndicator.style.display = 'none';
        if (progressContainer) progressContainer.style.display = 'none';
        
        alert('提案の取得中にエラーが発生しました。もう一度お試しください。');
    }
}

// 味の傾向の説明を更新
function updateTasteDescription(tasteX, tasteY, complexityX, complexityY) {
let tasteDesc = '';
let complexityDesc = '';

// 基本的な味の傾向の説明
if (tasteX < 0.33) {
if (tasteY < 0.33) {
tasteDesc = 'ライトでフルーティー';
} else if (tasteY > 0.66) {
tasteDesc = 'ライトでスモーキー';
} else {
tasteDesc = 'ライトでバランスの良い';
}
} else if (tasteX > 0.66) {
if (tasteY < 0.33) {
tasteDesc = 'ヘビーでフルーティー';
} else if (tasteY > 0.66) {
tasteDesc = 'ヘビーでスモーキー';
} else {
tasteDesc = 'ヘビーでバランスの良い';
}
} else {
if (tasteY < 0.33) {
tasteDesc = 'バランスの良いフルーティー';
} else if (tasteY > 0.66) {
tasteDesc = 'バランスの良いスモーキー';
} else {
tasteDesc = 'バランスの取れた';
}
}

// 複雑さの好みの説明
if (complexityX < 0.33) {
if (complexityY < 0.33) {
complexityDesc = '若くてまろやか';
} else if (complexityY > 0.66) {
complexityDesc = '若くて強烈な複雑さを好む';
} else {
complexityDesc = '若くてバランスの良い複雑さを好む';
}
} else if (complexityX > 0.66) {
if (complexityY < 0.33) {
complexityDesc = '熟成されたまろやか';
} else if (complexityY > 0.66) {
complexityDesc = '熟成された強烈な複雑さを好む';
} else {
complexityDesc = '熟成されたバランスの良い複雑さを好む';
}
} else {
if (complexityY < 0.33) {
complexityDesc = 'バランスの良いまろやか';
} else if (complexityY > 0.66) {
complexityDesc = 'バランスの良い強烈な複雑さを好む';
} else {
complexityDesc = 'バランスの良い複雑さを好む';
}
}

// 説明文を更新
document.getElementById('tasteDescription').textContent = tasteDesc;
document.getElementById('complexityDescription').textContent = complexityDesc;
}

// 推薦結果を表示（チャット連携強化版）
async function showRecommendationResult(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, chatPreferences, region = null) {
    console.log('showRecommendationResult 開始:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region });

    try {
        document.getElementById('splitLayoutContainer').style.display = 'grid';

        // チャットで言及された銘柄を最優先で取得
        const chatMentionedWhiskies = getChatMentionedWhiskies();
        console.log('チャットで言及された銘柄:', chatMentionedWhiskies.map(w => w.name));

        // ローカルデータからのマッチング
        console.log('findMatchingWhiskies 呼び出し前...');
        const matchedWhiskies = findMatchingWhiskies(
            tasteX, tasteY, complexityX, complexityY, 
            minPrice, maxPrice, region, 
            excludedWhiskies
        );
        console.log('findMatchingWhiskies 結果:', matchedWhiskies);

        // チャット言及銘柄を最優先で組み合わせ
        const finalRecommendations = combineRecommendations(chatMentionedWhiskies, matchedWhiskies, minPrice, maxPrice);
        console.log('最終推薦リスト:', finalRecommendations.map(w => w.name));

        if (!finalRecommendations || finalRecommendations.length === 0) {
            if (excludedWhiskies.length > 0) {
                console.log('除外リストをクリアして再試行');
                excludedWhiskies.length = 0;
                return showRecommendationResult(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, chatPreferences, region);
            }
            
            console.error('推薦できるウィスキーがありません');
            displayDefaultRecommendations();
            return;
        }

        console.log('displayLocalRecommendations 呼び出し前...');
        displayLocalRecommendations(finalRecommendations);

        if (finalRecommendations.length > 0) {
            lastRecommendedWhisky = finalRecommendations[0];
            console.log('selectWhisky 呼び出し前:', finalRecommendations[0]);
            selectWhisky(finalRecommendations[0]);
        }
    } catch (error) {
        console.error('showRecommendationResult エラー:', error);
        displayDefaultRecommendations();
    }
}

// チャットで言及された銘柄を取得する関数
function getChatMentionedWhiskies() {
    const mentionedWhiskies = [];
    
    // チャット履歴を収集
    const chatMessages = document.querySelectorAll('.chat-message');
    const allChatText = Array.from(chatMessages)
        .map(msg => msg.textContent.toLowerCase())
        .join(' ');
    
    console.log('チャット内容を分析:', allChatText);
    
    if (!allChatText) return mentionedWhiskies;
    
    // whiskyDataから銘柄名を検索
    whiskyData.forEach(whisky => {
        const whiskyName = whisky.name.toLowerCase();
        const whiskyNameParts = whiskyName.split(/[\s　年]/);
        
        // 完全一致を優先
        if (allChatText.includes(whiskyName)) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('完全一致で発見:', whisky.name);
            }
            return;
        }
        
        // 部分一致（ブランド名など）
        for (const part of whiskyNameParts) {
            if (part.length > 2 && allChatText.includes(part)) {
                if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                    mentionedWhiskies.push(whisky);
                    console.log('部分一致で発見:', whisky.name, '(キーワード:', part, ')');
                }
                break;
            }
        }
        
        // 特別なブランド名の処理（日本語対応）
        if (allChatText.includes('マッカラン') && whiskyName.includes('macallan')) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('特別キーワードで発見:', whisky.name);
            }
        }
        
        // その他の特別な対応
        if (allChatText.includes('グレンフィディック') && whiskyName.includes('glenfiddich')) {
            if (!mentionedWhiskies.find(w => w.name === whisky.name)) {
                mentionedWhiskies.push(whisky);
                console.log('特別キーワードで発見:', whisky.name);
            }
        }
    });
    
    return mentionedWhiskies;
}

// チャット言及銘柄と味覚マッチング銘柄を組み合わせる関数（除外機能強化版）
function combineRecommendations(chatMentioned, matchedWhiskies, minPrice, maxPrice) {
    const finalList = [];
    
    console.log('推薦組み合わせ開始 - 除外リスト:', excludedWhiskies);
    
    // 1. チャットで言及された銘柄を最優先で追加（除外チェック強化）
    const filteredChatMentioned = chatMentioned.filter(whisky => {
        // 除外リストにないかチェック
        if (excludedWhiskies.includes(whisky.name)) {
            console.log('チャット銘柄が除外リストに含まれています:', whisky.name);
            return false;
        }
        
        // 価格フィルター
        try {
            const price = parseInt(whisky.price.replace(/[¥,]/g, ''));
            const inPriceRange = price >= minPrice && price <= maxPrice;
            if (!inPriceRange) {
                console.log('チャット銘柄が価格範囲外:', whisky.name, price, '範囲:', minPrice, '-', maxPrice);
            }
            return inPriceRange;
        } catch (err) {
            console.error('価格チェックエラー:', whisky.name, err);
            return true;
        }
    });
    
    // チャット言及銘柄を最初に追加
    filteredChatMentioned.forEach(whisky => {
        if (!finalList.find(w => w.name === whisky.name)) {
            finalList.push(whisky);
            console.log('チャット銘柄を優先追加:', whisky.name);
        }
    });
    
    // 2. 味覚マッチング銘柄で不足分を補完（除外チェック強化）
    if (finalList.length < 3) {
        const remainingSlots = 3 - finalList.length;
        const additionalWhiskies = matchedWhiskies.filter(whisky => {
            // 既に含まれていないかチェック
            if (finalList.find(w => w.name === whisky.name)) return false;
            
            // 除外リストにないかチェック
            if (excludedWhiskies.includes(whisky.name)) {
                console.log('味覚マッチング銘柄が除外リストに含まれています:', whisky.name);
                return false;
            }
            
            return true;
        }).slice(0, remainingSlots);
        
        additionalWhiskies.forEach(whisky => {
            finalList.push(whisky);
            console.log('味覚マッチング銘柄で補完:', whisky.name);
        });
    }
    
    // 3. まだ足りない場合は、価格範囲内のウィスキーから追加（除外チェック強化）
    if (finalList.length < 3) {
        const remainingSlots = 3 - finalList.length;
        const additionalWhiskies = whiskyData.filter(whisky => {
            // 既に含まれていないかチェック
            if (finalList.find(w => w.name === whisky.name)) return false;
            
            // 除外リストにないかチェック
            if (excludedWhiskies.includes(whisky.name)) {
                console.log('補完銘柄が除外リストに含まれています:', whisky.name);
                return false;
            }
            
            // 価格フィルター
            try {
                const price = parseInt(whisky.price.replace(/[¥,]/g, ''));
                return price >= minPrice && price <= maxPrice;
            } catch (err) {
                return true;
            }
        })
        .sort(() => 0.5 - Math.random()) // ランダムソート
        .slice(0, remainingSlots);
        
        additionalWhiskies.forEach(whisky => {
            finalList.push(whisky);
            console.log('価格範囲内銘柄で補完:', whisky.name);
        });
    }
    
    // 4. それでも足りない場合は除外リストをクリアして再試行
    if (finalList.length === 0 && excludedWhiskies.length > 0) {
        console.log('推薦銘柄が0件のため、除外リストをクリアします');
        excludedWhiskies.length = 0; // 配列をクリア
        return combineRecommendations(chatMentioned, matchedWhiskies, minPrice, maxPrice);
    }
    
    console.log('最終推薦構成:', finalList.map(w => w.name));
    console.log('現在の除外リスト:', excludedWhiskies);
    return finalList;
}

// マッチするウィスキーを見つける（デバッグ強化版）
function findMatchingWhiskies(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region = null, excludedNames = []) {
    console.log('findMatchingWhiskies 開始:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region, excludedNames });
    console.log('whiskyData の状態:', whiskyData ? `${whiskyData.length}件のデータあり` : 'データなし');

    if (!whiskyData || whiskyData.length === 0) {
        console.error('ウィスキーデータがありません');
        return [];
    }

    try {
        // 価格を数値に変換
        const whiskiesWithNumericPrice = whiskyData.map(whisky => {
            try {
                const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
                return { ...whisky, numericPrice };
            } catch (err) {
                console.error('価格変換エラー:', whisky, err);
                return { ...whisky, numericPrice: 0 };
            }
        });
        console.log('価格変換後:', `${whiskiesWithNumericPrice.length}件`);

        // **新規追加：除外リストでフィルタリング**
        const excludeFiltered = whiskiesWithNumericPrice.filter(whisky => {
            const isExcluded = excludedNames.includes(whisky.name);
            if (isExcluded) {
                console.log('除外:', whisky.name);
            }
            return !isExcluded;
        });
        console.log('除外フィルタ後:', `${excludeFiltered.length}件`);

        // 価格帯でフィルタリング（除外フィルタ済みデータを使用）
        const priceFiltered = excludeFiltered.filter(
            whisky => whisky.numericPrice >= minPrice && whisky.numericPrice <= maxPrice
        );
        console.log('価格フィルタ後:', `${priceFiltered.length}件`);

        // 地域でフィルタリング
        let regionFiltered = priceFiltered;
        if (region) {
            console.log(`地域フィルタリング: "${region}" を検索中...`);

            // サンプルデータの地域情報を表示
            console.log('サンプルデータ地域情報:');
            priceFiltered.slice(0, 5).forEach(w => console.log(`- ${w.name}: region=${w.region}, subcategory=${w.subcategory}`));

            // 地域フィルタリング
            regionFiltered = priceFiltered.filter(whisky => 
                (whisky.region && whisky.region.toLowerCase().includes(region.toLowerCase())) ||
                (whisky.subcategory && whisky.subcategory.toLowerCase().includes(region.toLowerCase())) ||
                (region.toLowerCase() === 'japan' && whisky.name && (
                    whisky.name.toLowerCase().includes('japan') ||
                    whisky.name.toLowerCase().includes('japanese') ||
                    whisky.name.toLowerCase().includes('軽井沢') ||
                    whisky.name.toLowerCase().includes('山崎') ||
                    whisky.name.toLowerCase().includes('白州') ||
                    whisky.name.toLowerCase().includes('響') ||
                    whisky.name.toLowerCase().includes('長濱')
                ))
            );
            console.log('地域フィルタ後:', `${regionFiltered.length}件`);

            // 結果がない場合は価格フィルタのみ適用
            if (regionFiltered.length === 0) {
                console.log('地域フィルタリングの結果が0件のため、価格フィルタのみを適用します');
                regionFiltered = priceFiltered;
            }
        }

        if (regionFiltered.length === 0) {
            // **修正：除外フィルタ済みデータを使用**
            console.log('フィルタリング結果が0件のため、除外フィルタ済みデータから選択します');
            return excludeFiltered.slice(0, 3);
        }

        // 味覚プロファイルの基準
        console.log('味覚プロファイルの基準を設定...');
        const targetFruity = tasteY < 0.5 ? 4 : 2;
        const targetSmoky = tasteY > 0.5 ? 4 : 2;
        const targetBody = tasteX > 0.5 ? 4 : 3;
        const targetComplexity = complexityX > 0.5 ? 4 : 3;
        console.log('ターゲット値:', { targetFruity, targetSmoky, targetBody, targetComplexity });

// スコアリング関数
function scoreWhisky(whisky) {
try {
if (!whisky.taste_profile) {
console.log(`${whisky.name}: taste_profileなし`);
return 0;
}

const fruityScore = 5 - Math.abs((whisky.taste_profile.fruity || 0) - targetFruity);
const smokyScore = 5 - Math.abs((whisky.taste_profile.smoky || 0) - targetSmoky);
const bodyScore = 5 - Math.abs((whisky.taste_profile.body || 0) - targetBody);
const complexityScore = 5 - Math.abs((whisky.taste_profile.complexity || 0) - targetComplexity);

return fruityScore + smokyScore + bodyScore + complexityScore;
} catch (err) {
console.error('スコアリングエラー:', whisky, err);
return 0;
}
}

// スコアでソート
console.log('スコアリング開始...');
const scored = regionFiltered.map(whisky => {
try {
return {
whisky: whisky,
score: scoreWhisky(whisky)
};
} catch (err) {
console.error('スコアマッピングエラー:', whisky, err);
return { whisky: whisky, score: 0 };
}
}).sort((a, b) => b.score - a.score);

console.log('スコアリング完了。上位スコア:');
scored.slice(0, 5).forEach(item => console.log(`- ${item.whisky.name}: ${item.score}`));

// 上位3つを返す
const result = scored.slice(0, 3).map(item => item.whisky);
console.log('最終結果:', result.map(w => w.name));
return result;
} catch (error) {
console.error('findMatchingWhiskies エラー:', error);
console.error('スタックトレース:', error.stack);
return [];
}
}

// ローカルデータからの提案を表示（チャット強調版）
function displayLocalRecommendations(whiskies) {
    console.log('displayLocalRecommendations 開始:', whiskies);

    try {
        const recommendationContent = document.getElementById('recommendationContent');
        if (!recommendationContent) {
            console.error('recommendationContent 要素が見つかりません');
            return;
        }

        recommendationContent.innerHTML = '';

        if (!whiskies || whiskies.length === 0) {
            console.error('表示するウィスキーがありません');
            displayDefaultRecommendations();
            return;
        }

        // チャットで言及された銘柄を取得（強調表示用）
        const chatMentioned = getChatMentionedWhiskies().map(w => w.name);

        whiskies.forEach((whisky, index) => {
            try {
                console.log(`ウィスキーカード作成 ${index}:`, whisky.name);

                const whiskeyCard = document.createElement('div');
                whiskeyCard.className = 'whisky-card';
                
                // チャットで言及された銘柄は特別な強調表示
                const isChatMentioned = chatMentioned.includes(whisky.name);
                
                if (index === 0) {
                    whiskeyCard.classList.add('featured', 'selected');
                }
                
                if (isChatMentioned) {
                    whiskeyCard.classList.add('chat-mentioned');
                }

                // HTMLエスケープ関数
                function escapeHtml(text) {
                    if (text === undefined || text === null) return '';
                    return String(text)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#039;');
                }

                // 安全なHTMLの作成
                whiskeyCard.innerHTML = `
                    ${index === 0 ? '<div class="featured-label">おすすめ</div>' : ''}
                    ${isChatMentioned ? '<div class="chat-label">🎯 チャット推薦</div>' : ''}
                    <div class="flex justify-between mb-2">
                        <h3 class="text-lg font-bold text-cyan-400">${escapeHtml(whisky.name)}</h3>
                        <span class="text-pink-500 font-bold">${escapeHtml(whisky.price)}</span>
                    </div>
                    <div class="mb-2">
                        <span class="text-gray-400 text-sm">
                            ${escapeHtml(whisky.region || 'N/A')} | ${escapeHtml(whisky.subcategory || 'Whisky')}
                            ${whisky.abv ? ` | ${whisky.abv}% ABV` : ''}
                        </span>
                    </div>
                    <p class="text-sm mb-3 text-left">${escapeHtml(whisky.tastingNote_ja || '情報がありません。')}</p>
                    <div class="grid grid-cols-3 gap-2 text-center text-xs">
                        <div>
                            <span class="block text-yellow-400">フルーティー</span>
                            <span class="block">${'★'.repeat((whisky.taste_profile?.fruity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.fruity || 0))}</span>
                        </div>
                        <div>
                            <span class="block text-yellow-400">スモーキー</span>
                            <span class="block">${'★'.repeat((whisky.taste_profile?.smoky || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.smoky || 0))}</span>
                        </div>
                        <div>
                            <span class="block text-yellow-400">複雑さ</span>
                            <span class="block">${'★'.repeat((whisky.taste_profile?.complexity || 0))}${'☆'.repeat(5 - (whisky.taste_profile?.complexity || 0))}</span>
                        </div>
                    </div>
                `;

                // クリックで選択
                whiskeyCard.addEventListener('click', function() {
                    document.querySelectorAll('.whisky-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    whiskeyCard.classList.add('selected');
                    selectWhisky(whisky);
                });

                recommendationContent.appendChild(whiskeyCard);
            } catch (err) {
                console.error(`ウィスキーカード ${index} の作成中にエラーが発生:`, err);
            }
        });
    } catch (error) {
        console.error('displayLocalRecommendations エラー:', error);
        displayDefaultRecommendations();
    }
}



// デフォルトの提案を表示
function displayDefaultRecommendations() {
const recommendationContent = document.getElementById('recommendationContent');
recommendationContent.innerHTML = `
               <div class="text-center p-4">
                   <p class="mb-4">申し訳ありませんが、現在提案を生成できません。</p>
                   <p>別の味覚プロファイルをお試しいただくか、チャットでお好みをお知らせください。</p>
               </div>
           `;
}

// ユーザーの好みのプロファイルを取得
function getUserProfile() {
// 味覚座標の取得
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');
const tasteX = parseFloat(dot1.style.left) / 100;
const tasteY = parseFloat(dot1.style.top) / 100;
const complexityX = parseFloat(dot2.style.left) / 100;
const complexityY = parseFloat(dot2.style.top) / 100;

// 座標から各指標の値（0-5）を計算
const fruity = Math.round(5 * (1 - tasteY));
const smoky = Math.round(5 * tasteY);
const body = Math.round(5 * tasteX);
const spicy = Math.round(2.5 * (tasteX + tasteY));
const sweetness = Math.round(2.5 * (2 - tasteX - tasteY));
const complexity = Math.round(5 * complexityX);

return {
fruity,
spicy,
body,
smoky,
sweetness,
complexity
};
}

// ウィスキー選択時の処理（マップエラー対応版）
function selectWhisky(whisky) {
// レーダーチャートを更新
updateProfileChart(whisky.taste_profile, whisky.name);

try {
// 蒸留所情報を表示（マップ関連の処理をエラーハンドリング）
if (typeof updateDistilleryInfo === 'function') {
updateDistilleryInfo(whisky);
} else {
console.warn('updateDistilleryInfo関数が存在しないため、蒸留所情報は表示されません');
// 代替の処理（簡易的な蒸留所情報表示）
showSimpleDistilleryInfo(whisky);
}
} catch (err) {
console.error('蒸留所情報表示エラー:', err);
// マップが表示できない場合のフォールバック処理
showSimpleDistilleryInfo(whisky);
}

// チャートパネルのスクロール処理を改善
const chartPanel = document.getElementById('chartPanel');
if (chartPanel) {
// 1. パネル内のスクロール位置を最上部に設定
chartPanel.scrollTop = 0;

// 2. モバイルなど小さい画面サイズでは、パネル自体も視界に入れる
if (window.innerWidth <= 1024) {
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
} else {
// PCサイズの場合は、パネルが画面に表示されるようスクロール
// しかし、急激なスクロールではなくスムーズに
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
}
}

// 蒸留所情報表示関数（左寄せに修正）
function showSimpleDistilleryInfo(whisky) {
try {
// 蒸留所セクションを表示
const distillerySection = document.getElementById('distillerySection');
if (distillerySection) {
distillerySection.classList.add('active');
}

// 蒸留所名の推測
let distilleryName = "情報なし";
if (whisky.name && whisky.name.includes('軽井沢')) {
distilleryName = "軽井沢蒸溜所";
} else if (whisky.name && whisky.name.includes('山崎')) {
distilleryName = "山崎蒸溜所";
} else if (whisky.name && whisky.name.includes('白州')) {
distilleryName = "白州蒸溜所";
} else if (whisky.region && whisky.region.includes('Japan')) {
distilleryName = "日本の蒸溜所";
} else if (whisky.region && whisky.region.includes('Islay')) {
distilleryName = "アイラ島の蒸溜所";
} else if (whisky.region && whisky.region.includes('Speyside')) {
distilleryName = "スペイサイドの蒸溜所";
} else if (whisky.region) {
distilleryName = `${whisky.region}の蒸溜所`;
}

// 蒸留所情報の表示（左寄せに修正）
const distilleryNameElement = document.getElementById('distilleryName');
if (distilleryNameElement) {
distilleryNameElement.textContent = distilleryName;
distilleryNameElement.style.textAlign = 'left'; // 左寄せに変更
}

const distilleryRegionElement = document.getElementById('distilleryRegion');
if (distilleryRegionElement) {
distilleryRegionElement.textContent = whisky.region || '情報なし';
distilleryRegionElement.style.textAlign = 'left'; // 左寄せに変更
}

const distilleryFoundedElement = document.getElementById('distilleryFounded');
if (distilleryFoundedElement) {
distilleryFoundedElement.textContent = '情報なし';
distilleryFoundedElement.style.textAlign = 'left'; // 左寄せに変更
}

const statusElement = document.getElementById('distilleryStatus');
if (statusElement) {
statusElement.textContent = '情報なし';
statusElement.className = 'status-unknown';
statusElement.style.textAlign = 'left'; // 左寄せに変更
}

// 蒸留所の説明（左寄せに修正）
const distilleryDescriptionElement = document.getElementById('distilleryDescription');
if (distilleryDescriptionElement) {
distilleryDescriptionElement.textContent = 
`${whisky.name}の蒸留所情報は現在利用できません。このウィスキーは${whisky.region || '不明な地域'}で製造されています。`;
distilleryDescriptionElement.style.textAlign = 'left'; // 左寄せに変更
}

// 情報グリッド全体も左寄せに
const distilleryInfoGrid = document.querySelector('.distillery-info-grid');
if (distilleryInfoGrid) {
distilleryInfoGrid.style.textAlign = 'left'; // 左寄せに変更
}

} catch (err) {
console.error('簡易蒸留所情報表示エラー:', err);
}
}

// マップ初期化
function initializeCommonMap() {
const mapElement = document.getElementById('distilleryMap');
if (!mapElement) return;

console.log('Initializing map with dark theme...');

// 既存のマップインスタンスがあれば削除
if (distilleryMap) {
distilleryMap.remove();
}

// 新しいマップインスタンスを作成（暗いテーマ）
distilleryMap = L.map('distilleryMap', {
center: [55.0, -3.0],  // スコットランド中心
zoom: 5,
zoomControl: false
});

// 暗いスタイルのタイルレイヤー
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
subdomains: 'abcd',
maxZoom: 19
}).addTo(distilleryMap);

// ズームコントロールを右下に
L.control.zoom({
position: 'bottomright'
}).addTo(distilleryMap);

// サイズを更新
setTimeout(() => {
distilleryMap.invalidateSize();
}, 100);

console.log('Map initialized with dark theme.');
return true;
}

// 蒸留所情報を表示（安全版）
function showDistilleryInfo(distillery) {
if (!distillery) return;

try {
// 地図が利用可能か確認
if (distilleryMap && typeof distilleryMap.setView === 'function' && 
distillery.location && distillery.location.lat && distillery.location.lng) {
// 地図をズームして該当蒸留所の位置を中心に
const zoomLevel = distillery.zoomLevel || 8;
distilleryMap.setView([distillery.location.lat, distillery.location.lng], zoomLevel);

// マップを表示
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'block';
}
} else {
// マップが使用不可の場合は非表示に
console.warn('マップが初期化されていないか、蒸留所の位置情報がありません');
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}

// 蒸留所情報の表示を更新
document.getElementById('distilleryName').textContent = distillery.name || '情報なし';
document.getElementById('distilleryRegion').textContent = distillery.region || '情報なし';
document.getElementById('distilleryFounded').textContent = distillery.foundedYear ? distillery.foundedYear + '年' : '情報なし';

// ステータス表示の設定
const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = distillery.status || '情報なし';
statusElement.className = '';  // クラスをリセット

if (distillery.status) {
if (distillery.status.includes('アクティブ') || distillery.status.includes('稼働中')) {
statusElement.classList.add('status-active');
} else if (distillery.status.includes('閉鎖')) {
statusElement.classList.add('status-closed');
} else {
statusElement.classList.add('status-unknown');
}
}

// 蒸留所の説明を更新
document.getElementById('distilleryDescription').textContent = distillery.description || '詳細情報がありません。';
} catch (error) {
console.error('蒸留所情報表示エラー:', error);

// エラー時はマップを非表示にする
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// レーダーチャート更新（ユーザーの好みと選択ウィスキーを重ねて表示）
function updateProfileChart(profile, name) {
if (!profile) return;

const ctx = document.getElementById('combinedProfileChart');
if (!ctx) return;

const chartTitle = document.getElementById('chartTitle');
chartTitle.textContent = name ? `あなたの好み vs ${name}` : 'あなたの好み';

// ユーザーの好みプロファイルを取得
const userProfile = getUserProfile();

// Canvasサイズを明示的に設定
ctx.style.width = '100%';
ctx.style.height = '320px';
ctx.width = ctx.offsetWidth;
ctx.height = 320;

// Chart.jsの設定
const chartOptions = {
plugins: {
legend: {
display: true,
position: 'bottom',
labels: {
color: 'rgba(255, 255, 255, 0.8)',
font: {
size: 14
}
}
},
tooltip: {
enabled: true
}
},
scales: {
r: {
angleLines: {
color: 'rgba(255, 255, 255, 0.1)'
},
grid: {
color: 'rgba(255, 255, 255, 0.1)'
},
pointLabels: {
font: {
size: 16
},
color: 'rgba(255, 255, 255, 0.9)'
},
ticks: {
display: false,
backdropColor: 'transparent'
},
beginAtZero: true,
min: 0,
max: 5
}
},
maintainAspectRatio: false,
responsive: true
};

// データセットの準備（2つのデータセットで表示）
const datasets = [
{
label: 'あなたの好み',
data: [
userProfile.fruity, 
userProfile.spicy, 
userProfile.body, 
userProfile.smoky, 
userProfile.sweetness, 
userProfile.complexity
],
backgroundColor: 'rgba(78, 205, 196, 0.2)',
borderColor: '#4ecdc4',
pointBackgroundColor: '#4ecdc4',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#4ecdc4',
fill: true
}
];

// 選択したウィスキーのデータがあれば追加
if (name) {
datasets.push({
label: name,
data: [
profile.fruity || 0,
profile.spicy || 0,
profile.body || 0,
profile.smoky || 0,
profile.sweetness || 0,
profile.complexity || 0
],
backgroundColor: 'rgba(255, 107, 107, 0.2)',
borderColor: '#ff6b6b',
pointBackgroundColor: '#ff6b6b',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#ff6b6b',
fill: true
});
}

// Chart.jsの更新または作成
if (profileChartInstance) {
// 既存のチャートを破棄してから再作成
profileChartInstance.destroy();
}

// 新しいチャートを作成
profileChartInstance = new Chart(ctx, {
type: 'radar',
data: {
labels: ['フルーティー', 'スパイシー', 'ボディ', 'スモーキー', '甘さ', '複雑さ'],
datasets: datasets
},
options: chartOptions
});

console.log('Radar chart updated with new data');
}

// 通知を表示
function showNotification(message) {
const notification = document.createElement('div');
notification.className = 'error-notification';

notification.innerHTML = `
               <div class="notification-content">
                   <div class="notification-icon">
                       <i class="fas fa-exclamation-circle"></i>
                   </div>
                   <div class="notification-message">
                       ${message}
                   </div>
                   <button class="notification-close">&times;</button>
               </div>
           `;

document.body.appendChild(notification);

// 閉じるボタン
notification.querySelector('.notification-close').addEventListener('click', function() {
notification.remove();
});

// 5秒後に自動で閉じる
setTimeout(function() {
if (notification.parentNode) {
notification.remove();
}
}, 5000);
}

// エラー表示関数
function showError(message) {
console.error('Error:', message);
// 必要に応じて追加のエラー表示ロジックをここに追加
}

</script>


<script id="html_badge_script1">
window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
"remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3%2FDuBA6s%2F4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE%2FG0eL9qcC2PHM%2FfezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4%2B0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c%2BiEGpY7DMnGKNiptaLE9nF%2BYMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP%2Fhc2Wel1QtoQ08mJNhlTFLw%2F66U%2FBoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2%2Bu5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk%2F1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g%3D%3D";
window.__genspark_locale = "ja-JP";
window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3/DuBA6s/4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE/G0eL9qcC2PHM/fezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4+0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c+iEGpY7DMnGKNiptaLE9nF+YMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP/hc2Wel1QtoQ08mJNhlTFLw/66U/BoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2+u5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk/1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g==";
</script>

<script id="html_notice_dialog_script" src="./index_files/notice_dialog.js.ダウンロード"></script>
<!-- ページ末尾に追加 -->
<script type="text/javascript">
function openGoogleTranslate() {
const currentUrl = window.location.href;
const translateUrl = `https://translate.google.com/translate?sl=auto&u=${encodeURIComponent(currentUrl)}`;
window.open(translateUrl, '_blank');
}
</script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>