<!DOCTYPE html>
<!-- saved from url=(0130)https://gensparkpublicblob.blob.core.windows.net/user-upload-image/page/tooluse_LBd2w0vdTtOf_OswSt8juA/whisky_sommelier_final.html -->
<html lang="ja"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<!-- HTMLã®headã‚¿ã‚°å†…ã«Google Fontsã®ãƒªãƒ³ã‚¯ã‚’è¿½åŠ  -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">

<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ˜¼ã®æœˆã€‚AIã‚½ãƒ ãƒªã‚¨</title>
<link href="./index_files/tailwind.min.css" rel="stylesheet">
<link rel="stylesheet" href="./index_files/all.min.css">
<script src="./index_files/chart.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"></script>
<!-- Leaflet.jsåœ°å›³ãƒ©ã‚¤ãƒ–ãƒ©ãƒª -->
<link rel="stylesheet" href="./index_files/leaflet.css" crossorigin="">
<script src="./index_files/leaflet.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰" crossorigin=""></script>
<style>
body {
background-color: #000;
color: #fff;
font-family: 'Noto Sans JP', sans-serif;
}
.header-container {
background: rgba(0, 0, 0, 0.9);
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
padding: 15px 0;
position: fixed;
top: 0;
left: 0;
right: 0;
z-index: 1000;
display: flex;
align-items: center;
justify-content: center;
}
.logo {
width: 90px;
height: 90px;
object-fit: contain;
border-radius: 8px;
background: rgba(78, 205, 197, 0);
border: 2px solid #4ecdc500;
padding: 5px;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’å¤‰æ›´ */
.header-title {
color: #fff;
font-size: 28px;
font-weight: bold;
text-align: center;
margin: 0;
text-shadow: 0 0 10px rgba(78, 205, 196, 0.7);
letter-spacing: 2px;
background: linear-gradient(45deg, #ffffff, #4ecdc4);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
position: relative;
}

.header-title:after {
content: "";
position: absolute;
bottom: -5px;
left: 50%;
transform: translateX(-50%);
width: 70%;
height: 1px;
background: linear-gradient(90deg, transparent, rgba(78, 205, 196, 0.7), transparent);
}

@keyframes glow {
from {
text-shadow: 0 0 5px rgba(78, 205, 196, 0.5);
}
to {
text-shadow: 0 0 15px rgba(78, 205, 196, 0.8), 0 0 20px rgba(255, 107, 107, 0.5);
}
}

/* ç¿»è¨³ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.translate-link {
display: flex;
align-items: center;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.2);
border-radius: 4px;
padding: 5px 10px;
margin-left: 10px;
transition: all 0.3s ease;
}

.translate-link:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-2px);
}

.translate-icon {
margin-right: 6px;
}

/* è¨€èªãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.language-links {
display: flex;
margin-left: 15px;
}

.language-links .nav-link {
margin-left: 10px;
font-size: 14px;
padding: 5px 8px;
}

/* ãƒ˜ãƒƒãƒ€ãƒ¼ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ - å³ç«¯ã«é…ç½® */
.nav-links {
position: absolute;
right: 20px;
display: flex;
gap: 15px;
}

.nav-link {
color: rgba(255, 255, 255, 0.8);
text-decoration: none;
font-size: 15px;
font-weight: 600;
transition: all 0.2s ease;
padding: 5px 10px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.05);
}

.nav-link:hover {
color: #fff;
background: rgba(78, 205, 196, 0.2);
}

.nav-link.active {
color: #fff;
background: rgba(78, 205, 196, 0.3);
border-bottom: 2px solid #4ecdc4;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ç”»é¢ã§é‡ãªã‚Šå›é¿ */
@media (max-width: 768px) {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®é«˜ã•ã‚’å¢—ã‚„ã—ã¦ä½™è£•ã‚’æŒãŸã›ã‚‹ */
  .header-container {
    padding: 15px 0 20px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
    flex-wrap: wrap;      /* æŠ˜ã‚Šè¿”ã—ã‚’è¨±å¯ */
  }
  
  /* ãƒ­ã‚´ã‚µã‚¤ã‚ºèª¿æ•´ */
  .logo {
    width: 80px;
    height: 80px;
  }
  
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’èª¿æ•´ */
  .header-title {
    font-size: 24px;
    margin: 0 auto 10px;
    width: 100%;
    text-align: center;
  }
  
  /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒ˜ãƒƒãƒ€ãƒ¼ä¸‹éƒ¨ã«ç§»å‹•ã—ã¦ä¸­å¤®æƒãˆ */
  .nav-links {
    position: relative;
    top: 10px;
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
  }
  
  .nav-link {
    font-size: 13px;
    padding: 4px 8px;
  }

  .language-links {
    margin-top: 10px;
    width: 100%;
    justify-content: center;
  }
}

.container-custom {
max-width: 1200px;
margin: 0 auto;
padding: 100px 20px 20px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ç”»é¢ã§é‡ãªã‚Šå›é¿ */
@media (max-width: 768px) {
  /* ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’å¤§å¹…ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
  .header-container {
    padding: 5px 0 20px; /* ã•ã‚‰ã«å°ã•ãï¼šä¸Š5pxã€ä¸‹20px */
    flex-wrap: wrap;
    min-height: auto; /* æœ€å°é«˜ã•ã‚’è‡ªå‹•ã« */
  }
  
  /* ãƒ­ã‚´ã‚’ã•ã‚‰ã«å°ã•ã */
  .logo {
    width: 50px; /* ã•ã‚‰ã«å°ã•ã */
    height: 50px;
  }
  
  /* ãƒ­ã‚´ã®ä½ç½®èª¿æ•´ */
  .header-container a[target="_blank"] {
    position: absolute;
    left: 15px;
    top: 5px; /* ã‚ˆã‚Šä¸Šã« */
  }
  
  /* ã‚¿ã‚¤ãƒˆãƒ«ã‚’ã•ã‚‰ã«å°ã•ã */
  .header-title {
    font-size: 18px; /* ã•ã‚‰ã«å°ã•ã */
    margin: 0 auto 3px; /* ãƒãƒ¼ã‚¸ãƒ³ã‚’æœ€å°ã« */
    width: 100%;
    text-align: center;
  }
  
  /* ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ã•ã‚‰ã«ä¸Šã« */
  .nav-links {
    position: relative;
    top: 0px; /* ä¸Šã®ä½™ç™½ã‚’ãªãã™ */
    right: 0;
    width: 100%;
    justify-content: center;
    flex-wrap: wrap;
    gap: 8px; /* é–“éš”ã‚’ç‹­ã */
  }
  
  /* ãƒªãƒ³ã‚¯ã‚’ã•ã‚‰ã«ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã« */
  .nav-link {
    font-size: 11px; /* ã•ã‚‰ã«å°ã•ã */
    padding: 2px 6px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’æœ€å°ã« */
  }

  /* è¨€èªãƒªãƒ³ã‚¯ã®ä½™ç™½ã‚’æœ€å°ã« */
  .language-links {
    margin-top: 2px; /* æœ€å°ã®ãƒãƒ¼ã‚¸ãƒ³ */
    width: 100%;
    justify-content: center;
  }
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®èª¿æ•´ */
@media (max-width: 768px) {
  .container-custom {
    padding-top: 90px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ãŒã•ã‚‰ã«å°ã•ããªã£ãŸã®ã§å¤§å¹…ã«å‰Šæ¸› */
  }
}

/* ã•ã‚‰ã«å°ã•ã„ç”»é¢ã‚µã‚¤ã‚ºå‘ã‘ */
@media (max-width: 360px) {
  .container-custom {
    padding-top: 180px; /* ã•ã‚‰ã«å°ã•ã„ç”»é¢ã§ã¯ã‚ˆã‚Šå¤§ããªãƒ‘ãƒ‡ã‚£ãƒ³ã‚° */
  }
}

/* å‘³è¦šãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.taste-matrix {
width: 300px; /* PCè¡¨ç¤ºæ™‚ã®ã‚µã‚¤ã‚º */
height: 300px;
border: 2px solid #fff;
position: relative;
background: linear-gradient(to right, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%), 
linear-gradient(to top, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0.1) 100%);
}

.taste-dot {
width: 24px;
height: 24px;
background-color: #ff6b6b;
border-radius: 50%;
position: absolute;
transform: translate(-50%, -50%);
cursor: pointer;
box-shadow: 0 0 10px rgba(255, 107, 107, 0.5);
}

.dual-matrix-container {
display: grid;
grid-template-columns: 1fr 1fr;
gap: 40px;
margin-top: 20px;
}

.matrix-wrapper {
display: flex;
flex-direction: column;
align-items: center;
}

.matrix-title {
font-size: 18px;
font-weight: bold;
margin-bottom: 20px;
color: #4ecdc4;
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºã®ä¿®æ­£ */
@media (max-width: 1024px) {
  .dual-matrix-container {
    grid-template-columns: 1fr;
    gap: 30px;
  }
}

/* ã‚¹ãƒãƒ›ã‚µã‚¤ã‚ºã§ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã‚’ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«åã‚ã‚‹ */
@media (max-width: 768px) {
  .taste-matrix {
    width: 250px; /* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯å¹…ã‚’ç¸®å° */
    height: 250px;
  }
  
  .matrix-wrapper {
    max-width: 100%;
  }
  
  /* ä½™ç™½èª¿æ•´ */
  .absolute.left-1\/2 {
    width: 100%;
  }
}

/* ã•ã‚‰ã«å°ã•ã„ã‚¹ãƒãƒ›ç”»é¢ã®å¯¾å¿œ */
@media (max-width: 360px) {
  .taste-matrix {
    width: 220px; /* ã‚ˆã‚Šå°ã•ã„ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã¯ã•ã‚‰ã«ç¸®å° */
    height: 220px;
  }
  
  /* è»¸ãƒ©ãƒ™ãƒ«ã®ä½ç½®èª¿æ•´ */
  .absolute.-left-12 {
    left: -10px;
  }
  
  .absolute.-right-12 {
    right: -10px;
  }
}

.btn-primary {
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
border: none;
color: white;
padding: 12px 24px;
border-radius: 8px;
font-weight: bold;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-primary:hover {
transform: translateY(-2px);
box-shadow: 0 8px 25px rgba(255, 107, 107, 0.3);
}
.btn-primary:disabled {
opacity: 0.5;
cursor: not-allowed;
transform: none;
}
.btn-secondary {
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
color: white;
padding: 8px 16px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.btn-secondary:hover {
background: rgba(255, 255, 255, 0.2);
}
.card {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px;
margin-bottom: 24px;
backdrop-filter: blur(10px);
}

/* è¦‹å‡ºã—ã®ä½™ç™½ã‚’èª¿æ•´ã™ã‚‹ã‚«ã‚¹ã‚¿ãƒ ã‚¹ã‚¿ã‚¤ãƒ« */
.card h2 {
padding-top: 0px;      /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
padding-bottom: 15px;   /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
line-height: 0.8;       /* è¡Œã®é«˜ã•ã‚’èª¿æ•´ */
margin-bottom: 20px;    /* ä¸‹ã®ãƒãƒ¼ã‚¸ãƒ³ã‚’è¨­å®šï¼ˆmb-4ã‚’ä¸Šæ›¸ãï¼‰ */
}

/* split-layoutã®èª¿æ•´ - ãƒ‘ãƒãƒ«é–“ã®é–“éš”ã‚’åºƒã’ã‚‹ */
.split-layout {
gap: 400px;               /* ãƒ‘ãƒãƒ«é–“ã®é–“éš”ã‚’ã‚ˆã‚Šåºƒã */
}

.whisky-card {
background: rgba(255, 255, 255, 0.08);
border: 1px solid rgba(255, 255, 255, 0.15);
border-radius: 8px;
padding: 16px;
margin-bottom: 16px;
cursor: pointer;
transition: all 0.3s ease;
position: relative;
}
.whisky-card:hover {
background: rgba(255, 255, 255, 0.12);
border-color: #4ecdc4;
transform: translateY(-2px);
}
.whisky-card.selected {
background: rgba(78, 205, 196, 0.15);
border-color: #4ecdc4;
box-shadow: 0 0 15px rgba(78, 205, 196, 0.3);
}
.whisky-card.featured {
background: linear-gradient(135deg, rgba(255, 165, 0, 0.15), rgba(255, 215, 0, 0.10));
border: 2px solid #FFA500;
box-shadow: 0 0 20px rgba(255, 165, 0, 0.4);
animation: pulse-orange 2s infinite;
}
@keyframes pulse-orange {
0% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
50% { box-shadow: 0 0 30px rgba(255, 165, 0, 0.6); }
100% { box-shadow: 0 0 20px rgba(255, 165, 0, 0.4); }
}
.featured-label {
position: absolute;
top: -10px;
right: 10px;
background: linear-gradient(45deg, #FFA500, #FFD700);
color: #000;
padding: 4px 8px;
border-radius: 4px;
font-size: 12px;
font-weight: bold;
}
.loading {
display: none;
text-align: center;
color: #4ecdc4;
}
.progress-container {
display: none;
margin-top: 20px;
}
.progress-bar {
width: 100%;
height: 20px;
background: rgba(255, 255, 255, 0.1);
border-radius: 10px;
overflow: hidden;
margin-bottom: 10px;
}
.progress-fill {
height: 100%;
background: linear-gradient(45deg, #ff6b6b, #4ecdc4);
width: 0%;
transition: width 0.3s ease;
}
.progress-text {
color: #4ecdc4;
font-size: 14px;
margin-bottom: 5px;
}
.progress-percentage {
color: #fff;
font-size: 16px;
font-weight: bold;
}
.error {
color: #ff6b6b;
background: rgba(255, 107, 107, 0.1);
border: 1px solid rgba(255, 107, 107, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.success {
color: #4ecdc4;
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
padding: 12px;
border-radius: 8px;
margin-top: 12px;
}
.price-slider {
-webkit-appearance: none;
width: 100%;
height: 8px;
border-radius: 5px;
background: rgba(255, 255, 255, 0.2);
outline: none;
margin: 10px 0;
}
.price-slider::-webkit-slider-thumb {
-webkit-appearance: none;
appearance: none;
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
}
.price-slider::-moz-range-thumb {
width: 20px;
height: 20px;
border-radius: 50%;
background: #4ecdc4;
cursor: pointer;
border: none;
}
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
}
.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
}
.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
}

/* split-layoutã®ä¿®æ­£ - ä½™ç™½ã‚’å¢—ã‚„ã™ */
.split-layout {
display: grid;
grid-template-columns: 1fr 1fr; /* å‡ç­‰ã«åˆ†å‰² */
gap: 30px; /* é–“éš”ã‚’åºƒã’ã‚‹ï¼ˆå…ƒã¯20pxï¼‰ */
align-items: start;
margin-bottom: 30px; /* ä¸‹éƒ¨ã«ä½™ç™½ã‚’è¿½åŠ  */
}

/* ãƒ¬ã‚³ãƒ¡ãƒ³ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒãƒ«ã®ä¿®æ­£ */
.recommendations-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 24px;
backdrop-filter: blur(10px);
max-height: 85vh; /* å°‘ã—é«˜ã•ã‚’å¢—ã‚„ã™ */
overflow-y: auto;
margin-bottom: 30px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

/* ãƒãƒ£ãƒ¼ãƒˆãƒ‘ãƒãƒ«ã®ä¿®æ­£ - é‡è¦ãªä¿®æ­£éƒ¨åˆ† */
.chart-panel {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(255, 255, 255, 0.1);
border-radius: 12px;
padding: 30px 20px; /* ä¸Šä¸‹ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
backdrop-filter: blur(10px);
position: sticky;
top: 130px; /* å°‘ã—ä¸‹ã’ã‚‹ */
max-height: 85vh; /* å°‘ã—é«˜ã•ã‚’å¢—ã‚„ã™ */
overflow-y: auto;
scrollbar-width: thin;
scrollbar-color: rgba(78, 205, 196, 0.5) rgba(255, 255, 255, 0.1);
margin-bottom: 20px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

.chart-panel::-webkit-scrollbar {
width: 8px;
}

.chart-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.chart-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®ä¿®æ­£ */
.chart-container {
height: 380px; /* é«˜ã•ã‚’å¢—ã‚„ã™ï¼ˆå…ƒã¯350pxï¼‰ */
width: 100%;
position: relative;
margin-bottom: 30px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
/* ãƒãƒ£ãƒ¼ãƒˆã‚³ãƒ³ãƒ†ãƒŠã®è¦‹å‡ºã—ä¿®æ­£ */
.chart-container h3 {
text-align: center;
margin-bottom: 25px; /* ä½™ç™½ã‚’å¢—ã‚„ã™ */
color: #4ecdc4;
font-size: 16px;
padding-top: 10px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
/* ãƒãƒ£ãƒ¼ãƒˆã‚­ãƒ£ãƒ³ãƒã‚¹ã®ä¿®æ­£ */
.chart-canvas {
height: 350px !important;
width: 100% !important;
margin-top: 15px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}

#combinedProfileChart {
height: 350px !important; /* é«˜ã•ã‚’å¢—ã‚„ã™ï¼ˆå…ƒã¯320pxï¼‰ */
width: 100% !important;
margin-top: 20px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
margin-bottom: 20px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
}
.recommendation-summary {
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 8px;
padding: 16px;
margin-bottom: 20px;
color: #4ecdc4;
}

.custom-footer {
display: none;
text-align: center;
padding: 20px;
color: rgba(255, 255, 255, 0.6);
font-size: 12px;
margin-top: 40px;
}

.whisky-overview {
background: linear-gradient(135deg, rgba(78, 205, 196, 0.1), rgba(255, 107, 107, 0.1));
border: 2px solid rgba(78, 205, 196, 0.3);
border-radius: 16px;
padding: 30px;
margin-bottom: 30px;
text-align: center;
position: relative;
overflow: hidden;
}

.whisky-overview::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.1), transparent);
animation: shimmer 3s infinite;
}

@keyframes shimmer {
0% { transform: translateX(-100%); }
100% { transform: translateX(100%); }
}

.whisky-overview h2 {
font-size: 2.5rem;
font-weight: bold;
background: linear-gradient(45deg, #4ecdc4, #ff6b6b);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
margin-bottom: 20px;
position: relative;
z-index: 1;
}

.whisky-overview .subtitle {
font-size: 1.2rem;
color: #4ecdc4;
margin-bottom: 15px;
font-weight: 600;
position: relative;
z-index: 1;
}

.whisky-overview .description {
font-size: 1.1rem;
line-height: 1.6;
color: rgba(255, 255, 255, 0.9);
position: relative;
z-index: 1;
}

.whisky-stats {
display: flex;
justify-content: space-around;
margin-top: 25px;
margin-bottom: 24px;  /* ä¸‹ãƒãƒ¼ã‚¸ãƒ³ã‚’å¢—ã‚„ã™ï¼ˆæ•°å€¤ã¯èª¿æ•´å¯èƒ½ï¼‰ */
position: relative;
z-index: 1;
}

.stat-item {
text-align: center;
}

.stat-number {
font-size: 2rem;
font-weight: bold;
color: #ff6b6b;
display: block;
}

.stat-label {
font-size: 0.9rem;
color: rgba(255, 255, 255, 0.7);
margin-top: 5px;
}

.taste-icon {
width: 24px;
height: 24px;
margin-right: 8px;
fill: #4ecdc4;
}

.chat-section {
margin-top: 30px;
}

.chat-examples {
display: grid;
grid-template-columns: 1fr 1fr;  /* 2åˆ—ã«è¨­å®š */
grid-template-rows: auto auto;   /* 2è¡Œã«è¨­å®š */
gap: 10px;
background: rgba(78, 205, 196, 0.05);
border: 1px solid rgba(78, 205, 196, 0.2);
border-radius: 8px;
padding: 15px;
margin-bottom: 15px;
}

/* è³ªå•ä¾‹ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¨å¹…ã« */
.chat-examples .mb-3 {
grid-column: 1 / -1;  /* 1åˆ—ç›®ã‹ã‚‰æœ€å¾Œã®åˆ—ã¾ã§åºƒã’ã‚‹ */
}

.question-example {
/* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
display: flex;
align-items: center;
justify-content: center;  /* æ¨ªæ–¹å‘ã‚‚ä¸­å¤®æƒãˆ */
height: 100%;
margin-bottom: 0;
padding: 8px 12px;

/* ã‚¹ã‚¿ã‚¤ãƒ« */
background: rgba(78, 205, 196, 0.1);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 6px;
color: #4ecdc4;

/* ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ã‚·ãƒ§ãƒ³ */
cursor: pointer;
transition: all 0.3s ease;
}

/* ãƒ›ãƒãƒ¼åŠ¹æœã¯ç¶­æŒ */
.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.question-example:hover {
background: rgba(78, 205, 196, 0.2);
transform: translateY(-1px);
}

.chat-input-container {
display: flex;
gap: 10px;
margin-bottom: 20px;
}

.chat-input {
flex: 1;
background: rgba(255, 255, 255, 0.1);
border: 1px solid rgba(255, 255, 255, 0.3);
border-radius: 8px;
padding: 12px;
color: #fff;
font-size: 14px;
}

.chat-input:focus {
outline: none;
border-color: #4ecdc4;
box-shadow: 0 0 0 2px rgba(78, 205, 196, 0.2);
}

/* ã‚¹ãƒãƒ›è¡¨ç¤ºæ™‚ã®ãƒãƒ£ãƒƒãƒˆå…¥åŠ›ã‚¨ãƒªã‚¢ä¿®æ­£ */
@media (max-width: 768px) {
  .chat-input-container {
    flex-direction: column; /* ç¸¦ä¸¦ã³ã«å¤‰æ›´ */
    gap: 10px; /* ãƒœã‚¿ãƒ³é–“ã®ä½™ç™½ */
  }
  
  .chat-input {
    width: 100%; /* å…¥åŠ›æ¬„ã‚’å…¨å¹…ã« */
    margin-bottom: 10px; /* å…¥åŠ›æ¬„ã®ä¸‹ã«ä½™ç™½ */
  }
  
  /* ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ã‚’æ¨ªä¸¦ã³ã« */
  .chat-buttons {
    display: flex;
    gap: 10px;
    width: 100%;
  }
  
  .voice-input-btn {
    flex: 0 0 auto; /* ã‚µã‚¤ã‚ºå›ºå®š */
    min-width: 50px; /* æœ€å°å¹…ã‚’ç¢ºä¿ */
  }
  
  .btn-primary {
    flex: 1; /* æ®‹ã‚Šã®ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½¿ç”¨ */
    min-width: 0; /* æœ€å°å¹…åˆ¶é™ã‚’è§£é™¤ */
  }
}

.chat-history {
max-height: 400px;
overflow-y: auto;
padding: 15px;
background: rgba(0, 0, 0, 0.3);
border-radius: 8px;
margin-bottom: 15px;
display: none;
}

.chat-message {
margin-bottom: 15px;
padding: 12px;
border-radius: 8px;
word-wrap: break-word;
white-space: pre-wrap;
line-height: 1.6;
font-size: 14px;
}

/* AIãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ã‚¹ã‚¿ã‚¤ãƒ«ä¿®æ­£ */
.ai-message {
text-align: left;  /* å·¦å¯„ã›ã«è¨­å®š */
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
}

/* å¿…è¦ã«å¿œã˜ã¦é€šå¸¸ã®ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚‚å·¦å¯„ã›ã« */
.chat-message {
text-align: left;  /* å·¦å¯„ã›ã«è¨­å®š */
/* ãã®ä»–ã®æ—¢å­˜ã‚¹ã‚¿ã‚¤ãƒ« */
}

.user-message {
background: rgba(255, 107, 107, 0.15);
border-left: 3px solid #ff6b6b;
color: #fff;
}

.chat-history::-webkit-scrollbar {
width: 6px;
}

.chat-history::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 3px;
}

.chat-history::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 3px;
}

/* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œã®ä¿®æ­£ */
@media (max-width: 1024px) {
.split-layout {
grid-template-columns: 1fr;
gap: 30px; /* é–“éš”ã‚’åºƒã’ã‚‹ */
}

.chart-panel {
position: static;
margin-top: 30px; /* ä¸Šéƒ¨ã®ä½™ç™½ã‚’è¿½åŠ  */
padding: 30px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å‡ç­‰ã« */
}

.whisky-overview h2 {
font-size: 2rem;
}

.whisky-stats {
flex-direction: column;
gap: 15px;
}

.dual-matrix-container {
grid-template-columns: 1fr;
gap: 30px;
}
}

@media (max-width: 768px) {
.custom-footer {
display: block;
}

.whisky-overview h2 {
font-size: 1.8rem;
}

.whisky-overview .subtitle {
font-size: 1rem;
}

.whisky-overview .description {
font-size: 1rem;
}
}

.recommendations-panel::-webkit-scrollbar {
width: 8px;
}

.recommendations-panel::-webkit-scrollbar-track {
background: rgba(255, 255, 255, 0.1);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb {
background: rgba(78, 205, 196, 0.5);
border-radius: 4px;
}

.recommendations-panel::-webkit-scrollbar-thumb:hover {
background: rgba(78, 205, 196, 0.7);
}

/* è’¸ç•™æ‰€ãƒãƒƒãƒ—ã¨æƒ…å ±ãƒ‘ãƒãƒ« */
.distillery-section {
margin-top: 20px;
opacity: 0;
height: 0;
overflow: hidden;
transition: opacity 0.8s ease, height 0.8s ease;
}

.distillery-section.active {
opacity: 1;
height: auto;
}

.distillery-container {
display: flex;
flex-direction: column;
gap: 20px;
}

.map-container {
height: 300px;
border-radius: 12px;
overflow: hidden;
border: 2px solid rgba(78, 205, 196, 0.3);
background-color: #1a1a1a;
}

#distilleryMap {
height: 100%;
width: 100%;
background-color: #242424;
}

.distillery-info {
background: rgba(255, 255, 255, 0.05);
border: 1px solid rgba(78, 205, 196, 0.3);
border-radius: 12px;
padding: 16px;
color: #fff;
}

.distillery-info h3 {
color: #4ecdc4;
font-size: 18px;
font-weight: bold;
margin-bottom: 10px;
border-bottom: 1px solid rgba(78, 205, 196, 0.3);
padding-bottom: 8px;
}

.distillery-info-grid {
display: grid;
grid-template-columns: auto 1fr;
gap: 8px 16px;
margin-top: 15px;
}

.info-label {
color: rgba(255, 255, 255, 0.7);
font-weight: 600;
}

.info-value {
color: rgba(255, 255, 255, 0.9);
}

/* distilleryDescriptionã‚’å·¦å¯„ã›ã«ã™ã‚‹CSSä¿®æ­£ */
.distillery-description {
margin-top: 15px;
line-height: 1.6;
text-align: left; /* å·¦å¯„ã›ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š */
}
.status-active {
color: #4ecdc4;
font-weight: bold;
}

.status-closed {
color: #ff6b6b;
font-weight: bold;
}

.status-unknown {
color: #ffb347;
font-weight: bold;
}

/* Leafletãƒãƒƒãƒ—ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚«ã‚¹ã‚¿ãƒã‚¤ã‚º */
.leaflet-container {
background-color: #242424 !important;
}
.leaflet-tile-pane {
opacity: 0.9;
}
.leaflet-popup-content-wrapper {
background-color: rgba(40, 44, 52, 0.95) !important;
color: #fff !important;
border: 1px solid rgba(78, 205, 196, 0.5);
}
.leaflet-popup-tip {
background-color: rgba(40, 44, 52, 0.95) !important;
}
.leaflet-control-zoom a {
background-color: rgba(40, 44, 52, 0.8) !important;
color: #fff !important;
border-color: rgba(78, 205, 196, 0.3) !important;
}
.leaflet-control-zoom a:hover {
background-color: rgba(78, 205, 196, 0.3) !important;
}

/* éŸ³å£°å…¥åŠ›ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ« */
.voice-input-btn {
background: rgba(78, 205, 196, 0.2);
border: 1px solid #4ecdc4;
color: #4ecdc4;
padding: 8px 12px;
border-radius: 6px;
cursor: pointer;
transition: all 0.3s ease;
font-size: 18px;
}

.voice-input-btn:hover {
background: rgba(78, 205, 196, 0.3);
transform: translateY(-2px);
}

.voice-input-btn.recording {
background: rgba(255, 107, 107, 0.3);
border-color: #ff6b6b;
color: #ff6b6b;
animation: pulse-recording 1.5s infinite;
}

@keyframes pulse-recording {
0% { transform: scale(1); }
50% { transform: scale(1.1); }
100% { transform: scale(1); }
}

.error-notification {
position: fixed;
top: 20px;
right: 20px;
z-index: 9999;
max-width: 400px;
animation: slide-in 0.5s ease-out;
}

.notification-content {
background-color: rgba(255, 107, 107, 0.9);
color: white;
border-radius: 8px;
padding: 15px;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
display: flex;
align-items: center;
}

.notification-icon {
font-size: 24px;
margin-right: 15px;
}

.notification-message {
flex-grow: 1;
}

.notification-close {
background: none;
border: none;
color: white;
font-size: 20px;
cursor: pointer;
padding: 0;
margin-left: 10px;
}

@keyframes slide-in {
from {
transform: translateX(100%);
opacity: 0;
}
to {
transform: translateX(0);
opacity: 1;
}
}

/* AIææ¡ˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä¿®æ­£ */
.ai-recommendation-message {
background: rgba(78, 205, 196, 0.15);
border-left: 3px solid #4ecdc4;
color: #fff;
padding: 20px; /* ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’å¢—ã‚„ã™ */
border-radius: 8px;
margin-bottom: 25px; /* ä¸‹éƒ¨ã®ä½™ç™½ã‚’å¢—ã‚„ã™ */
line-height: 1.8; /* è¡Œé–“ã‚’åºƒã’ã‚‹ */
}

@keyframes thinking {
0% { content: "è€ƒãˆã¦ã„ã¾ã™"; }
25% { content: "è€ƒãˆã¦ã„ã¾ã™."; }
50% { content: "è€ƒãˆã¦ã„ã¾ã™.."; }
75% { content: "è€ƒãˆã¦ã„ã¾ã™..."; }
100% { content: "è€ƒãˆã¦ã„ã¾ã™...."; }
}

.thinking-animation {
position: relative;
}

.thinking-animation::after {
content: "è€ƒãˆã¦ã„ã¾ã™";
animation: thinking 1.5s infinite;
}

/* è’¸æºœæ‰€ãƒãƒ¼ã‚«ãƒ¼ã®ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ— */
.distillery-tooltip {
background-color: rgba(40, 44, 52, 0.95);
color: #fff;
border: 1px solid rgba(78, 205, 196, 0.5);
border-radius: 4px;
padding: 5px 8px;
font-size: 12px;
font-weight: bold;
box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
}


</style></head>
<body>
<div class="header-container">
<a href="https://www.hirunotsuki.com/" target="_blank" style="position: absolute; left: 20px; width: 90px; height: 90px; display: block;">
<img class="logo" src="./NH_bar_logo_fin_white.png" alt="æ˜¼ã®æœˆãƒãƒ¼ãƒ­ã‚´">
</a>
<h1 class="header-title">æ˜¼ã®æœˆã€‚AIã‚½ãƒ ãƒªã‚¨</h1>
<div class="nav-links">
<a href="whisky_list.html" class="nav-link" id="listLink">ãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒªã‚¹ãƒˆä¸€è¦§</a>

<!-- 1ã¤ã®ç¿»è¨³ãƒœã‚¿ãƒ³ã«çµ±åˆ -->
<a href="#" onclick="openGoogleTranslate(); return false;" class="nav-link translate-link">
<span class="translate-icon">ğŸŒ</span> ç¿»è¨³
</a>
</div>
</div>

<div class="container-custom">
<div class="whisky-overview">
<h2>ğŸ· ãƒ—ãƒ¬ãƒŸã‚¢ãƒ ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³</h2>
<div class="subtitle">æœ¬æ—¥ã¯å³é¸ã•ã‚ŒãŸ<span id="whiskyCount">0</span>æœ¬ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‹ã‚‰</div>
<div class="description">
<strong>ã‚ãªãŸã®å‘³è¦šã«å®Œç’§ã«ãƒãƒƒãƒã™ã‚‹</strong>æœ€é«˜ã®ä¸€æœ¬ã‚’<br>
AIæŠ€è¡“ã§åˆ†æãƒ»ææ¡ˆã„ãŸã—ã¾ã™
</div>
<div class="whisky-stats">
<div class="stat-item">
<span class="stat-number" id="totalWhiskies">0</span>
<div class="stat-label">å³é¸éŠ˜æŸ„</div>
</div>
<div class="stat-item">
<span class="stat-number" id="uniqueRegions">0</span>
<div class="stat-label">ç”£åœ°</div>
</div>
<div class="stat-item">
<span class="stat-number" id="distilleryCount">0</span>
<div class="stat-label">è’¸æºœæ‰€ã®æ•°</div>
</div>
<div class="stat-item">
<span class="stat-number" id="aiTechnology">AI</span>
<div class="stat-label">åˆ†ææŠ€è¡“</div>
</div>
</div>

<div class="card">
<h2 class="text-2xl font-bold mb-4">
ğŸ’ ä¾¡æ ¼å¸¯è¨­å®š
</h2>
<div class="grid grid-cols-2 gap-4">
<div>
<label class="block mb-2">ä¸‹é™ä¾¡æ ¼: <span id="minPriceDisplay">Â¥5,000</span></label>
<input type="range" id="minPrice" class="price-slider" min="1" max="80" value="5" step="1">
</div>
<div>
<label class="block mb-2">ä¸Šé™ä¾¡æ ¼: <span id="maxPriceDisplay">Â¥50,000</span></label>
<input type="range" id="maxPrice" class="price-slider" min="1" max="80" value="50" step="1">
</div>
</div>
</div>

<div class="card">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸŒŸ å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«è¨­å®š
</h2>
<p class="mb-6">2ã¤ã®å››è§’å†…ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã€ãã‚Œãã‚Œã®å¥½ã¿ã®ä½ç½®ã‚’é¸æŠã—ã¦ãã ã•ã„</p>

<div class="dual-matrix-container">
<div class="matrix-wrapper">
<div class="matrix-title">åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix1">
<div class="taste-dot" id="tasteDot1" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">ãƒ©ã‚¤ãƒˆ</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ãƒ˜ãƒ“ãƒ¼</div>
</div>
<div class="text-center mt-4">
<span id="coordinates1" class="text-xs text-gray-400">åº§æ¨™: X: 0.50, Y: 0.50</span>
</div>
</div>

<div class="matrix-wrapper">
<div class="matrix-title">è¤‡é›‘ã•ã®å¥½ã¿</div>
<div class="relative">
<div class="taste-matrix" id="tasteMatrix2">
<div class="taste-dot" id="tasteDot2" style="left: 50%; top: 50%;"></div>
</div>
<div class="absolute -top-6 left-1/2 transform -translate-x-1/2 text-sm">ã¾ã‚ã‚„ã‹</div>
<div class="absolute -bottom-6 left-1/2 transform -translate-x-1/2 text-sm">å¼·çƒˆ</div>
<div class="absolute -left-12 top-1/2 transform -translate-y-1/2 text-sm">è‹¥ã„</div>
<div class="absolute -right-12 top-1/2 transform -translate-y-1/2 text-sm">ç†Ÿæˆ</div>
</div>
<div class="text-center mt-4">
<span id="coordinates2" class="text-xs text-gray-400">åº§æ¨™: X: 0.50, Y: 0.50</span>
</div>
</div>
</div>
</div>

<div class="card chat-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 10px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ—¨ï¸ AIã‚½ãƒ ãƒªã‚¨ã¨ãƒãƒ£ãƒƒãƒˆ
</h2>

<div class="chat-examples">
<div class="mb-3 text-sm text-gray-300">è³ªå•ä¾‹ï¼ˆã‚¯ãƒªãƒƒã‚¯ã§å…¥åŠ›ï¼‰ï¼š</div>
<div class="question-example" data-question="ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ï¼ˆæœ€é«˜é¡80,400å††ï¼‰ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦">ğŸ’ ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ï¼ˆæœ€é«˜é¡80,400å††ï¼‰ã«ã¤ã„ã¦è©³ã—ãæ•™ãˆã¦</div>
<div class="question-example" data-question="3000å††ä»¥ä¸‹ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªã‚¢ã‚¤ãƒ©å³¶ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯ã‚ã‚‹ï¼Ÿ">ğŸŒŠ 3000å††ä»¥ä¸‹ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼ãªã‚¢ã‚¤ãƒ©å³¶ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯ã‚ã‚‹ï¼Ÿ</div>
<div class="question-example" data-question="æ—¥æœ¬ã®è»½äº•æ²¢ã‚„é•·æ¿±ãªã©ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’æ¯”è¼ƒã—ã¦">ğŸ¯ æ—¥æœ¬ã®è»½äº•æ²¢ã‚„é•·æ¿±ãªã©ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’æ¯”è¼ƒã—ã¦</div>
<div class="question-example" data-question="5000å††å‰å¾Œã§è¤‡é›‘ãªå‘³ã‚ã„ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãŠã™ã™ã‚ã¯ï¼Ÿ">â­ 5000å††å‰å¾Œã§è¤‡é›‘ãªå‘³ã‚ã„ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãŠã™ã™ã‚ã¯ï¼Ÿ</div>
</div>

<div class="chat-input-container">
  <input type="text" id="chatInput" class="chat-input" placeholder="è³ªå•ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„...">
  <div class="chat-buttons">
    <button id="voiceInputBtn" class="voice-input-btn">ğŸ™ï¸</button>
    <button id="sendChatBtn" class="btn-primary">ğŸ’¬ è³ªå•ã™ã‚‹</button>
  </div>
</div>

<div id="chatHistory" class="chat-history" style="display: none;"></div>
</div>

<div class="text-center mb-8">
<button id="getRecommendation" class="btn-primary text-lg mr-4">ğŸ¯ AIææ¡ˆã‚’é–‹å§‹</button>
<button id="refreshRecommendation" class="btn-secondary text-lg">
ğŸ”„ ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¦å†ææ¡ˆ
</button>
</div>

<div id="loadingIndicator" class="loading" style="display: none;">
<div class="animate-spin text-4xl mb-4">ğŸ·</div>
<p class="mt-2">AIãŒæœ€é©ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’åˆ†æä¸­...</p>
</div>

<div id="progressContainer" class="progress-container" style="display: none;">
<div id="progressText" class="progress-text">çµæœã‚’ç”Ÿæˆä¸­...</div>
<div class="progress-bar">
<div id="progressFill" class="progress-fill" style="width: 0%;"></div>
</div>
<div id="progressPercentage" class="progress-percentage">0%</div>
</div>

<div id="splitLayoutContainer" class="split-layout" style="display: none;">
<div id="recommendationsPanel" class="recommendations-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸŒ™ AIææ¡ˆçµæœ
</h2>
<div id="preferencesSummary" class="recommendation-summary" style="display: block;">
<h3 class="text-lg font-bold mb-3">ğŸ¯ ã‚ãªãŸã®å¥½ã¿ã®å‚¾å‘</h3>
<div class="space-y-2 text-sm">
<div><strong>åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘:</strong> <span id="tasteDescription">ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ</span></div>
<div><strong>è¤‡é›‘ã•ã®å¥½ã¿:</strong> <span id="complexityDescription">ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€</span></div>
<div><strong>ä¾¡æ ¼å¸¯:</strong> <span id="priceRange">Â¥5,000 - Â¥50,000</span></div>

<div class="mt-3 pt-2 border-t border-gray-600">
AIãŒç·åˆçš„ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã«åŸºã¥ã„ã¦ã€æœ€é©ãª3éŠ˜æŸ„ã‚’å³é¸ã—ã¾ã—ãŸã€‚
</div>
</div>
</div>
<div id="recommendationContent"></div>
<div class="text-center mt-6">
<button id="getAnotherRecommendation" class="btn-secondary">
ğŸ”„ åˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹
</button>
</div>
</div>

<div id="chartPanel" class="chart-panel">
<h2 class="text-2xl font-bold mb-4" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ•¸ï¸ å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«æ¯”è¼ƒ
</h2>
<div class="chart-container">
<h3 id="chartTitle">ã‚ãªãŸã®å¥½ã¿</h3>
<canvas id="combinedProfileChart" class="chart-canvas"></canvas>
</div>

<!-- è’¸ç•™æ‰€ãƒãƒƒãƒ—ã¨æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
<div id="distillerySection" class="distillery-section">
<h2 class="text-xl font-bold mb-3 text-center" style="margin-top: 0px; margin-bottom: 10px; padding-bottom: 15px; line-height: 2;">
ğŸ—¾ è’¸æºœæ‰€æƒ…å ±
</h2>
<div class="distillery-container">
<div class="map-container">
<div id="distilleryMap"></div>
</div>

<div class="distillery-info" id="distilleryInfo">
<h3 id="distilleryName">è’¸ç•™æ‰€å</h3>
<div class="distillery-info-grid" id="distilleryDetails">
<div class="info-label">æ‰€åœ¨åœ°:</div>
<div class="info-value" id="distilleryRegion">-</div>

<div class="info-label">å‰µæ¥­å¹´:</div>
<div class="info-value" id="distilleryFounded">-</div>

<div class="info-label">ç¾åœ¨ã®çŠ¶æ³:</div>
<div class="info-value" id="distilleryStatus">-</div>
</div>

<div class="distillery-description" id="distilleryDescription">
ç¾åœ¨æƒ…å ±ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚
</div>
</div>
</div>
</div>
</div>
</div>

<div class="custom-footer">
Powered by Nebula Hirozon Technology
</div>
</div>

<script>
// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let whiskyData = [];
let distilleryDatabase = {};
let distilleryMarkers = {};
let distilleryMap = null;
let profileChartInstance = null;
let brandToDistilleryMapping = {};

// ãƒ¦ãƒ¼ã‚¶ãƒ¼å¥½ã¿ã‚’ä¿å­˜ã™ã‚‹ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
let savedUserPreferences = {
minPrice: null,
maxPrice: null,
tasteX: null,
tasteY: null,
complexityX: null,
complexityY: null,
region: null
};

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–¢æ•°
function animateCounter(elementId, targetValue) {
const element = document.getElementById(elementId);
if (!element) return;

// ç¾åœ¨ã®å€¤ã‚’å–å¾—ï¼ˆæ•°å€¤ã§ãªã„å ´åˆã¯0ã‚’è¨­å®šï¼‰
let currentValue = 0;

// ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¿ã‚¤ãƒ ã‚¹ãƒ†ãƒƒãƒ—
const duration = 1000; // 1000ms = 1ç§’
const steps = 60;
const stepTime = duration / steps;

// ã‚¹ãƒ†ãƒƒãƒ—ã”ã¨ã®å¢—åŠ é‡
const increment = targetValue / steps;

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—é–¢æ•°
function updateCounter(currentStep) {
if (currentStep <= steps) {
// ç¾åœ¨ã®å€¤ã‚’è¨ˆç®—
currentValue = Math.min(Math.ceil(increment * currentStep), targetValue);

// è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆAIã®å ´åˆã¯æ–‡å­—åˆ—ã®ã¾ã¾ï¼‰
if (elementId === 'aiTechnology') {
element.textContent = 'AI';
} else {
element.textContent = currentValue.toString();
}

// æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’äºˆç´„
setTimeout(() => updateCounter(currentStep + 1), stepTime);
}
}

// ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—é–‹å§‹
updateCounter(1);
}

// DOMContentLoaded ã‚¤ãƒ™ãƒ³ãƒˆ
document.addEventListener('DOMContentLoaded', function() {
console.log('DOM fully loaded');

// ãƒšãƒ¼ã‚¸ãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã¨ãã«å±¥æ­´ã‚’ã‚¯ãƒªã‚¢
clearChatHistory();
resetTasteMatrices();

// å¤‰æ•°ã®åˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«è¡Œã†
if (typeof whiskyData === 'undefined') {
whiskyData = [];
}

if (typeof distilleryDatabase === 'undefined') {
distilleryDatabase = {};
}

if (typeof distilleryMarkers === 'undefined') {
distilleryMarkers = {};
}

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
setActiveNavLinks();

// å››è±¡é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
initializeTasteMatrix();

// çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ - éåŒæœŸå‡¦ç†
loadUnifiedWhiskyData().then(data => {
// ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿æˆåŠŸå¾Œã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
console.log('çµ±åˆãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†');

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
setupEventListeners();

// çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
updateStatistics();

}).catch(err => {
console.error('ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', err);
});
});

// ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ãƒªãƒ³ã‚¯ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’è¨­å®š
function setActiveNavLinks() {
const currentPage = window.location.pathname.split('/').pop() || 'index.html';
const links = document.querySelectorAll('.nav-links a');

links.forEach(link => {
const href = link.getAttribute('href').split('/').pop();
if (currentPage === href) {
link.classList.add('active');
} else {
link.classList.remove('active');
}
});
}

// çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
async function loadUnifiedWhiskyData() {
console.log('çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿é–‹å§‹...');

try {
const response = await fetch('unified_whisky_data.json');
const data = await response.json();

// JSONã®æ§‹é€ ã«åˆã‚ã›ã¦ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
whiskyData = data.whiskies || [];
distilleryDatabase = data.distilleries || {};
brandToDistilleryMapping = data.brandToDistillery || {};

console.log('çµ±åˆãƒ‡ãƒ¼ã‚¿ã‚’æ­£å¸¸ã«èª­ã¿è¾¼ã¿ã¾ã—ãŸ:', whiskyData.length, 'éŠ˜æŸ„');
console.log('è’¸æºœæ‰€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹:', Object.keys(distilleryDatabase).length, 'è’¸æºœæ‰€');
console.log('ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°:', Object.keys(brandToDistilleryMapping).length, 'ä»¶');

return whiskyData;
} catch (error) {
console.error('çµ±åˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:', error);
whiskyData = [];
distilleryDatabase = {};
brandToDistilleryMapping = {};

// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
console.warn('ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¾ã™');
const defaultData = getDefaultWhiskyData();
whiskyData = defaultData;
return defaultData;
}
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‹ã‚‰è’¸æºœæ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆçµ±åˆJSONå¯¾å¿œï¼‰
function getDistilleryForWhisky(whisky) {
// 1. brandToDistilleryMappingã‹ã‚‰ç›´æ¥å–å¾—ã‚’è©¦ã™
if (brandToDistilleryMapping[whisky.name]) {
const distilleryKey = brandToDistilleryMapping[whisky.name];
if (distilleryDatabase[distilleryKey]) {
console.log(`ãƒ–ãƒ©ãƒ³ãƒ‰ãƒãƒƒãƒ”ãƒ³ã‚°ã§ç™ºè¦‹: ${whisky.name} -> ${distilleryKey}`);
return distilleryDatabase[distilleryKey];
}
}

// 2. éƒ¨åˆ†ä¸€è‡´ã§æ¤œç´¢
const whiskyNameLower = whisky.name.toLowerCase();
for (const distilleryKey in distilleryDatabase) {
const distilleryNameLower = distilleryKey.toLowerCase().replace(/è’¸æºœæ‰€/g, '');
if (whiskyNameLower.includes(distilleryNameLower)) {
console.log(`éƒ¨åˆ†ä¸€è‡´ã§ç™ºè¦‹: ${whisky.name} -> ${distilleryKey}`);
return distilleryDatabase[distilleryKey];
}
}

console.log(`è’¸æºœæ‰€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${whisky.name}`);
return null;
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿
function getDefaultWhiskyData() {
return [
{
id: "1",
name: "ã‚¿ãƒªã‚¹ã‚«ãƒ¼ 44å¹´ ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ãƒœãƒˆãƒ«",
price: "Â¥80,400",
region: "Scotland, Isle of Skye",
subcategory: "Single Malt Scotch Whisky",
abv: 45.8,
tastingNote_ja: "ã“ã®éå¸¸ã«å¸Œå°‘ãªã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ã¯ã€å¼·ã„æµ·å²¸ã®å¡©æ°—ã‚’æŒã¤è¤‡é›‘ãªæµ·æ´‹æ€§ã®ç‰¹å¾´ã‚’æä¾›ã—ã¾ã™ã€‚è±Šã‹ãªãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã€ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€ã‚¢ãƒ³ãƒ†ã‚£ãƒ¼ã‚¯ãƒ¬ã‚¶ãƒ¼ã®å±¤ãŒã‚¿ãƒªã‚¹ã‚«ãƒ¼ç‰¹æœ‰ã®ãƒ”ãƒªãƒƒã¨ã—ãŸã‚¹ãƒ¢ãƒ¼ã‚¯ã¨èª¿å’Œã—ã¦ã„ã¾ã™ã€‚é•·æœŸç†Ÿæˆã«ã‚ˆã‚Šã€ãƒˆãƒ­ãƒ”ã‚«ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ã€ãƒŸãƒ„ãƒ­ã‚¦ã€ç¹Šç´°ãªæ¨½ã®ã‚¹ãƒ‘ã‚¤ã‚¹ã®ãƒãƒ¼ãƒˆã‚’æŒã¤é©šãã¹ãæ·±ã¿ãŒç”Ÿã¾ã‚Œã€éå¸¸ã«é•·ãæ¸©ã‹ã¿ã®ã‚ã‚‹ä½™éŸ»ã¸ã¨ç¶šãã¾ã™ã€‚",
taste_profile: {
fruity: 3,
spicy: 4,
body: 5,
smoky: 4,
sweetness: 2,
complexity: 5
}
},
{
id: "2",
name: "ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³ 25å¹´ one of only bottles",
price: "Â¥20,400",
region: "Scotland, Islay",
subcategory: "Single Malt Scotch Whisky",
abv: 40,
tastingNote_ja: "ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³25å¹´ã¯å¸Œå°‘ã§é«˜ãè©•ä¾¡ã•ã‚Œã‚‹ã‚¢ã‚¤ãƒ©ã‚¦ã‚¤ã‚¹ã‚­ãƒ¼ã§ã€å¼·ã„æµ·æ´‹æ€§ã®ç‰¹å¾´ã‚’æŒã¡ã¾ã™ã€‚è¤‡é›‘ãªæ³¥ç‚­ã®ç…™ã€æµ·å¡©ã€ãƒ¨ãƒ¼ãƒ‰ã®å±¤ãŒæŸ‘æ©˜é¡ã®çš®ã€ãƒãƒ‹ãƒ©ã€å¾®å¦™ãªãƒˆãƒ­ãƒ”ã‚«ãƒ«ãƒ•ãƒ«ãƒ¼ãƒ„ã¨ãƒãƒ©ãƒ³ã‚¹ã‚ˆãèª¿å’Œã—ã¦ã„ã¾ã™ã€‚é•·ã„ä½™éŸ»ã«ã¯ã€ã‚ªãƒ¼ã‚¯ã‚¿ãƒ³ãƒ‹ãƒ³ã€ç™½èƒ¡æ¤’ã€ãã—ã¦é•·ãç¶šãç”˜ã„ç…™ãŒç¾ã‚Œã¾ã™ã€‚",
taste_profile: {
fruity: 2,
spicy: 3,
body: 4,
smoky: 5,
sweetness: 2,
complexity: 5
}
},
{
id: "3",
name: "ãƒãƒƒã‚«ãƒ©ãƒ³ 1990å¹´ SAMAROLI",
price: "Â¥12,200",
region: "Scotland",
subcategory: "Single Malt Scotch Whisky - Speyside",
abv: 40,
tastingNote_ja: "æœ‰åãªç‹¬ç«‹ç³»ãƒœãƒˆãƒ©ãƒ¼ã€ã‚µãƒãƒ­ãƒ¼ãƒªã«ã‚ˆã£ã¦ãƒœãƒˆãƒªãƒ³ã‚°ã•ã‚ŒãŸå¸Œå°‘ãªãƒãƒƒã‚«ãƒ©ãƒ³1990å¹´ã€‚è±Šã‹ãªã‚·ã‚§ãƒªãƒ¼ã®å½±éŸ¿ãŒã‚ã‚Šã€ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã€ã‚ªãƒ¬ãƒ³ã‚¸ãƒ”ãƒ¼ãƒ«ã€ã‚¯ãƒªã‚¹ãƒã‚¹ã‚±ãƒ¼ã‚­ã®é¢¨å‘³ãŒç‰¹å¾´ã€‚è¤‡é›‘ãªæ¨½ã®ã‚¹ãƒ‘ã‚¤ã‚¹ãŒèœ‚èœœã€ãƒˆãƒ•ã‚£ãƒ¼ã€ãƒ€ãƒ¼ã‚¯ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã¨èª¿å’Œã—ã¦ã„ã¾ã™ã€‚ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥ã¯é•·ãã€é©ã€ã‚¿ãƒã‚³ã€ãã—ã¦ä½™éŸ»ã®æ®‹ã‚‹ãƒ‰ãƒ©ã‚¤ãƒ•ãƒ«ãƒ¼ãƒ„ã®ç”˜ã•ãŒæ„Ÿã˜ã‚‰ã‚Œã¾ã™ã€‚",
taste_profile: {
fruity: 4,
spicy: 3,
body: 5,
smoky: 1,
sweetness: 4,
complexity: 5
}
}
];
}

// å››è±¡é™ãƒãƒˆãƒªãƒƒã‚¯ã‚¹ã®åˆæœŸåŒ–
function initializeTasteMatrix() {
const matrix1 = document.getElementById('tasteMatrix1');
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');

const matrix2 = document.getElementById('tasteMatrix2');
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');

// ä¸­å¤®ä½ç½®ã«åˆæœŸåŒ–
resetTasteMatrices();

// ãƒãƒˆãƒªãƒƒã‚¯ã‚¹1ã®ã‚¤ãƒ™ãƒ³ãƒˆ
matrix1.addEventListener('click', function(e) {
updateDotPosition(e, matrix1, dot1, coords1, 1);
});

matrix1.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // å·¦ã‚¯ãƒªãƒƒã‚¯æŠ¼ä¸‹ä¸­
updateDotPosition(e, matrix1, dot1, coords1, 1);
}
});

// ãƒãƒˆãƒªãƒƒã‚¯ã‚¹2ã®ã‚¤ãƒ™ãƒ³ãƒˆ
matrix2.addEventListener('click', function(e) {
updateDotPosition(e, matrix2, dot2, coords2, 2);
});

matrix2.addEventListener('mousemove', function(e) {
if (e.buttons === 1) { // å·¦ã‚¯ãƒªãƒƒã‚¯æŠ¼ä¸‹ä¸­
updateDotPosition(e, matrix2, dot2, coords2, 2);
}
});
}

// ãƒ‰ãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°
function updateDotPosition(event, matrix, dot, coords, matrixNum) {
const rect = matrix.getBoundingClientRect();
let x = event.clientX - rect.left;
let y = event.clientY - rect.top;

// å¢ƒç•Œãƒã‚§ãƒƒã‚¯
x = Math.max(0, Math.min(x, rect.width));
y = Math.max(0, Math.min(y, rect.height));

// ãƒ‘ãƒ¼ã‚»ãƒ³ãƒ†ãƒ¼ã‚¸ã«å¤‰æ›
const xPercent = (x / rect.width) * 100;
const yPercent = (y / rect.height) * 100;

// ãƒ‰ãƒƒãƒˆã®ä½ç½®ã‚’æ›´æ–°
dot.style.left = `${xPercent}%`;
dot.style.top = `${yPercent}%`;

// åº§æ¨™è¡¨ç¤ºã‚’æ›´æ–°ï¼ˆå°æ•°ç‚¹2æ¡ã¾ã§ï¼‰
const xCoord = (x / rect.width).toFixed(2);
const yCoord = (y / rect.height).toFixed(2);
coords.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}

// å››è±¡é™ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ä¸­å¤®ã«é…ç½®
function resetTasteMatrices() {
// å››è±¡é™1ï¼ˆåŸºæœ¬çš„ãªå‘³ã®å‚¾å‘ï¼‰
const dot1 = document.getElementById('tasteDot1');
dot1.style.left = '50%';
dot1.style.top = '50%';
document.getElementById('coordinates1').textContent = 'åº§æ¨™: X: 0.50, Y: 0.50';

// å››è±¡é™2ï¼ˆè¤‡é›‘ã•ã®å¥½ã¿ï¼‰
const dot2 = document.getElementById('tasteDot2');
dot2.style.left = '50%';
dot2.style.top = '50%';
document.getElementById('coordinates2').textContent = 'åº§æ¨™: X: 0.50, Y: 0.50';
}

// ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
function setupEventListeners() {
// ä¾¡æ ¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆ - é€£å‹•æ©Ÿèƒ½è¿½åŠ 
document.getElementById('minPrice').addEventListener('input', function() {
const minVal = parseInt(this.value);
const maxVal = parseInt(document.getElementById('maxPrice').value);

// ä¸‹é™ãŒä¸Šé™ã‚’è¶…ãˆãªã„ã‚ˆã†ã«åˆ¶é™
if (minVal > maxVal) {
this.value = maxVal;
document.getElementById('minPriceDisplay').textContent = `Â¥${formatPrice(maxVal * 1000)}`;
} else {
document.getElementById('minPriceDisplay').textContent = `Â¥${formatPrice(minVal * 1000)}`;
}
});

document.getElementById('maxPrice').addEventListener('input', function() {
const maxVal = parseInt(this.value);
const minVal = parseInt(document.getElementById('minPrice').value);

// ä¸Šé™ãŒä¸‹é™ã‚’ä¸‹å›ã‚‰ãªã„ã‚ˆã†ã«åˆ¶é™
if (maxVal < minVal) {
this.value = minVal;
document.getElementById('maxPriceDisplay').textContent = `Â¥${formatPrice(minVal * 1000)}`;
} else {
document.getElementById('maxPriceDisplay').textContent = `Â¥${formatPrice(maxVal * 1000)}`;
}
});

// ãƒœã‚¿ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('getRecommendation').addEventListener('click', function() {
getRecommendation();

// ææ¡ˆçµæœã‚¨ãƒªã‚¢ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
setTimeout(() => {
const recommendationsPanel = document.getElementById('recommendationsPanel');
if (recommendationsPanel) {
recommendationsPanel.scrollIntoView({ behavior: 'smooth' });
}
}, 500);
});

document.getElementById('refreshRecommendation').addEventListener('click', function() {
// å››è±¡é™ã®ãƒªã‚»ãƒƒãƒˆã¨å±¥æ­´ã‚¯ãƒªã‚¢
resetTasteMatrices();
clearChatHistory();

// ææ¡ˆãƒ‘ãƒãƒ«ã‚’éè¡¨ç¤º
document.getElementById('splitLayoutContainer').style.display = 'none';

// ãƒãƒ£ãƒ¼ãƒˆåˆæœŸåŒ–
if (profileChartInstance) {
profileChartInstance.destroy();
profileChartInstance = null;
}

// è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
document.getElementById('distillerySection').classList.remove('active');
});

document.getElementById('getAnotherRecommendation').addEventListener('click', getRecommendation);

// ãƒãƒ£ãƒƒãƒˆé–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆ
document.getElementById('sendChatBtn').addEventListener('click', function() {
const input = document.getElementById('chatInput').value.trim();
if (input) {
sendChatMessage();
}
});

document.getElementById('chatInput').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
const input = document.getElementById('chatInput').value.trim();
if (input) {
sendChatMessage();
}
}
});

// è³ªå•ä¾‹ã‚¯ãƒªãƒƒã‚¯
document.querySelectorAll('.question-example').forEach(function(elem) {
elem.addEventListener('click', function() {
document.getElementById('chatInput').value = this.getAttribute('data-question');
sendChatMessage();
});
});

// ãƒã‚¤ã‚¯å…¥åŠ›è¨­å®š
setupVoiceInput();
}

// ãƒã‚¤ã‚¯å…¥åŠ›ã®å‡¦ç†
function setupVoiceInput() {
const voiceButton = document.getElementById('voiceInputBtn');
const chatInput = document.getElementById('chatInput');

// SpeechRecognition APIã®ç¢ºèª
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

if (!SpeechRecognition) {
console.warn('Speech recognition not supported');
voiceButton.style.display = 'none';
return;
}

const recognition = new SpeechRecognition();
recognition.lang = 'ja-JP';
recognition.interimResults = true;
recognition.continuous = false;

let isRecording = false;

voiceButton.addEventListener('click', () => {
if (!isRecording) {
// éŒ²éŸ³é–‹å§‹
recognition.start();
voiceButton.classList.add('recording');
voiceButton.textContent = 'ğŸ”´';
isRecording = true;
} else {
// éŒ²éŸ³çµ‚äº†
recognition.stop();
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;
}
});

// éŸ³å£°èªè­˜çµæœ
recognition.onresult = (event) => {
const transcript = Array.from(event.results)
.map(result => result[0])
.map(result => result.transcript)
.join('');

chatInput.value = transcript;
};

// ã‚¨ãƒ©ãƒ¼å‡¦ç†
recognition.onerror = (event) => {
console.error('Speech recognition error', event.error);
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;

if (event.error === 'not-allowed') {
showNotification('ãƒã‚¤ã‚¯ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
}
};

// çµ‚äº†å‡¦ç†
recognition.onend = () => {
voiceButton.classList.remove('recording');
voiceButton.textContent = 'ğŸ™ï¸';
isRecording = false;
};
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡ï¼ˆä¿®æ­£ç‰ˆï¼‰
function sendChatMessage() {
const input = document.getElementById('chatInput');
const message = input.value.trim();
if (!message) return;

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¡¨ç¤º
const chatHistory = document.getElementById('chatHistory');
chatHistory.style.display = 'block';

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
const userMessage = document.createElement('div');
userMessage.className = 'chat-message user-message';
userMessage.textContent = message;
chatHistory.appendChild(userMessage);

// å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
input.value = '';

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
chatHistory.scrollTop = chatHistory.scrollHeight;

// æ–°ã—ãè¿½åŠ : ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¥½ã¿ã‚’æŠ½å‡º
try {
const prefs = extractPreferencesFromMessage(message);

// æŠ½å‡ºã—ãŸå¥½ã¿ã‚’ä¿å­˜
if (prefs && Object.keys(prefs).length > 0) {
Object.assign(savedUserPreferences, prefs);

// UIè¦ç´ ã‚’æ›´æ–°
updateUIWithPreferences(prefs);
}
} catch (error) {
console.error('å¥½ã¿æŠ½å‡ºã‚¨ãƒ©ãƒ¼:', error);
}

// AIã®å¿œç­”ã‚’ç”Ÿæˆ
getAIResponse(message);
}

// AIå¿œç­”ã®å–å¾—ï¼ˆä¿®æ­£ç‰ˆï¼‰
async function getAIResponse(message) {
// AIã®å¿œç­”ã‚’ç”Ÿæˆä¸­ã§ã‚ã‚‹ã“ã¨ã‚’è¡¨ç¤º
const chatHistory = document.getElementById('chatHistory');
const aiMessage = document.createElement('div');
aiMessage.className = 'chat-message ai-message thinking-animation';
aiMessage.textContent = ''; // ãƒ†ã‚­ã‚¹ãƒˆã¯ç©ºã«ã€ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãŒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¡¨ç¤ºã—ã¾ã™
chatHistory.appendChild(aiMessage);

// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
chatHistory.scrollTop = chatHistory.scrollHeight;

try {
// æ–°ã—ãè¿½åŠ : å¥½ã¿é€šçŸ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®ä½œæˆ
let prefsMessage = '';
const prefs = extractPreferencesFromMessage(message);

if (prefs && Object.keys(prefs).length > 0) {
prefsMessage = 'ã‚ãªãŸã®å¥½ã¿ã‚’ç†è§£ã—ã¾ã—ãŸï¼š\n';

if (prefs.minPrice) prefsMessage += `ãƒ»æœ€ä½ä¾¡æ ¼: ${prefs.minPrice}å††\n`;
if (prefs.maxPrice) prefsMessage += `ãƒ»æœ€é«˜ä¾¡æ ¼: ${prefs.maxPrice}å††\n`;
if (prefs.tasteY !== undefined) prefsMessage += `ãƒ»å‘³ã®å‚¾å‘: ${prefs.tasteY > 0.5 ? 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼' : 'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼'}\n`;
if (prefs.region) prefsMessage += `ãƒ»ç”£åœ°: ${prefs.region}\n`;
prefsMessage += '\nææ¡ˆã‚·ã‚¹ãƒ†ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚ã€ŒAIææ¡ˆã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚ãªãŸã®å¥½ã¿ã«åˆã‚ã›ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ã€‚\n\n';
}

// å‘³è¦šåº§æ¨™ã®å–å¾—
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');
const tasteX = parseFloat(dot1.style.left) / 100;
const tasteY = parseFloat(dot1.style.top) / 100;

// ä¾¡æ ¼å¸¯ã®å–å¾—
const minPrice = document.getElementById('minPrice').value * 1000;
const maxPrice = document.getElementById('maxPrice').value * 1000;

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åé›†
const chatHistoryData = collectChatHistory();

// APIå‘¼ã³å‡ºã—
const response = await fetch('/.netlify/functions/claude-api', {
method: 'POST',
headers: {
'Content-Type': 'application/json'
},
body: JSON.stringify({
minPrice: minPrice,
maxPrice: maxPrice,
tasteX: tasteX.toFixed(2),
tasteY: tasteY.toFixed(2),
additionalPreferences: message,
chatHistory: chatHistoryData // ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’è¿½åŠ 
})
});

if (!response.ok) {
throw new Error(`API error: ${response.status}`);
}

const data = await response.json();

// APIå¿œç­”ã‚’è¡¨ç¤º
let aiResponseText = '';
if (data.success && data.data) {
if (data.data.choices && data.data.choices[0] && data.data.choices[0].message) {
// æ–°ã—ã„æ§‹é€ : data.data.choices[0].message.content
aiResponseText = data.data.choices[0].message.content;
} else if (data.data.content && data.data.content.length > 0) {
// å¤ã„æ§‹é€ : data.data.content[0].text
aiResponseText = data.data.content[0].text;
} else {
throw new Error('Invalid API response structure');
}
} else {
throw new Error('API response missing success or data field');
}

// æ–°ã—ãè¿½åŠ : å¥½ã¿é€šçŸ¥ã‚’å…ˆé ­ã«è¿½åŠ 
if (prefsMessage) {
aiResponseText = prefsMessage + aiResponseText;
}

aiMessage.textContent = aiResponseText;
aiMessage.classList.remove('thinking-animation'); // ã“ã®è¡Œã‚’è¿½åŠ 
updateRecommendationsFromChat(aiResponseText); // ã“ã®è¡Œã‚’è¿½åŠ 

} catch (error) {
console.error('Chat error:', error);

// ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€æ—¢å­˜ã®ãƒ¢ãƒƒã‚¯ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ä½¿ç”¨
let aiResponseText;

// è³ªå•ã«åŸºã¥ã„ã¦ãƒ¢ãƒƒã‚¯å¿œç­”ã‚’ç”Ÿæˆï¼ˆæ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼‰
if (message.includes('ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´')) {
aiResponseText = 'ğŸ· ã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ã‚ªãƒ•ã‚£ã‚·ãƒ£ãƒ«ãƒœãƒˆãƒ«ã¯...';
} else if (message.includes('3000å††ä»¥ä¸‹') && message.includes('ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼') && message.includes('ã‚¢ã‚¤ãƒ©')) {
aiResponseText = 'ğŸŒŠ ã‚­ãƒ«ãƒ›ãƒ¼ãƒãƒ³2013-2021ä¿¡æ¿ƒå±‹ï¼ˆÂ¥2,000ï¼‰ãŒ...';
} else if (message.includes('æ—¥æœ¬') && (message.includes('è»½äº•æ²¢') || message.includes('é•·æ¿±'))) {
aiResponseText = 'ğŸ¯ è»½äº•æ²¢25å¹´ï¼ˆÂ¥25,000ï¼‰ã¯æ—¥æœ¬ã‚’ä»£è¡¨ã™ã‚‹éŠ˜æŸ„ã§...';
} else if (message.includes('5000å††å‰å¾Œ') && message.includes('complexity5ç‚¹')) {
aiResponseText = 'â­ 5000å††å‰å¾Œã§complexity5ç‚¹ã‚’æŒã¤ãŠã™ã™ã‚ã¯...';
} else {
aiResponseText = 'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ç¾åœ¨AIãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ãŒä½¿ãˆã¾ã›ã‚“ã€‚å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ã‚ãªãŸã«æœ€é©ãªã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ã€‚';
}

// æ–°ã—ãè¿½åŠ : å¥½ã¿ã‚’æŠ½å‡ºã§ãã¦ã„ã‚Œã°é€šçŸ¥ã‚’è¿½åŠ 
const prefs = extractPreferencesFromMessage(message);
if (prefs && Object.keys(prefs).length > 0) {
let prefsMessage = 'ã‚ãªãŸã®å¥½ã¿ã‚’ç†è§£ã—ã¾ã—ãŸï¼š\n';

if (prefs.minPrice) prefsMessage += `ãƒ»æœ€ä½ä¾¡æ ¼: ${prefs.minPrice}å††\n`;
if (prefs.maxPrice) prefsMessage += `ãƒ»æœ€é«˜ä¾¡æ ¼: ${prefs.maxPrice}å††\n`;
if (prefs.tasteY !== undefined) prefsMessage += `ãƒ»å‘³ã®å‚¾å‘: ${prefs.tasteY > 0.5 ? 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼' : 'ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼'}\n`;
if (prefs.region) prefsMessage += `ãƒ»ç”£åœ°: ${prefs.region}\n`;
prefsMessage += '\nææ¡ˆã‚·ã‚¹ãƒ†ãƒ ã«åæ˜ ã—ã¾ã—ãŸã€‚ã€ŒAIææ¡ˆã‚’é–‹å§‹ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™ã¨ã€ã‚ãªãŸã®å¥½ã¿ã«åˆã‚ã›ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ææ¡ˆã—ã¾ã™ã€‚\n\n';

aiResponseText = prefsMessage + aiResponseText;
}

aiMessage.textContent = aiResponseText;
aiMessage.classList.remove('thinking-animation'); // ã“ã®è¡Œã‚’è¿½åŠ 
updateRecommendationsFromChat(aiResponseText); // ã“ã®è¡Œã‚’è¿½åŠ 
} finally {
// ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’æœ€ä¸‹éƒ¨ã«
chatHistory.scrollTop = chatHistory.scrollHeight;
}
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’åé›†ã™ã‚‹é–¢æ•°
function collectChatHistory() {
const chatHistory = document.getElementById('chatHistory');
if (!chatHistory) return [];

const messages = chatHistory.querySelectorAll('.chat-message');
const history = [];

messages.forEach(message => {
const isAI = message.classList.contains('ai-message');
// thinking-animationã‚¯ãƒ©ã‚¹ã‚’æŒã¤ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã¯é™¤å¤–
if (!message.classList.contains('thinking-animation')) {
history.push({
role: isAI ? 'assistant' : 'user',
content: message.textContent
});
}
});

return history;
}

// ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‹ã‚‰ã‚¦ã‚£ã‚¹ã‚­ãƒ¼åã‚’æŠ½å‡ºã—ã€æ¨å¥¨ãƒªã‚¹ãƒˆã«åæ˜ ã™ã‚‹é–¢æ•°
function updateRecommendationsFromChat(chatResponseText) {
if (!chatResponseText || !whiskyData || whiskyData.length === 0) return;

console.log('ãƒãƒ£ãƒƒãƒˆå¿œç­”ã‹ã‚‰ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’æŠ½å‡ºä¸­...');

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼åã‚’æŠ½å‡ºã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³
const patterns = [
/ã€Œ([^ã€]+)ã€/g,  // ã€Œã€ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†
/ã€([^ã€]+)ã€/g,  // ã€ã€ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†
/(\S+\s?\d+å¹´[^\sã€ã€‚,\.]+)/g,  // "ã€‡ã€‡ XXå¹´" ãƒ‘ã‚¿ãƒ¼ãƒ³
/((?:DAILUAINE|ã‚¿ãƒªã‚¹ã‚«ãƒ¼|ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³|ãƒãƒƒã‚«ãƒ©ãƒ³|è»½äº•æ²¢|å±±å´|ç™½å·|éŸ¿|é•·æ¿±|ã‚­ãƒ«ãƒ›ãƒ¼ãƒãƒ³|ABERFELDY|GLENLIVET|SPRINGBANK|GLENGLASSAUGH|ARDBEG|MORTLACH|CAOL ILA|KILCHOMAN)[^\sã€ã€‚,\.]*\s?\d*å¹´?[^\sã€ã€‚,\.]*)/g  // ç‰¹å®šã®éŠ˜æŸ„å
];

// æŠ½å‡ºã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼åã‚’ä¿å­˜ã™ã‚‹é…åˆ—
let extractedNames = [];

// å„ãƒ‘ã‚¿ãƒ¼ãƒ³ã§æŠ½å‡ºã‚’è©¦ã¿ã‚‹
patterns.forEach(pattern => {
let match;
while ((match = pattern.exec(chatResponseText)) !== null) {
if (match[1]) {
extractedNames.push(match[1].trim());
} else if (match[0]) {
extractedNames.push(match[0].trim());
}
}
});

// é‡è¤‡ã‚’å‰Šé™¤
extractedNames = [...new Set(extractedNames)];

console.log('æŠ½å‡ºã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„:', extractedNames);

if (extractedNames.length === 0) {
console.log('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼éŠ˜æŸ„ã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ');
return;
}

// æŠ½å‡ºã—ãŸéŠ˜æŸ„åã«æœ€ã‚‚è¿‘ã„ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’æ¢ã™
const recommendedWhiskies = [];

extractedNames.forEach(name => {
// å®Œå…¨ä¸€è‡´ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´ã‚’æ¢ã™
const matchingWhisky = whiskyData.find(w => 
w.name === name || 
w.name.includes(name) || 
name.includes(w.name)
);

if (matchingWhisky) {
console.log(`ãƒãƒƒãƒã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼: ${name} â†’ ${matchingWhisky.name}`);
recommendedWhiskies.push(matchingWhisky);
}
});

// ãƒãƒƒãƒã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒã‚ã‚Œã°è¡¨ç¤º
if (recommendedWhiskies.length > 0) {
console.log(`${recommendedWhiskies.length}å€‹ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡ºã—ã¦è¡¨ç¤ºã—ã¾ã™`);
displayLocalRecommendations(recommendedWhiskies);

// æœ€åˆã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é¸æŠ
if (recommendedWhiskies.length > 0) {
selectWhisky(recommendedWhiskies[0]);
}

// æ¨å¥¨ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
document.getElementById('splitLayoutContainer').style.display = 'grid';
}
}

// ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰å¥½ã¿ã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
function extractPreferencesFromMessage(message) {
if (!message) return {};

message = message.toLowerCase();
const preferences = {};

// ä¾¡æ ¼æ¡ä»¶ã®æŠ½å‡º
const maxPriceRegex = /([\d,]+)å††?(ä»¥ä¸‹|ã¾ã§|æœªæº€|ã‚ˆã‚Šå®‰ã„)/;
const minPriceRegex = /([\d,]+)å††?(ä»¥ä¸Š|ã‹ã‚‰|ã‚ˆã‚Šé«˜ã„)/;
const priceRangeRegex = /([\d,]+)å††?[ã€œï½-]+([\d,]+)å††?/;

// ä¾¡æ ¼ç¯„å›²ã®æŠ½å‡º
const priceRangeMatch = message.match(priceRangeRegex);
if (priceRangeMatch) {
const minPrice = parseInt(priceRangeMatch[1].replace(/,/g, ''));
const maxPrice = parseInt(priceRangeMatch[2].replace(/,/g, ''));
preferences.minPrice = minPrice;
preferences.maxPrice = maxPrice;
} else {
// æœ€ä½ä¾¡æ ¼ã®æŠ½å‡º
const minPriceMatch = message.match(minPriceRegex);
if (minPriceMatch) {
preferences.minPrice = parseInt(minPriceMatch[1].replace(/,/g, ''));
}

// æœ€é«˜ä¾¡æ ¼ã®æŠ½å‡º
const maxPriceMatch = message.match(maxPriceRegex);
if (maxPriceMatch) {
preferences.maxPrice = parseInt(maxPriceMatch[1].replace(/,/g, ''));
}
}

// åœ°åŸŸã®æŠ½å‡ºï¼ˆä¿®æ­£ç‰ˆï¼‰
if (message.includes('ã‚¢ã‚¤ãƒ©') || message.includes('islay')) {
preferences.region = 'Islay';
} else if (message.includes('ã‚¹ãƒšã‚¤ã‚µã‚¤ãƒ‰') || message.includes('speyside')) {
preferences.region = 'Speyside';
} else if (message.includes('ãƒã‚¤ãƒ©ãƒ³ãƒ‰') || message.includes('highland')) {
preferences.region = 'Highland';
} else if (message.includes('æ—¥æœ¬') || message.includes('ã‚¸ãƒ£ãƒ‘ãƒ³') || message.includes('ã‚¸ãƒ£ãƒ‘ãƒ‹ãƒ¼ã‚º') || 
message.includes('japan') || message.includes('japanese')) {
preferences.region = 'Japan';  // ã€ŒJapanã€ã¾ãŸã¯ã€ŒJapaneseã€ã‚’å«ã‚€å ´åˆ
}

// å‘³ã®å‚¾å‘ã®æŠ½å‡º
if (message.includes('ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼') || message.includes('ãƒ”ãƒ¼ãƒˆ') || message.includes('smoke')) {
preferences.tasteY = 0.8; // ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼æ–¹å‘
} else if (message.includes('ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼') || message.includes('fruity') || message.includes('æœå®Ÿ')) {
preferences.tasteY = 0.2; // ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼æ–¹å‘
}

if (message.includes('ãƒ˜ãƒ“ãƒ¼') || message.includes('heavy') || message.includes('é‡ã„')) {
preferences.tasteX = 0.8; // ãƒ˜ãƒ“ãƒ¼æ–¹å‘
} else if (message.includes('ãƒ©ã‚¤ãƒˆ') || message.includes('light') || message.includes('è»½ã„')) {
preferences.tasteX = 0.2; // ãƒ©ã‚¤ãƒˆæ–¹å‘
}

return preferences;
}

// æŠ½å‡ºã—ãŸå¥½ã¿ã«åŸºã¥ã„ã¦UIè¦ç´ ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateUIWithPreferences(preferences) {
try {
// ä¾¡æ ¼ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã®æ›´æ–°
if (preferences.minPrice) {
const minSlider = document.getElementById('minPrice');
if (minSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.minPrice / 1000)));
minSlider.value = value;
const minPriceDisplay = document.getElementById('minPriceDisplay');
if (minPriceDisplay) {
minPriceDisplay.textContent = `Â¥${value},000`;
}
}
}

if (preferences.maxPrice) {
const maxSlider = document.getElementById('maxPrice');
if (maxSlider) {
const value = Math.max(1, Math.min(80, Math.floor(preferences.maxPrice / 1000)));
maxSlider.value = value;
const maxPriceDisplay = document.getElementById('maxPriceDisplay');
if (maxPriceDisplay) {
maxPriceDisplay.textContent = `Â¥${value},000`;
}
}
}

// å‘³è¦šãƒãƒˆãƒªã‚¯ã‚¹ã®æ›´æ–°
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');

if (preferences.tasteX !== undefined && dot1) {
dot1.style.left = `${preferences.tasteX * 100}%`;
}

if (preferences.tasteY !== undefined && dot1) {
dot1.style.top = `${preferences.tasteY * 100}%`;
}

if (preferences.complexityX !== undefined && dot2) {
dot2.style.left = `${preferences.complexityX * 100}%`;
}

if (preferences.complexityY !== undefined && dot2) {
dot2.style.top = `${preferences.complexityY * 100}%`;
}

// åº§æ¨™è¡¨ç¤ºã®æ›´æ–°ï¼ˆå®‰å…¨ã«å‘¼ã³å‡ºã™ï¼‰
try {
if (typeof updateCoordinatesDisplay === 'function') {
updateCoordinatesDisplay();
} else {
console.warn('updateCoordinatesDisplayé–¢æ•°ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€åº§æ¨™è¡¨ç¤ºã¯æ›´æ–°ã•ã‚Œã¾ã›ã‚“');
// ä»£æ›¿ã®åº§æ¨™è¡¨ç¤ºæ›´æ–°å‡¦ç†
const coords1 = document.getElementById('coordinates1');
const coords2 = document.getElementById('coordinates2');

if (dot1 && coords1) {
const xCoord = (parseFloat(dot1.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot1.style.top) / 100).toFixed(2);
coords1.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}

if (dot2 && coords2) {
const xCoord = (parseFloat(dot2.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot2.style.top) / 100).toFixed(2);
coords2.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}
}
} catch (coordsErr) {
console.warn('åº§æ¨™è¡¨ç¤ºæ›´æ–°ã‚¹ã‚­ãƒƒãƒ—:', coordsErr);
}
} catch (error) {
console.error('UIæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
}
}

// åº§æ¨™è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
function updateCoordinatesDisplay() {
try {
// å››è±¡é™1ã®åº§æ¨™æ›´æ–°
const dot1 = document.getElementById('tasteDot1');
const coords1 = document.getElementById('coordinates1');
if (dot1 && coords1) {
const xCoord = (parseFloat(dot1.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot1.style.top) / 100).toFixed(2);
coords1.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}

// å››è±¡é™2ã®åº§æ¨™æ›´æ–°
const dot2 = document.getElementById('tasteDot2');
const coords2 = document.getElementById('coordinates2');
if (dot2 && coords2) {
const xCoord = (parseFloat(dot2.style.left) / 100).toFixed(2);
const yCoord = (parseFloat(dot2.style.top) / 100).toFixed(2);
coords2.textContent = `åº§æ¨™: X: ${xCoord}, Y: ${yCoord}`;
}
} catch (error) {
console.error('åº§æ¨™è¡¨ç¤ºæ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);
}
}

// ãƒãƒ£ãƒƒãƒˆå±¥æ­´ã‚’ã‚¯ãƒªã‚¢
function clearChatHistory() {
const chatHistory = document.getElementById('chatHistory');
chatHistory.innerHTML = '';
chatHistory.style.display = 'none';
document.getElementById('chatInput').value = '';
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®è’¸ç•™æ‰€æƒ…å ±ã‚’æ›´æ–°ï¼ˆçµ±åˆJSONå¯¾å¿œï¼‰
function updateDistilleryInfo(whisky) {
try {
// çµ±åˆJSONã‹ã‚‰è’¸æºœæ‰€ã‚’å–å¾—
const distillery = getDistilleryForWhisky(whisky);

// è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
const distillerySection = document.getElementById('distillerySection');
distillerySection.classList.add('active');

if (distillery) {
console.log(`è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:`, distillery.name);

// ãƒãƒƒãƒ—ã®åˆæœŸåŒ–ã‚’è©¦ã¿ã‚‹ï¼ˆLeaflet.jsãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆã®ã¿ï¼‰
let mapInitialized = false;
if (typeof L !== 'undefined') {
if (!distilleryMap) {
mapInitialized = initializeCommonMap();
} else {
mapInitialized = true;
}

// ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã§ããŸå ´åˆã¯ãƒãƒ¼ã‚«ãƒ¼ã‚’æ›´æ–°
if (mapInitialized && distillery.location) {
try {
showDistilleryOnMap(distillery);
} catch (e) {
console.warn('ãƒãƒ¼ã‚«ãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼:', e);
}
}
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
showDistilleryInfo(distillery);
} else {
// è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆ
console.log('è’¸ç•™æ‰€æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');

// ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}

// ç°¡æ˜“æƒ…å ±ã‚’è¡¨ç¤º
document.getElementById('distilleryName').textContent = whisky.name || 'æƒ…å ±ãªã—';
document.getElementById('distilleryRegion').textContent = whisky.region || 'æƒ…å ±ãªã—';
document.getElementById('distilleryFounded').textContent = 'æƒ…å ±ãªã—';

const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = 'æƒ…å ±ãªã—';
statusElement.className = 'status-unknown';

document.getElementById('distilleryDescription').textContent = 
`${whisky.name}ã®è’¸ç•™æ‰€æƒ…å ±ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯${whisky.region || 'ä¸æ˜ãªåœ°åŸŸ'}ã§è£½é€ ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
}
} catch (error) {
console.error('è’¸ç•™æ‰€æƒ…å ±æ›´æ–°ã‚¨ãƒ©ãƒ¼:', error);

// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// è’¸æºœæ‰€ã‚’ãƒãƒƒãƒ—ã«è¡¨ç¤ºï¼ˆçµ±åˆJSONå¯¾å¿œï¼‰
function showDistilleryOnMap(distillery) {
if (!distilleryMap || !distillery.location) return;

// ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’æ›´æ–°
distilleryMap.setView([distillery.location.lat, distillery.location.lng], distillery.zoomLevel || 10);

// ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã¨ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ç®¡ç†
if (window.activeMarker) {
distilleryMap.removeLayer(window.activeMarker);
}
if (window.pulseMarker) {
distilleryMap.removeLayer(window.pulseMarker);
clearInterval(window.pulseInterval);
}

// æ—¢å­˜ã®ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
distilleryMap.eachLayer(function(layer) {
if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
distilleryMap.removeLayer(layer);
}
});

// ã™ã¹ã¦ã®è’¸æºœæ‰€ã‚’ã‚°ãƒªãƒ¼ãƒ³ã§è¡¨ç¤º
Object.keys(distilleryDatabase).forEach(distilleryKey => {
const dist = distilleryDatabase[distilleryKey];
if (dist.location && dist.location.lat && dist.location.lng) {
const marker = L.circleMarker([dist.location.lat, dist.location.lng], {
radius: 6,
fillColor: '#4ecdc4',  // ã‚°ãƒªãƒ¼ãƒ³
color: '#4ecdc4',
weight: 2,
opacity: 1,
fillOpacity: 0.7
}).addTo(distilleryMap);

// ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¿½åŠ 
marker.on('click', function() {
// ç¾åœ¨ã®è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
const clickedDistillery = {
name: distilleryKey,
...dist
};

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆæ—¢å­˜ã®é–¢æ•°ã‚’å†åˆ©ç”¨ï¼‰
displayDistilleryInfo(clickedDistillery);

// æ—¢å­˜ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã‚’å‰Šé™¤
if (window.activeMarker) {
distilleryMap.removeLayer(window.activeMarker);
}
if (window.pulseMarker) {
distilleryMap.removeLayer(window.pulseMarker);
clearInterval(window.pulseInterval);
}

// æ–°ã—ã„ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
window.activeMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
radius: 10,
fillColor: '#ff6b6b',  // èµ¤
color: '#ff6b6b',
weight: 3,
opacity: 1,
fillOpacity: 0.8
}).addTo(distilleryMap);

// ãƒ‘ãƒ«ã‚¹ãƒãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆ
window.pulseMarker = L.circleMarker([dist.location.lat, dist.location.lng], {
radius: 15,
fillColor: 'rgba(255, 107, 107, 0.3)',
color: '#ff6b6b',
weight: 1,
opacity: 0.6,
fillOpacity: 0.2
}).addTo(distilleryMap);

// ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
let currentRadius = 15;
let growing = true;
window.pulseInterval = setInterval(() => {
if (growing) {
currentRadius += 0.5;
if (currentRadius >= 25) growing = false;
} else {
currentRadius -= 0.5;
if (currentRadius <= 12) growing = true;
}
window.pulseMarker.setRadius(currentRadius);
}, 100);

// ãƒãƒƒãƒ—ã®ä¸­å¿ƒã‚’æ›´æ–°
distilleryMap.setView([dist.location.lat, dist.location.lng], 10);
});

// ãƒ›ãƒãƒ¼åŠ¹æœ
marker.on('mouseover', function() {
marker.setStyle({
radius: 8,
fillOpacity: 0.9
});

// ãƒ„ãƒ¼ãƒ«ãƒãƒƒãƒ—è¡¨ç¤º
marker.bindTooltip(distilleryKey, {
permanent: false,
direction: 'top',
className: 'distillery-tooltip'
}).openTooltip();
});

marker.on('mouseout', function() {
marker.setStyle({
radius: 6,
fillOpacity: 0.7
});
});
}
});

// é¸æŠã•ã‚ŒãŸè’¸æºœæ‰€ã‚’èµ¤ã„ãƒ“ãƒ¼ã‚³ãƒ³ã§è¡¨ç¤º
window.activeMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
radius: 10,
fillColor: '#ff6b6b',  // èµ¤
color: '#ff6b6b',
weight: 3,
opacity: 1,
fillOpacity: 0.8
}).addTo(distilleryMap);

// ãƒ“ãƒ¼ã‚³ãƒ³åŠ¹æœï¼ˆãƒ‘ãƒ«ã‚¹ï¼‰
window.pulseMarker = L.circleMarker([distillery.location.lat, distillery.location.lng], {
radius: 15,
fillColor: 'rgba(255, 107, 107, 0.3)',
color: '#ff6b6b',
weight: 1,
opacity: 0.6,
fillOpacity: 0.2
}).addTo(distilleryMap);

// ãƒ‘ãƒ«ã‚¹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
let currentRadius = 15;
let growing = true;
window.pulseInterval = setInterval(() => {
if (growing) {
currentRadius += 0.5;
if (currentRadius >= 25) growing = false;
} else {
currentRadius -= 0.5;
if (currentRadius <= 12) growing = true;
}
window.pulseMarker.setRadius(currentRadius);
}, 100);

// ãƒãƒƒãƒ—ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
setTimeout(function() {
if (distilleryMap) {
distilleryMap.invalidateSize();
}
}, 100);
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤º
function displayDistilleryInfo(distillery) {
// è’¸ç•™æ‰€åã¨åœ°åŸŸã‚’è¡¨ç¤º
document.getElementById('distilleryName').textContent = distillery.name || 'ä¸æ˜';
document.getElementById('distilleryRegion').textContent = distillery.region || 'ä¸æ˜';

// è¨­ç«‹å¹´
if (distillery.foundedYear) {
document.getElementById('distilleryFounded').textContent = distillery.foundedYear + 'å¹´';
} else {
document.getElementById('distilleryFounded').textContent = 'ä¸æ˜';
}

// çŠ¶æ…‹ï¼ˆã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã€é–‰é–ãªã©ï¼‰
const statusElement = document.getElementById('distilleryStatus');
const status = distillery.status || 'ä¸æ˜';
statusElement.textContent = status;

// èª¬æ˜æ–‡
document.getElementById('distilleryDescription').textContent = 
distillery.description || 'è’¸ç•™æ‰€ã®è©³ç´°æƒ…å ±ã¯æº–å‚™ä¸­ã§ã™ã€‚';

// æƒ…å ±ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
document.getElementById('distilleryInfoSection').style.display = 'block';
}

// çµ±è¨ˆæƒ…å ±ã‚’æ›´æ–°
function updateStatistics() {
if (!whiskyData || !whiskyData.length) return;

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ç·æ•°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ï¼‰
document.getElementById('whiskyCount').textContent = whiskyData.length; // å…ƒã®ã¾ã¾
animateCounter('totalWhiskies', whiskyData.length); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´

// ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªç”£åœ°æ•°ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´ï¼‰
const uniqueRegions = new Set();
whiskyData.forEach(whisky => {
if (whisky.region) {
uniqueRegions.add(whisky.region.split(',')[0].trim());
}
});
animateCounter('uniqueRegions', uniqueRegions.size); // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã«å¤‰æ›´

// è’¸æºœæ‰€æ•°ã®ã‚«ã‚¦ãƒ³ãƒˆ
if (distilleryDatabase && typeof distilleryDatabase === 'object') {
const distilleryCount = Object.keys(distilleryDatabase).length;
animateCounter('distilleryCount', distilleryCount);
}

// ä¾¡æ ¼å¸¯
let minPrice = Infinity;
let maxPrice = 0;

whiskyData.forEach(whisky => {
const price = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
if (price > 0) {
minPrice = Math.min(minPrice, price);
maxPrice = Math.max(maxPrice, price);
}
});

if (minPrice !== Infinity && maxPrice !== 0) {
document.getElementById('priceRange').textContent = `Â¥${formatPrice(minPrice)}ã€œÂ¥${formatPrice(maxPrice)}`;
}
}

// ä¾¡æ ¼ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
function formatPrice(price) {
return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

// AIæ¨è–¦ã‚’å–å¾—ï¼ˆä¿®æ­£ç‰ˆï¼‰
async function getRecommendation() {
// ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
document.getElementById('loadingIndicator').style.display = 'block';

try {
// å‘³è¦šåº§æ¨™ã®å–å¾—ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');
const tasteX = parseFloat(dot1.style.left) / 100;
const tasteY = parseFloat(dot1.style.top) / 100;
const complexityX = parseFloat(dot2.style.left) / 100;
const complexityY = parseFloat(dot2.style.top) / 100;

// ä¾¡æ ¼å¸¯ã®å–å¾—ï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
const minPrice = document.getElementById('minPrice').value * 1000;
const maxPrice = document.getElementById('maxPrice').value * 1000;

// æ–°ã—ãè¿½åŠ : ãƒãƒ£ãƒƒãƒˆã‹ã‚‰æŠ½å‡ºã—ãŸå¥½ã¿ã¨ç¾åœ¨ã®UIå€¤ã‚’çµ±åˆ
const combinedPreferences = {
tasteX: savedUserPreferences.tasteX !== null ? savedUserPreferences.tasteX : tasteX,
tasteY: savedUserPreferences.tasteY !== null ? savedUserPreferences.tasteY : tasteY,
complexityX: savedUserPreferences.complexityX !== null ? savedUserPreferences.complexityX : complexityX,
complexityY: savedUserPreferences.complexityY !== null ? savedUserPreferences.complexityY : complexityY,
minPrice: savedUserPreferences.minPrice !== null ? savedUserPreferences.minPrice : minPrice,
maxPrice: savedUserPreferences.maxPrice !== null ? savedUserPreferences.maxPrice : maxPrice,
region: savedUserPreferences.region
};

// ã“ã“ã«æ–°ã—ã„ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ã‚’è¿½åŠ 
console.log('æ¤œç´¢é–‹å§‹ - å¥½ã¿æƒ…å ±:', {
savedPreferences: savedUserPreferences,
combinedPreferences: combinedPreferences
});

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¡¨ç¤ºï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
document.getElementById('loadingIndicator').style.display = 'none';
document.getElementById('progressContainer').style.display = 'block';

// ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã‚’é€²è¡Œï¼ˆæ—¢å­˜ã‚³ãƒ¼ãƒ‰ï¼‰
let progress = 0;
const progressInterval = setInterval(() => {
progress += 5;
if (progress > 100) {
clearInterval(progressInterval);
document.getElementById('progressContainer').style.display = 'none';

// ææ¡ˆçµæœã‚’è¡¨ç¤ºï¼ˆä¿®æ­£: çµ±åˆã—ãŸå¥½ã¿ã‚’ä½¿ç”¨ï¼‰
showRecommendationResult(
combinedPreferences.tasteX, 
combinedPreferences.tasteY, 
combinedPreferences.complexityX, 
combinedPreferences.complexityY, 
combinedPreferences.minPrice, 
combinedPreferences.maxPrice, 
'', // chatPreferences
combinedPreferences.region // æ–°ãŸã«åœ°åŸŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
);
return;
}

document.getElementById('progressFill').style.width = `${progress}%`;
document.getElementById('progressPercentage').textContent = `${progress}%`;

if (progress === 30) {
document.getElementById('progressText').textContent = 'ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†æä¸­...';
} else if (progress === 60) {
document.getElementById('progressText').textContent = 'æœ€é©ãªãƒãƒƒãƒãƒ³ã‚°ã‚’è¨ˆç®—ä¸­...';
} else if (progress === 90) {
document.getElementById('progressText').textContent = 'çµæœã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™...';
}
}, 50);

// å‘³ã®å‚¾å‘ã®èª¬æ˜ã‚’æ›´æ–°ï¼ˆçµ±åˆã—ãŸå¥½ã¿ã‚’ä½¿ç”¨ï¼‰
updateTasteDescription(
combinedPreferences.tasteX, 
combinedPreferences.tasteY, 
combinedPreferences.complexityX, 
combinedPreferences.complexityY
);

// ä¾¡æ ¼å¸¯ã®è¡¨ç¤ºã‚’æ›´æ–°
document.getElementById('priceRange').textContent = 
`Â¥${formatPrice(combinedPreferences.minPrice)} - Â¥${formatPrice(combinedPreferences.maxPrice)}`;

} catch (error) {
console.error('Error getting recommendations:', error);
document.getElementById('loadingIndicator').style.display = 'none';
document.getElementById('progressContainer').style.display = 'none';
alert('ææ¡ˆã®å–å¾—ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚');
}
}

// å‘³ã®å‚¾å‘ã®èª¬æ˜ã‚’æ›´æ–°
function updateTasteDescription(tasteX, tasteY, complexityX, complexityY) {
let tasteDesc = '';
let complexityDesc = '';

// åŸºæœ¬çš„ãªå‘³ã®å‚¾å‘ã®èª¬æ˜
if (tasteX < 0.33) {
if (tasteY < 0.33) {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒ©ã‚¤ãƒˆã§ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„';
}
} else if (tasteX > 0.66) {
if (tasteY < 0.33) {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒ˜ãƒ“ãƒ¼ã§ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„';
}
} else {
if (tasteY < 0.33) {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼';
} else if (tasteY > 0.66) {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼';
} else {
tasteDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®å–ã‚ŒãŸ';
}
}

// è¤‡é›‘ã•ã®å¥½ã¿ã®èª¬æ˜
if (complexityX < 0.33) {
if (complexityY < 0.33) {
complexityDesc = 'è‹¥ãã¦ã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'è‹¥ãã¦å¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'è‹¥ãã¦ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
} else if (complexityX > 0.66) {
if (complexityY < 0.33) {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸå¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'ç†Ÿæˆã•ã‚ŒãŸãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
} else {
if (complexityY < 0.33) {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ã¾ã‚ã‚„ã‹';
} else if (complexityY > 0.66) {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„å¼·çƒˆãªè¤‡é›‘ã•ã‚’å¥½ã‚€';
} else {
complexityDesc = 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„è¤‡é›‘ã•ã‚’å¥½ã‚€';
}
}

// èª¬æ˜æ–‡ã‚’æ›´æ–°
document.getElementById('tasteDescription').textContent = tasteDesc;
document.getElementById('complexityDescription').textContent = complexityDesc;
}

// æ¨è–¦çµæœã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å¼·åŒ–ç‰ˆï¼‰
async function showRecommendationResult(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, chatPreferences, region = null) {
console.log('showRecommendationResult é–‹å§‹:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region });

try {
// è¡¨ç¤ºã‚³ãƒ³ãƒ†ãƒŠã‚’è¡¨ç¤º
document.getElementById('splitLayoutContainer').style.display = 'grid';

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ãƒãƒƒãƒãƒ³ã‚°
console.log('findMatchingWhiskies å‘¼ã³å‡ºã—å‰...');
const recommendedWhiskies = findMatchingWhiskies(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region);
console.log('findMatchingWhiskies çµæœ:', recommendedWhiskies);

// æ¨å¥¨ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®è¡¨ç¤º
if (!recommendedWhiskies) {
console.error('recommendedWhiskies ãŒ undefined ã§ã™');
displayDefaultRecommendations();
return;
}

if (recommendedWhiskies.length === 0) {
console.error('recommendedWhiskies ãŒç©ºã®é…åˆ—ã§ã™');
displayDefaultRecommendations();
return;
}

console.log('displayLocalRecommendations å‘¼ã³å‡ºã—å‰...');
displayLocalRecommendations(recommendedWhiskies);

// æœ€åˆã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é¸æŠ
if (recommendedWhiskies.length > 0) {
console.log('selectWhisky å‘¼ã³å‡ºã—å‰:', recommendedWhiskies[0]);
selectWhisky(recommendedWhiskies[0]);
}
} catch (error) {
console.error('showRecommendationResult ã‚¨ãƒ©ãƒ¼:', error);
console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
displayDefaultRecommendations();
}
}

// ãƒãƒƒãƒã™ã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ç‰ˆï¼‰
function findMatchingWhiskies(tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region = null) {
console.log('findMatchingWhiskies é–‹å§‹:', { tasteX, tasteY, complexityX, complexityY, minPrice, maxPrice, region });
console.log('whiskyData ã®çŠ¶æ…‹:', whiskyData ? `${whiskyData.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š` : 'ãƒ‡ãƒ¼ã‚¿ãªã—');

if (!whiskyData || whiskyData.length === 0) {
console.error('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
return [];
}

try {
// ä¾¡æ ¼ã‚’æ•°å€¤ã«å¤‰æ›
const whiskiesWithNumericPrice = whiskyData.map(whisky => {
try {
const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
return { ...whisky, numericPrice };
} catch (err) {
console.error('ä¾¡æ ¼å¤‰æ›ã‚¨ãƒ©ãƒ¼:', whisky, err);
return { ...whisky, numericPrice: 0 };
}
});
console.log('ä¾¡æ ¼å¤‰æ›å¾Œ:', `${whiskiesWithNumericPrice.length}ä»¶`);

// ä¾¡æ ¼å¸¯ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const priceFiltered = whiskiesWithNumericPrice.filter(
whisky => whisky.numericPrice >= minPrice && whisky.numericPrice <= maxPrice
);
console.log('ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', `${priceFiltered.length}ä»¶`);

// åœ°åŸŸã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
let regionFiltered = priceFiltered;
if (region) {
console.log(`åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°: "${region}" ã‚’æ¤œç´¢ä¸­...`);

// ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã®åœ°åŸŸæƒ…å ±ã‚’è¡¨ç¤º
console.log('ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿åœ°åŸŸæƒ…å ±:');
priceFiltered.slice(0, 5).forEach(w => console.log(`- ${w.name}: region=${w.region}, subcategory=${w.subcategory}`));

// åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
regionFiltered = priceFiltered.filter(whisky => 
(whisky.region && whisky.region.toLowerCase().includes(region.toLowerCase())) ||
(whisky.subcategory && whisky.subcategory.toLowerCase().includes(region.toLowerCase())) ||
(region.toLowerCase() === 'japan' && whisky.name && (
whisky.name.toLowerCase().includes('japan') ||
whisky.name.toLowerCase().includes('japanese') ||
whisky.name.toLowerCase().includes('è»½äº•æ²¢') ||
whisky.name.toLowerCase().includes('å±±å´') ||
whisky.name.toLowerCase().includes('ç™½å·') ||
whisky.name.toLowerCase().includes('éŸ¿') ||
whisky.name.toLowerCase().includes('é•·æ¿±')
))
);
console.log('åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿å¾Œ:', `${regionFiltered.length}ä»¶`);

// çµæœãŒãªã„å ´åˆã¯ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ã®ã¿é©ç”¨
if (regionFiltered.length === 0) {
console.log('åœ°åŸŸãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ã®çµæœãŒ0ä»¶ã®ãŸã‚ã€ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ã®ã¿ã‚’é©ç”¨ã—ã¾ã™');
regionFiltered = priceFiltered;
}
}

if (regionFiltered.length === 0) {
// ä¾¡æ ¼å¸¯ã«åˆã†ã‚‚ã®ãŒãªã„å ´åˆã¯å…¨ã¦ã‹ã‚‰é¸æŠ
console.log('ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°çµæœãŒ0ä»¶ã®ãŸã‚ã€å…¨ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é¸æŠã—ã¾ã™');
return whiskiesWithNumericPrice.slice(0, 3);
}

// å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæº–
console.log('å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åŸºæº–ã‚’è¨­å®š...');
const targetFruity = tasteY < 0.5 ? 4 : 2;
const targetSmoky = tasteY > 0.5 ? 4 : 2;
const targetBody = tasteX > 0.5 ? 4 : 3;
const targetComplexity = complexityX > 0.5 ? 4 : 3;
console.log('ã‚¿ãƒ¼ã‚²ãƒƒãƒˆå€¤:', { targetFruity, targetSmoky, targetBody, targetComplexity });

// ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–¢æ•°
function scoreWhisky(whisky) {
try {
if (!whisky.taste_profile) {
console.log(`${whisky.name}: taste_profileãªã—`);
return 0;
}

const fruityScore = 5 - Math.abs((whisky.taste_profile.fruity || 0) - targetFruity);
const smokyScore = 5 - Math.abs((whisky.taste_profile.smoky || 0) - targetSmoky);
const bodyScore = 5 - Math.abs((whisky.taste_profile.body || 0) - targetBody);
const complexityScore = 5 - Math.abs((whisky.taste_profile.complexity || 0) - targetComplexity);

return fruityScore + smokyScore + bodyScore + complexityScore;
} catch (err) {
console.error('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', whisky, err);
return 0;
}
}

// ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
console.log('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°é–‹å§‹...');
const scored = regionFiltered.map(whisky => {
try {
return {
whisky: whisky,
score: scoreWhisky(whisky)
};
} catch (err) {
console.error('ã‚¹ã‚³ã‚¢ãƒãƒƒãƒ”ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼:', whisky, err);
return { whisky: whisky, score: 0 };
}
}).sort((a, b) => b.score - a.score);

console.log('ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°å®Œäº†ã€‚ä¸Šä½ã‚¹ã‚³ã‚¢:');
scored.slice(0, 5).forEach(item => console.log(`- ${item.whisky.name}: ${item.score}`));

// ä¸Šä½3ã¤ã‚’è¿”ã™
const result = scored.slice(0, 3).map(item => item.whisky);
console.log('æœ€çµ‚çµæœ:', result.map(w => w.name));
return result;
} catch (error) {
console.error('findMatchingWhiskies ã‚¨ãƒ©ãƒ¼:', error);
console.error('ã‚¹ã‚¿ãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:', error.stack);
return [];
}
}

// ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ã®ææ¡ˆã‚’è¡¨ç¤ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å¼·åŒ–ç‰ˆï¼‰
function displayLocalRecommendations(whiskies) {
console.log('displayLocalRecommendations é–‹å§‹:', whiskies);

try {
const recommendationContent = document.getElementById('recommendationContent');
if (!recommendationContent) {
console.error('recommendationContent è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
return;
}

recommendationContent.innerHTML = '';

if (!whiskies || whiskies.length === 0) {
console.error('è¡¨ç¤ºã™ã‚‹ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“');
displayDefaultRecommendations();
return;
}

whiskies.forEach((whisky, index) => {
try {
console.log(`ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ä½œæˆ ${index}:`, whisky.name);

const whiskeyCard = document.createElement('div');
whiskeyCard.className = 'whisky-card';
if (index === 0) {
whiskeyCard.classList.add('featured', 'selected');
}

// HTMLã‚¨ã‚¹ã‚±ãƒ¼ãƒ—é–¢æ•°
function escapeHtml(text) {
if (text === undefined || text === null) return '';
return String(text)
.replace(/&/g, '&amp;')
.replace(/</g, '&lt;')
.replace(/>/g, '&gt;')
.replace(/"/g, '&quot;')
.replace(/'/g, '&#039;');
}

// å®‰å…¨ãªHTMLã®ä½œæˆ
whiskeyCard.innerHTML = `
                       ${index === 0 ? '<div class="featured-label">ãŠã™ã™ã‚</div>' : ''}
                       <div class="flex justify-between mb-2">
                           <h3 class="text-lg font-bold text-cyan-400">${escapeHtml(whisky.name)}</h3>
                           <span class="text-pink-500 font-bold">${escapeHtml(whisky.price)}</span>
                       </div>
                       <div class="mb-2">
                           <span class="text-gray-400 text-sm">
                               ${escapeHtml(whisky.region || 'N/A')} | ${escapeHtml(whisky.subcategory || 'Whisky')}
                               ${whisky.abv ? ` | ${whisky.abv}% ABV` : ''}
                           </span>
                       </div>
                       <p class="text-sm mb-3 text-left">${escapeHtml(whisky.tastingNote_ja || 'æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚')}</p>
                       <div class="grid grid-cols-3 gap-2 text-center text-xs">
                           <div>
                               <span class="block text-yellow-400">ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼</span>
                               <span class="block">${'â˜…'.repeat((whisky.taste_profile?.fruity || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.fruity || 0))}</span>
                           </div>
                           <div>
                               <span class="block text-yellow-400">ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼</span>
                               <span class="block">${'â˜…'.repeat((whisky.taste_profile?.smoky || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.smoky || 0))}</span>
                           </div>
                           <div>
                               <span class="block text-yellow-400">è¤‡é›‘ã•</span>
                               <span class="block">${'â˜…'.repeat((whisky.taste_profile?.complexity || 0))}${'â˜†'.repeat(5 - (whisky.taste_profile?.complexity || 0))}</span>
                           </div>
                       </div>
                   `;

// ã‚¯ãƒªãƒƒã‚¯ã§é¸æŠ
whiskeyCard.addEventListener('click', function() {
document.querySelectorAll('.whisky-card').forEach(card => {
card.classList.remove('selected');
});
whiskeyCard.classList.add('selected');
selectWhisky(whisky);
});

recommendationContent.appendChild(whiskeyCard);
} catch (err) {
console.error(`ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚«ãƒ¼ãƒ‰ ${index} ã®ä½œæˆä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:`, err);
}
});
} catch (error) {
console.error('displayLocalRecommendations ã‚¨ãƒ©ãƒ¼:', error);
// ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯è¡¨ç¤º
displayDefaultRecommendations();
}
}

// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ææ¡ˆã‚’è¡¨ç¤º
function displayDefaultRecommendations() {
const recommendationContent = document.getElementById('recommendationContent');
recommendationContent.innerHTML = `
               <div class="text-center p-4">
                   <p class="mb-4">ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ãŒã€ç¾åœ¨ææ¡ˆã‚’ç”Ÿæˆã§ãã¾ã›ã‚“ã€‚</p>
                   <p>åˆ¥ã®å‘³è¦šãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãŠè©¦ã—ã„ãŸã ãã‹ã€ãƒãƒ£ãƒƒãƒˆã§ãŠå¥½ã¿ã‚’ãŠçŸ¥ã‚‰ã›ãã ã•ã„ã€‚</p>
               </div>
           `;
}

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã®ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
function getUserProfile() {
// å‘³è¦šåº§æ¨™ã®å–å¾—
const dot1 = document.getElementById('tasteDot1');
const dot2 = document.getElementById('tasteDot2');
const tasteX = parseFloat(dot1.style.left) / 100;
const tasteY = parseFloat(dot1.style.top) / 100;
const complexityX = parseFloat(dot2.style.left) / 100;
const complexityY = parseFloat(dot2.style.top) / 100;

// åº§æ¨™ã‹ã‚‰å„æŒ‡æ¨™ã®å€¤ï¼ˆ0-5ï¼‰ã‚’è¨ˆç®—
const fruity = Math.round(5 * (1 - tasteY));
const smoky = Math.round(5 * tasteY);
const body = Math.round(5 * tasteX);
const spicy = Math.round(2.5 * (tasteX + tasteY));
const sweetness = Math.round(2.5 * (2 - tasteX - tasteY));
const complexity = Math.round(5 * complexityX);

return {
fruity,
spicy,
body,
smoky,
sweetness,
complexity
};
}

// ã‚¦ã‚£ã‚¹ã‚­ãƒ¼é¸æŠæ™‚ã®å‡¦ç†ï¼ˆãƒãƒƒãƒ—ã‚¨ãƒ©ãƒ¼å¯¾å¿œç‰ˆï¼‰
function selectWhisky(whisky) {
// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆã‚’æ›´æ–°
updateProfileChart(whisky.taste_profile, whisky.name);

try {
// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆãƒãƒƒãƒ—é–¢é€£ã®å‡¦ç†ã‚’ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ï¼‰
if (typeof updateDistilleryInfo === 'function') {
updateDistilleryInfo(whisky);
} else {
console.warn('updateDistilleryInfoé–¢æ•°ãŒå­˜åœ¨ã—ãªã„ãŸã‚ã€è’¸ç•™æ‰€æƒ…å ±ã¯è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“');
// ä»£æ›¿ã®å‡¦ç†ï¼ˆç°¡æ˜“çš„ãªè’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºï¼‰
showSimpleDistilleryInfo(whisky);
}
} catch (err) {
console.error('è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
// ãƒãƒƒãƒ—ãŒè¡¨ç¤ºã§ããªã„å ´åˆã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
showSimpleDistilleryInfo(whisky);
}

// ãƒãƒ£ãƒ¼ãƒˆãƒ‘ãƒãƒ«ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«å‡¦ç†ã‚’æ”¹å–„
const chartPanel = document.getElementById('chartPanel');
if (chartPanel) {
// 1. ãƒ‘ãƒãƒ«å†…ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’æœ€ä¸Šéƒ¨ã«è¨­å®š
chartPanel.scrollTop = 0;

// 2. ãƒ¢ãƒã‚¤ãƒ«ãªã©å°ã•ã„ç”»é¢ã‚µã‚¤ã‚ºã§ã¯ã€ãƒ‘ãƒãƒ«è‡ªä½“ã‚‚è¦–ç•Œã«å…¥ã‚Œã‚‹
if (window.innerWidth <= 1024) {
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
} else {
// PCã‚µã‚¤ã‚ºã®å ´åˆã¯ã€ãƒ‘ãƒãƒ«ãŒç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
// ã—ã‹ã—ã€æ€¥æ¿€ãªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ã¯ãªãã‚¹ãƒ ãƒ¼ã‚ºã«
chartPanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}
}
}

// è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºé–¢æ•°ï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
function showSimpleDistilleryInfo(whisky) {
try {
// è’¸ç•™æ‰€ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’è¡¨ç¤º
const distillerySection = document.getElementById('distillerySection');
if (distillerySection) {
distillerySection.classList.add('active');
}

// è’¸ç•™æ‰€åã®æ¨æ¸¬
let distilleryName = "æƒ…å ±ãªã—";
if (whisky.name && whisky.name.includes('è»½äº•æ²¢')) {
distilleryName = "è»½äº•æ²¢è’¸æºœæ‰€";
} else if (whisky.name && whisky.name.includes('å±±å´')) {
distilleryName = "å±±å´è’¸æºœæ‰€";
} else if (whisky.name && whisky.name.includes('ç™½å·')) {
distilleryName = "ç™½å·è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Japan')) {
distilleryName = "æ—¥æœ¬ã®è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Islay')) {
distilleryName = "ã‚¢ã‚¤ãƒ©å³¶ã®è’¸æºœæ‰€";
} else if (whisky.region && whisky.region.includes('Speyside')) {
distilleryName = "ã‚¹ãƒšã‚¤ã‚µã‚¤ãƒ‰ã®è’¸æºœæ‰€";
} else if (whisky.region) {
distilleryName = `${whisky.region}ã®è’¸æºœæ‰€`;
}

// è’¸ç•™æ‰€æƒ…å ±ã®è¡¨ç¤ºï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
const distilleryNameElement = document.getElementById('distilleryName');
if (distilleryNameElement) {
distilleryNameElement.textContent = distilleryName;
distilleryNameElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const distilleryRegionElement = document.getElementById('distilleryRegion');
if (distilleryRegionElement) {
distilleryRegionElement.textContent = whisky.region || 'æƒ…å ±ãªã—';
distilleryRegionElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const distilleryFoundedElement = document.getElementById('distilleryFounded');
if (distilleryFoundedElement) {
distilleryFoundedElement.textContent = 'æƒ…å ±ãªã—';
distilleryFoundedElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

const statusElement = document.getElementById('distilleryStatus');
if (statusElement) {
statusElement.textContent = 'æƒ…å ±ãªã—';
statusElement.className = 'status-unknown';
statusElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

// è’¸ç•™æ‰€ã®èª¬æ˜ï¼ˆå·¦å¯„ã›ã«ä¿®æ­£ï¼‰
const distilleryDescriptionElement = document.getElementById('distilleryDescription');
if (distilleryDescriptionElement) {
distilleryDescriptionElement.textContent = 
`${whisky.name}ã®è’¸ç•™æ‰€æƒ…å ±ã¯ç¾åœ¨åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã“ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¯${whisky.region || 'ä¸æ˜ãªåœ°åŸŸ'}ã§è£½é€ ã•ã‚Œã¦ã„ã¾ã™ã€‚`;
distilleryDescriptionElement.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

// æƒ…å ±ã‚°ãƒªãƒƒãƒ‰å…¨ä½“ã‚‚å·¦å¯„ã›ã«
const distilleryInfoGrid = document.querySelector('.distillery-info-grid');
if (distilleryInfoGrid) {
distilleryInfoGrid.style.textAlign = 'left'; // å·¦å¯„ã›ã«å¤‰æ›´
}

} catch (err) {
console.error('ç°¡æ˜“è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', err);
}
}

// ãƒãƒƒãƒ—åˆæœŸåŒ–
function initializeCommonMap() {
const mapElement = document.getElementById('distilleryMap');
if (!mapElement) return;

console.log('Initializing map with dark theme...');

// æ—¢å­˜ã®ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒã‚ã‚Œã°å‰Šé™¤
if (distilleryMap) {
distilleryMap.remove();
}

// æ–°ã—ã„ãƒãƒƒãƒ—ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ã‚’ä½œæˆï¼ˆæš—ã„ãƒ†ãƒ¼ãƒï¼‰
distilleryMap = L.map('distilleryMap', {
center: [55.0, -3.0],  // ã‚¹ã‚³ãƒƒãƒˆãƒ©ãƒ³ãƒ‰ä¸­å¿ƒ
zoom: 5,
zoomControl: false
});

// æš—ã„ã‚¹ã‚¿ã‚¤ãƒ«ã®ã‚¿ã‚¤ãƒ«ãƒ¬ã‚¤ãƒ¤ãƒ¼
L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
subdomains: 'abcd',
maxZoom: 19
}).addTo(distilleryMap);

// ã‚ºãƒ¼ãƒ ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ã‚’å³ä¸‹ã«
L.control.zoom({
position: 'bottomright'
}).addTo(distilleryMap);

// ã‚µã‚¤ã‚ºã‚’æ›´æ–°
setTimeout(() => {
distilleryMap.invalidateSize();
}, 100);

console.log('Map initialized with dark theme.');
return true;
}

// è’¸ç•™æ‰€æƒ…å ±ã‚’è¡¨ç¤ºï¼ˆå®‰å…¨ç‰ˆï¼‰
function showDistilleryInfo(distillery) {
if (!distillery) return;

try {
// åœ°å›³ãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
if (distilleryMap && typeof distilleryMap.setView === 'function' && 
distillery.location && distillery.location.lat && distillery.location.lng) {
// åœ°å›³ã‚’ã‚ºãƒ¼ãƒ ã—ã¦è©²å½“è’¸ç•™æ‰€ã®ä½ç½®ã‚’ä¸­å¿ƒã«
const zoomLevel = distillery.zoomLevel || 8;
distilleryMap.setView([distillery.location.lat, distillery.location.lng], zoomLevel);

// ãƒãƒƒãƒ—ã‚’è¡¨ç¤º
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'block';
}
} else {
// ãƒãƒƒãƒ—ãŒä½¿ç”¨ä¸å¯ã®å ´åˆã¯éè¡¨ç¤ºã«
console.warn('ãƒãƒƒãƒ—ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„ã‹ã€è’¸ç•™æ‰€ã®ä½ç½®æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“');
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}

// è’¸ç•™æ‰€æƒ…å ±ã®è¡¨ç¤ºã‚’æ›´æ–°
document.getElementById('distilleryName').textContent = distillery.name || 'æƒ…å ±ãªã—';
document.getElementById('distilleryRegion').textContent = distillery.region || 'æƒ…å ±ãªã—';
document.getElementById('distilleryFounded').textContent = distillery.foundedYear ? distillery.foundedYear + 'å¹´' : 'æƒ…å ±ãªã—';

// ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®è¨­å®š
const statusElement = document.getElementById('distilleryStatus');
statusElement.textContent = distillery.status || 'æƒ…å ±ãªã—';
statusElement.className = '';  // ã‚¯ãƒ©ã‚¹ã‚’ãƒªã‚»ãƒƒãƒˆ

if (distillery.status) {
if (distillery.status.includes('ã‚¢ã‚¯ãƒ†ã‚£ãƒ–') || distillery.status.includes('ç¨¼åƒä¸­')) {
statusElement.classList.add('status-active');
} else if (distillery.status.includes('é–‰é–')) {
statusElement.classList.add('status-closed');
} else {
statusElement.classList.add('status-unknown');
}
}

// è’¸ç•™æ‰€ã®èª¬æ˜ã‚’æ›´æ–°
document.getElementById('distilleryDescription').textContent = distillery.description || 'è©³ç´°æƒ…å ±ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
} catch (error) {
console.error('è’¸ç•™æ‰€æƒ…å ±è¡¨ç¤ºã‚¨ãƒ©ãƒ¼:', error);

// ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒãƒƒãƒ—ã‚’éè¡¨ç¤ºã«ã™ã‚‹
const mapContainer = document.querySelector('.map-container');
if (mapContainer) {
mapContainer.style.display = 'none';
}
}
}

// ãƒ¬ãƒ¼ãƒ€ãƒ¼ãƒãƒ£ãƒ¼ãƒˆæ›´æ–°ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ã¨é¸æŠã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é‡ã­ã¦è¡¨ç¤ºï¼‰
function updateProfileChart(profile, name) {
if (!profile) return;

const ctx = document.getElementById('combinedProfileChart');
if (!ctx) return;

const chartTitle = document.getElementById('chartTitle');
chartTitle.textContent = name ? `ã‚ãªãŸã®å¥½ã¿ vs ${name}` : 'ã‚ãªãŸã®å¥½ã¿';

// ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å¥½ã¿ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
const userProfile = getUserProfile();

// Canvasã‚µã‚¤ã‚ºã‚’æ˜ç¤ºçš„ã«è¨­å®š
ctx.style.width = '100%';
ctx.style.height = '320px';
ctx.width = ctx.offsetWidth;
ctx.height = 320;

// Chart.jsã®è¨­å®š
const chartOptions = {
plugins: {
legend: {
display: true,
position: 'bottom',
labels: {
color: 'rgba(255, 255, 255, 0.8)',
font: {
size: 14
}
}
},
tooltip: {
enabled: true
}
},
scales: {
r: {
angleLines: {
color: 'rgba(255, 255, 255, 0.1)'
},
grid: {
color: 'rgba(255, 255, 255, 0.1)'
},
pointLabels: {
font: {
size: 16
},
color: 'rgba(255, 255, 255, 0.9)'
},
ticks: {
display: false,
backdropColor: 'transparent'
},
beginAtZero: true,
min: 0,
max: 5
}
},
maintainAspectRatio: false,
responsive: true
};

// ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã®æº–å‚™ï¼ˆ2ã¤ã®ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã§è¡¨ç¤ºï¼‰
const datasets = [
{
label: 'ã‚ãªãŸã®å¥½ã¿',
data: [
userProfile.fruity, 
userProfile.spicy, 
userProfile.body, 
userProfile.smoky, 
userProfile.sweetness, 
userProfile.complexity
],
backgroundColor: 'rgba(78, 205, 196, 0.2)',
borderColor: '#4ecdc4',
pointBackgroundColor: '#4ecdc4',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#4ecdc4',
fill: true
}
];

// é¸æŠã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°è¿½åŠ 
if (name) {
datasets.push({
label: name,
data: [
profile.fruity || 0,
profile.spicy || 0,
profile.body || 0,
profile.smoky || 0,
profile.sweetness || 0,
profile.complexity || 0
],
backgroundColor: 'rgba(255, 107, 107, 0.2)',
borderColor: '#ff6b6b',
pointBackgroundColor: '#ff6b6b',
pointBorderColor: '#fff',
pointHoverBackgroundColor: '#fff',
pointHoverBorderColor: '#ff6b6b',
fill: true
});
}

// Chart.jsã®æ›´æ–°ã¾ãŸã¯ä½œæˆ
if (profileChartInstance) {
// æ—¢å­˜ã®ãƒãƒ£ãƒ¼ãƒˆã‚’ç ´æ£„ã—ã¦ã‹ã‚‰å†ä½œæˆ
profileChartInstance.destroy();
}

// æ–°ã—ã„ãƒãƒ£ãƒ¼ãƒˆã‚’ä½œæˆ
profileChartInstance = new Chart(ctx, {
type: 'radar',
data: {
labels: ['ãƒ•ãƒ«ãƒ¼ãƒ†ã‚£ãƒ¼', 'ã‚¹ãƒ‘ã‚¤ã‚·ãƒ¼', 'ãƒœãƒ‡ã‚£', 'ã‚¹ãƒ¢ãƒ¼ã‚­ãƒ¼', 'ç”˜ã•', 'è¤‡é›‘ã•'],
datasets: datasets
},
options: chartOptions
});

console.log('Radar chart updated with new data');
}

// é€šçŸ¥ã‚’è¡¨ç¤º
function showNotification(message) {
const notification = document.createElement('div');
notification.className = 'error-notification';

notification.innerHTML = `
               <div class="notification-content">
                   <div class="notification-icon">
                       <i class="fas fa-exclamation-circle"></i>
                   </div>
                   <div class="notification-message">
                       ${message}
                   </div>
                   <button class="notification-close">&times;</button>
               </div>
           `;

document.body.appendChild(notification);

// é–‰ã˜ã‚‹ãƒœã‚¿ãƒ³
notification.querySelector('.notification-close').addEventListener('click', function() {
notification.remove();
});

// 5ç§’å¾Œã«è‡ªå‹•ã§é–‰ã˜ã‚‹
setTimeout(function() {
if (notification.parentNode) {
notification.remove();
}
}, 5000);
}

// åˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ãƒœã‚¿ãƒ³ã®æ©Ÿèƒ½å¼·åŒ– - é‡è¤‡ãªã—ã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
document.addEventListener('DOMContentLoaded', function() {
// ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«å®Ÿè¡Œ
setTimeout(function() {
// ãƒœã‚¿ãƒ³ã®å‚ç…§ã‚’å–å¾—ï¼ˆIDã€ãƒ†ã‚­ã‚¹ãƒˆå†…å®¹ã€ã¾ãŸã¯å±æ€§ã§æ¤œç´¢ï¼‰
const refreshButton = document.querySelector('button:contains("åˆ¥ã®ææ¡ˆ")') || 
document.getElementById('getAnotherRecommendation') ||
document.querySelector('[id*="refresh"][id*="recommendation"]');

// querySelectorã®:containsãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ãªã„å ´åˆã®ä»£æ›¿æ‰‹æ®µ
if (!refreshButton) {
const allButtons = Array.from(document.querySelectorAll('button'));
const targetButton = allButtons.find(btn => 
btn.textContent.includes('åˆ¥ã®ææ¡ˆ') || 
btn.innerHTML.includes('åˆ¥ã®ææ¡ˆ')
);

if (targetButton) {
setupRefreshButtonHandler(targetButton);
} else {
console.error('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
}
} else {
setupRefreshButtonHandler(refreshButton);
}
}, 1000); // DOMContentLoadedå¾Œã«å°‘ã—å¾…ã¤

// ä»¥å‰ã«è¡¨ç¤ºã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’è¨˜éŒ²ã™ã‚‹é…åˆ—
window.previouslyShownWhiskies = window.previouslyShownWhiskies || [];

// ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®šã™ã‚‹é–¢æ•°
function setupRefreshButtonHandler(button) {
console.log('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ:', button);

// æ—¢å­˜ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ã‚¯ãƒªã‚¢ï¼ˆäºŒé‡ç™»éŒ²é˜²æ­¢ï¼‰
const newButton = button.cloneNode(true);
button.parentNode.replaceChild(newButton, button);

// æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
newButton.addEventListener('click', function() {
console.log('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ãŒã‚¯ãƒªãƒƒã‚¯ã•ã‚Œã¾ã—ãŸ - æ–°ã—ã„ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é¸æŠã—ã¾ã™');

// ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼åã‚’å–å¾—
const currentlyShownNames = [];
document.querySelectorAll('.whisky-card h3').forEach(h3 => {
if (h3.textContent && h3.textContent.trim()) {
currentlyShownNames.push(h3.textContent.trim());
}
});

console.log('ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼:', currentlyShownNames);

// ä»¥å‰è¡¨ç¤ºã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼åãƒªã‚¹ãƒˆã‚’æ›´æ–°
window.previouslyShownWhiskies = [
...window.previouslyShownWhiskies,
...currentlyShownNames
];

// é‡è¤‡ã‚’æ’é™¤
window.previouslyShownWhiskies = [...new Set(window.previouslyShownWhiskies)];

// ãƒªã‚¹ãƒˆãŒé•·ã™ãã‚‹å ´åˆã¯å¤ã„ã‚‚ã®ã‹ã‚‰å‰Šé™¤ï¼ˆæœ€å¤§50ä»¶ï¼‰
if (window.previouslyShownWhiskies.length > 50) {
window.previouslyShownWhiskies = window.previouslyShownWhiskies.slice(-50);
}

console.log('è¡¨ç¤ºå±¥æ­´:', window.previouslyShownWhiskies);

// ç¾åœ¨ã®ä¾¡æ ¼è¨­å®šã‚’å–å¾—
const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;

// ä¾¡æ ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const priceFiltered = whiskyData.filter(whisky => {
try {
const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
return numericPrice >= minPrice && numericPrice <= maxPrice;
} catch (err) {
console.warn('ä¾¡æ ¼è§£æã‚¨ãƒ©ãƒ¼:', err);
return false;
}
});

console.log(`ä¾¡æ ¼ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ: ${priceFiltered.length}ä»¶ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼`);

if (priceFiltered.length === 0) {
alert('ä¾¡æ ¼æ¡ä»¶ã«åˆã†ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ç¯„å›²ã‚’åºƒã’ã¦ãã ã•ã„ã€‚');
return;
}

// ä»¥å‰è¡¨ç¤ºã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é™¤å¤–
const newCandidates = priceFiltered.filter(whisky => 
!window.previouslyShownWhiskies.includes(whisky.name)
);

console.log(`æ–°ã—ã„å€™è£œ: ${newCandidates.length}ä»¶`);

// å€™è£œãŒå°‘ãªã„å ´åˆã¯å…¨ä½“ã‹ã‚‰é¸æŠï¼ˆå±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆï¼‰
let sourceArray;
if (newCandidates.length < 3) {
console.log('å€™è£œãŒå°‘ãªã„ãŸã‚å…¨ä½“ã‹ã‚‰é¸æŠã—ã¾ã™ã€‚å±¥æ­´ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã€‚');
window.previouslyShownWhiskies = [...currentlyShownNames]; // ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚‚ã®ã®ã¿å±¥æ­´ã«æ®‹ã™
sourceArray = priceFiltered.filter(w => !currentlyShownNames.includes(w.name));
} else {
sourceArray = newCandidates;
}

// ãƒ©ãƒ³ãƒ€ãƒ ã«3ã¤é¸ã¶
const selected = [];
const usedIndices = new Set();

// æœ€å¤§100å›ã®ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã‚’è©¦ã¿ã‚‹
let attempts = 0;
while (selected.length < 3 && attempts < 100 && usedIndices.size < sourceArray.length) {
attempts++;
const randomIndex = Math.floor(Math.random() * sourceArray.length);

// æ—¢ã«é¸æŠæ¸ˆã¿ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã¯ã‚¹ã‚­ãƒƒãƒ—
if (usedIndices.has(randomIndex)) continue;

usedIndices.add(randomIndex);
selected.push(sourceArray[randomIndex]);
}

console.log('æ–°ã—ãé¸æŠã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼:', selected.map(w => w.name));

// é¸æŠãŒååˆ†ã§ãªã„å ´åˆã®å¯¾å‡¦
if (selected.length < 3) {
console.warn(`é¸æŠã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒ${selected.length}ä»¶ã—ã‹ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ©ãƒ³ãƒ€ãƒ è£œå®Œã—ã¾ã™ã€‚`);

// ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ é¸æŠï¼ˆç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚‚ã®ã¯é™¤å¤–ï¼‰
const remainingOptions = priceFiltered.filter(w => 
!selected.map(s => s.name).includes(w.name) && 
!currentlyShownNames.includes(w.name)
);

if (remainingOptions.length > 0) {
while (selected.length < 3 && remainingOptions.length > 0) {
const randomIndex = Math.floor(Math.random() * remainingOptions.length);
selected.push(remainingOptions[randomIndex]);
remainingOptions.splice(randomIndex, 1);
}
}

// ãã‚Œã§ã‚‚è¶³ã‚Šãªã„å ´åˆã¯å…¨ä½“ã‹ã‚‰é¸æŠ
if (selected.length < 3) {
const allRemaining = priceFiltered.filter(w => 
!selected.map(s => s.name).includes(w.name)
);

while (selected.length < 3 && allRemaining.length > 0) {
const randomIndex = Math.floor(Math.random() * allRemaining.length);
selected.push(allRemaining[randomIndex]);
allRemaining.splice(randomIndex, 1);
}
}

console.log('æœ€çµ‚çš„ã«é¸æŠã•ã‚ŒãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼:', selected.map(w => w.name));
}

if (selected.length === 0) {
console.error('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®é¸æŠã«å¤±æ•—ã—ã¾ã—ãŸ');
return;
}

try {
// é¸æŠã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’è¡¨ç¤º
displayLocalRecommendations(selected);

// æœ€åˆã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã‚’é¸æŠ
selectWhisky(selected[0]);

console.log('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®è¡¨ç¤ºã‚’æ›´æ–°ã—ã¾ã—ãŸ');
} catch (err) {
console.error('ã‚¦ã‚£ã‚¹ã‚­ãƒ¼è¡¨ç¤ºä¸­ã«ã‚¨ãƒ©ãƒ¼:', err);
}
});

console.log('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã«ãƒ©ãƒ³ãƒ€ãƒ é¸æŠæ©Ÿèƒ½ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
}
});

</script>
<script>
// ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³æ©Ÿèƒ½ã®ä¿®æ­£ãƒ‘ãƒƒãƒ - æ­£ç¢ºãªIDã‚’ä½¿ç”¨
(function() {
// DOMãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
function initializeCustomButton() {
// æ­£ç¢ºãªIDã§ãƒœã‚¿ãƒ³ã‚’å–å¾—
const refreshButton = document.getElementById('getAnotherRecommendation');

if (refreshButton) {
console.log('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã‚’æ­£ç¢ºãªIDã§ç™ºè¦‹ã—ã¾ã—ãŸ');

// æ—¢å­˜ã®ã™ã¹ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚¯ãƒ­ãƒ¼ãƒ³
const newButton = refreshButton.cloneNode(true);
refreshButton.parentNode.replaceChild(newButton, refreshButton);

// æ–°ã—ã„ãƒœã‚¿ãƒ³ã«åŒã˜IDã‚’è¨­å®šï¼ˆé‡è¦ï¼‰
newButton.id = 'getAnotherRecommendation';

// å®Œå…¨ã«æ–°ã—ã„ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
newButton.addEventListener('click', function(e) {
// ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®å‹•ä½œã¨ã‚¤ãƒ™ãƒ³ãƒˆä¼æ’­ã‚’åœæ­¢
if (e) {
e.preventDefault();
e.stopPropagation();
}

console.log('å®Œå…¨ãƒ©ãƒ³ãƒ€ãƒ é¸æŠã®ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€å‡¦ç†ã‚’å®Ÿè¡Œ');

// ç¾åœ¨ã®ä¾¡æ ¼è¨­å®šã‚’å–å¾—
const minPrice = parseInt(document.getElementById('minPrice').value) * 1000;
const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000;

// ä¾¡æ ¼ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const priceFiltered = whiskyData.filter(whisky => {
try {
const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
return numericPrice >= minPrice && numericPrice <= maxPrice;
} catch (err) {
return false;
}
});

if (priceFiltered.length < 3) {
alert('æ¡ä»¶ã«åˆã†ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ãŒè¶³ã‚Šã¾ã›ã‚“ã€‚ä¾¡æ ¼ç¯„å›²ã‚’åºƒã’ã¦ãã ã•ã„ã€‚');
return false;
}

// ç¾åœ¨è¡¨ç¤ºä¸­ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼åã‚’å–å¾—ã—ã¦é™¤å¤–
const currentlyShown = [];
document.querySelectorAll('.whisky-card h3').forEach(h3 => {
if (h3.textContent) currentlyShown.push(h3.textContent.trim());
});

// ç¾åœ¨è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
const notCurrentlyShown = priceFiltered.filter(w => 
!currentlyShown.includes(w.name)
);

// å€™è£œãŒååˆ†ã«ã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
const sourceArray = notCurrentlyShown.length >= 3 ? notCurrentlyShown : priceFiltered;

// å®Œå…¨ã«ãƒ©ãƒ³ãƒ€ãƒ åŒ–ã—ã¦é¸æŠ
const randomWhiskies = [];
const shuffled = [...sourceArray].sort(() => 0.5 - Math.random());

// æœ€å¤§3ã¤é¸æŠ
for (let i = 0; i < Math.min(3, shuffled.length); i++) {
randomWhiskies.push(shuffled[i]);
}

console.log('ãƒ©ãƒ³ãƒ€ãƒ ã«é¸æŠã—ãŸã‚¦ã‚£ã‚¹ã‚­ãƒ¼:', randomWhiskies.map(w => w.name));

// è¡¨ç¤ºé–¢æ•°ã‚’å‘¼ã³å‡ºã—
if (typeof displayLocalRecommendations === 'function') {
try {
displayLocalRecommendations(randomWhiskies);
if (randomWhiskies.length > 0 && typeof selectWhisky === 'function') {
selectWhisky(randomWhiskies[0]);
}
} catch (error) {
console.error('è¡¨ç¤ºå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ:', error);
}
} else {
console.error('displayLocalRecommendationsé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}

return false;
});

console.log('ã€Œåˆ¥ã®ææ¡ˆã‚’å—ã‘ã‚‹ã€ãƒœã‚¿ãƒ³ã®å‡¦ç†ã‚’å®Œå…¨ã«ä¸Šæ›¸ãã—ã¾ã—ãŸ');
} else {
console.error('IDã€ŒgetAnotherRecommendationã€ã®ãƒœã‚¿ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
}
}

// æ—¢å­˜ã®å‡¦ç†ãŒå®Œäº†ã—ãŸå¾Œã«å®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã‚’èª¿æ•´
if (document.readyState === 'complete') {
// ãƒšãƒ¼ã‚¸ãŒæ—¢ã«å®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹å ´åˆ
setTimeout(initializeCustomButton, 1500);
} else {
// ã¾ã ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿ä¸­ã®å ´åˆã¯loadã‚¤ãƒ™ãƒ³ãƒˆã‚’å¾…ã¤
window.addEventListener('load', function() {
setTimeout(initializeCustomButton, 1500);
});
}
})();
</script>
<script>
// AIãƒãƒ£ãƒƒãƒˆã‹ã‚‰ã®éŠ˜æŸ„æŠ½å‡ºã¨æ¨å¥¨ãƒªã‚¹ãƒˆã®é€£æºã‚’æ”¹å–„ï¼ˆé¡ä¼¼åº¦ãƒãƒƒãƒãƒ³ã‚°ç‰ˆï¼‰
(function() {
  // AIã®å¿œç­”ã‚’å‡¦ç†ã™ã‚‹é–¢æ•°ã‚’æ”¹å–„ã™ã‚‹
  function enhanceAIResponseProcessing() {
    // å…ƒã®getAIResponseé–¢æ•°ã‚’ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
    const originalGetAIResponse = window.getAIResponse;
    
    // ã‚‚ã—å…ƒã®é–¢æ•°ãŒå­˜åœ¨ã—ãªã‘ã‚Œã°çµ‚äº†
    if (typeof originalGetAIResponse !== 'function') {
      console.error('å…ƒã®getAIResponseé–¢æ•°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // æ‹¡å¼µç‰ˆã®getAIResponseé–¢æ•°
    window.getAIResponse = async function(message) {
      // ã¾ãšéŠ˜æŸ„åã‚’æ¢ç´¢
      const mentionedWhiskies = findWhiskiesInText(message);
      console.log('ãƒãƒ£ãƒƒãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‹ã‚‰æŠ½å‡ºã—ãŸéŠ˜æŸ„:', mentionedWhiskies);
      
      // å…ƒã®é–¢æ•°ã‚’å‘¼ã³å‡ºã—ã¦å¿œç­”ã‚’å–å¾—
      const result = await originalGetAIResponse.apply(this, arguments);
      
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å†…ã§è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’è¡¨ç¤ºãƒªã‚¹ãƒˆã«å«ã‚ã‚‹
      if (mentionedWhiskies.length > 0) {
        setTimeout(() => {
          updateRecommendationsWithMentioned(mentionedWhiskies);
        }, 1000); // AIã®å¿œç­”ãŒè¡¨ç¤ºã•ã‚ŒãŸå¾Œã«å®Ÿè¡Œ
      }
      
      return result;
    };
    
    console.log('getAIResponseé–¢æ•°ã‚’æ‹¡å¼µã—ã¾ã—ãŸ - ãƒãƒ£ãƒƒãƒˆå†…ã®éŠ˜æŸ„åæŠ½å‡ºã¨è¡¨ç¤ºã‚’é€£æº');
  }
  
  // ãƒ†ã‚­ã‚¹ãƒˆå†…ã§è¨€åŠã•ã‚Œã¦ã„ã‚‹éŠ˜æŸ„ã‚’æ¤œå‡ºã™ã‚‹é–¢æ•°ï¼ˆé¡ä¼¼åº¦ã‚’ä½¿ç”¨ï¼‰
  function findWhiskiesInText(text) {
    if (!text || typeof text !== 'string') return [];
    if (!window.whiskyData || !Array.isArray(window.whiskyData)) return [];
    
    // çµæœã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    const result = [];
    
    // ãƒ†ã‚­ã‚¹ãƒˆã‚’å‰å‡¦ç†ï¼ˆå°æ–‡å­—åŒ–ã€ç©ºç™½ã®æ­£è¦åŒ–ï¼‰
    const normalizedText = text.toLowerCase().replace(/\s+/g, ' ');
    
    // ç‰¹å¾´çš„ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä¸»è¦éŠ˜æŸ„åï¼‰
    const commonWhiskyNames = [
      'å±±å´', 'ç™½å·', 'éŸ¿', 'è»½äº•æ²¢', 'é•·æ¿±', 'ã‚¿ãƒªã‚¹ã‚«ãƒ¼', 'ãƒãƒƒã‚«ãƒ©ãƒ³', 'ã‚¢ãƒ¼ãƒ‰ãƒ™ãƒƒã‚°', 
      'ãƒãƒ¼ãƒˆã‚¨ãƒ¬ãƒ³', 'NAGAHAMA', 'DAILUAINE', 'ã‚­ãƒ«ãƒ›ãƒ¼ãƒãƒ³', 'GLENLIVET', 'ABERFELDY', 
      'SPRINGBANK', 'MORTLACH', 'CAOL ILA', 'KILCHOMAN', 'ç§©çˆ¶'
    ];
    
    // ç›´æ¥çš„ãªéŠ˜æŸ„åã®æ¤œç´¢ï¼ˆå®Œå…¨ä¸€è‡´ã¾ãŸã¯ä¸»è¦éƒ¨åˆ†ãŒä¸€è‡´ï¼‰
    const matches = [];
    window.whiskyData.forEach(whisky => {
      // éŠ˜æŸ„åã‚’æ­£è¦åŒ–
      const whiskyName = whisky.name.toLowerCase();
      
      // å®Œå…¨ä¸€è‡´ã¾ãŸã¯éƒ¨åˆ†ä¸€è‡´
      if (normalizedText.includes(whiskyName) || 
          whiskyName.includes(normalizedText) || 
          textSimilarity(normalizedText, whiskyName) > 0.7) {
        matches.push({
          whisky: whisky,
          score: 1.0,
          matchType: 'direct'
        });
        return;
      }
      
      // ä¸»è¦ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯
      for (const keyword of commonWhiskyNames) {
        const normalizedKeyword = keyword.toLowerCase();
        if ((whiskyName.includes(normalizedKeyword) || 
             normalizedKeyword.includes(whiskyName)) && 
            normalizedText.includes(normalizedKeyword)) {
          matches.push({
            whisky: whisky,
            score: 0.9,
            matchType: 'keyword'
          });
          return;
        }
      }
      
      // ãƒˆãƒ¼ã‚¯ãƒ³ãƒ™ãƒ¼ã‚¹ã®éƒ¨åˆ†ä¸€è‡´ãƒã‚§ãƒƒã‚¯
      const whiskyTokens = whiskyName.split(/[\s\d]+/);
      const textTokens = normalizedText.split(/[\s\d]+/);
      
      for (const whiskyToken of whiskyTokens) {
        if (whiskyToken.length < 2) continue; // çŸ­ã™ãã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç„¡è¦–
        
        for (const textToken of textTokens) {
          if (textToken.length < 2) continue; // çŸ­ã™ãã‚‹ãƒˆãƒ¼ã‚¯ãƒ³ã¯ç„¡è¦–
          
          if (whiskyToken === textToken || 
              whiskyToken.includes(textToken) || 
              textToken.includes(whiskyToken)) {
            matches.push({
              whisky: whisky,
              score: 0.8,
              matchType: 'token',
              token: whiskyToken
            });
            return;
          }
        }
      }
    });
    
    // ã‚¹ã‚³ã‚¢ã§ã‚½ãƒ¼ãƒˆ
    matches.sort((a, b) => b.score - a.score);
    
    // çµæœã®æŠ½å‡º
    return matches.map(match => match.whisky);
  }
  
  // ãƒ†ã‚­ã‚¹ãƒˆã®é¡ä¼¼åº¦ã‚’è¨ˆç®—ã™ã‚‹é–¢æ•°
  function textSimilarity(text1, text2) {
    // ç°¡æ˜“çš„ãªé¡ä¼¼åº¦è¨ˆç®—ï¼ˆLevenshteinè·é›¢ã®æ­£è¦åŒ–ç‰ˆï¼‰
    function levenshteinDistance(a, b) {
      const matrix = [];
      
      // åˆæœŸåŒ–
      for (let i = 0; i <= b.length; i++) {
        matrix[i] = [i];
      }
      for (let j = 0; j <= a.length; j++) {
        matrix[0][j] = j;
      }
      
      // è¨ˆç®—
      for (let i = 1; i <= b.length; i++) {
        for (let j = 1; j <= a.length; j++) {
          if (b.charAt(i-1) === a.charAt(j-1)) {
            matrix[i][j] = matrix[i-1][j-1];
          } else {
            matrix[i][j] = Math.min(
              matrix[i-1][j-1] + 1, // ç½®æ›
              Math.min(
                matrix[i][j-1] + 1, // æŒ¿å…¥
                matrix[i-1][j] + 1  // å‰Šé™¤
              )
            );
          }
        }
      }
      
      return matrix[b.length][a.length];
    }
    
    // æœ€å¤§ã®é•·ã•
    const maxLength = Math.max(text1.length, text2.length);
    if (maxLength === 0) return 1.0; // ä¸¡æ–¹ãŒç©ºæ–‡å­—åˆ—
    
    // è·é›¢ã‚’è¨ˆç®—
    const distance = levenshteinDistance(text1, text2);
    
    // æ­£è¦åŒ–ï¼ˆ0-1ã®ç¯„å›²ã«ï¼‰
    return 1.0 - (distance / maxLength);
  }
  
  // AIã®å¿œç­”ã‹ã‚‰éŠ˜æŸ„åã‚’æŠ½å‡ºã™ã‚‹é–¢æ•°
  function extractWhiskyNamesFromAIResponse(response) {
    if (!response || typeof response !== 'string') return [];
    if (!window.whiskyData || !Array.isArray(window.whiskyData)) return [];
    
    // çµæœã‚’æ ¼ç´ã™ã‚‹é…åˆ—
    const result = [];
    
    // ã€Œã€ã‚„ã€ã€ã§å›²ã¾ã‚ŒãŸéƒ¨åˆ†ã‚’æŠ½å‡º
    const quotedMatches = response.match(/[ã€Œã€]([^ã€ã€]+)[ã€ã€]/g) || [];
    for (const match of quotedMatches) {
      const extractedName = match.replace(/[ã€Œã€ã€ã€]/g, '');
      // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹å†…ã§é¡ä¼¼ã™ã‚‹éŠ˜æŸ„ã‚’æ¤œç´¢
      const similarWhisky = findSimilarWhisky(extractedName);
      if (similarWhisky && !result.includes(similarWhisky)) {
        result.push(similarWhisky);
      }
    }
    
    // å¹´æ•°ã‚’å«ã‚€ç‰¹å¾´çš„ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æŠ½å‡ºï¼ˆä¾‹ï¼šã‚¿ãƒªã‚¹ã‚«ãƒ¼44å¹´ï¼‰
    const ageMatches = response.match(/(\S+\s?\d+å¹´[^\sã€ã€‚,.]+)/g) || [];
    for (const match of ageMatches) {
      const similarWhisky = findSimilarWhisky(match);
      if (similarWhisky && !result.includes(similarWhisky)) {
        result.push(similarWhisky);
      }
    }
    
    return result;
  }
  
  // ãƒ†ã‚­ã‚¹ãƒˆã«æœ€ã‚‚é¡ä¼¼ã—ãŸéŠ˜æŸ„ã‚’è¦‹ã¤ã‘ã‚‹é–¢æ•°
  function findSimilarWhisky(text) {
    if (!text || !window.whiskyData) return null;
    
    let bestMatch = null;
    let highestScore = 0;
    
    for (const whisky of window.whiskyData) {
      const similarityScore = textSimilarity(
        text.toLowerCase(), 
        whisky.name.toLowerCase()
      );
      
      if (similarityScore > highestScore && similarityScore > 0.6) {
        highestScore = similarityScore;
        bestMatch = whisky;
      }
    }
    
    return bestMatch;
  }
  
  // è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’æ¨å¥¨ãƒªã‚¹ãƒˆã«å«ã‚ã‚‹
  function updateRecommendationsWithMentioned(mentionedWhiskies) {
    if (!mentionedWhiskies || mentionedWhiskies.length === 0) return;
    
    console.log('éŠ˜æŸ„æ¨å¥¨ãƒªã‚¹ãƒˆã«å«ã‚ã‚‹:', mentionedWhiskies.map(w => w.name));
    
    // ç¾åœ¨ã®ä¾¡æ ¼è¨­å®šã‚’å–å¾—
    const minPrice = parseInt(document.getElementById('minPrice').value) * 1000 || 0;
    const maxPrice = parseInt(document.getElementById('maxPrice').value) * 1000 || 100000;
    
    // ä¾¡æ ¼ç¯„å›²å†…ã®è¨€åŠéŠ˜æŸ„ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    const filteredWhiskies = mentionedWhiskies.filter(whisky => {
      try {
        const numericPrice = parseInt(whisky.price.replace(/[^\d]/g, '')) || 0;
        return numericPrice >= minPrice && numericPrice <= maxPrice;
      } catch (err) {
        return true; // ä¾¡æ ¼è§£æã‚¨ãƒ©ãƒ¼ã®å ´åˆã¯å«ã‚ã‚‹
      }
    });
    
    if (filteredWhiskies.length === 0) {
      console.log('è¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ãŒä¾¡æ ¼ç¯„å›²å¤–ã§ã™');
      return;
    }
    
    // è¶³ã‚Šãªã„å ´åˆã¯ãƒ©ãƒ³ãƒ€ãƒ ã«è¿½åŠ 
    const finalSelection = [...filteredWhiskies];
    if (finalSelection.length < 3) {
      // ç¾åœ¨ã®ã‚¦ã‚£ã‚¹ã‚­ãƒ¼ã¨è¨€åŠã•ã‚ŒãŸã‚‚ã®ã‚’é™¤å¤–ã—ã¦ãƒ©ãƒ³ãƒ€ãƒ é¸æŠ
      const currentNames = finalSelection.map(w => w.name);
      const additionalCandidates = window.whiskyData.filter(w => {
        try {
          const numericPrice = parseInt(w.price.replace(/[^\d]/g, '')) || 0;
          return numericPrice >= minPrice && numericPrice <= maxPrice && !currentNames.includes(w.name);
        } catch (err) {
          return false;
        }
      });
      
      // ãƒ©ãƒ³ãƒ€ãƒ ã«ä¸¦ã¹æ›¿ãˆã¦å¿…è¦ãªæ•°ã ã‘è¿½åŠ 
      const shuffled = additionalCandidates.sort(() => 0.5 - Math.random());
      while (finalSelection.length < 3 && shuffled.length > 0) {
        finalSelection.push(shuffled.pop());
      }
    }
    
    // æœ€çµ‚çš„ãªé¸æŠçµæœãŒå¾—ã‚‰ã‚ŒãŸå ´åˆã€è¡¨ç¤ºã‚’æ›´æ–°
    if (finalSelection.length > 0) {
      console.log('æœ€çµ‚çš„ã«é¸æŠã•ã‚ŒãŸéŠ˜æŸ„:', finalSelection.map(w => w.name));
      
      try {
        // æ¨å¥¨ãƒ‘ãƒãƒ«ã‚’è¡¨ç¤º
        document.getElementById('splitLayoutContainer').style.display = 'grid';
        
        // éŠ˜æŸ„ã‚’è¡¨ç¤º
        if (typeof displayLocalRecommendations === 'function') {
          displayLocalRecommendations(finalSelection);
          
          // æœ€åˆã®éŠ˜æŸ„ã‚’é¸æŠï¼ˆè¨€åŠã•ã‚ŒãŸéŠ˜æŸ„ã‚’å„ªå…ˆï¼‰
          if (filteredWhiskies.length > 0 && typeof selectWhisky === 'function') {
            selectWhisky(filteredWhiskies[0]);
          } else if (finalSelection.length > 0 && typeof selectWhisky === 'function') {
            selectWhisky(finalSelection[0]);
          }
        }
      } catch (err) {
        console.error('è¡¨ç¤ºæ›´æ–°ä¸­ã«ã‚¨ãƒ©ãƒ¼:', err);
      }
    }
  }
  
  // å®Ÿè¡Œã‚¿ã‚¤ãƒŸãƒ³ã‚°ã®èª¿æ•´
  if (document.readyState === 'complete') {
    setTimeout(enhanceAIResponseProcessing, 2000);
  } else {
    window.addEventListener('load', function() {
      setTimeout(enhanceAIResponseProcessing, 2000);
    });
  }
})();
</script>


<script id="html_badge_script1">
window.__genspark_remove_badge_link = "https://www.genspark.ai/api/html_badge/" +
"remove_badge?token=To%2FBnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3%2FDuBA6s%2F4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE%2FG0eL9qcC2PHM%2FfezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4%2B0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c%2BiEGpY7DMnGKNiptaLE9nF%2BYMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP%2Fhc2Wel1QtoQ08mJNhlTFLw%2F66U%2FBoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2%2Bu5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk%2F1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g%3D%3D";
window.__genspark_locale = "ja-JP";
window.__genspark_token = "To/BnjzloZ3UfQdcSaYfDq9sMzTBnkK7N3vAQixbZKInGo3/DuBA6s/4VsjkLQIldQG1vBDFOom35B3TYhS0C5loF0WIDf5yE/G0eL9qcC2PHM/fezhPsC8fofhN40jlExJ4Z2GrQNhHhSoa3luU4+0Sapq4VdJCyDpWhuLcSfgUGnT4f2WU37rDhgQFXxI2c+iEGpY7DMnGKNiptaLE9nF+YMDq7mzCYwQVUHEYGSiRB8xTGxpQV49PdUwIeNLp7WlAkvXWOi1eVTnGF7FqxOP/hc2Wel1QtoQ08mJNhlTFLw/66U/BoCwUnkc4BJONTAnlqJyoHGYYwfAZXH6DfcXlQqu805Zulsk8hrnasqAF172mArQLBFkPWCW5mpdZrPJMSVbIvTbRYimqBuvdaT02pMiNWDG4uiDaUgDMR0rhm2+u5cehH427wZ75S6ebV0t3T6Dl7JtDzvcjVPiLrSk/1wH1q4ZTwkNlRY8dqxyz7gY5bliH4OYy0wSaqHyncNa3jAHYAsiE0nsbiNUB0g==";
</script>

<script id="html_notice_dialog_script" src="./index_files/notice_dialog.js.ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰"></script>
<!-- ãƒšãƒ¼ã‚¸æœ«å°¾ã«è¿½åŠ  -->
<script type="text/javascript">
function openGoogleTranslate() {
const currentUrl = window.location.href;
const translateUrl = `https://translate.google.com/translate?sl=auto&u=${encodeURIComponent(currentUrl)}`;
window.open(translateUrl, '_blank');
}
</script>
<script type="text/javascript" src="https://translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>